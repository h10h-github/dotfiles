<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>guard.rb.orig - guard-2.10.2 Documentation</title>

<link href="../fonts.css" rel="stylesheet">
<link href="../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/navigation.js"></script>
<script src="../js/search_index.js"></script>
<script src="../js/search.js"></script>
<script src="../js/searcher.js"></script>
<script src="../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../lib/guard_rb_orig.html">guard.rb.orig</a>
  
    <li><a href="../lib/guard/compat/test/helper_rb_orig.html">helper.rb.orig</a>
  
    <li><a href="../lib/guard/dsl_rb_orig.html">dsl.rb.orig</a>
  
    <li><a href="../lib/guard/internals/session_rb_orig.html">session.rb.orig</a>
  
    <li><a href="../lib/guard/plugin_util_rb_orig.html">plugin_util.rb.orig</a>
  
    <li><a href="../lib/guard/templates/Guardfile.html">Guardfile</a>
  
    <li><a href="../lib/guard/ui_rb_orig.html">ui.rb.orig</a>
  
    <li><a href="../lib/guard/version_rb_orig.html">version.rb.orig</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page lib/guard.rb.orig">

<p>require “thread” require “listen”</p>

<p>require “guard/config” require “guard/deprecated/guard” unless
Guard::Config.new.strict?</p>

<p>require “guard/internals/debugging” require “guard/internals/traps” require
“guard/internals/helpers”</p>

<p>require “guard/internals/queue” require “guard/internals/state”</p>

<p>require “guard/options” require “guard/commander” require “guard/dsl”
require “guard/group” require “guard/interactor” require “guard/notifier”
require “guard/plugin_util” require “guard/runner” require “guard/sheller”
require “guard/ui” require “guard/watcher” require
“guard/guardfile/evaluator”</p>

<p># Guard is the main module for all Guard related modules and classes. #
Also Guard plugins should use this namespace. # module Guard</p>

<pre class="ruby"><span class="ruby-constant">Deprecated</span><span class="ruby-operator">::</span><span class="ruby-constant">Guard</span>.<span class="ruby-identifier">add_deprecated</span>(<span class="ruby-keyword">self</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">Config</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">strict?</span>

<span class="ruby-keyword">class</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">self</span>
  <span class="ruby-identifier">attr_reader</span> :<span class="ruby-identifier">listener</span>

  <span class="ruby-comment"># @private api</span>
  <span class="ruby-identifier">attr_reader</span> :<span class="ruby-identifier">queue</span>

  <span class="ruby-identifier">include</span> <span class="ruby-constant">Internals</span><span class="ruby-operator">::</span><span class="ruby-constant">Helpers</span>

  <span class="ruby-comment"># Initializes the Guard singleton:</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># * Initialize the internal Guard state;</span>
  <span class="ruby-comment"># * Create the interactor</span>
  <span class="ruby-comment"># * Select and initialize the file change listener.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># @option options [Boolean] clear if auto clear the UI should be done</span>
  <span class="ruby-comment"># @option options [Boolean] notify if system notifications should be shown</span>
  <span class="ruby-comment"># @option options [Boolean] debug if debug output should be shown</span>
  <span class="ruby-comment"># @option options [Array&lt;String&gt;] group the list of groups to start</span>
  <span class="ruby-comment"># @option options [Array&lt;String&gt;] watchdir the directories to watch</span>
  <span class="ruby-comment"># @option options [String] guardfile the path to the Guardfile</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># @return [Guard] the Guard singleton</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">setup</span>(<span class="ruby-identifier">cmdline_options</span> = {})
    <span class="ruby-identifier">init</span>(<span class="ruby-identifier">cmdline_options</span>)

    <span class="ruby-ivar">@queue</span> = <span class="ruby-constant">Internals</span><span class="ruby-operator">::</span><span class="ruby-constant">Queue</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Guard</span>)

    <span class="ruby-identifier">_evaluate</span>(<span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">evaluator_options</span>)

    <span class="ruby-comment"># NOTE: this should be *after* evaluate so :directories can work</span>
    <span class="ruby-comment"># TODO: move listener setup to session?</span>
    <span class="ruby-ivar">@listener</span> = <span class="ruby-constant">Listen</span>.<span class="ruby-identifier">send</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">listener_args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">_listener_callback</span>)

    <span class="ruby-identifier">ignores</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">guardfile_ignore</span>
    <span class="ruby-ivar">@listener</span>.<span class="ruby-identifier">ignore</span>(<span class="ruby-identifier">ignores</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ignores</span>.<span class="ruby-identifier">empty?</span>

    <span class="ruby-identifier">ignores</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">guardfile_ignore_bang</span>
    <span class="ruby-ivar">@listener</span>.<span class="ruby-identifier">ignore!</span>(<span class="ruby-identifier">ignores</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ignores</span>.<span class="ruby-identifier">empty?</span>

    <span class="ruby-constant">Notifier</span>.<span class="ruby-identifier">connect</span>(<span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">notify_options</span>)

    <span class="ruby-identifier">traps</span> = <span class="ruby-constant">Internals</span><span class="ruby-operator">::</span><span class="ruby-constant">Traps</span>
    <span class="ruby-identifier">traps</span>.<span class="ruby-identifier">handle</span>(<span class="ruby-string">&quot;USR1&quot;</span>) { <span class="ruby-identifier">async_queue_add</span>([:<span class="ruby-identifier">guard_pause</span>, :<span class="ruby-identifier">paused</span>]) }
    <span class="ruby-identifier">traps</span>.<span class="ruby-identifier">handle</span>(<span class="ruby-string">&quot;USR2&quot;</span>) { <span class="ruby-identifier">async_queue_add</span>([:<span class="ruby-identifier">guard_pause</span>, :<span class="ruby-identifier">unpaused</span>]) }

    <span class="ruby-ivar">@interactor</span> = <span class="ruby-constant">Interactor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">interactor_name</span> <span class="ruby-operator">==</span> :<span class="ruby-identifier">sleep</span>)
    <span class="ruby-identifier">traps</span>.<span class="ruby-identifier">handle</span>(<span class="ruby-string">&quot;INT&quot;</span>) { <span class="ruby-ivar">@interactor</span>.<span class="ruby-identifier">handle_interrupt</span> }

    <span class="ruby-keyword">self</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">init</span>(<span class="ruby-identifier">cmdline_options</span>)
    <span class="ruby-ivar">@state</span> = <span class="ruby-constant">Internals</span><span class="ruby-operator">::</span><span class="ruby-constant">State</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">cmdline_options</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">attr_reader</span> :<span class="ruby-identifier">state</span>

  <span class="ruby-identifier">attr_reader</span> :<span class="ruby-identifier">interactor</span>

  <span class="ruby-comment"># Asynchronously trigger changes</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Currently supported args:</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   @example Old style hash:</span>
  <span class="ruby-comment">#     async_queue_add(modified: [&#39;foo&#39;], added: [&#39;bar&#39;], removed: [])</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   @example New style signals with args:</span>
  <span class="ruby-comment">#     async_queue_add([:guard_pause, :unpaused ])</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">async_queue_add</span>(<span class="ruby-identifier">changes</span>)
    <span class="ruby-ivar">@queue</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">changes</span>

    <span class="ruby-comment"># Putting interactor in background puts guard into foreground</span>
    <span class="ruby-comment"># so it can handle change notifications</span>
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-identifier">interactor</span>.<span class="ruby-identifier">background</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-comment"># Check if any of the changes are actually watched for</span>
  <span class="ruby-comment"># TODO: why iterate twice? reuse this info when running tasks</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">_relevant_changes?</span>(<span class="ruby-identifier">changes</span>)
    <span class="ruby-comment"># TODO: no coverage!</span>
    <span class="ruby-identifier">files</span> = <span class="ruby-identifier">changes</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">flatten</span>(<span class="ruby-value">1</span>)
    <span class="ruby-identifier">scope</span> = <span class="ruby-constant">Guard</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">scope</span>
    <span class="ruby-identifier">watchers</span> = <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">grouped_plugins</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">_group</span>, <span class="ruby-identifier">plugins</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">plugins</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span>:<span class="ruby-identifier">watchers</span>).<span class="ruby-identifier">flatten</span>
    <span class="ruby-keyword">end</span>.<span class="ruby-identifier">flatten</span>
    <span class="ruby-identifier">watchers</span>.<span class="ruby-identifier">any?</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">watcher</span><span class="ruby-operator">|</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">any?</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">watcher</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">file</span>) } }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">_relative_pathnames</span>(<span class="ruby-identifier">paths</span>)
    <span class="ruby-identifier">paths</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_relative_pathname</span>(<span class="ruby-identifier">path</span>) }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">_listener_callback</span>
    <span class="ruby-identifier">lambda</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">modified</span>, <span class="ruby-identifier">added</span>, <span class="ruby-identifier">removed</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">relative_paths</span> = {
        <span class="ruby-identifier">modified</span><span class="ruby-operator">:</span> <span class="ruby-identifier">_relative_pathnames</span>(<span class="ruby-identifier">modified</span>),
        <span class="ruby-identifier">added</span><span class="ruby-operator">:</span> <span class="ruby-identifier">_relative_pathnames</span>(<span class="ruby-identifier">added</span>),
        <span class="ruby-identifier">removed</span><span class="ruby-operator">:</span> <span class="ruby-identifier">_relative_pathnames</span>(<span class="ruby-identifier">removed</span>)
      }

      <span class="ruby-identifier">async_queue_add</span>(<span class="ruby-identifier">relative_paths</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">_relevant_changes?</span>(<span class="ruby-identifier">relative_paths</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># TODO: obsoleted? (move to Dsl?)</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">_pluginless_guardfile?</span>
    <span class="ruby-comment"># no Reevaluator means there was no Guardfile configured that could be</span>
    <span class="ruby-comment"># reevaluated, so we don&#39;t have a pluginless guardfile, because we don&#39;t</span>
    <span class="ruby-comment"># have a Guardfile to begin with...</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># But, if we have a Guardfile, we&#39;ll at least have the built-in</span>
    <span class="ruby-comment"># Reevaluator, so the following will work:</span>

    <span class="ruby-identifier">plugins</span> = <span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">plugins</span>.<span class="ruby-identifier">all</span>
    <span class="ruby-identifier">plugins</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">plugins</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span>:<span class="ruby-identifier">name</span>) <span class="ruby-operator">==</span> [<span class="ruby-string">&quot;reevaluator&quot;</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">_evaluate</span>(<span class="ruby-identifier">options</span>)
    <span class="ruby-identifier">evaluator</span> = <span class="ruby-constant">Guardfile</span><span class="ruby-operator">::</span><span class="ruby-constant">Evaluator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">options</span>)
    <span class="ruby-identifier">evaluator</span>.<span class="ruby-identifier">evaluate</span>

    <span class="ruby-comment"># TODO: remove this workaround when options are removed</span>
    <span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">clearing</span>(<span class="ruby-identifier">state</span>.<span class="ruby-identifier">session</span>.<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">clear</span>])

    <span class="ruby-constant">UI</span>.<span class="ruby-identifier">reset_and_clear</span>

    <span class="ruby-identifier">msg</span> = <span class="ruby-string">&quot;No plugins found in Guardfile, please add at least one.&quot;</span>
    <span class="ruby-constant">UI</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">msg</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">_pluginless_guardfile?</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">evaluator</span>.<span class="ruby-identifier">inline?</span>
      <span class="ruby-constant">UI</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">&quot;Using inline Guardfile.&quot;</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">evaluator</span>.<span class="ruby-identifier">custom?</span>
      <span class="ruby-constant">UI</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Using Guardfile at #{ evaluator.path }.&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Guardfile</span><span class="ruby-operator">::</span><span class="ruby-constant">Evaluator</span><span class="ruby-operator">::</span><span class="ruby-constant">NoPluginsError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-constant">UI</span>.<span class="ruby-identifier">error</span>(<span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

