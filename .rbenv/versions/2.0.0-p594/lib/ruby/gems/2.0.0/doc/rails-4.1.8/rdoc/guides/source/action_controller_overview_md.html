<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>action_controller_overview - rails-4.1.8 Documentation</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Action+Controller+Overview">Action Controller Overview</a>
    <li><a href="#label-What+Does+a+Controller+Do%3F">What Does a Controller Do?</a>
    <li><a href="#label-Controller+Naming+Convention">Controller Naming Convention</a>
    <li><a href="#label-Methods+and+Actions">Methods and Actions</a>
    <li><a href="#label-Parameters">Parameters</a>
    <li><a href="#label-Hash+and+Array+Parameters">Hash and Array Parameters</a>
    <li><a href="#label-JSON+parameters">JSON parameters</a>
    <li><a href="#label-Routing+Parameters">Routing Parameters</a>
    <li><a href="#label-default_url_options"><code>default_url_options</code></a>
    <li><a href="#label-Strong+Parameters">Strong Parameters</a>
    <li><a href="#label-Permitted+Scalar+Values">Permitted Scalar Values</a>
    <li><a href="#label-Nested+Parameters">Nested Parameters</a>
    <li><a href="#label-More+Examples">More Examples</a>
    <li><a href="#label-Outside+the+Scope+of+Strong+Parameters">Outside the Scope of Strong Parameters</a>
    <li><a href="#label-Session">Session</a>
    <li><a href="#label-Accessing+the+Session">Accessing the Session</a>
    <li><a href="#label-The+Flash">The Flash</a>
    <li><a href="#label-flash.now"><code>flash.now</code></a>
    <li><a href="#label-Cookies">Cookies</a>
    <li><a href="#label-Rendering+XML+and+JSON+data">Rendering XML and JSON data</a>
    <li><a href="#label-Filters">Filters</a>
    <li><a href="#label-After+Filters+and+Around+Filters">After Filters and Around Filters</a>
    <li><a href="#label-Other+Ways+to+Use+Filters">Other Ways to Use Filters</a>
    <li><a href="#label-Request+Forgery+Protection">Request Forgery Protection</a>
    <li><a href="#label-The+Request+and+Response+Objects">The Request and Response Objects</a>
    <li><a href="#label-The+request+Object">The <code>request</code> Object</a>
    <li><a href="#label-path_parameters%2C+query_parameters%2C+and+request_parameters"><code>path_parameters</code>, <code>query_parameters</code>, and <code>request_parameters</code></a>
    <li><a href="#label-The+response+Object">The <code>response</code> Object</a>
    <li><a href="#label-Setting+Custom+Headers">Setting Custom Headers</a>
    <li><a href="#label-HTTP+Authentications">HTTP Authentications</a>
    <li><a href="#label-HTTP+Basic+Authentication">HTTP Basic Authentication</a>
    <li><a href="#label-HTTP+Digest+Authentication">HTTP Digest Authentication</a>
    <li><a href="#label-Streaming+and+File+Downloads">Streaming and File Downloads</a>
    <li><a href="#label-Sending+Files">Sending Files</a>
    <li><a href="#label-RESTful+Downloads">RESTful Downloads</a>
    <li><a href="#label-Live+Streaming+of+Arbitrary+Data">Live Streaming of Arbitrary Data</a>
    <li><a href="#label-Incorporating+Live+Streaming">Incorporating Live Streaming</a>
    <li><a href="#label-Example+Usage">Example Usage</a>
    <li><a href="#label-Streaming+Considerations">Streaming Considerations</a>
    <li><a href="#label-Log+Filtering">Log Filtering</a>
    <li><a href="#label-Parameters+Filtering">Parameters Filtering</a>
    <li><a href="#label-Redirects+Filtering">Redirects Filtering</a>
    <li><a href="#label-Rescue">Rescue</a>
    <li><a href="#label-The+Default+500+and+404+Templates">The Default 500 and 404 Templates</a>
    <li><a href="#label-rescue_from"><code>rescue_from</code></a>
    <li><a href="#label-Force+HTTPS+protocol">Force HTTPS protocol</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile.html">Gemfile</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../guides/code/getting_started/README_rdoc.html">README</a>
  
    <li><a href="../../guides/code/getting_started/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/comments_js_coffee.html">comments.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/posts_js_coffee.html">posts.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/welcome_js_coffee.html">welcome.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/comments_css_scss.html">comments.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/posts_css_scss.html">posts.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/welcome_css_scss.html">welcome.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/config_ru.html">config.ru</a>
  
    <li><a href="../../guides/code/getting_started/public/404_html.html">404.html</a>
  
    <li><a href="../../guides/code/getting_started/public/422_html.html">422.html</a>
  
    <li><a href="../../guides/code/getting_started/public/500_html.html">500.html</a>
  
    <li><a href="../../guides/code/getting_started/public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../guides/code/getting_started/public/robots_txt.html">robots</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/migrations_md.html">migrations</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/action_controller_overview.md">

<h1 id="label-Action+Controller+Overview">Action Controller Overview<span><a href="#label-Action+Controller+Overview">&para;</a> <a href="#documentation">&uarr;</a></span></h1>

<p>In this guide you will learn how controllers work and how they fit into the
request cycle in your application.</p>

<p>After reading this guide, you will know:</p>
<ul><li>
<p>How to follow the flow of a request through a controller.</p>
</li><li>
<p>How to restrict parameters passed to your controller.</p>
</li><li>
<p>Why and how to store data in the session or cookies.</p>
</li><li>
<p>How to work with filters to execute code during request processing.</p>
</li><li>
<p>How to use Action Controller&#39;s built-in HTTP authentication.</p>
</li><li>
<p>How to stream data directly to the user&#39;s browser.</p>
</li><li>
<p>How to filter sensitive parameters so they do not appear in the
application&#39;s log.</p>
</li><li>
<p>How to deal with exceptions that may be raised during request processing.</p>
</li></ul>
<hr>

<h2 id="label-What+Does+a+Controller+Do%3F">What Does a Controller Do?<span><a href="#label-What+Does+a+Controller+Do%3F">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Action Controller is the C in MVC. After routing has determined which
controller to use for a request, your controller is responsible for making
sense of the request and producing the appropriate output. Luckily, Action
Controller does most of the groundwork for you and uses smart conventions
to make this as straightforward as possible.</p>

<p>For most conventional <a
href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a>
applications, the controller will receive the request (this is invisible to
you as the developer), fetch or save data from a model and use a view to
create HTML output. If your controller needs to do things a little
differently, that&#39;s not a problem, this is just the most common way for
a controller to work.</p>

<p>A controller can thus be thought of as a middle man between models and
views. It makes the model data available to the view so it can display that
data to the user, and it saves or updates data from the user to the model.</p>

<p>NOTE: For more details on the routing process, see <a
href="routing.html">Rails Routing from the Outside In</a>.</p>

<h2 id="label-Controller+Naming+Convention">Controller Naming Convention<span><a href="#label-Controller+Naming+Convention">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>The naming convention of controllers in Rails favors pluralization of the
last word in the controller&#39;s name, although it is not strictly
required (e.g. <code>ApplicationController</code>). For example,
<code>ClientsController</code> is preferable to
<code>ClientController</code>, <code>SiteAdminsController</code> is
preferable to <code>SiteAdminController</code> or
<code>SitesAdminsController</code>, and so on.</p>

<p>Following this convention will allow you to use the default route
generators (e.g. <code>resources</code>, etc) without needing to qualify
each <code>:path</code> or <code>:controller</code>, and keeps URL and path
helpers&#39; usage consistent throughout your application. See <a
href="layouts_and_rendering.html">Layouts & Rendering Guide</a> for more
details.</p>

<p>NOTE: The controller naming convention differs from the naming convention
of models, which expected to be named in singular form.</p>

<h2 id="label-Methods+and+Actions">Methods and Actions<span><a href="#label-Methods+and+Actions">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>A controller is a Ruby class which inherits from
<code>ApplicationController</code> and has methods just like any other
class. When your application receives a request, the routing will determine
which controller and action to run, then Rails creates an instance of that
controller and runs the method with the same name as the action.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>As an example, if a user goes to <code>/clients/new</code> in your
application to add a new client, Rails will create an instance of
<code>ClientsController</code> and run the <code>new</code> method. Note
that the empty method from the example above would work just fine because
Rails will by default render the <code>new.html.erb</code> view unless the
action says otherwise. The <code>new</code> method could make available to
the view a <code>@client</code> instance variable by creating a new
<code>Client</code>:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <a href="layouts_and_rendering.html">Layouts & Rendering Guide</a>
explains this in more detail.</p>

<p><code>ApplicationController</code> inherits from
<code>ActionController::Base</code>, which defines a number of helpful
methods. This guide will cover some of these, but if you&#39;re curious to
see what&#39;s in there, you can see all of them in the API documentation
or in the source itself.</p>

<p>Only public methods are callable as actions. It is a best practice to lower
the visibility of methods which are not intended to be actions, like
auxiliary methods or filters.</p>

<h2 id="label-Parameters">Parameters<span><a href="#label-Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>You will probably want to access data sent in by the user or other
parameters in your controller actions. There are two kinds of parameters
possible in a web application. The first are parameters that are sent as
part of the URL, called query string parameters. The query string is
everything after “?” in the URL. The second type of parameter is usually
referred to as POST data. This information usually comes from an HTML form
which has been filled in by the user. It&#39;s called POST data because it
can only be sent as part of an HTTP POST request. Rails does not make any
distinction between query string parameters and POST parameters, and both
are available in the <code>params</code> hash in your controller:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># This action uses query string parameters because it gets run</span>
  <span class="ruby-comment"># by an HTTP GET request, but this does not make any difference</span>
  <span class="ruby-comment"># to the way in which the parameters are accessed. The URL for</span>
  <span class="ruby-comment"># this action would look like this in order to list activated</span>
  <span class="ruby-comment"># clients: /clients?status=activated</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[:<span class="ruby-identifier">status</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;activated&quot;</span>
      <span class="ruby-ivar">@clients</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">activated</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@clients</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">inactivated</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># This action uses POST parameters. They are most likely coming</span>
  <span class="ruby-comment"># from an HTML form which the user has submitted. The URL for</span>
  <span class="ruby-comment"># this RESTful request will be &quot;/clients&quot;, and the data will be</span>
  <span class="ruby-comment"># sent as part of the request body.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
    <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">client</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@client</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># This line overrides the default rendering behavior, which</span>
      <span class="ruby-comment"># would have been to render the &quot;create&quot; view.</span>
      <span class="ruby-identifier">render</span> <span class="ruby-string">&quot;new&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Hash+and+Array+Parameters">Hash and Array Parameters<span><a href="#label-Hash+and+Array+Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>params</code> hash is not limited to one-dimensional keys and
values. It can contain arrays and (nested) hashes. To send an array of
values, append an empty pair of square brackets “[]” to the key name:</p>

<pre>GET /clients?ids[]=1&amp;ids[]=2&amp;ids[]=3</pre>

<p>NOTE: The actual URL in this example will be encoded as
“/clients?ids%5b%5d=1&amp;ids%5b%5d=2&amp;ids%5b%5d=3” as “[” and “]” are
not allowed in URLs. Most of the time you don&#39;t have to worry about
this because the browser will take care of it for you, and Rails will
decode it back when it receives it, but if you ever find yourself having to
send those requests to the server manually you have to keep this in mind.</p>

<p>The value of <code>params[:ids]</code> will now be <code>[&quot;1&quot;,
&quot;2&quot;, &quot;3&quot;]</code>. Note that parameter values are always
strings; Rails makes no attempt to guess or cast the type.</p>

<p>NOTE: Values such as <code>[]</code>, <code>[nil]</code> or <code>[nil,
nil, ...]</code> in <code>params</code> are replaced with <code>nil</code>
for security reasons by default. See <a
href="security.html#unsafe-query-generation">Security Guide</a> for more
information.</p>

<p>To send a hash you include the key name inside the brackets:</p>

<pre>&lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/clients&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[name]&quot; value=&quot;Acme&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[phone]&quot; value=&quot;12345&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[address][postcode]&quot; value=&quot;12345&quot; /&gt;
  &lt;input type=&quot;text&quot; name=&quot;client[address][city]&quot; value=&quot;Carrot City&quot; /&gt;
&lt;/form&gt;</pre>

<p>When this form is submitted, the value of <code>params[:client]</code> will
be <code>{ &quot;name&quot; =&gt; &quot;Acme&quot;, &quot;phone&quot; =&gt;
&quot;12345&quot;, &quot;address&quot; =&gt; { &quot;postcode&quot; =&gt;
&quot;12345&quot;, &quot;city&quot; =&gt; &quot;Carrot City&quot; }
}</code>. Note the nested hash in <code>params[:client][:address]</code>.</p>

<p>Note that the <code>params</code> hash is actually an instance of
<code>ActiveSupport::HashWithIndifferentAccess</code>, which acts like a
hash but lets you use symbols and strings interchangeably as keys.</p>

<h3 id="label-JSON+parameters">JSON parameters<span><a href="#label-JSON+parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you&#39;re writing a web service application, you might find yourself
more comfortable accepting parameters in JSON format. If the “Content-Type”
header of your request is set to “application/json”, Rails will
automatically convert your parameters into the <code>params</code> hash,
which you can access as you would normally.</p>

<p>So for example, if you are sending this JSON content:</p>

<pre>{ &quot;company&quot;: { &quot;name&quot;: &quot;acme&quot;, &quot;address&quot;: &quot;123 Carrot Street&quot; } }</pre>

<p>You&#39;ll get <code>params[:company]</code> as <code>{ &quot;name&quot;
=&gt; &quot;acme&quot;, &quot;address&quot; =&gt; &quot;123 Carrot
Street&quot; }</code>.</p>

<p>Also, if you&#39;ve turned on <code>config.wrap_parameters</code> in your
initializer or calling <code>wrap_parameters</code> in your controller, you
can safely omit the root element in the JSON parameter. The parameters will
be cloned and wrapped in the key according to your controller&#39;s name by
default. So the above parameter can be written as:</p>

<pre>{ &quot;name&quot;: &quot;acme&quot;, &quot;address&quot;: &quot;123 Carrot Street&quot; }</pre>

<p>And assume that you&#39;re sending the data to
<code>CompaniesController</code>, it would then be wrapped in
<code>:company</code> key like this:</p>

<pre class="ruby">{ <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;acme&quot;</span>, <span class="ruby-identifier">address</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;123 Carrot Street&quot;</span>, <span class="ruby-identifier">company</span><span class="ruby-operator">:</span> { <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;acme&quot;</span>, <span class="ruby-identifier">address</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;123 Carrot Street&quot;</span> } }
</pre>

<p>You can customize the name of the key or specific parameters you want to
wrap by consulting the <a
href="http://api.rubyonrails.org/classes/ActionController/ParamsWrapper.html">API
documentation</a></p>

<p>NOTE: Support for parsing XML parameters has been extracted into a gem
named <code>actionpack-xml_parser</code></p>

<h3 id="label-Routing+Parameters">Routing Parameters<span><a href="#label-Routing+Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>params</code> hash will always contain the
<code>:controller</code> and <code>:action</code> keys, but you should use
the methods <code>controller_name</code> and <code>action_name</code>
instead to access these values. Any other parameters defined by the
routing, such as <code>:id</code> will also be available. As an example,
consider a listing of clients where the list can show either active or
inactive clients. We can add a route which captures the
<code>:status</code> parameter in a “pretty” URL:</p>

<pre class="ruby"><span class="ruby-identifier">get</span> <span class="ruby-string">&#39;/clients/:status&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;clients#index&#39;</span>, <span class="ruby-identifier">foo</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;bar&#39;</span>
</pre>

<p>In this case, when a user opens the URL <code>/clients/active</code>,
<code>params[:status]</code> will be set to “active”. When this route is
used, <code>params[:foo]</code> will also be set to “bar” just like it was
passed in the query string. In the same way <code>params[:action]</code>
will contain “index”.</p>

<h3 id="label-default_url_options"><code>default_url_options</code><span><a href="#label-default_url_options">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can set global default parameters for URL generation by defining a
method called <code>default_url_options</code> in your controller. Such a
method must return a hash with the desired defaults, whose keys must be
symbols:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">default_url_options</span>
    { <span class="ruby-identifier">locale</span><span class="ruby-operator">:</span> <span class="ruby-constant">I18n</span>.<span class="ruby-identifier">locale</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>These options will be used as a starting point when generating URLs, so
it&#39;s possible they&#39;ll be overridden by the options passed in
<code>url_for</code> calls.</p>

<p>If you define <code>default_url_options</code> in
<code>ApplicationController</code>, as in the example above, it would be
used for all URL generation. The method can also be defined in one specific
controller, in which case it only affects URLs generated there.</p>

<h3 id="label-Strong+Parameters">Strong Parameters<span><a href="#label-Strong+Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>With strong parameters, Action Controller parameters are forbidden to be
used in Active Model mass assignments until they have been whitelisted.
This means you&#39;ll have to make a conscious choice about which
attributes to allow for mass updating and thus prevent accidentally
exposing that which shouldn&#39;t be exposed.</p>

<p>In addition, parameters can be marked as required and flow through a
predefined raise/rescue flow to end up as a 400 Bad Request with no effort.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">PeopleController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-comment"># This will raise an ActiveModel::ForbiddenAttributes exception</span>
  <span class="ruby-comment"># because it&#39;s using mass assignment without an explicit permit</span>
  <span class="ruby-comment"># step.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
    <span class="ruby-constant">Person</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">person</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># This will pass with flying colors as long as there&#39;s a person key</span>
  <span class="ruby-comment"># in the parameters, otherwise it&#39;ll raise a</span>
  <span class="ruby-comment"># ActionController::ParameterMissing exception, which will get</span>
  <span class="ruby-comment"># caught by ActionController::Base and turned into that 400 Bad</span>
  <span class="ruby-comment"># Request reply.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
    <span class="ruby-identifier">person</span> = <span class="ruby-identifier">current_account</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])
    <span class="ruby-identifier">person</span>.<span class="ruby-identifier">update!</span>(<span class="ruby-identifier">person_params</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">person</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-comment"># Using a private method to encapsulate the permissible parameters</span>
    <span class="ruby-comment"># is just a good pattern since you&#39;ll be able to reuse the same</span>
    <span class="ruby-comment"># permit list between create and update. Also, you can specialize</span>
    <span class="ruby-comment"># this method with per-user checking of permissible attributes.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">person_params</span>
      <span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">person</span>).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">name</span>, :<span class="ruby-identifier">age</span>)
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-Permitted+Scalar+Values">Permitted Scalar Values<span><a href="#label-Permitted+Scalar+Values">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Given</p>

<pre class="ruby"><span class="ruby-identifier">params</span>.<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">id</span>)
</pre>

<p>the key <code>:id</code> will pass the whitelisting if it appears in
<code>params</code> and it has a permitted scalar value associated.
Otherwise the key is going to be filtered out, so arrays, hashes, or any
other objects cannot be injected.</p>

<p>The permitted scalar types are <code>String</code>, <code>Symbol</code>,
<code>NilClass</code>, <code>Numeric</code>, <code>TrueClass</code>,
<code>FalseClass</code>, <code>Date</code>, <code>Time</code>,
<code>DateTime</code>, <code>StringIO</code>, <code>IO</code>,
<code>ActionDispatch::Http::UploadedFile</code> and
<code>Rack::Test::UploadedFile</code>.</p>

<p>To declare that the value in <code>params</code> must be an array of
permitted scalar values map the key to an empty array:</p>

<pre class="ruby"><span class="ruby-identifier">params</span>.<span class="ruby-identifier">permit</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> [])
</pre>

<p>To whitelist an entire hash of parameters, the <code>permit!</code> method
can be used:</p>

<pre class="ruby"><span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">log_entry</span>).<span class="ruby-identifier">permit!</span>
</pre>

<p>This will mark the <code>:log_entry</code> parameters hash and any subhash
of it permitted. Extreme care should be taken when using
<code>permit!</code> as it will allow all current and future model
attributes to be mass-assigned.</p>

<h4 id="label-Nested+Parameters">Nested Parameters<span><a href="#label-Nested+Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>You can also use permit on nested parameters, like:</p>

<pre class="ruby"><span class="ruby-identifier">params</span>.<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">name</span>, { <span class="ruby-identifier">emails</span><span class="ruby-operator">:</span> [] },
              <span class="ruby-identifier">friends</span><span class="ruby-operator">:</span> [ :<span class="ruby-identifier">name</span>,
                         { <span class="ruby-identifier">family</span><span class="ruby-operator">:</span> [ :<span class="ruby-identifier">name</span> ], <span class="ruby-identifier">hobbies</span><span class="ruby-operator">:</span> [] }])
</pre>

<p>This declaration whitelists the <code>name</code>, <code>emails</code> and
<code>friends</code> attributes. It is expected that <code>emails</code>
will be an array of permitted scalar values and that <code>friends</code>
will be an array of resources with specific attributes : they should have a
<code>name</code> attribute (any permitted scalar values allowed), a
<code>hobbies</code> attribute as an array of permitted scalar values, and
a <code>family</code> attribute which is restricted to having a
<code>name</code> (any permitted scalar values allowed, too).</p>

<h4 id="label-More+Examples">More Examples<span><a href="#label-More+Examples">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>You want to also use the permitted attributes in the <code>new</code>
action. This raises the problem that you can&#39;t use <code>require</code>
on the root key because normally it does not exist when calling
<code>new</code>:</p>

<pre class="ruby"><span class="ruby-comment"># using `fetch` you can supply a default and use</span>
<span class="ruby-comment"># the Strong Parameters API from there.</span>
<span class="ruby-identifier">params</span>.<span class="ruby-identifier">fetch</span>(:<span class="ruby-identifier">blog</span>, {}).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">title</span>, :<span class="ruby-identifier">author</span>)
</pre>

<p><code>accepts_nested_attributes_for</code> allows you to update and destroy
associated records. This is based on the <code>id</code> and
<code>_destroy</code> parameters:</p>

<pre class="ruby"><span class="ruby-comment"># permit :id and :_destroy</span>
<span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">author</span>).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">name</span>, <span class="ruby-identifier">books_attributes</span><span class="ruby-operator">:</span> [:<span class="ruby-identifier">title</span>, :<span class="ruby-identifier">id</span>, :<span class="ruby-identifier">_destroy</span>])
</pre>

<p>Hashes with integer keys are treated differently and you can declare the
attributes as if they were direct children. You get these kinds of
parameters when you use <code>accepts_nested_attributes_for</code> in
combination with a <code>has_many</code> association:</p>

<pre class="ruby"><span class="ruby-comment"># To whitelist the following data:</span>
<span class="ruby-comment"># {&quot;book&quot; =&gt; {&quot;title&quot; =&gt; &quot;Some Book&quot;,</span>
<span class="ruby-comment">#             &quot;chapters_attributes&quot; =&gt; { &quot;1&quot; =&gt; {&quot;title&quot; =&gt; &quot;First Chapter&quot;},</span>
<span class="ruby-comment">#                                        &quot;2&quot; =&gt; {&quot;title&quot; =&gt; &quot;Second Chapter&quot;}}}}</span>

<span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">book</span>).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">title</span>, <span class="ruby-identifier">chapters_attributes</span><span class="ruby-operator">:</span> [:<span class="ruby-identifier">title</span>])
</pre>

<h4 id="label-Outside+the+Scope+of+Strong+Parameters">Outside the Scope of Strong Parameters<span><a href="#label-Outside+the+Scope+of+Strong+Parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>The strong parameter API was designed with the most common use cases in
mind. It is not meant as a silver bullet to handle all your whitelisting
problems. However you can easily mix the API with your own code to adapt to
your situation.</p>

<p>Imagine a scenario where you have parameters representing a product name
and a hash of arbitrary data associated with that product, and you want to
whitelist the product name attribute but also the whole data hash. The
strong parameters API doesn&#39;t let you directly whitelist the whole of a
nested hash with any keys, but you can use the keys of your nested hash to
declare what to whitelist:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">product_params</span>
  <span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">product</span>).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">name</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">params</span>[:<span class="ruby-identifier">product</span>][:<span class="ruby-identifier">data</span>].<span class="ruby-identifier">try</span>(:<span class="ruby-identifier">keys</span>))
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Session">Session<span><a href="#label-Session">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Your application has a session for each user in which you can store small
amounts of data that will be persisted between requests. The session is
only available in the controller and the view and can use one of a number
of different storage mechanisms:</p>
<ul><li>
<p><code>ActionDispatch::Session::CookieStore</code> - Stores everything on
the client.</p>
</li><li>
<p><code>ActionDispatch::Session::CacheStore</code> - Stores the data in the
Rails cache.</p>
</li><li>
<p><code>ActionDispatch::Session::ActiveRecordStore</code> - Stores the data
in a database using Active Record. (require
<code>activerecord-session_store</code> gem).</p>
</li><li>
<p><code>ActionDispatch::Session::MemCacheStore</code> - Stores the data in a
memcached cluster (this is a legacy implementation; consider using
CacheStore instead).</p>
</li></ul>

<p>All session stores use a cookie to store a unique ID for each session (you
must use a cookie, Rails will not allow you to pass the session ID in the
URL as this is less secure).</p>

<p>For most stores, this ID is used to look up the session data on the server,
e.g. in a database table. There is one exception, and that is the default
and recommended session store - the CookieStore - which stores all session
data in the cookie itself (the ID is still available to you if you need
it). This has the advantage of being very lightweight and it requires zero
setup in a new application in order to use the session. The cookie data is
cryptographically signed to make it tamper-proof. And it is also encrypted
so anyone with access to it can&#39;t read its contents. (Rails will not
accept it if it has been edited).</p>

<p>The CookieStore can store around 4kB of data - much less than the others -
but this is usually enough. Storing large amounts of data in the session is
discouraged no matter which session store your application uses. You should
especially avoid storing complex objects (anything other than basic Ruby
objects, the most common example being model instances) in the session, as
the server might not be able to reassemble them between requests, which
will result in an error.</p>

<p>If your user sessions don&#39;t store critical data or don&#39;t need to be
around for long periods (for instance if you just use the flash for
messaging), you can consider using
<code>ActionDispatch::Session::CacheStore</code>. This will store sessions
using the cache implementation you have configured for your application.
The advantage of this is that you can use your existing cache
infrastructure for storing sessions without requiring any additional setup
or administration. The downside, of course, is that the sessions will be
ephemeral and could disappear at any time.</p>

<p>Read more about session storage in the <a href="security.html">Security
Guide</a>.</p>

<p>If you need a different session storage mechanism, you can change it in the
<code>config/initializers/session_store.rb</code> file:</p>

<pre class="ruby"><span class="ruby-comment"># Use the database for sessions instead of the cookie-based default,</span>
<span class="ruby-comment"># which shouldn&#39;t be used to store highly confidential information</span>
<span class="ruby-comment"># (create the session table with &quot;rails g active_record:session_migration&quot;)</span>
<span class="ruby-comment"># Rails.application.config.session_store :active_record_store</span>
</pre>

<p>Rails sets up a session key (the name of the cookie) when signing the
session data. These can also be changed in
<code>config/initializers/session_store.rb</code>:</p>

<pre class="ruby"><span class="ruby-comment"># Be sure to restart your server when you modify this file.</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">session_store</span> :<span class="ruby-identifier">cookie_store</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;_your_app_session&#39;</span>
</pre>

<p>You can also pass a <code>:domain</code> key and specify the domain name
for the cookie:</p>

<pre class="ruby"><span class="ruby-comment"># Be sure to restart your server when you modify this file.</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">session_store</span> :<span class="ruby-identifier">cookie_store</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;_your_app_session&#39;</span>, <span class="ruby-identifier">domain</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;.example.com&quot;</span>
</pre>

<p>Rails sets up (for the CookieStore) a secret key used for signing the
session data. This can be changed in
<code>config/initializers/secret_token.rb</code></p>

<pre class="ruby"><span class="ruby-comment"># Be sure to restart your server when you modify this file.</span>

<span class="ruby-comment"># Your secret key for verifying the integrity of signed cookies.</span>
<span class="ruby-comment"># If you change this key, all old signed cookies will become invalid!</span>
<span class="ruby-comment"># Make sure the secret is at least 30 characters and all random,</span>
<span class="ruby-comment"># no regular words or you&#39;ll be exposed to dictionary attacks.</span>
<span class="ruby-constant">YourApp</span><span class="ruby-operator">::</span><span class="ruby-constant">Application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">secret_key_base</span> = <span class="ruby-string">&#39;49d3f3de9ed86c74b94ad6bd0...&#39;</span>
</pre>

<p>NOTE: Changing the secret when using the <code>CookieStore</code> will
invalidate all existing sessions.</p>

<h3 id="label-Accessing+the+Session">Accessing the Session<span><a href="#label-Accessing+the+Session">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>In your controller you can access the session through the
<code>session</code> instance method.</p>

<p>NOTE: Sessions are lazily loaded. If you don&#39;t access sessions in your
action&#39;s code, they will not be loaded. Hence you will never need to
disable sessions, just not accessing them will do the job.</p>

<p>Session values are stored using key/value pairs like a hash:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-comment"># Finds the User with the ID stored in the session with the key</span>
  <span class="ruby-comment"># :current_user_id This is a common way to handle user login in</span>
  <span class="ruby-comment"># a Rails application; logging in sets the session value and</span>
  <span class="ruby-comment"># logging out removes it.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">current_user</span>
    <span class="ruby-ivar">@_current_user</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">session</span>[:<span class="ruby-identifier">current_user_id</span>] <span class="ruby-operator">&amp;&amp;</span>
      <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">session</span>[:<span class="ruby-identifier">current_user_id</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To store something in the session, just assign it to the key like a hash:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LoginsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># &quot;Create&quot; a login, aka &quot;log the user in&quot;</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">authenticate</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">username</span>], <span class="ruby-identifier">params</span>[:<span class="ruby-identifier">password</span>])
      <span class="ruby-comment"># Save the user ID in the session so it can be used in</span>
      <span class="ruby-comment"># subsequent requests</span>
      <span class="ruby-identifier">session</span>[:<span class="ruby-identifier">current_user_id</span>] = <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To remove something from the session, assign that key to be
<code>nil</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LoginsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># &quot;Delete&quot; a login, aka &quot;log the user out&quot;</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
    <span class="ruby-comment"># Remove the user id from the session</span>
    <span class="ruby-ivar">@_current_user</span> = <span class="ruby-identifier">session</span>[:<span class="ruby-identifier">current_user_id</span>] = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To reset the entire session, use <code>reset_session</code>.</p>

<h3 id="label-The+Flash">The Flash<span><a href="#label-The+Flash">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The flash is a special part of the session which is cleared with each
request. This means that values stored there will only be available in the
next request, which is useful for passing error messages etc.</p>

<p>It is accessed in much the same way as the session, as a hash (it&#39;s a
<a
href="http://api.rubyonrails.org/classes/ActionDispatch/Flash/FlashHash.html">FlashHash</a>
instance).</p>

<p>Let&#39;s use the act of logging out as an example. The controller can send
a message which will be displayed to the user on the next request:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LoginsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
    <span class="ruby-identifier">session</span>[:<span class="ruby-identifier">current_user_id</span>] = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">notice</span>] = <span class="ruby-string">&quot;You have successfully logged out.&quot;</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that it is also possible to assign a flash message as part of the
redirection. You can assign <code>:notice</code>, <code>:alert</code> or
the general purpose <code>:flash</code>:</p>

<pre class="ruby"><span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>, <span class="ruby-identifier">notice</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;You have successfully logged out.&quot;</span>
<span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>, <span class="ruby-identifier">alert</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;You&#39;re stuck here!&quot;</span>
<span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_url</span>, <span class="ruby-identifier">flash</span><span class="ruby-operator">:</span> { <span class="ruby-identifier">referral_code</span><span class="ruby-operator">:</span> <span class="ruby-value">1234</span> }
</pre>

<p>The <code>destroy</code> action redirects to the application&#39;s
<code>root_url</code>, where the message will be displayed. Note that
it&#39;s entirely up to the next action to decide what, if anything, it
will do with what the previous action put in the flash. It&#39;s
conventional to display any error alerts or notices from the flash in the
application&#39;s layout:</p>

<pre>&lt;html&gt;
  &lt;!-- &lt;head/&gt; --&gt;
  &lt;body&gt;
    &lt;% flash.each do |name, msg| -%&gt;
      &lt;%= content_tag :div, msg, class: name %&gt;
    &lt;% end -%&gt;

    &lt;!-- more content --&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>

<p>This way, if an action sets a notice or an alert message, the layout will
display it automatically.</p>

<p>You can pass anything that the session can store; you&#39;re not limited to
notices and alerts:</p>

<pre>&lt;% if flash[:just_signed_up] %&gt;
  &lt;p class=&quot;welcome&quot;&gt;Welcome to our site!&lt;/p&gt;
&lt;% end %&gt;</pre>

<p>If you want a flash value to be carried over to another request, use the
<code>keep</code> method:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MainController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># Let&#39;s say this action corresponds to root_url, but you want</span>
  <span class="ruby-comment"># all requests here to be redirected to UsersController#index.</span>
  <span class="ruby-comment"># If an action sets the flash and redirects here, the values</span>
  <span class="ruby-comment"># would normally be lost when another redirect happens, but you</span>
  <span class="ruby-comment"># can use &#39;keep&#39; to make it persist for another request.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
    <span class="ruby-comment"># Will persist all flash values.</span>
    <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">keep</span>

    <span class="ruby-comment"># You can also use a key to keep only some kind of value.</span>
    <span class="ruby-comment"># flash.keep(:notice)</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">users_url</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-flash.now"><code>flash.now</code><span><a href="#label-flash.now">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>By default, adding values to the flash will make them available to the next
request, but sometimes you may want to access those values in the same
request. For example, if the <code>create</code> action fails to save a
resource and you render the <code>new</code> template directly, that&#39;s
not going to result in a new request, but you may still want to display a
message using the flash. To do this, you can use <code>flash.now</code> in
the same way you use the normal <code>flash</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
    <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">client</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@client</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-comment"># ...</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[:<span class="ruby-identifier">error</span>] = <span class="ruby-string">&quot;Could not save client&quot;</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;new&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Cookies">Cookies<span><a href="#label-Cookies">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Your application can store small amounts of data on the client - called
cookies - that will be persisted across requests and even sessions. Rails
provides easy access to cookies via the <code>cookies</code> method, which
- much like the <code>session</code> - works like a hash:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CommentsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new</span>
    <span class="ruby-comment"># Auto-fill the commenter&#39;s name if it has been stored in a cookie</span>
    <span class="ruby-ivar">@comment</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">author</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cookies</span>[:<span class="ruby-identifier">commenter_name</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
    <span class="ruby-ivar">@comment</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">comment</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@comment</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">notice</span>] = <span class="ruby-string">&quot;Thanks for your comment!&quot;</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[:<span class="ruby-identifier">remember_name</span>]
        <span class="ruby-comment"># Remember the commenter&#39;s name.</span>
        <span class="ruby-identifier">cookies</span>[:<span class="ruby-identifier">commenter_name</span>] = <span class="ruby-ivar">@comment</span>.<span class="ruby-identifier">author</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-comment"># Delete cookie for the commenter&#39;s name cookie, if any.</span>
        <span class="ruby-identifier">cookies</span>.<span class="ruby-identifier">delete</span>(:<span class="ruby-identifier">commenter_name</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@comment</span>.<span class="ruby-identifier">article</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;new&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that while for session values you set the key to <code>nil</code>, to
delete a cookie value you should use <code>cookies.delete(:key)</code>.</p>

<p>Rails also provides a signed cookie jar and an encrypted cookie jar for
storing sensitive data. The signed cookie jar appends a cryptographic
signature on the cookie values to protect their integrity. The encrypted
cookie jar encrypts the values in addition to signing them, so that they
cannot be read by the end user. Refer to the <a
href="http://api.rubyonrails.org/classes/ActionDispatch/Cookies.html">API
documentation</a> for more details.</p>

<p>These special cookie jars use a serializer to serialize the assigned values
into strings and deserializes them into Ruby objects on read.</p>

<p>You can specify what serializer to use:</p>

<pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">action_dispatch</span>.<span class="ruby-identifier">cookies_serializer</span> = :<span class="ruby-identifier">json</span>
</pre>

<p>The default serializer for new applications is <code>:json</code>. For
compatibility with old applications with existing cookies,
<code>:marshal</code> is used when <code>serializer</code> option is not
specified.</p>

<p>You may also set this option to <code>:hybrid</code>, in which case Rails
would transparently deserialize existing (<code>Marshal</code>-serialized)
cookies on read and re-write them in the <code>JSON</code> format. This is
useful for migrating existing applications to the <code>:json</code>
serializer.</p>

<p>It is also possible to pass a custom serializer that responds to
<code>load</code> and <code>dump</code>:</p>

<pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">action_dispatch</span>.<span class="ruby-identifier">cookies_serializer</span> = <span class="ruby-constant">MyCustomSerializer</span>
</pre>

<p>When using the <code>:json</code> or <code>:hybrid</code> serializer, you
should beware that not all Ruby objects can be serialized as JSON. For
example, <code>Date</code> and <code>Time</code> objects will be serialized
as strings, and <code>Hash</code>es will have their keys stringified.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CookiesController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">set_cookie</span>
    <span class="ruby-identifier">cookies</span>.<span class="ruby-identifier">encrypted</span>[:<span class="ruby-identifier">expiration_date</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">tomorrow</span> <span class="ruby-comment"># =&gt; Thu, 20 Mar 2014</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;read_cookie&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">read_cookie</span>
    <span class="ruby-identifier">cookies</span>.<span class="ruby-identifier">encrypted</span>[:<span class="ruby-identifier">expiration_date</span>] <span class="ruby-comment"># =&gt; &quot;2014-03-20&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>It&#39;s advisable that you only store simple data (strings and numbers) in
cookies. If you have to store complex objects, you would need to handle the
conversion manually when reading the values on subsequent requests.</p>

<p>If you use the cookie session store, this would apply to the
<code>session</code> and <code>flash</code> hash as well.</p>

<h2 id="label-Rendering+XML+and+JSON+data">Rendering XML and JSON data<span><a href="#label-Rendering+XML+and+JSON+data">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>ActionController makes it extremely easy to render <code>XML</code> or
<code>JSON</code> data. If you&#39;ve generated a controller using
scaffolding, it would look something like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">UsersController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
    <span class="ruby-ivar">@users</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">all</span>
    <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment"># index.html.erb</span>
      <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">xml</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@users</span>}
      <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@users</span>}
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You may notice in the above code that we&#39;re using <code>render xml:
@users</code>, not <code>render xml: @users.to_xml</code>. If the object is
not a String, then Rails will automatically invoke <code>to_xml</code> for
us.</p>

<h2 id="label-Filters">Filters<span><a href="#label-Filters">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Filters are methods that are run before, after or “around” a controller
action.</p>

<p>Filters are inherited, so if you set a filter on
<code>ApplicationController</code>, it will be run on every controller in
your application.</p>

<p>“Before” filters may halt the request cycle. A common “before” filter is
one which requires that a user is logged in for an action to be run. You
can define the filter method this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">before_action</span> :<span class="ruby-identifier">require_login</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">require_login</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">logged_in?</span>
      <span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">error</span>] = <span class="ruby-string">&quot;You must be logged in to access this section&quot;</span>
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">new_login_url</span> <span class="ruby-comment"># halts request cycle</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The method simply stores an error message in the flash and redirects to the
login form if the user is not logged in. If a “before” filter renders or
redirects, the action will not run. If there are additional filters
scheduled to run after that filter, they are also cancelled.</p>

<p>In this example the filter is added to <code>ApplicationController</code>
and thus all controllers in the application inherit it. This will make
everything in the application require the user to be logged in in order to
use it. For obvious reasons (the user wouldn&#39;t be able to log in in the
first place!), not all controllers or actions should require this. You can
prevent this filter from running before particular actions with
<code>skip_before_action</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LoginsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-identifier">skip_before_action</span> :<span class="ruby-identifier">require_login</span>, <span class="ruby-identifier">only</span><span class="ruby-operator">:</span> [:<span class="ruby-identifier">new</span>, :<span class="ruby-identifier">create</span>]
<span class="ruby-keyword">end</span>
</pre>

<p>Now, the <code>LoginsController</code>&#39;s <code>new</code> and
<code>create</code> actions will work as before without requiring the user
to be logged in. The <code>:only</code> option is used to only skip this
filter for these actions, and there is also an <code>:except</code> option
which works the other way. These options can be used when adding filters
too, so you can add a filter which only runs for selected actions in the
first place.</p>

<h3 id="label-After+Filters+and+Around+Filters">After Filters and Around Filters<span><a href="#label-After+Filters+and+Around+Filters">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>In addition to “before” filters, you can also run filters after an action
has been executed, or both before and after.</p>

<p>“After” filters are similar to “before” filters, but because the action has
already been run they have access to the response data that&#39;s about to
be sent to the client. Obviously, “after” filters cannot stop the action
from running.</p>

<p>“Around” filters are responsible for running their associated actions by
yielding, similar to how Rack middlewares work.</p>

<p>For example, in a website where changes have an approval workflow an
administrator could be able to preview them easily, just apply them within
a transaction:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ChangesController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-identifier">around_action</span> :<span class="ruby-identifier">wrap_in_transaction</span>, <span class="ruby-identifier">only</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">show</span>

  <span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">wrap_in_transaction</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-keyword">yield</span>
      <span class="ruby-keyword">ensure</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that an “around” filter also wraps rendering. In particular, if in the
example above, the view itself reads from the database (e.g. via a scope),
it will do so within the transaction and thus present the data to preview.</p>

<p>You can choose not to yield and build the response yourself, in which case
the action will not be run.</p>

<h3 id="label-Other+Ways+to+Use+Filters">Other Ways to Use Filters<span><a href="#label-Other+Ways+to+Use+Filters">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>While the most common way to use filters is by creating private methods and
using *_action to add them, there are two other ways to do the same thing.</p>

<p>The first is to use a block directly with the *_action methods. The block
receives the controller as an argument, and the <code>require_login</code>
filter from above could be rewritten to use a block:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">before_action</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">controller</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">send</span>(:<span class="ruby-identifier">logged_in?</span>)
      <span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">error</span>] = <span class="ruby-string">&quot;You must be logged in to access this section&quot;</span>
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">new_login_url</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note that the filter in this case uses <code>send</code> because the
<code>logged_in?</code> method is private and the filter is not run in the
scope of the controller. This is not the recommended way to implement this
particular filter, but in more simple cases it might be useful.</p>

<p>The second way is to use a class (actually, any object that responds to the
right methods will do) to handle the filtering. This is useful in cases
that are more complex and cannot be implemented in a readable and reusable
way using the two other methods. As an example, you could rewrite the login
filter again to use a class:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">before_action</span> <span class="ruby-constant">LoginFilter</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">LoginFilter</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">before</span>(<span class="ruby-identifier">controller</span>)
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">send</span>(:<span class="ruby-identifier">logged_in?</span>)
      <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">error</span>] = <span class="ruby-string">&quot;You must be logged in to access this section&quot;</span>
      <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">controller</span>.<span class="ruby-identifier">new_login_url</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Again, this is not an ideal example for this filter, because it&#39;s not
run in the scope of the controller but gets the controller passed as an
argument. The filter class must implement a method with the same name as
the filter, so for the <code>before_action</code> filter the class must
implement a <code>before</code> method, and so on. The <code>around</code>
method must <code>yield</code> to execute the action.</p>

<h2 id="label-Request+Forgery+Protection">Request Forgery Protection<span><a href="#label-Request+Forgery+Protection">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Cross-site request forgery is a type of attack in which a site tricks a
user into making requests on another site, possibly adding, modifying or
deleting data on that site without the user&#39;s knowledge or permission.</p>

<p>The first step to avoid this is to make sure all “destructive” actions
(create, update and destroy) can only be accessed with non-GET requests. If
you&#39;re following RESTful conventions you&#39;re already doing this.
However, a malicious site can still send a non-GET request to your site
quite easily, and that&#39;s where the request forgery protection comes in.
As the name says, it protects from forged requests.</p>

<p>The way this is done is to add a non-guessable token which is only known to
your server to each request. This way, if a request comes in without the
proper token, it will be denied access.</p>

<p>If you generate a form like this:</p>

<pre>&lt;%= form_for @user do |f| %&gt;
  &lt;%= f.text_field :username %&gt;
  &lt;%= f.text_field :password %&gt;
&lt;% end %&gt;</pre>

<p>You will see how the token gets added as a hidden field:</p>

<pre>&lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/users/1&quot; method=&quot;post&quot;&gt;
&lt;input type=&quot;hidden&quot;
       value=&quot;67250ab105eb5ad10851c00a5621854a23af5489&quot;
       name=&quot;authenticity_token&quot;/&gt;
&lt;!-- fields --&gt;
&lt;/form&gt;</pre>

<p>Rails adds this token to every form that&#39;s generated using the <a
href="form_helpers.html">form helpers</a>, so most of the time you
don&#39;t have to worry about it. If you&#39;re writing a form manually or
need to add the token for another reason, it&#39;s available through the
method <code>form_authenticity_token</code>:</p>

<p>The <code>form_authenticity_token</code> generates a valid authentication
token. That&#39;s useful in places where Rails does not add it
automatically, like in custom Ajax calls.</p>

<p>The <a href="security.html">Security Guide</a> has more about this and a
lot of other security-related issues that you should be aware of when
developing a web application.</p>

<h2 id="label-The+Request+and+Response+Objects">The Request and Response Objects<span><a href="#label-The+Request+and+Response+Objects">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>In every controller there are two accessor methods pointing to the request
and the response objects associated with the request cycle that is
currently in execution. The <code>request</code> method contains an
instance of <code>AbstractRequest</code> and the <code>response</code>
method returns a response object representing what is going to be sent back
to the client.</p>

<h3 id="label-The+request+Object">The <code>request</code> <a href="../../Object.html">Object</a><span><a href="#label-The+request+Object">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The request object contains a lot of useful information about the request
coming in from the client. To get a full list of the available methods,
refer to the <a
href="http://api.rubyonrails.org/classes/ActionDispatch/Request.html">API
documentation</a>. Among the properties that you can access on this object
are:</p>

<p>| Property of <code>request</code> | Purpose | | —————————————– |
——————————————————————————– | | host | The hostname used for this request.
| | domain(n=2) | The hostname&#39;s first <code>n</code> segments,
starting from the right (the TLD). | | format | The content type requested
by the client. | | method | The HTTP method used for the request. | | get?,
post?, patch?, put?, delete?, head? | Returns true if the HTTP method is
GET/POST/PATCH/PUT/DELETE/HEAD. | | headers | Returns a hash containing the
headers associated with the request. | | port | The port number (integer)
used for the request. | | protocol | Returns a string containing the
protocol used plus “://”, for example “http://”. | | query_string | The
query string part of the URL, i.e., everything after “?”. | | remote_ip |
The IP address of the client. | | url | The entire URL used for the
request. |</p>

<h4 id="label-path_parameters%2C+query_parameters%2C+and+request_parameters"><code>path_parameters</code>, <code>query_parameters</code>, and <code>request_parameters</code><span><a href="#label-path_parameters%2C+query_parameters%2C+and+request_parameters">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Rails collects all of the parameters sent along with the request in the
<code>params</code> hash, whether they are sent as part of the query string
or the post body. The request object has three accessors that give you
access to these parameters depending on where they came from. The
<code>query_parameters</code> hash contains parameters that were sent as
part of the query string while the <code>request_parameters</code> hash
contains parameters sent as part of the post body. The
<code>path_parameters</code> hash contains parameters that were recognized
by the routing as being part of the path leading to this particular
controller and action.</p>

<h3 id="label-The+response+Object">The <code>response</code> <a href="../../Object.html">Object</a><span><a href="#label-The+response+Object">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The response object is not usually used directly, but is built up during
the execution of the action and rendering of the data that is being sent
back to the user, but sometimes - like in an after filter - it can be
useful to access the response directly. Some of these accessor methods also
have setters, allowing you to change their values.</p>

<p>| Property of <code>response</code> | Purpose | | ———————- |
————————————————————————————————— | | body | This is the string of data
being sent back to the client. This is most often HTML. | | status | The
HTTP status code for the response, like 200 for a successful request or 404
for file not found. | | location | The URL the client is being redirected
to, if any. | | content_type | The content type of the response. | |
charset | The character set being used for the response. Default is
“utf-8”. | | headers | Headers used for the response. |</p>

<h4 id="label-Setting+Custom+Headers">Setting Custom Headers<span><a href="#label-Setting+Custom+Headers">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>If you want to set custom headers for a response then
<code>response.headers</code> is the place to do it. The headers attribute
is a hash which maps header names to their values, and Rails will set some
of them automatically. If you want to add or change a header, just assign
it to <code>response.headers</code> this way:</p>

<pre class="ruby"><span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&quot;Content-Type&quot;</span>] = <span class="ruby-string">&quot;application/pdf&quot;</span>
</pre>

<p>Note: in the above case it would make more sense to use the
<code>content_type</code> setter directly.</p>

<h2 id="label-HTTP+Authentications">HTTP Authentications<span><a href="#label-HTTP+Authentications">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Rails comes with two built-in HTTP authentication mechanisms:</p>
<ul><li>
<p>Basic Authentication</p>
</li><li>
<p>Digest Authentication</p>
</li></ul>

<h3 id="label-HTTP+Basic+Authentication">HTTP Basic Authentication<span><a href="#label-HTTP+Basic+Authentication">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>HTTP basic authentication is an authentication scheme that is supported by
the majority of browsers and other HTTP clients. As an example, consider an
administration section which will only be available by entering a username
and a password into the browser&#39;s HTTP basic dialog window. Using the
built-in authentication is quite easy and only requires you to use one
method, <code>http_basic_authenticate_with</code>.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AdminsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-identifier">http_basic_authenticate_with</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;humbaba&quot;</span>, <span class="ruby-identifier">password</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;5baa61e4&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With this in place, you can create namespaced controllers that inherit from
<code>AdminsController</code>. The filter will thus be run for all actions
in those controllers, protecting them with HTTP basic authentication.</p>

<h3 id="label-HTTP+Digest+Authentication">HTTP Digest Authentication<span><a href="#label-HTTP+Digest+Authentication">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>HTTP digest authentication is superior to the basic authentication as it
does not require the client to send an unencrypted password over the
network (though HTTP basic authentication is safe over HTTPS). Using digest
authentication with Rails is quite easy and only requires using one method,
<code>authenticate_or_request_with_http_digest</code>.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AdminsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-constant">USERS</span> = { <span class="ruby-string">&quot;lifo&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;world&quot;</span> }

  <span class="ruby-identifier">before_action</span> :<span class="ruby-identifier">authenticate</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">authenticate</span>
      <span class="ruby-identifier">authenticate_or_request_with_http_digest</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">username</span><span class="ruby-operator">|</span>
        <span class="ruby-constant">USERS</span>[<span class="ruby-identifier">username</span>]
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>As seen in the example above, the
<code>authenticate_or_request_with_http_digest</code> block takes only one
argument - the username. And the block returns the password. Returning
<code>false</code> or <code>nil</code> from the
<code>authenticate_or_request_with_http_digest</code> will cause
authentication failure.</p>

<h2 id="label-Streaming+and+File+Downloads">Streaming and File Downloads<span><a href="#label-Streaming+and+File+Downloads">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Sometimes you may want to send a file to the user instead of rendering an
HTML page. All controllers in Rails have the <code>send_data</code> and the
<code>send_file</code> methods, which will both stream data to the client.
<code>send_file</code> is a convenience method that lets you provide the
name of a file on the disk and it will stream the contents of that file for
you.</p>

<p>To stream data to the client, use <code>send_data</code>:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;prawn&quot;</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># Generates a PDF document with information on the client and</span>
  <span class="ruby-comment"># returns it. The user will get the PDF as a file download.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">download_pdf</span>
    <span class="ruby-identifier">client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])
    <span class="ruby-identifier">send_data</span> <span class="ruby-identifier">generate_pdf</span>(<span class="ruby-identifier">client</span>),
              <span class="ruby-identifier">filename</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;#{client.name}.pdf&quot;</span>,
              <span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;application/pdf&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_pdf</span>(<span class="ruby-identifier">client</span>)
      <span class="ruby-constant">Prawn</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">text</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">align</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">center</span>
        <span class="ruby-identifier">text</span> <span class="ruby-node">&quot;Address: #{client.address}&quot;</span>
        <span class="ruby-identifier">text</span> <span class="ruby-node">&quot;Email: #{client.email}&quot;</span>
      <span class="ruby-keyword">end</span>.<span class="ruby-identifier">render</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>download_pdf</code> action in the example above will call a
private method which actually generates the PDF document and returns it as
a string. This string will then be streamed to the client as a file
download and a filename will be suggested to the user. Sometimes when
streaming files to the user, you may not want them to download the file.
Take images, for example, which can be embedded into HTML pages. To tell
the browser a file is not meant to be downloaded, you can set the
<code>:disposition</code> option to “inline”. The opposite and default
value for this option is “attachment”.</p>

<h3 id="label-Sending+Files">Sending Files<span><a href="#label-Sending+Files">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you want to send a file that already exists on disk, use the
<code>send_file</code> method.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># Stream a file that has already been generated and stored on disk.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">download_pdf</span>
    <span class="ruby-identifier">client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])
    <span class="ruby-identifier">send_file</span>(<span class="ruby-node">&quot;#{Rails.root}/files/clients/#{client.id}.pdf&quot;</span>,
              <span class="ruby-identifier">filename</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;#{client.name}.pdf&quot;</span>,
              <span class="ruby-identifier">type</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;application/pdf&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This will read and stream the file 4kB at the time, avoiding loading the
entire file into memory at once. You can turn off streaming with the
<code>:stream</code> option or adjust the block size with the
<code>:buffer_size</code> option.</p>

<p>If <code>:type</code> is not specified, it will be guessed from the file
extension specified in <code>:filename</code>. If the content type is not
registered for the extension, <code>application/octet-stream</code> will be
used.</p>

<p>WARNING: Be careful when using data coming from the client (params,
cookies, etc.) to locate the file on disk, as this is a security risk that
might allow someone to gain access to files they are not meant to.</p>

<p>TIP: It is not recommended that you stream static files through Rails if
you can instead keep them in a public folder on your web server. It is much
more efficient to let the user download the file directly using Apache or
another web server, keeping the request from unnecessarily going through
the whole Rails stack.</p>

<h3 id="label-RESTful+Downloads">RESTful Downloads<span><a href="#label-RESTful+Downloads">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>While <code>send_data</code> works just fine, if you are creating a RESTful
application having separate actions for file downloads is usually not
necessary. In REST terminology, the PDF file from the example above can be
considered just another representation of the client resource. Rails
provides an easy and quite sleek way of doing “RESTful downloads”.
Here&#39;s how you can rewrite the example so that the PDF download is a
part of the <code>show</code> action, without any streaming:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># The user can request to receive this resource as HTML or PDF.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
    <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])

    <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
      <span class="ruby-identifier">format</span>.<span class="ruby-identifier">pdf</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">pdf</span><span class="ruby-operator">:</span> <span class="ruby-identifier">generate_pdf</span>(<span class="ruby-ivar">@client</span>) }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>In order for this example to work, you have to add the PDF MIME type to
Rails. This can be done by adding the following line to the file
<code>config/initializers/mime_types.rb</code>:</p>

<pre class="ruby"><span class="ruby-constant">Mime</span><span class="ruby-operator">::</span><span class="ruby-constant">Type</span>.<span class="ruby-identifier">register</span> <span class="ruby-string">&quot;application/pdf&quot;</span>, :<span class="ruby-identifier">pdf</span>
</pre>

<p>NOTE: Configuration files are not reloaded on each request, so you have to
restart the server in order for their changes to take effect.</p>

<p>Now the user can request to get a PDF version of a client just by adding
“.pdf” to the URL:</p>

<pre>GET /clients/1.pdf</pre>

<h3 id="label-Live+Streaming+of+Arbitrary+Data">Live Streaming of Arbitrary Data<span><a href="#label-Live+Streaming+of+Arbitrary+Data">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails allows you to stream more than just files. In fact, you can stream
anything you would like in a response object. The
<code>ActionController::Live</code> module allows you to create a
persistent connection with a browser. Using this module, you will be able
to send arbitrary data to the browser at specific points in time.</p>

<h4 id="label-Incorporating+Live+Streaming">Incorporating Live Streaming<span><a href="#label-Incorporating+Live+Streaming">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Including <code>ActionController::Live</code> inside of your controller
class will provide all actions inside of the controller the ability to
stream data. You can mix in the module like so:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Live</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">stream</span>
    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&#39;Content-Type&#39;</span>] = <span class="ruby-string">&#39;text/event-stream&#39;</span>
    <span class="ruby-value">100</span>.<span class="ruby-identifier">times</span> {
      <span class="ruby-identifier">response</span>.<span class="ruby-identifier">stream</span>.<span class="ruby-identifier">write</span> <span class="ruby-string">&quot;hello world\n&quot;</span>
      <span class="ruby-identifier">sleep</span> <span class="ruby-value">1</span>
    }
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">stream</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The above code will keep a persistent connection with the browser and send
100 messages of <code>&quot;hello world\n&quot;</code>, each one second
apart.</p>

<p>There are a couple of things to notice in the above example. We need to
make sure to close the response stream. Forgetting to close the stream will
leave the socket open forever. We also have to set the content type to
<code>text/event-stream</code> before we write to the response stream. This
is because headers cannot be written after the response has been committed
(when <code>response.committed</code> returns a truthy value), which occurs
when you <code>write</code> or <code>commit</code> the response stream.</p>

<h4 id="label-Example+Usage">Example Usage<span><a href="#label-Example+Usage">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Let&#39;s suppose that you were making a Karaoke machine and a user wants
to get the lyrics for a particular song. Each <code>Song</code> has a
particular number of lines and each line takes time <code>num_beats</code>
to finish singing.</p>

<p>If we wanted to return the lyrics in Karaoke fashion (only sending the line
when the singer has finished the previous line), then we could use
<code>ActionController::Live</code> as follows:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LyricsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Live</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-string">&#39;Content-Type&#39;</span>] = <span class="ruby-string">&#39;text/event-stream&#39;</span>
    <span class="ruby-identifier">song</span> = <span class="ruby-constant">Song</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])

    <span class="ruby-identifier">song</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">response</span>.<span class="ruby-identifier">stream</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">lyrics</span>
      <span class="ruby-identifier">sleep</span> <span class="ruby-identifier">line</span>.<span class="ruby-identifier">num_beats</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">stream</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The above code sends the next line only after the singer has completed the
previous line.</p>

<h4 id="label-Streaming+Considerations">Streaming Considerations<span><a href="#label-Streaming+Considerations">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Streaming arbitrary data is an extremely powerful tool. As shown in the
previous examples, you can choose when and what to send across a response
stream. However, you should also note the following things:</p>
<ul><li>
<p>Each response stream creates a new thread and copies over the thread local 
variables from the original thread. Having too many thread local variables
can  negatively impact performance. Similarly, a large number of threads
can also  hinder performance.</p>
</li><li>
<p>Failing to close the response stream will leave the corresponding socket
open  forever. Make sure to call <code>close</code> whenever you are using
a response stream.</p>
</li><li>
<p>WEBrick servers buffer all responses, and so including
<code>ActionController::Live</code>  will not work. You must use a web
server which does not automatically buffer  responses.</p>
</li></ul>

<h2 id="label-Log+Filtering">Log Filtering<span><a href="#label-Log+Filtering">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Rails keeps a log file for each environment in the <code>log</code> folder.
These are extremely useful when debugging what&#39;s actually going on in
your application, but in a live application you may not want every bit of
information to be stored in the log file.</p>

<h3 id="label-Parameters+Filtering">Parameters Filtering<span><a href="#label-Parameters+Filtering">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can filter certain request parameters from your log files by appending
them to <code>config.filter_parameters</code> in the application
configuration. These parameters will be marked [FILTERED] in the log.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">filter_parameters</span> <span class="ruby-operator">&lt;&lt;</span> :<span class="ruby-identifier">password</span>
</pre>

<h3 id="label-Redirects+Filtering">Redirects Filtering<span><a href="#label-Redirects+Filtering">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Sometimes it&#39;s desirable to filter out from log files some sensible
locations your application is redirecting to. You can do that by using the
<code>config.filter_redirect</code> configuration option:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">filter_redirect</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&#39;s3.amazonaws.com&#39;</span>
</pre>

<p>You can set it to a String, a Regexp, or an array of both.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">filter_redirect</span>.<span class="ruby-identifier">concat</span> [<span class="ruby-string">&#39;s3.amazonaws.com&#39;</span>, <span class="ruby-regexp">/private_path/</span>]
</pre>

<p>Matching URLs will be marked as &#39;[FILTERED]&#39;.</p>

<h2 id="label-Rescue">Rescue<span><a href="#label-Rescue">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Most likely your application is going to contain bugs or otherwise throw an
exception that needs to be handled. For example, if the user follows a link
to a resource that no longer exists in the database, Active Record will
throw the <code>ActiveRecord::RecordNotFound</code> exception.</p>

<p>Rails&#39; default exception handling displays a “500 Server Error” message
for all exceptions. If the request was made locally, a nice traceback and
some added information gets displayed so you can figure out what went wrong
and deal with it. If the request was remote Rails will just display a
simple “500 Server Error” message to the user, or a “404 Not Found” if
there was a routing error or a record could not be found. Sometimes you
might want to customize how these errors are caught and how they&#39;re
displayed to the user. There are several levels of exception handling
available in a Rails application:</p>

<h3 id="label-The+Default+500+and+404+Templates">The Default 500 and 404 Templates<span><a href="#label-The+Default+500+and+404+Templates">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>By default a production application will render either a 404 or a 500 error
message. These messages are contained in static HTML files in the
<code>public</code> folder, in <code>404.html</code> and
<code>500.html</code> respectively. You can customize these files to add
some extra information and layout, but remember that they are static; i.e.
you can&#39;t use RHTML or layouts in them, just plain HTML.</p>

<h3 id="label-rescue_from"><code>rescue_from</code><span><a href="#label-rescue_from">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you want to do something a bit more elaborate when catching errors, you
can use <code>rescue_from</code>, which handles exceptions of a certain
type (or multiple types) in an entire controller and its subclasses.</p>

<p>When an exception occurs which is caught by a <code>rescue_from</code>
directive, the exception object is passed to the handler. The handler can
be a method or a <code>Proc</code> object passed to the <code>:with</code>
option. You can also use a block directly instead of an explicit
<code>Proc</code> object.</p>

<p>Here&#39;s how you can use <code>rescue_from</code> to intercept all
<code>ActiveRecord::RecordNotFound</code> errors and do something with
them.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">rescue_from</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>, <span class="ruby-identifier">with</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">record_not_found</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">record_not_found</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">plain</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;404 Not Found&quot;</span>, <span class="ruby-identifier">status</span><span class="ruby-operator">:</span> <span class="ruby-value">404</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Of course, this example is anything but elaborate and doesn&#39;t improve
on the default exception handling at all, but once you can catch all those
exceptions you&#39;re free to do whatever you want with them. For example,
you could create custom exception classes that will be thrown when a user
doesn&#39;t have access to a certain section of your application:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">rescue_from</span> <span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">NotAuthorized</span>, <span class="ruby-identifier">with</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">user_not_authorized</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">user_not_authorized</span>
      <span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">error</span>] = <span class="ruby-string">&quot;You don&#39;t have access to this section.&quot;</span>
      <span class="ruby-identifier">redirect_to</span> :<span class="ruby-identifier">back</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">ClientsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-comment"># Check that the user has the right authorization to access clients.</span>
  <span class="ruby-identifier">before_action</span> :<span class="ruby-identifier">check_authorization</span>

  <span class="ruby-comment"># Note how the actions don&#39;t have to worry about all the auth stuff.</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">edit</span>
    <span class="ruby-ivar">@client</span> = <span class="ruby-constant">Client</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">private</span>

    <span class="ruby-comment"># If the user is not authorized, just throw the exception.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">check_authorization</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">User</span><span class="ruby-operator">::</span><span class="ruby-constant">NotAuthorized</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">admin?</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>NOTE: Certain exceptions are only rescuable from the
<code>ApplicationController</code> class, as they are raised before the
controller gets initialized and the action gets executed. See Pratik
Naik&#39;s <a
href="http://m.onkey.org/2008/7/20/rescue-from-dispatching">article</a> on
the subject for more information.</p>

<h2 id="label-Force+HTTPS+protocol">Force HTTPS protocol<span><a href="#label-Force+HTTPS+protocol">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Sometime you might want to force a particular controller to only be
accessible via an HTTPS protocol for security reasons. You can use the
<code>force_ssl</code> method in your controller to enforce that:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">DinnerController</span>
  <span class="ruby-identifier">force_ssl</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Just like the filter, you could also pass <code>:only</code> and
<code>:except</code> to enforce the secure connection only to specific
actions:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">DinnerController</span>
  <span class="ruby-identifier">force_ssl</span> <span class="ruby-identifier">only</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">cheeseburger</span>
  <span class="ruby-comment"># or</span>
  <span class="ruby-identifier">force_ssl</span> <span class="ruby-identifier">except</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">cheeseburger</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Please note that if you find yourself adding <code>force_ssl</code> to many
controllers, you may want to force the whole application to use HTTPS
instead. In that case, you can set the <code>config.force_ssl</code> in
your environment file.</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

