<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>caching_with_rails - rails-4.1.8 Documentation</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Caching+with+Rails%3A+An+overview">Caching with Rails: An overview</a>
    <li><a href="#label-Basic+Caching">Basic Caching</a>
    <li><a href="#label-Page+Caching">Page Caching</a>
    <li><a href="#label-Action+Caching">Action Caching</a>
    <li><a href="#label-Fragment+Caching">Fragment Caching</a>
    <li><a href="#label-SQL+Caching">SQL Caching</a>
    <li><a href="#label-Cache+Stores">Cache Stores</a>
    <li><a href="#label-Configuration">Configuration</a>
    <li><a href="#label-ActiveSupport%3A%3ACache%3A%3AStore">ActiveSupport::Cache::Store</a>
    <li><a href="#label-ActiveSupport%3A%3ACache%3A%3AMemoryStore">ActiveSupport::Cache::MemoryStore</a>
    <li><a href="#label-ActiveSupport%3A%3ACache%3A%3AFileStore">ActiveSupport::Cache::FileStore</a>
    <li><a href="#label-ActiveSupport%3A%3ACache%3A%3AMemCacheStore">ActiveSupport::Cache::MemCacheStore</a>
    <li><a href="#label-ActiveSupport%3A%3ACache%3A%3AEhcacheStore">ActiveSupport::Cache::EhcacheStore</a>
    <li><a href="#label-ActiveSupport%3A%3ACache%3A%3ANullStore">ActiveSupport::Cache::NullStore</a>
    <li><a href="#label-Custom+Cache+Stores">Custom Cache Stores</a>
    <li><a href="#label-Cache+Keys">Cache Keys</a>
    <li><a href="#label-Conditional+GET+support">Conditional GET support</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile.html">Gemfile</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../guides/code/getting_started/README_rdoc.html">README</a>
  
    <li><a href="../../guides/code/getting_started/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/comments_js_coffee.html">comments.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/posts_js_coffee.html">posts.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/welcome_js_coffee.html">welcome.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/comments_css_scss.html">comments.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/posts_css_scss.html">posts.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/welcome_css_scss.html">welcome.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/config_ru.html">config.ru</a>
  
    <li><a href="../../guides/code/getting_started/public/404_html.html">404.html</a>
  
    <li><a href="../../guides/code/getting_started/public/422_html.html">422.html</a>
  
    <li><a href="../../guides/code/getting_started/public/500_html.html">500.html</a>
  
    <li><a href="../../guides/code/getting_started/public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../guides/code/getting_started/public/robots_txt.html">robots</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/migrations_md.html">migrations</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/caching_with_rails.md">

<h1 id="label-Caching+with+Rails%3A+An+overview">Caching with Rails: An overview<span><a href="#label-Caching+with+Rails%3A+An+overview">&para;</a> <a href="#documentation">&uarr;</a></span></h1>

<p>This guide will teach you what you need to know about avoiding that
expensive round-trip to your database and returning what you need to return
to the web clients in the shortest time possible.</p>

<p>After reading this guide, you will know:</p>
<ul><li>
<p>Page and action caching (moved to separate gems as of Rails 4).</p>
</li><li>
<p>Fragment caching.</p>
</li><li>
<p>Alternative cache stores.</p>
</li><li>
<p>Conditional GET support.</p>
</li></ul>
<hr>

<h2 id="label-Basic+Caching">Basic Caching<span><a href="#label-Basic+Caching">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>This is an introduction to three types of caching techniques: page, action
and fragment caching. Rails provides by default fragment caching. In order
to use page and action caching, you will need to add
<code>actionpack-page_caching</code> and
<code>actionpack-action_caching</code> to your <a
href="../code/getting_started/Gemfile.html">Gemfile</a>.</p>

<p>To start playing with caching you&#39;ll want to ensure that
<code>config.action_controller.perform_caching</code> is set to
<code>true</code>, if you&#39;re running in development mode. This flag is
normally set in the corresponding <code>config/environments/*.rb</code> and
caching is disabled by default for development and test, and enabled for
production.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">action_controller</span>.<span class="ruby-identifier">perform_caching</span> = <span class="ruby-keyword">true</span>
</pre>

<h3 id="label-Page+Caching">Page Caching<span><a href="#label-Page+Caching">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Page caching is a Rails mechanism which allows the request for a generated
page to be fulfilled by the webserver (i.e. Apache or nginx), without ever
having to go through the Rails stack at all. Obviously, this is super-fast.
Unfortunately, it can&#39;t be applied to every situation (such as pages
that need authentication) and since the webserver is literally just serving
a file from the filesystem, cache expiration is an issue that needs to be
dealt with.</p>

<p>INFO: Page Caching has been removed from Rails 4. See the <a
href="https://github.com/rails/actionpack-page_caching">actionpack-page_caching
gem</a>. See <a
href="http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works">DHH’s
key-based cache expiration overview</a> for the newly-preferred method.</p>

<h3 id="label-Action+Caching">Action Caching<span><a href="#label-Action+Caching">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Page Caching cannot be used for actions that have before filters - for
example, pages that require authentication. This is where Action Caching
comes in. Action Caching works like Page Caching except the incoming web
request hits the Rails stack so that before filters can be run on it before
the cache is served. This allows authentication and other restrictions to
be run while still serving the result of the output from a cached copy.</p>

<p>INFO: Action Caching has been removed from Rails 4. See the <a
href="https://github.com/rails/actionpack-action_caching">actionpack-action_caching
gem</a>. See <a
href="http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works">DHH’s
key-based cache expiration overview</a> for the newly-preferred method.</p>

<h3 id="label-Fragment+Caching">Fragment Caching<span><a href="#label-Fragment+Caching">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Life would be perfect if we could get away with caching the entire contents
of a page or action and serving it out to the world. Unfortunately, dynamic
web applications usually build pages with a variety of components not all
of which have the same caching characteristics. In order to address such a
dynamically created page where different parts of the page need to be
cached and expired differently, Rails provides a mechanism called Fragment
Caching.</p>

<p>Fragment Caching allows a fragment of view logic to be wrapped in a cache
block and served out of the cache store when the next request comes in.</p>

<p>As an example, if you wanted to show all the orders placed on your website
in real time and didn&#39;t want to cache that part of the page, but did
want to cache the part of the page which lists all products available, you
could use this piece of code:</p>

<pre>&lt;% Order.find_recent.each do |o| %&gt;
  &lt;%= o.buyer.name %&gt; bought &lt;%= o.product.name %&gt;
&lt;% end %&gt;

&lt;% cache do %&gt;
  All available products:
  &lt;% Product.all.each do |p| %&gt;
    &lt;%= link_to p.name, product_url(p) %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;</pre>

<p>The cache block in our example will bind to the action that called it and
is written out to the same place as the Action Cache, which means that if
you want to cache multiple fragments per action, you should provide an
<code>action_suffix</code> to the cache call:</p>

<pre>&lt;% cache(action: &#39;recent&#39;, action_suffix: &#39;all_products&#39;) do %&gt;
  All available products:</pre>

<p>and you can expire it using the <code>expire_fragment</code> method, like
so:</p>

<pre class="ruby"><span class="ruby-identifier">expire_fragment</span>(<span class="ruby-identifier">controller</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;products&#39;</span>, <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;recent&#39;</span>, <span class="ruby-identifier">action_suffix</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;all_products&#39;</span>)
</pre>

<p>If you don&#39;t want the cache block to bind to the action that called it,
you can also use globally keyed fragments by calling the <code>cache</code>
method with a key:</p>

<pre>&lt;% cache(&#39;all_available_products&#39;) do %&gt;
  All available products:
&lt;% end %&gt;</pre>

<p>This fragment is then available to all actions in the
<code>ProductsController</code> using the key and can be expired the same
way:</p>

<pre class="ruby"><span class="ruby-identifier">expire_fragment</span>(<span class="ruby-string">&#39;all_available_products&#39;</span>)
</pre>

<p>If you want to avoid expiring the fragment manually, whenever an action
updates a product, you can define a helper method:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">ProductsHelper</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">cache_key_for_products</span>
    <span class="ruby-identifier">count</span>          = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">count</span>
    <span class="ruby-identifier">max_updated_at</span> = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">maximum</span>(:<span class="ruby-identifier">updated_at</span>).<span class="ruby-identifier">try</span>(:<span class="ruby-identifier">utc</span>).<span class="ruby-identifier">try</span>(:<span class="ruby-identifier">to_s</span>, :<span class="ruby-identifier">number</span>)
    <span class="ruby-node">&quot;products/all-#{count}-#{max_updated_at}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This method generates a cache key that depends on all products and can be
used in the view:</p>

<pre>&lt;% cache(cache_key_for_products) do %&gt;
  All available products:
&lt;% end %&gt;</pre>

<p>If you want to cache a fragment under certain condition you can use
<code>cache_if</code> or <code>cache_unless</code></p>

<pre>&lt;% cache_if (condition, cache_key_for_products) do %&gt;
  All available products:
&lt;% end %&gt;</pre>

<p>You can also use an Active Record model as the cache key:</p>

<pre>&lt;% Product.all.each do |p| %&gt;
  &lt;% cache(p) do %&gt;
    &lt;%= link_to p.name, product_url(p) %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;</pre>

<p>Behind the scenes, a method called <code>cache_key</code> will be invoked
on the model and it returns a string like
<code>products/23-20130109142513</code>. The cache key includes the model
name, the id and finally the updated_at timestamp. Thus it will
automatically generate a new fragment when the product is updated because
the key changes.</p>

<p>You can also combine the two schemes which is called “Russian Doll
Caching”:</p>

<pre>&lt;% cache(cache_key_for_products) do %&gt;
  All available products:
  &lt;% Product.all.each do |p| %&gt;
    &lt;% cache(p) do %&gt;
      &lt;%= link_to p.name, product_url(p) %&gt;
    &lt;% end %&gt;
  &lt;% end %&gt;
&lt;% end %&gt;</pre>

<p>It&#39;s called “Russian Doll Caching” because it nests multiple fragments.
The advantage is that if a single product is updated, all the other inner
fragments can be reused when regenerating the outer fragment.</p>

<h3 id="label-SQL+Caching">SQL Caching<span><a href="#label-SQL+Caching">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Query caching is a Rails feature that caches the result set returned by
each query so that if Rails encounters the same query again for that
request, it will use the cached result set as opposed to running the query
against the database again.</p>

<p>For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ProductsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
    <span class="ruby-comment"># Run a find query</span>
    <span class="ruby-ivar">@products</span> = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">all</span>

    <span class="ruby-operator">...</span>

    <span class="ruby-comment"># Run the same query again</span>
    <span class="ruby-ivar">@products</span> = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">all</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Cache+Stores">Cache Stores<span><a href="#label-Cache+Stores">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Rails provides different stores for the cached data created by
<strong>action</strong> and <strong>fragment</strong> caches.</p>

<p>TIP: Page caches are always stored on disk.</p>

<h3 id="label-Configuration">Configuration<span><a href="#label-Configuration">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can set up your application&#39;s default cache store by calling
<code>config.cache_store=</code> in the Application definition inside your
<code>config/application.rb</code> file or in an Application.configure
block in an environment specific configuration file (i.e.
<code>config/environments/*.rb</code>). The first argument will be the
cache store to use and the rest of the argument will be passed as arguments
to the cache store constructor.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">memory_store</span>
</pre>

<p>NOTE: Alternatively, you can call
<code>ActionController::Base.cache_store</code> outside of a configuration
block.</p>

<p>You can access the cache by calling <code>Rails.cache</code>.</p>

<h3 id="label-ActiveSupport%3A%3ACache%3A%3AStore">ActiveSupport::Cache::Store<span><a href="#label-ActiveSupport%3A%3ACache%3A%3AStore">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This class provides the foundation for interacting with the cache in Rails.
This is an abstract class and you cannot use it on its own. Rather you must
use a concrete implementation of the class tied to a storage engine. Rails
ships with several implementations documented below.</p>

<p>The main methods to call are <code>read</code>, <code>write</code>,
<code>delete</code>, <code>exist?</code>, and <code>fetch</code>. The fetch
method takes a block and will either return an existing value from the
cache, or evaluate the block and write the result to the cache if no value
exists.</p>

<p>There are some common options used by all cache implementations. These can
be passed to the constructor or the various methods to interact with
entries.</p>
<ul><li>
<p><code>:namespace</code> - This option can be used to create a namespace
within the cache store. It is especially useful if your application shares
a cache with other applications.</p>
</li><li>
<p><code>:compress</code> - This option can be used to indicate that
compression should be used in the cache. This can be useful for
transferring large cache entries over a slow network.</p>
</li><li>
<p><code>:compress_threshold</code> - This options is used in conjunction with
the <code>:compress</code> option to indicate a threshold under which cache
entries should not be compressed. This defaults to 16 kilobytes.</p>
</li><li>
<p><code>:expires_in</code> - This option sets an expiration time in seconds
for the cache entry when it will be automatically removed from the cache.</p>
</li><li>
<p><code>:race_condition_ttl</code> - This option is used in conjunction with
the <code>:expires_in</code> option. It will prevent race conditions when
cache entries expire by preventing multiple processes from simultaneously
regenerating the same entry (also known as the dog pile effect). This
option sets the number of seconds that an expired entry can be reused while
a new value is being regenerated. It&#39;s a good practice to set this
value if you use the <code>:expires_in</code> option.</p>
</li></ul>

<h3 id="label-ActiveSupport%3A%3ACache%3A%3AMemoryStore">ActiveSupport::Cache::MemoryStore<span><a href="#label-ActiveSupport%3A%3ACache%3A%3AMemoryStore">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This cache store keeps entries in memory in the same Ruby process. The
cache store has a bounded size specified by the <code>:size</code> options
to the initializer (default is 32Mb). When the cache exceeds the allotted
size, a cleanup will occur and the least recently used entries will be
removed.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">memory_store</span>, { <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">64</span>.<span class="ruby-identifier">megabytes</span> }
</pre>

<p>If you&#39;re running multiple Ruby on Rails server processes (which is the
case if you&#39;re using mongrel_cluster or Phusion Passenger), then your
Rails server process instances won&#39;t be able to share cache data with
each other. This cache store is not appropriate for large application
deployments, but can work well for small, low traffic sites with only a
couple of server processes or for development and test environments.</p>

<h3 id="label-ActiveSupport%3A%3ACache%3A%3AFileStore">ActiveSupport::Cache::FileStore<span><a href="#label-ActiveSupport%3A%3ACache%3A%3AFileStore">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This cache store uses the file system to store entries. The path to the
directory where the store files will be stored must be specified when
initializing the cache.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">file_store</span>, <span class="ruby-string">&quot;/path/to/cache/directory&quot;</span>
</pre>

<p>With this cache store, multiple server processes on the same host can share
a cache. Servers processes running on different hosts could share a cache
by using a shared file system, but that set up would not be ideal and is
not recommended. The cache store is appropriate for low to medium traffic
sites that are served off one or two hosts.</p>

<p>Note that the cache will grow until the disk is full unless you
periodically clear out old entries.</p>

<p>This is the default cache store implementation.</p>

<h3 id="label-ActiveSupport%3A%3ACache%3A%3AMemCacheStore">ActiveSupport::Cache::MemCacheStore<span><a href="#label-ActiveSupport%3A%3ACache%3A%3AMemCacheStore">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This cache store uses Danga&#39;s <code>memcached</code> server to provide
a centralized cache for your application. Rails uses the bundled
<code>dalli</code> gem by default. This is currently the most popular cache
store for production websites. It can be used to provide a single, shared
cache cluster with very high performance and redundancy.</p>

<p>When initializing the cache, you need to specify the addresses for all
memcached servers in your cluster. If none is specified, it will assume
memcached is running on the local host on the default port, but this is not
an ideal set up for larger sites.</p>

<p>The <code>write</code> and <code>fetch</code> methods on this cache accept
two additional options that take advantage of features specific to
memcached. You can specify <code>:raw</code> to send a value directly to
the server with no serialization. The value must be a string or number. You
can use memcached direct operation like <code>increment</code> and
<code>decrement</code> only on raw values. You can also specify
<code>:unless_exist</code> if you don&#39;t want memcached to overwrite an
existing entry.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">mem_cache_store</span>, <span class="ruby-string">&quot;cache-1.example.com&quot;</span>, <span class="ruby-string">&quot;cache-2.example.com&quot;</span>
</pre>

<h3 id="label-ActiveSupport%3A%3ACache%3A%3AEhcacheStore">ActiveSupport::Cache::EhcacheStore<span><a href="#label-ActiveSupport%3A%3ACache%3A%3AEhcacheStore">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you are using JRuby you can use Terracotta&#39;s Ehcache as the cache
store for your application. Ehcache is an open source Java cache that also
offers an enterprise version with increased scalability, management, and
commercial support. You must first install the jruby-ehcache-rails3 gem
(version 1.1.0 or later) to use this cache store.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">ehcache_store</span>
</pre>

<p>When initializing the cache, you may use the <code>:ehcache_config</code>
option to specify the Ehcache config file to use (where the default is
“ehcache.xml” in your Rails config directory), and the :cache_name option
to provide a custom name for your cache (the default is rails_cache).</p>

<p>In addition to the standard <code>:expires_in</code> option, the
<code>write</code> method on this cache can also accept the additional
<code>:unless_exist</code> option, which will cause the cache store to use
Ehcache&#39;s <code>putIfAbsent</code> method instead of <code>put</code>,
and therefore will not overwrite an existing entry. Additionally, the
<code>write</code> method supports all of the properties exposed by the <a
href="http://ehcache.org/apidocs/net/sf/ehcache/Element.html">Ehcache
Element class</a> , including:</p>

<p>| Property | Argument Type | Description | | ————————— | ——————- |
———————————————————– | | elementEvictionData | ElementEvictionData | Sets
this element&#39;s eviction data instance. | | eternal | boolean | Sets
whether the element is eternal. | | timeToIdle, tti | int | Sets time to
idle | | timeToLive, ttl, expires_in | int | Sets time to Live | | version
| long | Sets the version attribute of the ElementAttributes object. |</p>

<p>These options are passed to the <code>write</code> method as Hash options
using either camelCase or underscore notation, as in the following
examples:</p>

<pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">write</span>(<span class="ruby-string">&#39;key&#39;</span>, <span class="ruby-string">&#39;value&#39;</span>, <span class="ruby-identifier">time_to_idle</span><span class="ruby-operator">:</span> <span class="ruby-value">60</span>.<span class="ruby-identifier">seconds</span>, <span class="ruby-identifier">timeToLive</span><span class="ruby-operator">:</span> <span class="ruby-value">600</span>.<span class="ruby-identifier">seconds</span>)
<span class="ruby-identifier">caches_action</span> :<span class="ruby-identifier">index</span>, <span class="ruby-identifier">expires_in</span><span class="ruby-operator">:</span> <span class="ruby-value">60</span>.<span class="ruby-identifier">seconds</span>, <span class="ruby-identifier">unless_exist</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
</pre>

<p>For more information about Ehcache, see <a
href="http://ehcache.org/">ehcache.org/</a> . For more information about
Ehcache for JRuby and Rails, see <a
href="http://ehcache.org/documentation/jruby.html">ehcache.org/documentation/jruby.html</a></p>

<h3 id="label-ActiveSupport%3A%3ACache%3A%3ANullStore">ActiveSupport::Cache::NullStore<span><a href="#label-ActiveSupport%3A%3ACache%3A%3ANullStore">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This cache store implementation is meant to be used only in development or
test environments and it never stores anything. This can be very useful in
development when you have code that interacts directly with
<code>Rails.cache</code>, but caching may interfere with being able to see
the results of code changes. With this cache store, all <code>fetch</code>
and <code>read</code> operations will result in a miss.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">null_store</span>
</pre>

<h3 id="label-Custom+Cache+Stores">Custom Cache Stores<span><a href="#label-Custom+Cache+Stores">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can create your own custom cache store by simply extending
<code>ActiveSupport::Cache::Store</code> and implementing the appropriate
methods. In this way, you can swap in any number of caching technologies
into your Rails application.</p>

<p>To use a custom cache store, simple set the cache store to a new instance
of the class.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">cache_store</span> = <span class="ruby-constant">MyCacheStore</span>.<span class="ruby-identifier">new</span>
</pre>

<h3 id="label-Cache+Keys">Cache Keys<span><a href="#label-Cache+Keys">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The keys used in a cache can be any object that responds to either
<code>:cache_key</code> or to <code>:to_param</code>. You can implement the
<code>:cache_key</code> method on your classes if you need to generate
custom keys. Active Record will generate keys based on the class name and
record id.</p>

<p>You can use Hashes and Arrays of values as cache keys.</p>

<pre class="ruby"><span class="ruby-comment"># This is a legal cache key</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">site</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;mysite&quot;</span>, <span class="ruby-identifier">owners</span><span class="ruby-operator">:</span> [<span class="ruby-identifier">owner_1</span>, <span class="ruby-identifier">owner_2</span>])
</pre>

<p>The keys you use on <code>Rails.cache</code> will not be the same as those
actually used with the storage engine. They may be modified with a
namespace or altered to fit technology backend constraints. This means, for
instance, that you can&#39;t save values with <code>Rails.cache</code> and
then try to pull them out with the <code>memcache-client</code> gem.
However, you also don&#39;t need to worry about exceeding the memcached
size limit or violating syntax rules.</p>

<h2 id="label-Conditional+GET+support">Conditional GET support<span><a href="#label-Conditional+GET+support">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Conditional GETs are a feature of the HTTP specification that provide a way
for web servers to tell browsers that the response to a GET request
hasn&#39;t changed since the last request and can be safely pulled from the
browser cache.</p>

<p>They work by using the <code>HTTP_IF_NONE_MATCH</code> and
<code>HTTP_IF_MODIFIED_SINCE</code> headers to pass back and forth both a
unique content identifier and the timestamp of when the content was last
changed. If the browser makes a request where the content identifier (etag)
or last modified since timestamp matches the server&#39;s version then the
server only needs to send back an empty response with a not modified
status.</p>

<p>It is the server&#39;s (i.e. our) responsibility to look for a last
modified timestamp and the if-none-match header and determine whether or
not to send back the full response. With conditional-get support in Rails
this is a pretty easy task:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ProductsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
    <span class="ruby-ivar">@product</span> = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])

    <span class="ruby-comment"># If the request is stale according to the given timestamp and etag value</span>
    <span class="ruby-comment"># (i.e. it needs to be processed again) then execute this block</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">stale?</span>(<span class="ruby-identifier">last_modified</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@product</span>.<span class="ruby-identifier">updated_at</span>.<span class="ruby-identifier">utc</span>, <span class="ruby-identifier">etag</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@product</span>.<span class="ruby-identifier">cache_key</span>)
      <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">wants</span><span class="ruby-operator">|</span>
        <span class="ruby-comment"># ... normal response processing</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># If the request is fresh (i.e. it&#39;s not modified) then you don&#39;t need to do</span>
    <span class="ruby-comment"># anything. The default render checks for this using the parameters</span>
    <span class="ruby-comment"># used in the previous call to stale? and will automatically send a</span>
    <span class="ruby-comment"># :not_modified. So that&#39;s it, you&#39;re done.</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Instead of an options hash, you can also simply pass in a model, Rails will
use the <code>updated_at</code> and <code>cache_key</code> methods for
setting <code>last_modified</code> and <code>etag</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ProductsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
    <span class="ruby-ivar">@product</span> = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])
    <span class="ruby-identifier">respond_with</span>(<span class="ruby-ivar">@product</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">stale?</span>(<span class="ruby-ivar">@product</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you don&#39;t have any special response processing and are using the
default rendering mechanism (i.e. you&#39;re not using respond_to or
calling render yourself) then you&#39;ve got an easy helper in fresh_when:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ProductsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>

  <span class="ruby-comment"># This will automatically send back a :not_modified if the request is fresh,</span>
  <span class="ruby-comment"># and will render the default template (product.*) if it&#39;s stale.</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
    <span class="ruby-ivar">@product</span> = <span class="ruby-constant">Product</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">id</span>])
    <span class="ruby-identifier">fresh_when</span> <span class="ruby-identifier">last_modified</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@product</span>.<span class="ruby-identifier">published_at</span>.<span class="ruby-identifier">utc</span>, <span class="ruby-identifier">etag</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@product</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

