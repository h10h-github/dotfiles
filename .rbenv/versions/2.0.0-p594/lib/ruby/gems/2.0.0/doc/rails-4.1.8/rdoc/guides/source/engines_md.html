<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>engines - rails-4.1.8 Documentation</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Getting+Started+with+Engines">Getting Started with Engines</a>
    <li><a href="#label-What+are+engines%3F">What are engines?</a>
    <li><a href="#label-Generating+an+engine">Generating an engine</a>
    <li><a href="#label-Inside+an+Engine">Inside an Engine</a>
    <li><a href="#label-Critical+Files">Critical Files</a>
    <li><a href="#label-app+Directory"><code>app</code> Directory</a>
    <li><a href="#label-bin+Directory"><code>bin</code> Directory</a>
    <li><a href="#label-test+Directory"><code>test</code> Directory</a>
    <li><a href="#label-Providing+engine+functionality">Providing engine functionality</a>
    <li><a href="#label-Generating+a+Post+Resource">Generating a Post Resource</a>
    <li><a href="#label-Generating+a+Comments+Resource">Generating a Comments Resource</a>
    <li><a href="#label-Hooking+Into+an+Application">Hooking Into an Application</a>
    <li><a href="#label-Mounting+the+Engine">Mounting the Engine</a>
    <li><a href="#label-Engine+setup">Engine setup</a>
    <li><a href="#label-Using+a+Class+Provided+by+the+Application">Using a Class Provided by the Application</a>
    <li><a href="#label-Using+a+Model+Provided+by+the+Application">Using a Model Provided by the Application</a>
    <li><a href="#label-Using+a+Controller+Provided+by+the+Application">Using a Controller Provided by the Application</a>
    <li><a href="#label-Configuring+an+Engine">Configuring an Engine</a>
    <li><a href="#label-Setting+Configuration+Settings+in+the+Application">Setting Configuration Settings in the Application</a>
    <li><a href="#label-General+Engine+Configuration">General Engine Configuration</a>
    <li><a href="#label-Testing+an+engine">Testing an engine</a>
    <li><a href="#label-Functional+Tests">Functional Tests</a>
    <li><a href="#label-Improving+engine+functionality">Improving engine functionality</a>
    <li><a href="#label-Overriding+Models+and+Controllers">Overriding Models and Controllers</a>
    <li><a href="#label-A+note+on+Decorators+and+Loading+Code">A note on Decorators and Loading Code</a>
    <li><a href="#label-Implementing+Decorator+Pattern+Using+Class%23class_eval">Implementing Decorator Pattern Using Class#class_eval</a>
    <li><a href="#label-Implementing+Decorator+Pattern+Using+ActiveSupport%3A%3AConcern">Implementing Decorator Pattern Using ActiveSupport::Concern</a>
    <li><a href="#label-Overriding+Views">Overriding Views</a>
    <li><a href="#label-Routes">Routes</a>
    <li><a href="#label-Assets">Assets</a>
    <li><a href="#label-Separate+Assets+%26+Precompiling">Separate Assets &amp; Precompiling</a>
    <li><a href="#label-Other+Gem+Dependencies">Other Gem Dependencies</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile.html">Gemfile</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../guides/code/getting_started/README_rdoc.html">README</a>
  
    <li><a href="../../guides/code/getting_started/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/comments_js_coffee.html">comments.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/posts_js_coffee.html">posts.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/welcome_js_coffee.html">welcome.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/comments_css_scss.html">comments.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/posts_css_scss.html">posts.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/welcome_css_scss.html">welcome.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/config_ru.html">config.ru</a>
  
    <li><a href="../../guides/code/getting_started/public/404_html.html">404.html</a>
  
    <li><a href="../../guides/code/getting_started/public/422_html.html">422.html</a>
  
    <li><a href="../../guides/code/getting_started/public/500_html.html">500.html</a>
  
    <li><a href="../../guides/code/getting_started/public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../guides/code/getting_started/public/robots_txt.html">robots</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/migrations_md.html">migrations</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/engines.md">

<h1 id="label-Getting+Started+with+Engines">Getting Started with Engines<span><a href="#label-Getting+Started+with+Engines">&para;</a> <a href="#documentation">&uarr;</a></span></h1>

<p>In this guide you will learn about engines and how they can be used to
provide additional functionality to their host applications through a clean
and very easy-to-use interface.</p>

<p>After reading this guide, you will know:</p>

<p>What makes an engine.  How to generate an engine.  Building features for
the engine.  Hooking the engine into an application.  Overriding engine
functionality in the application.</p>
<hr>

<h2 id="label-What+are+engines%3F">What are engines?<span><a href="#label-What+are+engines%3F">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Engines can be considered miniature applications that provide functionality
to their host applications. A Rails application is actually just a
“supercharged” engine, with the <code>Rails::Application</code> class
inheriting a lot of its behavior from <code>Rails::Engine</code>.</p>

<p>Therefore, engines and applications can be thought of almost the same
thing, just with subtle differences, as you&#39;ll see throughout this
guide. Engines and applications also share a common structure.</p>

<p>Engines are also closely related to plugins. The two share a common
<code>lib</code> directory structure, and are both generated using the
<code>rails plugin new</code> generator. The difference is that an engine
is considered a “full plugin” by Rails (as indicated by the
<code>--full</code> option that&#39;s passed to the generator command).
This guide will refer to them simply as “engines” throughout. An engine
<strong>can</strong> be a plugin, and a plugin <strong>can</strong> be an
engine.</p>

<p>The engine that will be created in this guide will be called “blorgh”. The
engine will provide blogging functionality to its host applications,
allowing for new posts and comments to be created. At the beginning of this
guide, you will be working solely within the engine itself, but in later
sections you&#39;ll see how to hook it into an application.</p>

<p>Engines can also be isolated from their host applications. This means that
an application is able to have a path provided by a routing helper such as
<code>posts_path</code> and use an engine also that provides a path also
called <code>posts_path</code>, and the two would not clash. Along with
this, controllers, models and table names are also namespaced. You&#39;ll
see how to do this later in this guide.</p>

<p>It&#39;s important to keep in mind at all times that the application should
<em>always</em>* take precedence over its engines. An application is the
object that has final say in what goes on in the universe (with the
universe being the application&#39;s environment) where the engine should
only be enhancing it, rather than changing it drastically.</p>

<p>To see demonstrations of other engines, check out <a
href="https://github.com/plataformatec/devise">Devise</a>, an engine that
provides authentication for its parent applications, or <a
href="https://github.com/radar/forem">Forem</a>, an engine that provides
forum functionality. There&#39;s also <a
href="https://github.com/spree/spree">Spree</a> which provides an
e-commerce platform, and <a
href="https://github.com/refinery/refinerycms">RefineryCMS</a>, a CMS
engine.</p>

<p>Finally, engines would not have been possible without the work of James
Adam, Piotr Sarnacki, the Rails Core Team, and a number of other people. If
you ever meet them, don&#39;t forget to say thanks!</p>

<h2 id="label-Generating+an+engine">Generating an engine<span><a href="#label-Generating+an+engine">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>To generate an engine, you will need to run the plugin generator and pass
it options as appropriate to the need. For the “blorgh” example, you will
need to create a “mountable” engine, running this command in a terminal:</p>

<pre>$ bin/rails plugin new blorgh --mountable</pre>

<p>The full list of options for the plugin generator may be seen by typing:</p>

<pre>$ bin/rails plugin --help</pre>

<p>The <code>--full</code> option tells the generator that you want to create
an engine, including a skeleton structure that provides the following:</p>

<pre class="ruby"><span class="ruby-constant">An</span> <span class="ruby-value">%xapp`</span> <span class="ruby-identifier">directory</span> <span class="ruby-identifier">tree</span>
<span class="ruby-constant">A</span> <span class="ruby-value">%xconfig/routes.rb`</span> <span class="ruby-identifier">file</span><span class="ruby-operator">:</span>

<span class="ruby-value">%x`</span><span class="ruby-value">%xruby
Rails.application.routes.draw do
end
`</span><span class="ruby-value">%x`</span>

<span class="ruby-constant">A</span> <span class="ruby-identifier">file</span> <span class="ruby-identifier">at</span> <span class="ruby-value">%xlib/blorgh/engine.rb`</span>, <span class="ruby-identifier">which</span> <span class="ruby-identifier">is</span> <span class="ruby-identifier">identical</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">function</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">a</span>
<span class="ruby-identifier">standard</span> <span class="ruby-constant">Rails</span> <span class="ruby-identifier">application</span><span class="ruby-string">&#39;s `config/application.rb` file:

```ruby
module Blorgh
  class Engine &lt; ::Rails::Engine
  end
end
```
</span></pre>

<p>The <code>--mountable</code> option tells the generator that you want to
create a “mountable” and namespace-isolated engine. This generator will
provide the same skeleton structure as would the <code>--full</code>
option, and will add:</p>

<pre class="ruby"><span class="ruby-constant">Asset</span> <span class="ruby-identifier">manifest</span> <span class="ruby-identifier">files</span> (<span class="ruby-value">%xapplication.js`</span> <span class="ruby-keyword">and</span> <span class="ruby-value">%xapplication.css`</span>)
<span class="ruby-constant">A</span> <span class="ruby-identifier">namespaced</span> <span class="ruby-value">%xApplicationController`</span> <span class="ruby-identifier">stub</span>
<span class="ruby-constant">A</span> <span class="ruby-identifier">namespaced</span> <span class="ruby-value">%xApplicationHelper`</span> <span class="ruby-identifier">stub</span>
<span class="ruby-constant">A</span> <span class="ruby-identifier">layout</span> <span class="ruby-identifier">view</span> <span class="ruby-identifier">template</span> <span class="ruby-keyword">for</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">engine</span>
<span class="ruby-constant">Namespace</span> <span class="ruby-identifier">isolation</span> <span class="ruby-identifier">to</span> <span class="ruby-value">%xconfig/routes.rb`</span><span class="ruby-operator">:</span>

<span class="ruby-value">%x`</span><span class="ruby-value">%xruby
Blorgh::Engine.routes.draw do
end
`</span><span class="ruby-value">%x`</span>

<span class="ruby-constant">Namespace</span> <span class="ruby-identifier">isolation</span> <span class="ruby-identifier">to</span> <span class="ruby-value">%xlib/blorgh/engine.rb`</span><span class="ruby-operator">:</span>

<span class="ruby-value">%x`</span><span class="ruby-value">%xruby
module Blorgh
  class Engine &lt; ::Rails::Engine
    isolate_namespace Blorgh
  end
end
`</span><span class="ruby-value">%x`</span>
</pre>

<p>Additionally, the <code>--mountable</code> option tells the generator to
mount the engine inside the dummy testing application located at
<code>test/dummy</code> by adding the following to the dummy
application&#39;s routes file at <code>test/dummy/config/routes.rb</code>:</p>

<pre class="ruby"><span class="ruby-identifier">mount</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>, <span class="ruby-identifier">at</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;blorgh&quot;</span>
</pre>

<h3 id="label-Inside+an+Engine">Inside an Engine<span><a href="#label-Inside+an+Engine">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<h4 id="label-Critical+Files">Critical Files<span><a href="#label-Critical+Files">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>At the root of this brand new engine&#39;s directory lives a
<code>blorgh.gemspec</code> file. When you include the engine into an
application later on, you will do so with this line in the Rails
application&#39;s <code>Gemfile</code>:</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;blorgh&#39;</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;vendor/engines/blorgh&quot;</span>
</pre>

<p>Don&#39;t forget to run <code>bundle install</code> as usual. By specifying
it as a gem within the <code>Gemfile</code>, Bundler will load it as such,
parsing this <code>blorgh.gemspec</code> file and requiring a file within
the <code>lib</code> directory called <code>lib/blorgh.rb</code>. This file
requires the <code>blorgh/engine.rb</code> file (located at
<code>lib/blorgh/engine.rb</code>) and defines a base module called
<code>Blorgh</code>.</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;blorgh/engine&quot;</span>

<span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span>
<span class="ruby-keyword">end</span>
</pre>

<p>TIP: Some engines choose to use this file to put global configuration
options for their engine. It&#39;s a relatively good idea, so if you want
to offer configuration options, the file where your engine&#39;s
<code>module</code> is defined is perfect for that. Place the methods
inside the module and you&#39;ll be good to go.</p>

<p>Within <code>lib/blorgh/engine.rb</code> is the base class for the engine:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Engine</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>
    <span class="ruby-identifier">isolate_namespace</span> <span class="ruby-constant">Blorgh</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By inheriting from the <code>Rails::Engine</code> class, this gem notifies
Rails that there&#39;s an engine at the specified path, and will correctly
mount the engine inside the application, performing tasks such as adding
the <code>app</code> directory of the engine to the load path for models,
mailers, controllers and views.</p>

<p>The <code>isolate_namespace</code> method here deserves special notice.
This call is responsible for isolating the controllers, models, routes and
other things into their own namespace, away from similar components inside
the application. Without this, there is a possibility that the engine&#39;s
components could “leak” into the application, causing unwanted disruption,
or that important engine components could be overridden by similarly named
things within the application. One of the examples of such conflicts is
helpers. Without calling <code>isolate_namespace</code>, the engine&#39;s
helpers would be included in an application&#39;s controllers.</p>

<p>NOTE: It is <strong>highly</strong> recommended that the
<code>isolate_namespace</code> line be left within the <code>Engine</code>
class definition. Without it, classes generated in an engine  <em>may</em>*
conflict with an application.</p>

<p>What this isolation of the namespace means is that a model generated by a
call to <code>bin/rails g model</code>, such as <code>bin/rails g model
post</code>, won&#39;t be called <code>Post</code>, but instead be
namespaced and called <code>Blorgh::Post</code>. In addition, the table for
the model is namespaced, becoming <code>blorgh_posts</code>, rather than
simply <code>posts</code>. Similar to the model namespacing, a controller
called <code>PostsController</code> becomes
<code>Blorgh::PostsController</code> and the views for that controller will
not be at <code>app/views/posts</code>, but
<code>app/views/blorgh/posts</code> instead. Mailers are namespaced as
well.</p>

<p>Finally, routes will also be isolated within the engine. This is one of the
most important parts about namespacing, and is discussed later in the <a
href="#routes">Routes</a> section of this guide.</p>

<h4 id="label-app+Directory"><code>app</code> Directory<span><a href="#label-app+Directory">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Inside the <code>app</code> directory are the standard <code>assets</code>,
<code>controllers</code>, <code>helpers</code>, <code>mailers</code>,
<code>models</code> and <code>views</code> directories that you should be
familiar with from an application. The <code>helpers</code>,
<code>mailers</code> and <code>models</code> directories are empty, so they
aren&#39;t described in this section. We&#39;ll look more into models in a
future section, when we&#39;re writing the engine.</p>

<p>Within the <code>app/assets</code> directory, there are the
<code>images</code>, <code>javascripts</code> and <code>stylesheets</code>
directories which, again, you should be familiar with due to their
similarity to an application. One difference here, however, is that each
directory contains a sub-directory with the engine name. Because this
engine is going to be namespaced, its assets should be too.</p>

<p>Within the <code>app/controllers</code> directory there is a
<code>blorgh</code> directory that contains a file called
<code>application_controller.rb</code>. This file will provide any common
functionality for the controllers of the engine. The <code>blorgh</code>
directory is where the other controllers for the engine will go. By placing
them within this namespaced directory, you prevent them from possibly
clashing with identically-named controllers within other engines or even
within the application.</p>

<p>NOTE: The <code>ApplicationController</code> class inside an engine is
named just like a Rails application in order to make it easier for you to
convert your applications into engines.</p>

<p>Lastly, the <code>app/views</code> directory contains a
<code>layouts</code> folder, which contains a file at
<code>blorgh/application.html.erb</code>. This file allows you to specify a
layout for the engine. If this engine is to be used as a stand-alone
engine, then you would add any customization to its layout in this file,
rather than the application&#39;s
<code>app/views/layouts/application.html.erb</code> file.</p>

<p>If you don&#39;t want to force a layout on to users of the engine, then you
can delete this file and reference a different layout in the controllers of
your engine.</p>

<h4 id="label-bin+Directory"><code>bin</code> Directory<span><a href="#label-bin+Directory">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>This directory contains one file, <code>bin/rails</code>, which enables you
to use the <code>rails</code> sub-commands and generators just like you
would within an application. This means that you will be able to generate
new controllers and models for this engine very easily by running commands
like this:</p>

<pre>$ bin/rails g model</pre>

<p>Keep in mind, of course, that anything generated with these commands inside
of an engine that has <code>isolate_namespace</code> in the
<code>Engine</code> class will be namespaced.</p>

<h4 id="label-test+Directory"><code>test</code> Directory<span><a href="#label-test+Directory">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>The <code>test</code> directory is where tests for the engine will go. To
test the engine, there is a cut-down version of a Rails application
embedded within it at <code>test/dummy</code>. This application will mount
the engine in the <code>test/dummy/config/routes.rb</code> file:</p>

<pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">mount</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;/blorgh&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This line mounts the engine at the path <code>/blorgh</code>, which will
make it accessible through the application only at that path.</p>

<p>Inside the test directory there is the <code>test/integration</code>
directory, where integration tests for the engine should be placed. Other
directories can be created in the <code>test</code> directory as well. For
example, you may wish to create a <code>test/models</code> directory for
your model tests.</p>

<h2 id="label-Providing+engine+functionality">Providing engine functionality<span><a href="#label-Providing+engine+functionality">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>The engine that this guide covers provides posting and commenting
functionality and follows a similar thread to the <a
href="getting_started.html">Getting Started Guide</a>, with some new
twists.</p>

<h3 id="label-Generating+a+Post+Resource">Generating a <a href="../../Post.html">Post</a> Resource<span><a href="#label-Generating+a+Post+Resource">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The first thing to generate for a blog engine is the <code>Post</code>
model and related controller. To quickly generate this, you can use the
Rails scaffold generator.</p>

<pre>$ bin/rails generate scaffold post title:string text:text</pre>

<p>This command will output this information:</p>

<pre>invoke  active_record
create    db/migrate/[timestamp]_create_blorgh_posts.rb
create    app/models/blorgh/post.rb
invoke    test_unit
create      test/models/blorgh/post_test.rb
create      test/fixtures/blorgh/posts.yml
invoke  resource_route
 route    resources :posts
invoke  scaffold_controller
create    app/controllers/blorgh/posts_controller.rb
invoke    erb
create      app/views/blorgh/posts
create      app/views/blorgh/posts/index.html.erb
create      app/views/blorgh/posts/edit.html.erb
create      app/views/blorgh/posts/show.html.erb
create      app/views/blorgh/posts/new.html.erb
create      app/views/blorgh/posts/_form.html.erb
invoke    test_unit
create      test/controllers/blorgh/posts_controller_test.rb
invoke    helper
create      app/helpers/blorgh/posts_helper.rb
invoke      test_unit
create        test/helpers/blorgh/posts_helper_test.rb
invoke  assets
invoke    js
create      app/assets/javascripts/blorgh/posts.js
invoke    css
create      app/assets/stylesheets/blorgh/posts.css
invoke  css
create    app/assets/stylesheets/scaffold.css</pre>

<p>The first thing that the scaffold generator does is invoke the
<code>active_record</code> generator, which generates a migration and a
model for the resource. Note here, however, that the migration is called
<code>create_blorgh_posts</code> rather than the usual
<code>create_posts</code>. This is due to the
<code>isolate_namespace</code> method called in the
<code>Blorgh::Engine</code> class&#39;s definition. The model here is also
namespaced, being placed at <code>app/models/blorgh/post.rb</code> rather
than <code>app/models/post.rb</code> due to the
<code>isolate_namespace</code> call within the <code>Engine</code> class.</p>

<p>Next, the <code>test_unit</code> generator is invoked for this model,
generating a model test at <code>test/models/blorgh/post_test.rb</code>
(rather than <code>test/models/post_test.rb</code>) and a fixture at
<code>test/fixtures/blorgh/posts.yml</code> (rather than
<code>test/fixtures/posts.yml</code>).</p>

<p>After that, a line for the resource is inserted into the
<code>config/routes.rb</code> file for the engine. This line is simply
<code>resources :posts</code>, turning the <code>config/routes.rb</code>
file for the engine into this:</p>

<pre class="ruby"><span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">resources</span> :<span class="ruby-identifier">posts</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Note here that the routes are drawn upon the <code>Blorgh::Engine</code>
object rather than the <code>YourApp::Application</code> class. This is so
that the engine routes are confined to the engine itself and can be mounted
at a specific point as shown in the <a href="#test-directory">test
directory</a> section. It also causes the engine&#39;s routes to be
isolated from those routes that are within the application. The <a
href="#routes">Routes</a> section of this guide describes it in detail.</p>

<p>Next, the <code>scaffold_controller</code> generator is invoked, generating
a controller called <code>Blorgh::PostsController</code> (at
<code>app/controllers/blorgh/posts_controller.rb</code>) and its related
views at <code>app/views/blorgh/posts</code>. This generator also generates
a test for the controller
(<code>test/controllers/blorgh/posts_controller_test.rb</code>) and a
helper (<code>app/helpers/blorgh/posts_controller.rb</code>).</p>

<p>Everything this generator has created is neatly namespaced. The
controller&#39;s class is defined within the <code>Blorgh</code> module:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">PostsController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
    <span class="ruby-operator">...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>NOTE: The <code>ApplicationController</code> class being inherited from
here is the <code>Blorgh::ApplicationController</code>, not an
application&#39;s <code>ApplicationController</code>.</p>

<p>The helper inside <code>app/helpers/blorgh/posts_helper.rb</code> is also
namespaced:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span>
  <span class="ruby-keyword">module</span> <span class="ruby-constant">PostsHelper</span>
    <span class="ruby-operator">...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This helps prevent conflicts with any other engine or application that may
have a post resource as well.</p>

<p>Finally, the assets for this resource are generated in two files:
<code>app/assets/javascripts/blorgh/posts.js</code> and
<code>app/assets/stylesheets/blorgh/posts.css</code>. You&#39;ll see how to
use these a little later.</p>

<p>By default, the scaffold styling is not applied to the engine because the
engine&#39;s layout file,
<code>app/views/layouts/blorgh/application.html.erb</code>, doesn&#39;t
load it. To make the scaffold styling apply, insert this line into the
<code>&lt;head&gt;</code> tag of this layout:</p>

<pre>&lt;%= stylesheet_link_tag &quot;scaffold&quot; %&gt;</pre>

<p>You can see what the engine has so far by running <code>rake
db:migrate</code> at the root of our engine to run the migration generated
by the scaffold generator, and then running <code>rails server</code> in
<code>test/dummy</code>. When you open
<code>http://localhost:3000/blorgh/posts</code> you will see the default
scaffold that has been generated. Click around! You&#39;ve just generated
your first engine&#39;s first functions.</p>

<p>If you&#39;d rather play around in the console, <code>rails console</code>
will also work just like a Rails application. Remember: the
<code>Post</code> model is namespaced, so to reference it you must call it
as <code>Blorgh::Post</code>.</p>

<pre class="ruby"><span class="ruby-operator">&gt;&gt;</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
=<span class="ruby-operator">&gt;</span> <span class="ruby-comment">#&lt;Blorgh::Post id: 1 ...&gt;</span>
</pre>

<p>One final thing is that the <code>posts</code> resource for this engine
should be the root of the engine. Whenever someone goes to the root path
where the engine is mounted, they should be shown a list of posts. This can
be made to happen if this line is inserted into the
<code>config/routes.rb</code> file inside the engine:</p>

<pre class="ruby"><span class="ruby-identifier">root</span> <span class="ruby-identifier">to</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;posts#index&quot;</span>
</pre>

<p>Now people will only need to go to the root of the engine to see all the
posts, rather than visiting <code>/posts</code>. This means that instead of
<code>http://localhost:3000/blorgh/posts</code>, you only need to go to
<code>http://localhost:3000/blorgh</code> now.</p>

<h3 id="label-Generating+a+Comments+Resource">Generating a Comments Resource<span><a href="#label-Generating+a+Comments+Resource">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Now that the engine can create new blog posts, it only makes sense to add
commenting functionality as well. To do this, you&#39;ll need to generate a
comment model, a comment controller and then modify the posts scaffold to
display comments and allow people to create new ones.</p>

<p>From the application root, run the model generator. Tell it to generate a
<code>Comment</code> model, with the related table having two columns: a
<code>post_id</code> integer and <code>text</code> text column.</p>

<pre>$ bin/rails generate model Comment post_id:integer text:text</pre>

<p>This will output the following:</p>

<pre>invoke  active_record
create    db/migrate/[timestamp]_create_blorgh_comments.rb
create    app/models/blorgh/comment.rb
invoke    test_unit
create      test/models/blorgh/comment_test.rb
create      test/fixtures/blorgh/comments.yml</pre>

<p>This generator call will generate just the necessary model files it needs,
namespacing the files under a <code>blorgh</code> directory and creating a
model class called <code>Blorgh::Comment</code>. Now run the migration to
create our blorgh_comments table:</p>

<pre>$ bin/rake db:migrate</pre>

<p>To show the comments on a post, edit
<code>app/views/blorgh/posts/show.html.erb</code> and add this line before
the “Edit” link:</p>

<pre>&lt;h3&gt;Comments&lt;/h3&gt;
&lt;%= render @post.comments %&gt;</pre>

<p>This line will require there to be a <code>has_many</code> association for
comments defined on the <code>Blorgh::Post</code> model, which there
isn&#39;t right now. To define one, open
<code>app/models/blorgh/post.rb</code> and add this line into the model:</p>

<pre class="ruby"><span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">comments</span>
</pre>

<p>Turning the model into this:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
    <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">comments</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>NOTE: Because the <code>has_many</code> is defined inside a class that is
inside the <code>Blorgh</code> module, Rails will know that you want to use
the <code>Blorgh::Comment</code> model for these objects, so there&#39;s no
need to specify that using the <code>:class_name</code> option here.</p>

<p>Next, there needs to be a form so that comments can be created on a post.
To add this, put this line underneath the call to <code>render
@post.comments</code> in <code>app/views/blorgh/posts/show.html.erb</code>:</p>

<pre>&lt;%= render &quot;blorgh/comments/form&quot; %&gt;</pre>

<p>Next, the partial that this line will render needs to exist. Create a new
directory at <code>app/views/blorgh/comments</code> and in it a new file
called <code>_form.html.erb</code> which has this content to create the
required partial:</p>

<pre>&lt;h3&gt;New comment&lt;/h3&gt;
&lt;%= form_for [@post, @post.comments.build] do |f| %&gt;
  &lt;p&gt;
    &lt;%= f.label :text %&gt;&lt;br&gt;
    &lt;%= f.text_area :text %&gt;
  &lt;/p&gt;
  &lt;%= f.submit %&gt;
&lt;% end %&gt;</pre>

<p>When this form is submitted, it is going to attempt to perform a
<code>POST</code> request to a route of
<code>/posts/:post_id/comments</code> within the engine. This route
doesn&#39;t exist at the moment, but can be created by changing the
<code>resources :posts</code> line inside <code>config/routes.rb</code>
into these lines:</p>

<pre class="ruby"><span class="ruby-identifier">resources</span> :<span class="ruby-identifier">posts</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">resources</span> :<span class="ruby-identifier">comments</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This creates a nested route for the comments, which is what the form
requires.</p>

<p>The route now exists, but the controller that this route goes to does not.
To create it, run this command from the application root:</p>

<pre>$ bin/rails g controller comments</pre>

<p>This will generate the following things:</p>

<pre>create  app/controllers/blorgh/comments_controller.rb
invoke  erb
 exist    app/views/blorgh/comments
invoke  test_unit
create    test/controllers/blorgh/comments_controller_test.rb
invoke  helper
create    app/helpers/blorgh/comments_helper.rb
invoke    test_unit
create      test/helpers/blorgh/comments_helper_test.rb
invoke  assets
invoke    js
create      app/assets/javascripts/blorgh/comments.js
invoke    css
create      app/assets/stylesheets/blorgh/comments.css</pre>

<p>The form will be making a <code>POST</code> request to
<code>/posts/:post_id/comments</code>, which will correspond with the
<code>create</code> action in <code>Blorgh::CommentsController</code>. This
action needs to be created, which can be done by putting the following
lines inside the class definition in
<code>app/controllers/blorgh/comments_controller.rb</code>:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
  <span class="ruby-ivar">@post</span> = <span class="ruby-constant">Post</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[:<span class="ruby-identifier">post_id</span>])
  <span class="ruby-ivar">@comment</span> = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">comment_params</span>)
  <span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">notice</span>] = <span class="ruby-string">&quot;Comment has been created!&quot;</span>
  <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">posts_path</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">private</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">comment_params</span>
    <span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">comment</span>).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">text</span>)
  <span class="ruby-keyword">end</span>
</pre>

<p>This is the final step required to get the new comment form working.
Displaying the comments, however, is not quite right yet. If you were to
create a comment right now, you would see this error:</p>

<pre class="ruby"><span class="ruby-constant">Missing</span> <span class="ruby-identifier">partial</span> <span class="ruby-identifier">blorgh</span><span class="ruby-operator">/</span><span class="ruby-identifier">comments</span><span class="ruby-operator">/</span><span class="ruby-identifier">comment</span> <span class="ruby-identifier">with</span> {:<span class="ruby-identifier">handlers=</span><span class="ruby-operator">&gt;</span>[:<span class="ruby-identifier">erb</span>, :<span class="ruby-identifier">builder</span>],
:<span class="ruby-identifier">formats=</span><span class="ruby-operator">&gt;</span>[:<span class="ruby-identifier">html</span>], :<span class="ruby-identifier">locale=</span><span class="ruby-operator">&gt;</span>[:<span class="ruby-identifier">en</span>, :<span class="ruby-identifier">en</span>]}. <span class="ruby-constant">Searched</span> <span class="ruby-keyword">in</span><span class="ruby-operator">:</span>   <span class="ruby-operator">*</span>
<span class="ruby-string">&quot;/Users/ryan/Sites/side_projects/blorgh/test/dummy/app/views&quot;</span>   <span class="ruby-operator">*</span>
<span class="ruby-string">&quot;/Users/ryan/Sites/side_projects/blorgh/app/views&quot;</span>
</pre>

<p>The engine is unable to find the partial required for rendering the
comments. Rails looks first in the application&#39;s
(<code>test/dummy</code>) <code>app/views</code> directory and then in the
engine&#39;s <code>app/views</code> directory. When it can&#39;t find it,
it will throw this error. The engine knows to look for
<code>blorgh/comments/comment</code> because the model object it is
receiving is from the <code>Blorgh::Comment</code> class.</p>

<p>This partial will be responsible for rendering just the comment text, for
now. Create a new file at
<code>app/views/blorgh/comments/_comment.html.erb</code> and put this line
inside it:</p>

<pre>&lt;%= comment_counter + 1 %&gt;. &lt;%= comment.text %&gt;</pre>

<p>The <code>comment_counter</code> local variable is given to us by the
<code>&lt;%= render @post.comments %&gt;</code> call, which will define it
automatically and increment the counter as it iterates through each
comment. It&#39;s used in this example to display a small number next to
each comment when it&#39;s created.</p>

<p>That completes the comment function of the blogging engine. Now it&#39;s
time to use it within an application.</p>

<h2 id="label-Hooking+Into+an+Application">Hooking Into an Application<span><a href="#label-Hooking+Into+an+Application">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Using an engine within an application is very easy. This section covers how
to mount the engine into an application and the initial setup required, as
well as linking the engine to a <code>User</code> class provided by the
application to provide ownership for posts and comments within the engine.</p>

<h3 id="label-Mounting+the+Engine">Mounting the Engine<span><a href="#label-Mounting+the+Engine">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>First, the engine needs to be specified inside the application&#39;s
<code>Gemfile</code>. If there isn&#39;t an application handy to test this
out in, generate one using the <code>rails new</code> command outside of
the engine directory like this:</p>

<pre>$ rails new unicorn</pre>

<p>Usually, specifying the engine inside the <a
href="../code/getting_started/Gemfile.html">Gemfile</a> would be done by
specifying it as a normal, everyday gem.</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;devise&#39;</span>
</pre>

<p>However, because you are developing the <code>blorgh</code> engine on your
local machine, you will need to specify the <code>:path</code> option in
your <code>Gemfile</code>:</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;blorgh&#39;</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;/path/to/blorgh&quot;</span>
</pre>

<p>Then run <code>bundle</code> to install the gem.</p>

<p>As described earlier, by placing the gem in the <code>Gemfile</code> it
will be loaded when Rails is loaded. It will first require
<code>lib/blorgh.rb</code> from the engine, then
<code>lib/blorgh/engine.rb</code>, which is the file that defines the major
pieces of functionality for the engine.</p>

<p>To make the engine&#39;s functionality accessible from within an
application, it needs to be mounted in that application&#39;s
<code>config/routes.rb</code> file:</p>

<pre class="ruby"><span class="ruby-identifier">mount</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>, <span class="ruby-identifier">at</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;/blog&quot;</span>
</pre>

<p>This line will mount the engine at <code>/blog</code> in the application.
Making it accessible at <code>http://localhost:3000/blog</code> when the
application runs with <code>rails server</code>.</p>

<p>NOTE: Other engines, such as Devise, handle this a little differently by
making you specify custom helpers (such as <code>devise_for</code>) in the
routes. These helpers do exactly the same thing, mounting pieces of the
engines&#39;s functionality at a pre-defined path which may be
customizable.</p>

<h3 id="label-Engine+setup">Engine setup<span><a href="#label-Engine+setup">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The engine contains migrations for the <code>blorgh_posts</code> and
<code>blorgh_comments</code> table which need to be created in the
application&#39;s database so that the engine&#39;s models can query them
correctly. To copy these migrations into the application use this command:</p>

<pre>$ bin/rake blorgh:install:migrations</pre>

<p>If you have multiple engines that need migrations copied over, use
<code>railties:install:migrations</code> instead:</p>

<pre>$ bin/rake railties:install:migrations</pre>

<p>This command, when run for the first time, will copy over all the
migrations from the engine. When run the next time, it will only copy over
migrations that haven&#39;t been copied over already. The first run for
this command will output something such as this:</p>

<pre>Copied migration [timestamp_1]_create_blorgh_posts.rb from blorgh
Copied migration [timestamp_2]_create_blorgh_comments.rb from blorgh</pre>

<p>The first timestamp (<code>[timestamp_1]</code>) will be the current time,
and the second timestamp (<code>[timestamp_2]</code>) will be the current
time plus a second. The reason for this is so that the migrations for the
engine are run after any existing migrations in the application.</p>

<p>To run these migrations within the context of the application, simply run
<code>rake db:migrate</code>. When accessing the engine through
<code>http://localhost:3000/blog</code>, the posts will be empty. This is
because the table created inside the application is different from the one
created within the engine. Go ahead, play around with the newly mounted
engine. You&#39;ll find that it&#39;s the same as when it was only an
engine.</p>

<p>If you would like to run migrations only from one engine, you can do it by
specifying <code>SCOPE</code>:</p>

<pre>rake db:migrate SCOPE=blorgh</pre>

<p>This may be useful if you want to revert engine&#39;s migrations before
removing it. To revert all migrations from blorgh engine you can run code
such as:</p>

<pre>rake db:migrate SCOPE=blorgh VERSION=0</pre>

<h3 id="label-Using+a+Class+Provided+by+the+Application">Using a Class Provided by the Application<span><a href="#label-Using+a+Class+Provided+by+the+Application">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<h4 id="label-Using+a+Model+Provided+by+the+Application">Using a Model Provided by the Application<span><a href="#label-Using+a+Model+Provided+by+the+Application">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>When an engine is created, it may want to use specific classes from an
application to provide links between the pieces of the engine and the
pieces of the application. In the case of the <code>blorgh</code> engine,
making posts and comments have authors would make a lot of sense.</p>

<p>A typical application might have a <code>User</code> class that would be
used to represent authors for a post or a comment. But there could be a
case where the application calls this class something different, such as
<code>Person</code>. For this reason, the engine should not hardcode
associations specifically for a <code>User</code> class.</p>

<p>To keep it simple in this case, the application will have a class called
<code>User</code> that represents the users of the application. It can be
generated using this command inside the application:</p>

<pre>rails g model user name:string</pre>

<p>The <code>rake db:migrate</code> command needs to be run here to ensure
that our application has the <code>users</code> table for future use.</p>

<p>Also, to keep it simple, the posts form will have a new text field called
<code>author_name</code>, where users can elect to put their name. The
engine will then take this name and either create a new <code>User</code>
object from it, or find one that already has that name. The engine will
then associate the post with the found or created <code>User</code> object.</p>

<p>First, the <code>author_name</code> text field needs to be added to the
<code>app/views/blorgh/posts/_form.html.erb</code> partial inside the
engine. This can be added above the <code>title</code> field with this
code:</p>

<pre>&lt;div class=&quot;field&quot;&gt;
  &lt;%= f.label :author_name %&gt;&lt;br&gt;
  &lt;%= f.text_field :author_name %&gt;
&lt;/div&gt;</pre>

<p>Next, we need to update our <code>Blorgh::PostController#post_params</code>
method to permit the new form parameter:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">post_params</span>
  <span class="ruby-identifier">params</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">post</span>).<span class="ruby-identifier">permit</span>(:<span class="ruby-identifier">title</span>, :<span class="ruby-identifier">text</span>, :<span class="ruby-identifier">author_name</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>Blorgh::Post</code> model should then have some code to convert
the <code>author_name</code> field into an actual <code>User</code> object
and associate it as that post&#39;s <code>author</code> before the post is
saved. It will also need to have an <code>attr_accessor</code> set up for
this field, so that the setter and getter methods are defined for it.</p>

<p>To do all this, you&#39;ll need to add the <code>attr_accessor</code> for
<code>author_name</code>, the association for the author and the
<code>before_save</code> call into <code>app/models/blorgh/post.rb</code>.
The <code>author</code> association will be hard-coded to the
<code>User</code> class for the time being.</p>

<pre class="ruby"><span class="ruby-identifier">attr_accessor</span> :<span class="ruby-identifier">author_name</span>
<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">author</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;User&quot;</span>

<span class="ruby-identifier">before_save</span> :<span class="ruby-identifier">set_author</span>

<span class="ruby-identifier">private</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">set_author</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">author</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_or_create_by</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">author_name</span>)
  <span class="ruby-keyword">end</span>
</pre>

<p>By representing the <code>author</code> association&#39;s object with the
<code>User</code> class, a link is established between the engine and the
application. There needs to be a way of associating the records in the
<code>blorgh_posts</code> table with the records in the <code>users</code>
table. Because the association is called <code>author</code>, there should
be an <code>author_id</code> column added to the <code>blorgh_posts</code>
table.</p>

<p>To generate this new column, run this command within the engine:</p>

<pre>$ bin/rails g migration add_author_id_to_blorgh_posts author_id:integer</pre>

<p>NOTE: Due to the migration&#39;s name and the column specification after
it, Rails will automatically know that you want to add a column to a
specific table and write that into the migration for you. You don&#39;t
need to tell it any more than this.</p>

<p>This migration will need to be run on the application. To do that, it must
first be copied using this command:</p>

<pre>$ bin/rake blorgh:install:migrations</pre>

<p>Notice that only <em>one</em> migration was copied over here. This is
because the first two migrations were copied over the first time this
command was run.</p>

<pre>NOTE Migration [timestamp]_create_blorgh_posts.rb from blorgh has been
skipped. Migration with the same name already exists. NOTE Migration
[timestamp]_create_blorgh_comments.rb from blorgh has been skipped. Migration
with the same name already exists. Copied migration
[timestamp]_add_author_id_to_blorgh_posts.rb from blorgh</pre>

<p>Run the migration using:</p>

<pre>$ bin/rake db:migrate</pre>

<p>Now with all the pieces in place, an action will take place that will
associate an author - represented by a record in the <code>users</code>
table - with a post, represented by the <code>blorgh_posts</code> table
from the engine.</p>

<p>Finally, the author&#39;s name should be displayed on the post&#39;s page.
Add this code above the “Title” output inside
<code>app/views/blorgh/posts/show.html.erb</code>:</p>

<pre>&lt;p&gt;
  &lt;b&gt;Author:&lt;/b&gt;
  &lt;%= @post.author %&gt;
&lt;/p&gt;</pre>

<p>By outputting <code>@post.author</code> using the <code>&lt;%=</code> tag,
the <code>to_s</code> method will be called on the object. By default, this
will look quite ugly:</p>

<pre>#&lt;User:0x00000100ccb3b0&gt;</pre>

<p>This is undesirable. It would be much better to have the user&#39;s name
there. To do this, add a <code>to_s</code> method to the <code>User</code>
class within the application:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">name</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now instead of the ugly Ruby object output, the author&#39;s name will be
displayed.</p>

<h4 id="label-Using+a+Controller+Provided+by+the+Application">Using a Controller Provided by the Application<span><a href="#label-Using+a+Controller+Provided+by+the+Application">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Because Rails controllers generally share code for things like
authentication and accessing session variables, they inherit from
<code>ApplicationController</code> by default. Rails engines, however are
scoped to run independently from the main application, so each engine gets
a scoped <code>ApplicationController</code>. This namespace prevents code
collisions, but often engine controllers need to access methods in the main
application&#39;s <code>ApplicationController</code>. An easy way to
provide this access is to change the engine&#39;s scoped
<code>ApplicationController</code> to inherit from the main
application&#39;s <code>ApplicationController</code>. For our Blorgh engine
this would be done by changing
<code>app/controllers/blorgh/application_controller.rb</code> to look like:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">ApplicationController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By default, the engine&#39;s controllers inherit from
<code>Blorgh::ApplicationController</code>. So, after making this change
they will have access to the main application&#39;s
<code>ApplicationController</code>, as though they were part of the main
application.</p>

<p>This change does require that the engine is run from a Rails application
that has an <code>ApplicationController</code>.</p>

<h3 id="label-Configuring+an+Engine">Configuring an Engine<span><a href="#label-Configuring+an+Engine">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This section covers how to make the <code>User</code> class configurable,
followed by general configuration tips for the engine.</p>

<h4 id="label-Setting+Configuration+Settings+in+the+Application">Setting Configuration Settings in the Application<span><a href="#label-Setting+Configuration+Settings+in+the+Application">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>The next step is to make the class that represents a <code>User</code> in
the application customizable for the engine. This is because that class may
not always be <code>User</code>, as previously explained. To make this
setting customizable, the engine will have a configuration setting called
<code>author_class</code> that will be used to specify which class
represents users inside the application.</p>

<p>To define this configuration setting, you should use a
<code>mattr_accessor</code> inside the <code>Blorgh</code> module for the
engine. Add this line to <code>lib/blorgh.rb</code> inside the engine:</p>

<pre class="ruby"><span class="ruby-identifier">mattr_accessor</span> :<span class="ruby-identifier">author_class</span>
</pre>

<p>This method works like its brothers, <code>attr_accessor</code> and
<code>cattr_accessor</code>, but provides a setter and getter method on the
module with the specified name. To use it, it must be referenced using
<code>Blorgh.author_class</code>.</p>

<p>The next step is to switch the <code>Blorgh::Post</code> model over to this
new setting. Change the <code>belongs_to</code> association inside this
model (<code>app/models/blorgh/post.rb</code>) to this:</p>

<pre class="ruby"><span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">author</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-constant">Blorgh</span>.<span class="ruby-identifier">author_class</span>
</pre>

<p>The <code>set_author</code> method in the <code>Blorgh::Post</code> model
should also use this class:</p>

<pre class="ruby"><span class="ruby-keyword">self</span>.<span class="ruby-identifier">author</span> = <span class="ruby-constant">Blorgh</span>.<span class="ruby-identifier">author_class</span>.<span class="ruby-identifier">constantize</span>.<span class="ruby-identifier">find_or_create_by</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">author_name</span>)
</pre>

<p>To save having to call <code>constantize</code> on the
<code>author_class</code> result all the time, you could instead just
override the <code>author_class</code> getter method inside the
<code>Blorgh</code> module in the <code>lib/blorgh.rb</code> file to always
call <code>constantize</code> on the saved value before returning the
result:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">author_class</span>
  <span class="ruby-identifier">@@author_class</span>.<span class="ruby-identifier">constantize</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This would then turn the above code for <code>set_author</code> into this:</p>

<pre class="ruby"><span class="ruby-keyword">self</span>.<span class="ruby-identifier">author</span> = <span class="ruby-constant">Blorgh</span>.<span class="ruby-identifier">author_class</span>.<span class="ruby-identifier">find_or_create_by</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">author_name</span>)
</pre>

<p>Resulting in something a little shorter, and more implicit in its behavior.
The <code>author_class</code> method should always return a
<code>Class</code> object.</p>

<p>Since we changed the <code>author_class</code> method to return a
<code>Class</code> instead of a <code>String</code>, we must also modify
our <code>belongs_to</code> definition in the <code>Blorgh::Post</code>
model:</p>

<pre class="ruby"><span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">author</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-constant">Blorgh</span>.<span class="ruby-identifier">author_class</span>.<span class="ruby-identifier">to_s</span>
</pre>

<p>To set this configuration setting within the application, an initializer
should be used. By using an initializer, the configuration will be set up
before the application starts and calls the engine&#39;s models, which may
depend on this configuration setting existing.</p>

<p>Create a new initializer at <code>config/initializers/blorgh.rb</code>
inside the application where the <code>blorgh</code> engine is installed
and put this content in it:</p>

<pre class="ruby"><span class="ruby-constant">Blorgh</span>.<span class="ruby-identifier">author_class</span> = <span class="ruby-string">&quot;User&quot;</span>
</pre>

<p>WARNING: It&#39;s very important here to use the <code>String</code>
version of the class, rather than the class itself. If you were to use the
class, Rails would attempt to load that class and then reference the
related table. This could lead to problems if the table wasn&#39;t already
existing. Therefore, a <code>String</code> should be used and then
converted to a class using <code>constantize</code> in the engine later on.</p>

<p>Go ahead and try to create a new post. You will see that it works exactly
in the same way as before, except this time the engine is using the
configuration setting in <code>config/initializers/blorgh.rb</code> to
learn what the class is.</p>

<p>There are now no strict dependencies on what the class is, only what the
API for the class must be. The engine simply requires this class to define
a <code>find_or_create_by</code> method which returns an object of that
class, to be associated with a post when it&#39;s created. This object, of
course, should have some sort of identifier by which it can be referenced.</p>

<h4 id="label-General+Engine+Configuration">General Engine Configuration<span><a href="#label-General+Engine+Configuration">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Within an engine, there may come a time where you wish to use things such
as initializers, internationalization or other configuration options. The
great news is that these things are entirely possible, because a Rails
engine shares much the same functionality as a Rails application. In fact,
a Rails application&#39;s functionality is actually a superset of what is
provided by engines!</p>

<p>If you wish to use an initializer - code that should run before the engine
is loaded - the place for it is the <code>config/initializers</code>
folder. This directory&#39;s functionality is explained in the <a
href="configuring.html#initializers">Initializers section</a> of the
Configuring guide, and works precisely the same way as the
<code>config/initializers</code> directory inside an application. The same
thing goes if you want to use a standard initializer.</p>

<p>For locales, simply place the locale files in the
<code>config/locales</code> directory, just like you would in an
application.</p>

<h2 id="label-Testing+an+engine">Testing an engine<span><a href="#label-Testing+an+engine">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>When an engine is generated, there is a smaller dummy application created
inside it at <code>test/dummy</code>. This application is used as a
mounting point for the engine, to make testing the engine extremely simple.
You may extend this application by generating controllers, models or views
from within the directory, and then use those to test your engine.</p>

<p>The <code>test</code> directory should be treated like a typical Rails
testing environment, allowing for unit, functional and integration tests.</p>

<h3 id="label-Functional+Tests">Functional Tests<span><a href="#label-Functional+Tests">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>A matter worth taking into consideration when writing functional tests is
that the tests are going to be running on an application - the
<code>test/dummy</code> application - rather than your engine. This is due
to the setup of the testing environment; an engine needs an application as
a host for testing its main functionality, especially controllers. This
means that if you were to make a typical <code>GET</code> to a controller
in a controller&#39;s functional test like this:</p>

<pre class="ruby"><span class="ruby-identifier">get</span> :<span class="ruby-identifier">index</span>
</pre>

<p>It may not function correctly. This is because the application doesn&#39;t
know how to route these requests to the engine unless you explicitly tell
it <strong>how</strong>. To do this, you must also pass the
<code>:use_route</code> option as a parameter on these requests:</p>

<pre class="ruby"><span class="ruby-identifier">get</span> :<span class="ruby-identifier">index</span>, <span class="ruby-identifier">use_route</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">blorgh</span>
</pre>

<p>This tells the application that you still want to perform a
<code>GET</code> request to the <code>index</code> action of this
controller, but you want to use the engine&#39;s route to get there, rather
than the application&#39;s one.</p>

<h2 id="label-Improving+engine+functionality">Improving engine functionality<span><a href="#label-Improving+engine+functionality">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>This section explains how to add and/or override engine MVC functionality
in the main Rails application.</p>

<h3 id="label-Overriding+Models+and+Controllers">Overriding Models and Controllers<span><a href="#label-Overriding+Models+and+Controllers">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Engine model and controller classes can be extended by open classing them
in the main Rails application (since model and controller classes are just
Ruby classes that inherit Rails specific functionality). Open classing an
Engine class redefines it for use in the main application. This is usually
implemented by using the decorator pattern.</p>

<p>For simple class modifications, use <code>Class#class_eval</code>. For
complex class modifications, consider using
<code>ActiveSupport::Concern</code>.</p>

<h4 id="label-A+note+on+Decorators+and+Loading+Code">A note on Decorators and Loading Code<span><a href="#label-A+note+on+Decorators+and+Loading+Code">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Because these decorators are not referenced by your Rails application
itself, Rails&#39; autoloading system will not kick in and load your
decorators. This means that you need to require them yourself.</p>

<p>Here is some sample code to do this:</p>

<pre class="ruby"><span class="ruby-comment"># lib/blorgh/engine.rb</span>
<span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Engine</span> <span class="ruby-operator">&lt;</span> <span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>
    <span class="ruby-identifier">isolate_namespace</span> <span class="ruby-constant">Blorgh</span>

    <span class="ruby-identifier">config</span>.<span class="ruby-identifier">to_prepare</span> <span class="ruby-keyword">do</span>
      <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">glob</span>(<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;app/decorators   /*_decorator*.rb&quot;</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">require_dependency</span>(<span class="ruby-identifier">c</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This doesn&#39;t apply to just Decorators, but anything that you add in an
engine that isn&#39;t referenced by your main application.</p>

<h4 id="label-Implementing+Decorator+Pattern+Using+Class%23class_eval">Implementing Decorator Pattern Using Class#class_eval<span><a href="#label-Implementing+Decorator+Pattern+Using+Class%23class_eval">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p><em>Adding</em>* <code>Post#time_since_created</code>:</p>

<pre class="ruby"><span class="ruby-comment"># MyApp/app/decorators/models/blorgh/post_decorator.rb</span>

<span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">time_since_created</span>
    <span class="ruby-constant">Time</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">created_at</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># Blorgh/app/models/post.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">comments</span>
<span class="ruby-keyword">end</span>
</pre>

<p><em>Overriding</em>* <code>Post#summary</code>:</p>

<pre class="ruby"><span class="ruby-comment"># MyApp/app/decorators/models/blorgh/post_decorator.rb</span>

<span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">summary</span>
    <span class="ruby-node">&quot;#{title} - #{truncate(text)}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># Blorgh/app/models/post.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">comments</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">summary</span>
    <span class="ruby-node">&quot;#{title}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-Implementing+Decorator+Pattern+Using+ActiveSupport%3A%3AConcern">Implementing Decorator Pattern Using ActiveSupport::Concern<span><a href="#label-Implementing+Decorator+Pattern+Using+ActiveSupport%3A%3AConcern">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Using <code>Class#class_eval</code> is great for simple adjustments, but
for more complex class modifications, you might want to consider using <a
href="http://edgeapi.rubyonrails.org/classes/ActiveSupport/Concern.html">ActiveSupport::Concern</a>.
ActiveSupport::Concern manages load order of interlinked dependent modules
and classes at run time allowing you to significantly modularize your code.</p>

<p><em>Adding</em>* <code>Post#time_since_created</code> and
<strong>Overriding</strong> <code>Post#summary</code>:</p>

<pre class="ruby"><span class="ruby-comment"># MyApp/app/models/blorgh/post.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Concerns</span><span class="ruby-operator">::</span><span class="ruby-constant">Models</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">time_since_created</span>
    <span class="ruby-constant">Time</span>.<span class="ruby-identifier">current</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">created_at</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">summary</span>
    <span class="ruby-node">&quot;#{title} - #{truncate(text)}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># Blorgh/app/models/post.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Post</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Concerns</span><span class="ruby-operator">::</span><span class="ruby-constant">Models</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># Blorgh/lib/concerns/models/post</span>

<span class="ruby-keyword">module</span> <span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Concerns</span><span class="ruby-operator">::</span><span class="ruby-constant">Models</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>
  <span class="ruby-identifier">extend</span> <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Concern</span>

  <span class="ruby-comment"># &#39;included do&#39; causes the included code to be evaluated in the</span>
  <span class="ruby-comment"># context where it is included (post.rb), rather than being</span>
  <span class="ruby-comment"># executed in the module&#39;s context (blorgh/concerns/models/post).</span>
  <span class="ruby-identifier">included</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">attr_accessor</span> :<span class="ruby-identifier">author_name</span>
    <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">author</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;User&quot;</span>

    <span class="ruby-identifier">before_save</span> :<span class="ruby-identifier">set_author</span>

    <span class="ruby-identifier">private</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier">set_author</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">author</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_or_create_by</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">author_name</span>)
      <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">summary</span>
    <span class="ruby-node">&quot;#{title}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">module</span> <span class="ruby-constant">ClassMethods</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">some_class_method</span>
      <span class="ruby-string">&#39;some class method string&#39;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Overriding+Views">Overriding Views<span><a href="#label-Overriding+Views">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>When Rails looks for a view to render, it will first look in the
<code>app/views</code> directory of the application. If it cannot find the
view there, it will check in the <code>app/views</code> directories of all
engines that have this directory.</p>

<p>When the application is asked to render the view for
<code>Blorgh::PostsController</code>&#39;s index action, it will first look
for the path <code>app/views/blorgh/posts/index.html.erb</code> within the
application. If it cannot find it, it will look inside the engine.</p>

<p>You can override this view in the application by simply creating a new file
at <code>app/views/blorgh/posts/index.html.erb</code>. Then you can
completely change what this view would normally output.</p>

<p>Try this now by creating a new file at
<code>app/views/blorgh/posts/index.html.erb</code> and put this content in
it:</p>

<pre>&lt;h1&gt;Posts&lt;/h1&gt;
&lt;%= link_to &quot;New Post&quot;, new_post_path %&gt;
&lt;% @posts.each do |post| %&gt;
  &lt;h2&gt;&lt;%= post.title %&gt;&lt;/h2&gt;
  &lt;small&gt;By &lt;%= post.author %&gt;&lt;/small&gt;
  &lt;%= simple_format(post.text) %&gt;
  &lt;hr&gt;
&lt;% end %&gt;</pre>

<h3 id="label-Routes">Routes<span><a href="#label-Routes">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Routes inside an engine are isolated from the application by default. This
is done by the <code>isolate_namespace</code> call inside the
<code>Engine</code> class. This essentially means that the application and
its engines can have identically named routes and they will not clash.</p>

<p>Routes inside an engine are drawn on the <code>Engine</code> class within
<code>config/routes.rb</code>, like this:</p>

<pre class="ruby"><span class="ruby-constant">Blorgh</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">resources</span> :<span class="ruby-identifier">posts</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By having isolated routes such as this, if you wish to link to an area of
an engine from within an application, you will need to use the engine&#39;s
routing proxy method. Calls to normal routing methods such as
<code>posts_path</code> may end up going to undesired locations if both the
application and the engine have such a helper defined.</p>

<p>For instance, the following example would go to the application&#39;s
<code>posts_path</code> if that template was rendered from the application,
or the engine&#39;s <code>posts_path</code> if it was rendered from the
engine:</p>

<pre>&lt;%= link_to &quot;Blog posts&quot;, posts_path %&gt;</pre>

<p>To make this route always use the engine&#39;s <code>posts_path</code>
routing helper method, we must call the method on the routing proxy method
that shares the same name as the engine.</p>

<pre>&lt;%= link_to &quot;Blog posts&quot;, blorgh.posts_path %&gt;</pre>

<p>If you wish to reference the application inside the engine in a similar
way, use the <code>main_app</code> helper:</p>

<pre>&lt;%= link_to &quot;Home&quot;, main_app.root_path %&gt;</pre>

<p>If you were to use this inside an engine, it would <strong>always</strong>
go to the application&#39;s root. If you were to leave off the
<code>main_app</code> “routing proxy” method call, it could potentially go
to the engine&#39;s or application&#39;s root, depending on where it was
called from.</p>

<p>If a template rendered from within an engine attempts to use one of the
application&#39;s routing helper methods, it may result in an undefined
method call. If you encounter such an issue, ensure that you&#39;re not
attempting to call the application&#39;s routing methods without the
<code>main_app</code> prefix from within the engine.</p>

<h3 id="label-Assets">Assets<span><a href="#label-Assets">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Assets within an engine work in an identical way to a full application.
Because the engine class inherits from <code>Rails::Engine</code>, the
application will know to look up assets in the engine&#39;s
&#39;app/assets&#39; and &#39;lib/assets&#39; directories.</p>

<p>Like all of the other components of an engine, the assets should be
namespaced. This means that if you have an asset called
<code>style.css</code>, it should be placed at
<code>app/assets/stylesheets/[engine name]/style.css</code>, rather than
<code>app/assets/stylesheets/style.css</code>. If this asset isn&#39;t
namespaced, there is a possibility that the host application could have an
asset named identically, in which case the application&#39;s asset would
take precedence and the engine&#39;s one would be ignored.</p>

<p>Imagine that you did have an asset located at
<code>app/assets/stylesheets/blorgh/style.css</code> To include this asset
inside an application, just use <code>stylesheet_link_tag</code> and
reference the asset as if it were inside the engine:</p>

<pre>&lt;%= stylesheet_link_tag &quot;blorgh/style.css&quot; %&gt;</pre>

<p>You can also specify these assets as dependencies of other assets using
Asset Pipeline require statements in processed files:</p>

<pre class="ruby"><span class="ruby-regexp">/*
  = require blorgh/s</span><span class="ruby-identifier">tyle</span>
</pre>

<p>INFO. Remember that in order to use languages like Sass or CoffeeScript,
you should add the relevant library to your engine&#39;s
<code>.gemspec</code>.</p>

<h3 id="label-Separate+Assets+%26+Precompiling">Separate Assets &amp; Precompiling<span><a href="#label-Separate+Assets+%26+Precompiling">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>There are some situations where your engine&#39;s assets are not required
by the host application. For example, say that you&#39;ve created an admin
functionality that only exists for your engine. In this case, the host
application doesn&#39;t need to require <code>admin.css</code> or
<code>admin.js</code>. Only the gem&#39;s admin layout needs these assets.
It doesn&#39;t make sense for the host app to include
<code>&quot;blorgh/admin.css&quot;</code> in its stylesheets. In this
situation, you should explicitly define these assets for precompilation.
This tells sprockets to add your engine assets when <code>rake
assets:precompile</code> is triggered.</p>

<p>You can define assets for precompilation in <code>engine.rb</code>:</p>

<pre class="ruby"><span class="ruby-identifier">initializer</span> <span class="ruby-string">&quot;blorgh.assets.precompile&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">app</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">app</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">precompile</span> <span class="ruby-operator">+=</span> <span class="ruby-node">%w(admin.css admin.js)</span>
<span class="ruby-keyword">end</span>
</pre>

<p>For more information, read the <a href="asset_pipeline.html">Asset Pipeline
guide</a>.</p>

<h3 id="label-Other+Gem+Dependencies">Other Gem Dependencies<span><a href="#label-Other+Gem+Dependencies">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Gem dependencies inside an engine should be specified inside the
<code>.gemspec</code> file at the root of the engine. The reason is that
the engine may be installed as a gem. If dependencies were to be specified
inside the <code>Gemfile</code>, these would not be recognized by a
traditional gem install and so they would not be installed, causing the
engine to malfunction.</p>

<p>To specify a dependency that should be installed with the engine during a
traditional <code>gem install</code>, specify it inside the
<code>Gem::Specification</code> block inside the <code>.gemspec</code> file
in the engine:</p>

<pre class="ruby"><span class="ruby-identifier">s</span>.<span class="ruby-identifier">add_dependency</span> <span class="ruby-string">&quot;moo&quot;</span>
</pre>

<p>To specify a dependency that should only be installed as a development
dependency of the application, specify it like this:</p>

<pre class="ruby"><span class="ruby-identifier">s</span>.<span class="ruby-identifier">add_development_dependency</span> <span class="ruby-string">&quot;moo&quot;</span>
</pre>

<p>Both kinds of dependencies will be installed when <code>bundle
install</code> is run inside of the application. The development
dependencies for the gem will only be used when the tests for the engine
are running.</p>

<p>Note that if you want to immediately require dependencies when the engine
is required, you should require them before the engine&#39;s
initialization. For example:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;other_engine/engine&#39;</span>
<span class="ruby-identifier">require</span> <span class="ruby-string">&#39;yet_another_engine/engine&#39;</span>

<span class="ruby-keyword">module</span> <span class="ruby-constant">MyEngine</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Engine</span> <span class="ruby-operator">&lt;</span> <span class="ruby-operator">::</span><span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Engine</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

