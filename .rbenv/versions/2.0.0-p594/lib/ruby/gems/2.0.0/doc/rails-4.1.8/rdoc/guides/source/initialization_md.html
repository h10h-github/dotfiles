<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>initialization - rails-4.1.8 Documentation</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-The+Rails+Initialization+Process">The Rails Initialization Process</a>
    <li><a href="#label-Launch%21">Launch!</a>
    <li><a href="#label-railties%2Fbin%2Frails"><code>railties/bin/rails</code></a>
    <li><a href="#label-railties%2Flib%2Frails%2Fapp_rails_loader.rb"><code>railties/lib/rails/app_rails_loader.rb</code></a>
    <li><a href="#label-bin%2Frails"><code>bin/rails</code></a>
    <li><a href="#label-config%2Fboot.rb"><code>config/boot.rb</code></a>
    <li><a href="#label-rails%2Fcommands.rb"><code>rails/commands.rb</code></a>
    <li><a href="#label-rails%2Fcommands%2Fcommand_tasks.rb"><code>rails/commands/command_tasks.rb</code></a>
    <li><a href="#label-actionpack%2Flib%2Faction_dispatch.rb"><code>actionpack/lib/action_dispatch.rb</code></a>
    <li><a href="#label-rails%2Fcommands%2Fserver.rb"><code>rails/commands/server.rb</code></a>
    <li><a href="#label-Rack%3A+lib%2Frack%2Fserver.rb">Rack: <code>lib/rack/server.rb</code></a>
    <li><a href="#label-config%2Fapplication"><code>config/application</code></a>
    <li><a href="#label-Rails%3A%3AServer%23start"><code>Rails::Server#start</code></a>
    <li><a href="#label-config%2Fenvironment.rb"><code>config/environment.rb</code></a>
    <li><a href="#label-config%2Fapplication.rb"><code>config/application.rb</code></a>
    <li><a href="#label-Loading+Rails">Loading Rails</a>
    <li><a href="#label-railties%2Flib%2Frails%2Fall.rb"><code>railties/lib/rails/all.rb</code></a>
    <li><a href="#label-Back+to+config%2Fenvironment.rb">Back to <code>config/environment.rb</code></a>
    <li><a href="#label-railties%2Flib%2Frails%2Fapplication.rb"><code>railties/lib/rails/application.rb</code></a>
    <li><a href="#label-Rack%3A+lib%2Frack%2Fserver.rb">Rack: lib/rack/server.rb</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile.html">Gemfile</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../guides/code/getting_started/README_rdoc.html">README</a>
  
    <li><a href="../../guides/code/getting_started/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/comments_js_coffee.html">comments.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/posts_js_coffee.html">posts.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/welcome_js_coffee.html">welcome.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/comments_css_scss.html">comments.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/posts_css_scss.html">posts.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/welcome_css_scss.html">welcome.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/config_ru.html">config.ru</a>
  
    <li><a href="../../guides/code/getting_started/public/404_html.html">404.html</a>
  
    <li><a href="../../guides/code/getting_started/public/422_html.html">422.html</a>
  
    <li><a href="../../guides/code/getting_started/public/500_html.html">500.html</a>
  
    <li><a href="../../guides/code/getting_started/public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../guides/code/getting_started/public/robots_txt.html">robots</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/migrations_md.html">migrations</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/initialization.md">

<h1 id="label-The+Rails+Initialization+Process">The Rails Initialization Process<span><a href="#label-The+Rails+Initialization+Process">&para;</a> <a href="#documentation">&uarr;</a></span></h1>

<p>This guide explains the internals of the initialization process in Rails as
of Rails 4. It is an extremely in-depth guide and recommended for advanced
Rails developers.</p>

<p>After reading this guide, you will know:</p>
<ul><li>
<p>How to use <code>rails server</code>.</p>
</li><li>
<p>The timeline of Rails&#39; initialization sequence.</p>
</li><li>
<p>Where different files are required by the boot sequence.</p>
</li><li>
<p>How the Rails::Server interface is defined and used.</p>
</li></ul>
<hr>

<p>This guide goes through every method call that is required to boot up the
Ruby on Rails stack for a default Rails 4 application, explaining each part
in detail along the way. For this guide, we will be focusing on what
happens when you execute <code>rails server</code> to boot your app.</p>

<p>NOTE: Paths in this guide are relative to Rails or a Rails application
unless otherwise specified.</p>

<p>TIP: If you want to follow along while browsing the Rails <a
href="https://github.com/rails/rails">source code</a>, we recommend that
you use the <code>t</code> key binding to open the file finder inside
GitHub and find files quickly.</p>

<h2 id="label-Launch%21">Launch!<span><a href="#label-Launch%21">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Let&#39;s start to boot and initialize the app. A Rails application is
usually started by running <code>rails console</code> or <code>rails
server</code>.</p>

<h3 id="label-railties%2Fbin%2Frails"><code>railties/bin/rails</code><span><a href="#label-railties%2Fbin%2Frails">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>rails</code> in the command <code>rails server</code> is a ruby
executable in your load path. This executable contains the following lines:</p>

<pre class="ruby"><span class="ruby-identifier">version</span> = <span class="ruby-string">&quot;&gt;= 0&quot;</span>
<span class="ruby-identifier">load</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">bin_path</span>(<span class="ruby-string">&#39;railties&#39;</span>, <span class="ruby-string">&#39;rails&#39;</span>, <span class="ruby-identifier">version</span>)
</pre>

<p>If you try out this command in a Rails console, you would see that this
loads <code>railties/bin/rails</code>. A part of the file
<code>railties/bin/rails.rb</code> has the following code:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;rails/cli&quot;</span>
</pre>

<p>The file <code>railties/lib/rails/cli</code> in turn calls
<code>Rails::AppRailsLoader.exec_app_rails</code>.</p>

<h3 id="label-railties%2Flib%2Frails%2Fapp_rails_loader.rb"><code>railties/lib/rails/app_rails_loader.rb</code><span><a href="#label-railties%2Flib%2Frails%2Fapp_rails_loader.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The primary goal of the function <code>exec_app_rails</code> is to execute
your app&#39;s <code>bin/rails</code>. If the current directory does not
have a <code>bin/rails</code>, it will navigate upwards until it finds a
<code>bin/rails</code> executable. Thus one can invoke a <code>rails</code>
command from anywhere inside a rails application.</p>

<p>For <code>rails server</code> the equivalent of the following command is
executed:</p>

<pre>$ exec ruby bin/rails server</pre>

<h3 id="label-bin%2Frails"><code>bin/rails</code><span><a href="#label-bin%2Frails">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This file is as follows:</p>

<pre class="ruby"><span class="ruby-comment">#!/usr/bin/env ruby</span>
<span class="ruby-constant">APP_PATH</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&#39;../../config/application&#39;</span>, <span class="ruby-keyword">__FILE__</span>)
<span class="ruby-identifier">require_relative</span> <span class="ruby-string">&#39;../config/boot&#39;</span>
<span class="ruby-identifier">require</span> <span class="ruby-string">&#39;rails/commands&#39;</span>
</pre>

<p>The <code>APP_PATH</code> constant will be used later in
<code>rails/commands</code>. The <code>config/boot</code> file referenced
here is the <code>config/boot.rb</code> file in our application which is
responsible for loading Bundler and setting it up.</p>

<h3 id="label-config%2Fboot.rb"><code>config/boot.rb</code><span><a href="#label-config%2Fboot.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p><code>config/boot.rb</code> contains:</p>

<pre class="ruby"><span class="ruby-comment"># Set up gems listed in the Gemfile.</span>
<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;BUNDLE_GEMFILE&#39;</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&#39;../../Gemfile&#39;</span>, <span class="ruby-keyword">__FILE__</span>)

<span class="ruby-identifier">require</span> <span class="ruby-string">&#39;bundler/setup&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;BUNDLE_GEMFILE&#39;</span>])
</pre>

<p>In a standard Rails application, there&#39;s a <code>Gemfile</code> which
declares all dependencies of the application. <code>config/boot.rb</code>
sets <code>ENV['BUNDLE_GEMFILE']</code> to the location of this file. If
the <a href="../code/getting_started/Gemfile.html">Gemfile</a> exists, then
<code>bundler/setup</code> is required. The require is used by Bundler to
configure the load path for your Gemfile&#39;s dependencies.</p>

<p>A standard Rails application depends on several gems, specifically:</p>
<ul><li>
<p>abstract</p>
</li><li>
<p>actionmailer</p>
</li><li>
<p>actionpack</p>
</li><li>
<p>activemodel</p>
</li><li>
<p>activerecord</p>
</li><li>
<p>activesupport</p>
</li><li>
<p>arel</p>
</li><li>
<p>builder</p>
</li><li>
<p>bundler</p>
</li><li>
<p>erubis</p>
</li><li>
<p>i18n</p>
</li><li>
<p>mail</p>
</li><li>
<p>mime-types</p>
</li><li>
<p>polyglot</p>
</li><li>
<p>rack</p>
</li><li>
<p>rack-cache</p>
</li><li>
<p>rack-mount</p>
</li><li>
<p>rack-test</p>
</li><li>
<p>rails</p>
</li><li>
<p>railties</p>
</li><li>
<p>rake</p>
</li><li>
<p>sqlite3-ruby</p>
</li><li>
<p>thor</p>
</li><li>
<p>treetop</p>
</li><li>
<p>tzinfo</p>
</li></ul>

<h3 id="label-rails%2Fcommands.rb"><code>rails/commands.rb</code><span><a href="#label-rails%2Fcommands.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Once <code>config/boot.rb</code> has finished, the next file that is
required is <code>rails/commands</code>, which helps in expanding aliases.
In the current case, the <code>ARGV</code> array simply contains
<code>server</code> which will be passed over:</p>

<pre class="ruby"><span class="ruby-constant">ARGV</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&#39;--help&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>

<span class="ruby-identifier">aliases</span> = {
  <span class="ruby-string">&quot;g&quot;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;generate&quot;</span>,
  <span class="ruby-string">&quot;d&quot;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;destroy&quot;</span>,
  <span class="ruby-string">&quot;c&quot;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;console&quot;</span>,
  <span class="ruby-string">&quot;s&quot;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;server&quot;</span>,
  <span class="ruby-string">&quot;db&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;dbconsole&quot;</span>,
  <span class="ruby-string">&quot;r&quot;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;runner&quot;</span>
}

<span class="ruby-identifier">command</span> = <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
<span class="ruby-identifier">command</span> = <span class="ruby-identifier">aliases</span>[<span class="ruby-identifier">command</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">command</span>

<span class="ruby-identifier">require</span> <span class="ruby-string">&#39;rails/commands/commands_tasks&#39;</span>

<span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">CommandsTasks</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">ARGV</span>).<span class="ruby-identifier">run_command!</span>(<span class="ruby-identifier">command</span>)
</pre>

<p>TIP: As you can see, an empty ARGV list will make Rails show the help
snippet.</p>

<p>If we had used <code>s</code> rather than <code>server</code>, Rails would
have used the <code>aliases</code> defined here to find the matching
command.</p>

<h3 id="label-rails%2Fcommands%2Fcommand_tasks.rb"><code>rails/commands/command_tasks.rb</code><span><a href="#label-rails%2Fcommands%2Fcommand_tasks.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>When one types an incorrect rails command, the <code>run_command</code> is
responsible for throwing an error message. If the command is valid, a
method of the same name is called.</p>

<pre class="ruby"><span class="ruby-constant">COMMAND_WHITELIST</span> = <span class="ruby-string">%Q(plugin generate destroy console server dbconsole application runner new version help)</span>

<span class="ruby-keyword">def</span> <span class="ruby-identifier">run_command!</span>(<span class="ruby-identifier">command</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-constant">COMMAND_WHITELIST</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">command</span>)
    <span class="ruby-identifier">send</span>(<span class="ruby-identifier">command</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">write_error_message</span>(<span class="ruby-identifier">command</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With the <code>server</code> command, Rails will further run the following
code:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">set_application_directory!</span>
  <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&#39;../../&#39;</span>, <span class="ruby-constant">APP_PATH</span>)) <span class="ruby-keyword">unless</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&quot;config.ru&quot;</span>))
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">def</span> <span class="ruby-identifier">server</span>
  <span class="ruby-identifier">set_application_directory!</span>
  <span class="ruby-identifier">require_command!</span>(<span class="ruby-string">&quot;server&quot;</span>)

  <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">tap</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">require</span> <span class="ruby-constant">APP_PATH</span>
    <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">chdir</span>(<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">root</span>)
    <span class="ruby-identifier">server</span>.<span class="ruby-identifier">start</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">def</span> <span class="ruby-identifier">require_command!</span>(<span class="ruby-identifier">command</span>)
  <span class="ruby-identifier">require</span> <span class="ruby-node">&quot;rails/commands/#{command}&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This file will change into the Rails root directory (a path two directories
up from <code>APP_PATH</code> which points at
<code>config/application.rb</code>), but only if the <code>config.ru</code>
file isn&#39;t found. This then requires <code>rails/commands/server</code>
which sets up the <code>Rails::Server</code> class.</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;fileutils&#39;</span>
<span class="ruby-identifier">require</span> <span class="ruby-string">&#39;optparse&#39;</span>
<span class="ruby-identifier">require</span> <span class="ruby-string">&#39;action_dispatch&#39;</span>

<span class="ruby-keyword">module</span> <span class="ruby-constant">Rails</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Server</span> <span class="ruby-operator">&lt;</span> <span class="ruby-operator">::</span><span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Server</span>
</pre>

<p><code>fileutils</code> and <code>optparse</code> are standard Ruby
libraries which provide helper functions for working with files and parsing
options.</p>

<h3 id="label-actionpack%2Flib%2Faction_dispatch.rb"><code>actionpack/lib/action_dispatch.rb</code><span><a href="#label-actionpack%2Flib%2Faction_dispatch.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Action Dispatch is the routing component of the Rails framework. It adds
functionality like routing, session, and common middlewares.</p>

<h3 id="label-rails%2Fcommands%2Fserver.rb"><code>rails/commands/server.rb</code><span><a href="#label-rails%2Fcommands%2Fserver.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>Rails::Server</code> class is defined in this file by inheriting
from <code>Rack::Server</code>. When <code>Rails::Server.new</code> is
called, this calls the <code>initialize</code> method in
<code>rails/commands/server.rb</code>:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-operator">*</span>)
  <span class="ruby-keyword">super</span>
  <span class="ruby-identifier">set_environment</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Firstly, <code>super</code> is called which calls the
<code>initialize</code> method on <code>Rack::Server</code>.</p>

<h3 id="label-Rack%3A+lib%2Frack%2Fserver.rb">Rack: <code>lib/rack/server.rb</code><span><a href="#label-Rack%3A+lib%2Frack%2Fserver.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p><code>Rack::Server</code> is responsible for providing a common server
interface for all Rack-based applications, which Rails is now a part of.</p>

<p>The <code>initialize</code> method in <code>Rack::Server</code> simply sets
a couple of variables:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>
  <span class="ruby-ivar">@app</span> = <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">app</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">app</span>]
<span class="ruby-keyword">end</span>
</pre>

<p>In this case, <code>options</code> will be <code>nil</code> so nothing
happens in this method.</p>

<p>After <code>super</code> has finished in <code>Rack::Server</code>, we jump
back to <code>rails/commands/server.rb</code>. At this point,
<code>set_environment</code> is called within the context of the
<code>Rails::Server</code> object and this method doesn&#39;t appear to do
much at first glance:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">set_environment</span>
  <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;RAILS_ENV&quot;</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">environment</span>]
<span class="ruby-keyword">end</span>
</pre>

<p>In fact, the <code>options</code> method here does quite a lot. This method
is defined in <code>Rack::Server</code> like this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">options</span>
  <span class="ruby-ivar">@options</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">parse_options</span>(<span class="ruby-constant">ARGV</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>Then <code>parse_options</code> is defined like this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">parse_options</span>(<span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">default_options</span>

  <span class="ruby-comment"># Don&#39;t evaluate CGI ISINDEX parameters.</span>
  <span class="ruby-comment"># http://www.meb.uni-bonn.de/docs/cgi/cl.html</span>
  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">clear</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;REQUEST_METHOD&quot;</span>)

  <span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">opt_parser</span>.<span class="ruby-identifier">parse!</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">config</span>] = <span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">config</span>])
  <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;RACK_ENV&quot;</span>] = <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">environment</span>]
  <span class="ruby-identifier">options</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With the <code>default_options</code> set to this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">default_options</span>
  {
    <span class="ruby-identifier">environment</span><span class="ruby-operator">:</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;RACK_ENV&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-string">&quot;development&quot;</span>,
    <span class="ruby-identifier">pid</span><span class="ruby-operator">:</span>         <span class="ruby-keyword">nil</span>,
    <span class="ruby-constant">Port</span><span class="ruby-operator">:</span>        <span class="ruby-value">9292</span>,
    <span class="ruby-constant">Host</span><span class="ruby-operator">:</span>        <span class="ruby-string">&quot;0.0.0.0&quot;</span>,
    <span class="ruby-constant">AccessLog</span><span class="ruby-operator">:</span>   [],
    <span class="ruby-identifier">config</span><span class="ruby-operator">:</span>      <span class="ruby-string">&quot;config.ru&quot;</span>
  }
<span class="ruby-keyword">end</span>
</pre>

<p>There is no <code>REQUEST_METHOD</code> key in <code>ENV</code> so we can
skip over that line. The next line merges in the options from
<code>opt_parser</code> which is defined plainly in
<code>Rack::Server</code></p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">opt_parser</span>
  <span class="ruby-constant">Options</span>.<span class="ruby-identifier">new</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The class <strong>is</strong> defined in <code>Rack::Server</code>, but is
overwritten in <code>Rails::Server</code> to take different arguments. Its
<code>parse!</code> method begins like this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">parse!</span>(<span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">args</span>, <span class="ruby-identifier">options</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">dup</span>, {}

  <span class="ruby-identifier">opt_parser</span> = <span class="ruby-constant">OptionParser</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">opts</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">banner</span> = <span class="ruby-string">&quot;Usage: rails server [mongrel, thin, etc] [options]&quot;</span>
    <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">on</span>(<span class="ruby-string">&quot;-p&quot;</span>, <span class="ruby-string">&quot;--port=port&quot;</span>, <span class="ruby-constant">Integer</span>,
            <span class="ruby-string">&quot;Runs Rails on the specified port.&quot;</span>, <span class="ruby-string">&quot;Default: 3000&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">options</span>[:<span class="ruby-constant">Port</span>] = <span class="ruby-identifier">v</span> }
  <span class="ruby-operator">...</span>
</pre>

<p>This method will set up keys for the <code>options</code> which Rails will
then be able to use to determine how its server should run. After
<code>initialize</code> has finished, we jump back into
<code>rails/server</code> where <code>APP_PATH</code> (which was set
earlier) is required.</p>

<h3 id="label-config%2Fapplication"><code>config/application</code><span><a href="#label-config%2Fapplication">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>When <code>require APP_PATH</code> is executed,
<code>config/application.rb</code> is loaded (recall that
<code>APP_PATH</code> is defined in <code>bin/rails</code>). This file
exists in your application and it&#39;s free for you to change based on
your needs.</p>

<h3 id="label-Rails%3A%3AServer%23start"><code>Rails::Server#start</code><span><a href="#label-Rails%3A%3AServer%23start">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>After <code>config/application</code> is loaded, <code>server.start</code>
is called. This method is defined like this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">start</span>
  <span class="ruby-identifier">print_boot_information</span>
  <span class="ruby-identifier">trap</span>(:<span class="ruby-constant">INT</span>) { <span class="ruby-identifier">exit</span> }
  <span class="ruby-identifier">create_tmp_directories</span>
  <span class="ruby-identifier">log_to_stdout</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">log_stdout</span>]

  <span class="ruby-keyword">super</span>
  <span class="ruby-operator">...</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">private</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">print_boot_information</span>
    <span class="ruby-operator">...</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;=&gt; Run `rails server -h` for more startup options&quot;</span>
    <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;=&gt; Ctrl-C to shutdown server&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">daemonize</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">create_tmp_directories</span>
    <span class="ruby-node">%w(cache pids sessions sockets)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir_to_make</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>, <span class="ruby-string">&#39;tmp&#39;</span>, <span class="ruby-identifier">dir_to_make</span>))
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">log_to_stdout</span>
    <span class="ruby-identifier">wrapped_app</span> <span class="ruby-comment"># touch the app so the logger is set up</span>

    <span class="ruby-identifier">console</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">$stdout</span>)
    <span class="ruby-identifier">console</span>.<span class="ruby-identifier">formatter</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">formatter</span>
    <span class="ruby-identifier">console</span>.<span class="ruby-identifier">level</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">level</span>

    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">extend</span>(<span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">broadcast</span>(<span class="ruby-identifier">console</span>))
  <span class="ruby-keyword">end</span>
</pre>

<p>This is where the first output of the Rails initialization happens. This
method creates a trap for <code>INT</code> signals, so if you
<code>CTRL-C</code> the server, it will exit the process. As we can see
from the code here, it will create the <code>tmp/cache</code>,
<code>tmp/pids</code>, <code>tmp/sessions</code> and
<code>tmp/sockets</code> directories. It then calls
<code>wrapped_app</code> which is responsible for creating the Rack app,
before creating and assigning an instance of
<code>ActiveSupport::Logger</code>.</p>

<p>The <code>super</code> method will call <code>Rack::Server.start</code>
which begins its definition like this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">start</span> <span class="ruby-operator">&amp;</span><span class="ruby-identifier">blk</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">warn</span>]
    <span class="ruby-identifier">$-w</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">includes</span> = <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">include</span>]
    <span class="ruby-identifier">$LOAD_PATH</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">includes</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">library</span> = <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">require</span>]
    <span class="ruby-identifier">require</span> <span class="ruby-identifier">library</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">debug</span>]
    <span class="ruby-identifier">$DEBUG</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-identifier">require</span> <span class="ruby-string">&#39;pp&#39;</span>
    <span class="ruby-identifier">p</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">server</span>]
    <span class="ruby-identifier">pp</span> <span class="ruby-identifier">wrapped_app</span>
    <span class="ruby-identifier">pp</span> <span class="ruby-identifier">app</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">check_pid!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">pid</span>]

  <span class="ruby-comment"># Touch the wrapped app, so that the config.ru is loaded before</span>
  <span class="ruby-comment"># daemonization (i.e. before chdir, etc).</span>
  <span class="ruby-identifier">wrapped_app</span>

  <span class="ruby-identifier">daemonize_app</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">daemonize</span>]

  <span class="ruby-identifier">write_pid</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">pid</span>]

  <span class="ruby-identifier">trap</span>(:<span class="ruby-constant">INT</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">server</span>.<span class="ruby-identifier">respond_to?</span>(:<span class="ruby-identifier">shutdown</span>)
      <span class="ruby-identifier">server</span>.<span class="ruby-identifier">shutdown</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">exit</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">server</span>.<span class="ruby-identifier">run</span> <span class="ruby-identifier">wrapped_app</span>, <span class="ruby-identifier">options</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">blk</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The interesting part for a Rails app is the last line,
<code>server.run</code>. Here we encounter the <code>wrapped_app</code>
method again, which this time we&#39;re going to explore more (even though
it was executed before, and thus memoized by now).</p>

<pre class="ruby"><span class="ruby-ivar">@wrapped_app</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">build_app</span> <span class="ruby-identifier">app</span>
</pre>

<p>The <code>app</code> method here is defined like so:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">app</span>
  <span class="ruby-ivar">@app</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">config</span>]
      <span class="ruby-identifier">abort</span> <span class="ruby-node">&quot;configuration #{options[:config]} not found&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">app</span>, <span class="ruby-identifier">options</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Builder</span>.<span class="ruby-identifier">parse_file</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">config</span>], <span class="ruby-identifier">opt_parser</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">options</span>
    <span class="ruby-identifier">app</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>options[:config]</code> value defaults to <code>config.ru</code>
which contains this:</p>

<pre class="ruby"><span class="ruby-comment"># This file is used by Rack-based servers to start the application.</span>

<span class="ruby-identifier">require</span> <span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&#39;../config/environment&#39;</span>, <span class="ruby-keyword">__FILE__</span>)
<span class="ruby-identifier">run</span> <span class="ruby-operator">&lt;</span><span class="ruby-string">%Q app_const %&gt;
</span></pre>

<p>The <code>Rack::Builder.parse_file</code> method here takes the content
from this <code>config.ru</code> file and parses it using this code:</p>

<pre class="ruby"><span class="ruby-identifier">app</span> = <span class="ruby-identifier">eval</span> <span class="ruby-string">&quot;Rack::Builder.new {( &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">cfgfile</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;\n )}.to_app&quot;</span>,
    <span class="ruby-constant">TOPLEVEL_BINDING</span>, <span class="ruby-identifier">config</span>
</pre>

<p>The <code>initialize</code> method of <code>Rack::Builder</code> will take
the block here and execute it within an instance of
<code>Rack::Builder</code>. This is where the majority of the
initialization process of Rails happens. The <code>require</code> line for
<code>config/environment.rb</code> in <code>config.ru</code> is the first
to run:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-string">&#39;../config/environment&#39;</span>, <span class="ruby-keyword">__FILE__</span>)
</pre>

<h3 id="label-config%2Fenvironment.rb"><code>config/environment.rb</code><span><a href="#label-config%2Fenvironment.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This file is the common file required by <code>config.ru</code>
(<code>rails server</code>) and Passenger. This is where these two ways to
run the server meet; everything before this point has been Rack and Rails
setup.</p>

<p>This file begins with requiring <code>config/application.rb</code>.</p>

<h3 id="label-config%2Fapplication.rb"><code>config/application.rb</code><span><a href="#label-config%2Fapplication.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This file requires <code>config/boot.rb</code>, but only if it hasn&#39;t
been required before, which would be the case in <code>rails server</code>
but <strong>wouldn&#39;t</strong> be the case with Passenger.</p>

<p>Then the fun begins!</p>

<h2 id="label-Loading+Rails">Loading Rails<span><a href="#label-Loading+Rails">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>The next line in <code>config/application.rb</code> is:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&#39;rails/all&#39;</span>
</pre>

<h3 id="label-railties%2Flib%2Frails%2Fall.rb"><code>railties/lib/rails/all.rb</code><span><a href="#label-railties%2Flib%2Frails%2Fall.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>This file is responsible for requiring all the individual frameworks of
Rails:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;rails&quot;</span>

<span class="ruby-node">%w(
    active_record
    action_controller
    action_mailer
    rails/test_unit
    sprockets
)</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">framework</span><span class="ruby-operator">|</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">require</span> <span class="ruby-node">&quot;#{framework}/railtie&quot;</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">LoadError</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This is where all the Rails frameworks are loaded and thus made available
to the application. We won&#39;t go into detail of what happens inside each
of those frameworks, but you&#39;re encouraged to try and explore them on
your own.</p>

<p>For now, just keep in mind that common functionality like Rails engines,
I18n and Rails configuration are all being defined here.</p>

<h3 id="label-Back+to+config%2Fenvironment.rb">Back to <code>config/environment.rb</code><span><a href="#label-Back+to+config%2Fenvironment.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The rest of <code>config/application.rb</code> defines the configuration
for the <code>Rails::Application</code> which will be used once the
application is fully initialized. When <code>config/application.rb</code>
has finished loading Rails and defined the application namespace, we go
back to <code>config/environment.rb</code>, where the application is
initialized. For example, if the application was called <code>Blog</code>,
here we would find <code>Rails.application.initialize!</code>, which is
defined in <code>rails/application.rb</code></p>

<h3 id="label-railties%2Flib%2Frails%2Fapplication.rb"><code>railties/lib/rails/application.rb</code><span><a href="#label-railties%2Flib%2Frails%2Fapplication.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>initialize!</code> method looks like this:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize!</span>(<span class="ruby-identifier">group</span>=:<span class="ruby-identifier">default</span>) <span class="ruby-comment">#:nodoc:</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Application has been already initialized.&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@initialized</span>
  <span class="ruby-identifier">run_initializers</span>(<span class="ruby-identifier">group</span>, <span class="ruby-keyword">self</span>)
  <span class="ruby-ivar">@initialized</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span>
</pre>

<p>As you can see, you can only initialize an app once. The initializers are
run through the <code>run_initializers</code> method which is defined in
<code>railties/lib/rails/initializable.rb</code></p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">run_initializers</span>(<span class="ruby-identifier">group</span>=:<span class="ruby-identifier">default</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">instance_variable_defined?</span>(:<span class="ruby-ivar">@ran</span>)
  <span class="ruby-identifier">initializers</span>.<span class="ruby-identifier">tsort_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">initializer</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">initializer</span>.<span class="ruby-identifier">run</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">initializer</span>.<span class="ruby-identifier">belongs_to?</span>(<span class="ruby-identifier">group</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@ran</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The run_initializers code itself is tricky. What Rails is doing here is
traversing all the class ancestors looking for those that respond to an
<code>initializers</code> method. It then sorts the ancestors by name, and
runs them. For example, the <code>Engine</code> class will make all the
engines available by providing an <code>initializers</code> method on them.</p>

<p>The <code>Rails::Application</code> class, as defined in
<code>railties/lib/rails/application.rb</code> defines
<code>bootstrap</code>, <code>railtie</code>, and <code>finisher</code>
initializers. The <code>bootstrap</code> initializers prepare the
application (like initializing the logger) while the <code>finisher</code>
initializers (like building the middleware stack) are run last. The
<code>railtie</code> initializers are the initializers which have been
defined on the <code>Rails::Application</code> itself and are run between
the <code>bootstrap</code> and <code>finishers</code>.</p>

<p>After this is done we go back to <code>Rack::Server</code></p>

<h3 id="label-Rack%3A+lib%2Frack%2Fserver.rb">Rack: lib/rack/server.rb<span><a href="#label-Rack%3A+lib%2Frack%2Fserver.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Last time we left when the <code>app</code> method was being defined:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">app</span>
  <span class="ruby-ivar">@app</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-operator">::</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">config</span>]
      <span class="ruby-identifier">abort</span> <span class="ruby-node">&quot;configuration #{options[:config]} not found&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">app</span>, <span class="ruby-identifier">options</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Builder</span>.<span class="ruby-identifier">parse_file</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">config</span>], <span class="ruby-identifier">opt_parser</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">options</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">options</span>
    <span class="ruby-identifier">app</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>At this point <code>app</code> is the Rails app itself (a middleware), and
what happens next is Rack will call all the provided middlewares:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier">build_app</span>(<span class="ruby-identifier">app</span>)
  <span class="ruby-identifier">middleware</span>[<span class="ruby-identifier">options</span>[:<span class="ruby-identifier">environment</span>]].<span class="ruby-identifier">reverse_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">middleware</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">middleware</span> = <span class="ruby-identifier">middleware</span>.<span class="ruby-identifier">call</span>(<span class="ruby-keyword">self</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">middleware</span>.<span class="ruby-identifier">respond_to?</span>(:<span class="ruby-identifier">call</span>)
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">middleware</span>
    <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">middleware</span>.<span class="ruby-identifier">shift</span>
    <span class="ruby-identifier">app</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">app</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">middleware</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">app</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Remember, <code>build_app</code> was called (by wrapped_app) in the last
line of <code>Server#start</code>. Here&#39;s how it looked like when we
left:</p>

<pre class="ruby"><span class="ruby-identifier">server</span>.<span class="ruby-identifier">run</span> <span class="ruby-identifier">wrapped_app</span>, <span class="ruby-identifier">options</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">blk</span>
</pre>

<p>At this point, the implementation of <code>server.run</code> will depend on
the server you&#39;re using. For example, if you were using Mongrel,
here&#39;s what the <code>run</code> method would look like:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">run</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">options</span>={})
  <span class="ruby-identifier">server</span> = <span class="ruby-operator">::</span><span class="ruby-constant">Mongrel</span><span class="ruby-operator">::</span><span class="ruby-constant">HttpServer</span>.<span class="ruby-identifier">new</span>(
    <span class="ruby-identifier">options</span>[:<span class="ruby-constant">Host</span>]           <span class="ruby-operator">||</span> <span class="ruby-string">&#39;0.0.0.0&#39;</span>,
    <span class="ruby-identifier">options</span>[:<span class="ruby-constant">Port</span>]           <span class="ruby-operator">||</span> <span class="ruby-value">8080</span>,
    <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">num_processors</span>] <span class="ruby-operator">||</span> <span class="ruby-value">950</span>,
    <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">throttle</span>]       <span class="ruby-operator">||</span> <span class="ruby-value">0</span>,
    <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">timeout</span>]        <span class="ruby-operator">||</span> <span class="ruby-value">60</span>)
  <span class="ruby-comment"># Acts like Rack::URLMap, utilizing Mongrel&#39;s own path finding methods.</span>
  <span class="ruby-comment"># Use is similar to #run, replacing the app argument with a hash of</span>
  <span class="ruby-comment"># { path=&gt;app, ... } or an instance of Rack::URLMap.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[:<span class="ruby-identifier">map</span>]
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">app</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Hash</span>
      <span class="ruby-identifier">app</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">appl</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">path</span> = <span class="ruby-string">&#39;/&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">path</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">path</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">?/</span>
        <span class="ruby-identifier">server</span>.<span class="ruby-identifier">register</span>(<span class="ruby-identifier">path</span>, <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Handler</span><span class="ruby-operator">::</span><span class="ruby-constant">Mongrel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">appl</span>))
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">app</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">URLMap</span>
      <span class="ruby-identifier">app</span>.<span class="ruby-identifier">instance_variable_get</span>(:<span class="ruby-ivar">@mapping</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">host</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">appl</span>)<span class="ruby-operator">|</span>
       <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[:<span class="ruby-constant">Host</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">options</span>[:<span class="ruby-constant">Host</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">host</span>
       <span class="ruby-identifier">path</span> = <span class="ruby-string">&#39;/&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">path</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">path</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">?/</span>
       <span class="ruby-identifier">server</span>.<span class="ruby-identifier">register</span>(<span class="ruby-identifier">path</span>, <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Handler</span><span class="ruby-operator">::</span><span class="ruby-constant">Mongrel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">appl</span>))
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;first argument should be a Hash or URLMap&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">server</span>.<span class="ruby-identifier">register</span>(<span class="ruby-string">&#39;/&#39;</span>, <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Handler</span><span class="ruby-operator">::</span><span class="ruby-constant">Mongrel</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">app</span>))
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">yield</span> <span class="ruby-identifier">server</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block_given?</span>
  <span class="ruby-identifier">server</span>.<span class="ruby-identifier">run</span>.<span class="ruby-identifier">join</span>
<span class="ruby-keyword">end</span>
</pre>

<p>We won&#39;t dig into the server configuration itself, but this is the last
piece of our journey in the Rails initialization process.</p>

<p>This high level overview will help you understand when your code is
executed and how, and overall become a better Rails developer. If you still
want to know more, the Rails source code itself is probably the best place
to go next.</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

