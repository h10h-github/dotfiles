<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>migrations - rails-4.1.8 Documentation</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Active+Record+Migrations">Active Record Migrations</a>
    <li><a href="#label-Migration+Overview">Migration Overview</a>
    <li><a href="#label-Creating+a+Migration">Creating a Migration</a>
    <li><a href="#label-Creating+a+Standalone+Migration">Creating a Standalone Migration</a>
    <li><a href="#label-Model+Generators">Model Generators</a>
    <li><a href="#label-Passing+Modifiers">Passing Modifiers</a>
    <li><a href="#label-Writing+a+Migration">Writing a Migration</a>
    <li><a href="#label-Creating+a+Table">Creating a Table</a>
    <li><a href="#label-Creating+a+Join+Table">Creating a Join Table</a>
    <li><a href="#label-Changing+Tables">Changing Tables</a>
    <li><a href="#label-Changing+Columns">Changing Columns</a>
    <li><a href="#label-Column+Modifiers">Column Modifiers</a>
    <li><a href="#label-When+Helpers+aren%27t+Enough">When Helpers aren&#39;t Enough</a>
    <li><a href="#label-Using+the+change+Method">Using the <code>change</code> Method</a>
    <li><a href="#label-Using+reversible">Using <code>reversible</code></a>
    <li><a href="#label-Using+the+up%2Fdown+Methods">Using the <code>up</code>/<code>down</code> Methods</a>
    <li><a href="#label-Reverting+Previous+Migrations">Reverting Previous Migrations</a>
    <li><a href="#label-Running+Migrations">Running Migrations</a>
    <li><a href="#label-Rolling+Back">Rolling Back</a>
    <li><a href="#label-Setup+the+Database">Setup the Database</a>
    <li><a href="#label-Resetting+the+Database">Resetting the Database</a>
    <li><a href="#label-Running+Specific+Migrations">Running Specific Migrations</a>
    <li><a href="#label-Running+Migrations+in+Different+Environments">Running Migrations in Different Environments</a>
    <li><a href="#label-Changing+the+Output+of+Running+Migrations">Changing the Output of Running Migrations</a>
    <li><a href="#label-Changing+Existing+Migrations">Changing Existing Migrations</a>
    <li><a href="#label-Using+Models+in+Your+Migrations">Using Models in Your Migrations</a>
    <li><a href="#label-Schema+Dumping+and+You">Schema Dumping and You</a>
    <li><a href="#label-What+are+Schema+Files+for%3F">What are Schema Files for?</a>
    <li><a href="#label-Types+of+Schema+Dumps">Types of Schema Dumps</a>
    <li><a href="#label-Schema+Dumps+and+Source+Control">Schema Dumps and Source Control</a>
    <li><a href="#label-Active+Record+and+Referential+Integrity">Active Record and Referential Integrity</a>
    <li><a href="#label-Migrations+and+Seed+Data">Migrations and Seed Data</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile.html">Gemfile</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../guides/code/getting_started/README_rdoc.html">README</a>
  
    <li><a href="../../guides/code/getting_started/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/comments_js_coffee.html">comments.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/posts_js_coffee.html">posts.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/welcome_js_coffee.html">welcome.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/comments_css_scss.html">comments.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/posts_css_scss.html">posts.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/welcome_css_scss.html">welcome.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/config_ru.html">config.ru</a>
  
    <li><a href="../../guides/code/getting_started/public/404_html.html">404.html</a>
  
    <li><a href="../../guides/code/getting_started/public/422_html.html">422.html</a>
  
    <li><a href="../../guides/code/getting_started/public/500_html.html">500.html</a>
  
    <li><a href="../../guides/code/getting_started/public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../guides/code/getting_started/public/robots_txt.html">robots</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/migrations_md.html">migrations</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/migrations.md">

<h1 id="label-Active+Record+Migrations">Active Record Migrations<span><a href="#label-Active+Record+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h1>

<p>Migrations are a feature of Active Record that allows you to evolve your
database schema over time. Rather than write schema modifications in pure
SQL, migrations allow you to use an easy Ruby DSL to describe changes to
your tables.</p>

<p>After reading this guide, you will know:</p>
<ul><li>
<p>The generators you can use to create them.</p>
</li><li>
<p>The methods Active Record provides to manipulate your database.</p>
</li><li>
<p>The Rake tasks that manipulate migrations and your schema.</p>
</li><li>
<p>How migrations relate to <code>schema.rb</code>.</p>
</li></ul>
<hr>

<h2 id="label-Migration+Overview">Migration Overview<span><a href="#label-Migration+Overview">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Migrations are a convenient way to alter your database schema over time in
a consistent and easy way. They use a Ruby DSL so that you don&#39;t have
to write SQL by hand, allowing your schema and changes to be database
independent.</p>

<p>You can think of each migration as being a new &#39;version&#39; of the
database. A schema starts off with nothing in it, and each migration
modifies it to add or remove tables, columns, or entries. Active Record
knows how to update your schema along this timeline, bringing it from
whatever point it is in the history to the latest version. Active Record
will also update your <code>db/schema.rb</code> file to match the
up-to-date structure of your database.</p>

<p>Here&#39;s an example of a migration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">text</span> :<span class="ruby-identifier">description</span>

      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This migration adds a table called <code>products</code> with a string
column called <code>name</code> and a text column called
<code>description</code>. A primary key column called <code>id</code> will
also be added implicitly, as it&#39;s the default primary key for all
Active Record models. The <code>timestamps</code> macro adds two columns,
<code>created_at</code> and <code>updated_at</code>. These special columns
are automatically managed by Active Record if they exist.</p>

<p>Note that we define the change that we want to happen moving forward in
time. Before this migration is run, there will be no table. After, the
table will exist. Active Record knows how to reverse this migration as
well: if we roll this migration back, it will remove the table.</p>

<p>On databases that support transactions with statements that change the
schema, migrations are wrapped in a transaction. If the database does not
support this then when a migration fails the parts of it that succeeded
will not be rolled back. You will have to rollback the changes that were
made by hand.</p>

<p>NOTE: There are certain queries that can&#39;t run inside a transaction. If
your adapter supports DDL transactions you can use
<code>disable_ddl_transaction!</code> to disable them for a single
migration.</p>

<p>If you wish for a migration to do something that Active Record doesn&#39;t
know how to reverse, you can use <code>reversible</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ChangeProductsPrice</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">change_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span>   { <span class="ruby-identifier">t</span>.<span class="ruby-identifier">change</span> :<span class="ruby-identifier">price</span>, :<span class="ruby-identifier">string</span> }
        <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">down</span> { <span class="ruby-identifier">t</span>.<span class="ruby-identifier">change</span> :<span class="ruby-identifier">price</span>, :<span class="ruby-identifier">integer</span> }
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Alternatively, you can use <code>up</code> and <code>down</code> instead of
<code>change</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ChangeProductsPrice</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">up</span>
    <span class="ruby-identifier">change_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">change</span> :<span class="ruby-identifier">price</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">down</span>
    <span class="ruby-identifier">change_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">change</span> :<span class="ruby-identifier">price</span>, :<span class="ruby-identifier">integer</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Creating+a+Migration">Creating a Migration<span><a href="#label-Creating+a+Migration">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<h3 id="label-Creating+a+Standalone+Migration">Creating a Standalone Migration<span><a href="#label-Creating+a+Standalone+Migration">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Migrations are stored as files in the <code>db/migrate</code> directory,
one for each migration class. The name of the file is of the form
<code>YYYYMMDDHHMMSS_create_products.rb</code>, that is to say a UTC
timestamp identifying the migration followed by an underscore followed by
the name of the migration. The name of the migration class (CamelCased
version) should match the latter part of the file name. For example
<code>20080906120000_create_products.rb</code> should define class
<code>CreateProducts</code> and
<code>20080906120001_add_details_to_products.rb</code> should define
<code>AddDetailsToProducts</code>. Rails uses this timestamp to determine
which migration should be run and in what order, so if you&#39;re copying a
migration from another application or generate a file yourself, be aware of
its position in the order.</p>

<p>Of course, calculating timestamps is no fun, so Active Record provides a
generator to handle making it for you:</p>

<pre>$ bin/rails generate migration AddPartNumberToProducts</pre>

<p>This will create an empty but appropriately named migration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddPartNumberToProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If the migration name is of the form “AddXXXToYYY” or “RemoveXXXFromYYY”
and is followed by a list of column names and types then a migration
containing the appropriate <code>add_column</code> and
<code>remove_column</code> statements will be created.</p>

<pre>$ bin/rails generate migration AddPartNumberToProducts part_number:string</pre>

<p>will generate</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddPartNumberToProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">part_number</span>, :<span class="ruby-identifier">string</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you&#39;d like to add an index on the new column, you can do that as
well:</p>

<pre>$ bin/rails generate migration AddPartNumberToProducts part_number:string:index</pre>

<p>will generate</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddPartNumberToProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">part_number</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">part_number</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Similarly, you can generate a migration to remove a column from the command
line:</p>

<pre>$ bin/rails generate migration RemovePartNumberFromProducts part_number:string</pre>

<p>generates</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">RemovePartNumberFromProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">remove_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">part_number</span>, :<span class="ruby-identifier">string</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You are not limited to one magically generated column. For example:</p>

<pre>$ bin/rails generate migration AddDetailsToProducts part_number:string price:decimal</pre>

<p>generates</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddDetailsToProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">part_number</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">price</span>, :<span class="ruby-identifier">decimal</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If the migration name is of the form “CreateXXX” and is followed by a list
of column names and types then a migration creating the table XXX with the
columns listed will be generated. For example:</p>

<pre>$ bin/rails generate migration CreateProducts name:string part_number:string</pre>

<p>generates</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">part_number</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>As always, what has been generated for you is just a starting point. You
can add or remove from it as you see fit by editing the
<code>db/migrate/YYYYMMDDHHMMSS_add_details_to_products.rb</code> file.</p>

<p>Also, the generator accepts column type as <code>references</code>(also
available as <code>belongs_to</code>). For instance:</p>

<pre>$ bin/rails generate migration AddUserRefToProducts user:references</pre>

<p>generates</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddUserRefToProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_reference</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">user</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This migration will create a <code>user_id</code> column and appropriate
index.</p>

<p>There is also a generator which will produce join tables if
<code>JoinTable</code> is part of the name:</p>

<pre>$ bin/rails g migration CreateJoinTableCustomerProduct customer product</pre>

<p>will produce the following migration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateJoinTableCustomerProduct</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_join_table</span> :<span class="ruby-identifier">customers</span>, :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># t.index [:customer_id, :product_id]</span>
      <span class="ruby-comment"># t.index [:product_id, :customer_id]</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Model+Generators">Model Generators<span><a href="#label-Model+Generators">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The model and scaffold generators will create migrations appropriate for
adding a new model. This migration will already contain instructions for
creating the relevant table. If you tell Rails what columns you want, then
statements for adding these columns will also be created. For example,
running:</p>

<pre>$ bin/rails generate model Product name:string description:text</pre>

<p>will create a migration that looks like this</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">text</span> :<span class="ruby-identifier">description</span>

      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You can append as many column name/type pairs as you want.</p>

<h3 id="label-Passing+Modifiers">Passing Modifiers<span><a href="#label-Passing+Modifiers">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Some commonly used <a href="#column-modifiers">type modifiers</a> can be
passed directly on the command line. They are enclosed by curly braces and
follow the field type:</p>

<p>For instance, running:</p>

<pre>$ bin/rails generate migration AddDetailsToProducts &#39;price:decimal{5,2}&#39; supplier:references{polymorphic}</pre>

<p>will produce a migration that looks like this</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddDetailsToProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">price</span>, :<span class="ruby-identifier">decimal</span>, <span class="ruby-identifier">precision</span><span class="ruby-operator">:</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">scale</span><span class="ruby-operator">:</span> <span class="ruby-value">2</span>
    <span class="ruby-identifier">add_reference</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">supplier</span>, <span class="ruby-identifier">polymorphic</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>TIP: Have a look at the generators help output for further details.</p>

<h2 id="label-Writing+a+Migration">Writing a Migration<span><a href="#label-Writing+a+Migration">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Once you have created your migration using one of the generators it&#39;s
time to get to work!</p>

<h3 id="label-Creating+a+Table">Creating a Table<span><a href="#label-Creating+a+Table">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>create_table</code> method is one of the most fundamental, but
most of the time, will be generated for you from using a model or scaffold
generator. A typical use would be</p>

<pre class="ruby"><span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
<span class="ruby-keyword">end</span>
</pre>

<p>which creates a <code>products</code> table with a column called
<code>name</code> (and as discussed below, an implicit <code>id</code>
column).</p>

<p>By default, <code>create_table</code> will create a primary key called
<code>id</code>. You can change the name of the primary key with the
<code>:primary_key</code> option (don&#39;t forget to update the
corresponding model) or, if you don&#39;t want a primary key at all, you
can pass the option <code>id: false</code>. If you need to pass database
specific options you can place an SQL fragment in the <code>:options</code>
option. For example:</p>

<pre class="ruby"><span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span>, <span class="ruby-identifier">options</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;ENGINE=BLACKHOLE&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>, <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>
</pre>

<p>will append <code>ENGINE=BLACKHOLE</code> to the SQL statement used to
create the table (when using MySQL, the default is
<code>ENGINE=InnoDB</code>).</p>

<h3 id="label-Creating+a+Join+Table">Creating a Join Table<span><a href="#label-Creating+a+Join+Table">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Migration method <code>create_join_table</code> creates a HABTM join table.
A typical use would be:</p>

<pre class="ruby"><span class="ruby-identifier">create_join_table</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">categories</span>
</pre>

<p>which creates a <code>categories_products</code> table with two columns
called <code>category_id</code> and <code>product_id</code>. These columns
have the option <code>:null</code> set to <code>false</code> by default.
This can be overridden by specifying the <code>:column_options</code>
option.</p>

<pre class="ruby"><span class="ruby-identifier">create_join_table</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">categories</span>, <span class="ruby-identifier">column_options</span><span class="ruby-operator">:</span> {<span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>}
</pre>

<p>will create the <code>product_id</code> and <code>category_id</code> with
the <code>:null</code> option as <code>true</code>.</p>

<p>You can pass the option <code>:table_name</code> when you want to customize
the table name. For example:</p>

<pre class="ruby"><span class="ruby-identifier">create_join_table</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">categories</span>, <span class="ruby-identifier">table_name</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">categorization</span>
</pre>

<p>will create a <code>categorization</code> table.</p>

<p><code>create_join_table</code> also accepts a block, which you can use to
add indices (which are not created by default) or additional columns:</p>

<pre class="ruby"><span class="ruby-identifier">create_join_table</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">categories</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">index</span> :<span class="ruby-identifier">product_id</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">index</span> :<span class="ruby-identifier">category_id</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Changing+Tables">Changing Tables<span><a href="#label-Changing+Tables">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>A close cousin of <code>create_table</code> is <code>change_table</code>,
used for changing existing tables. It is used in a similar fashion to
<code>create_table</code> but the object yielded to the block knows more
tricks. For example:</p>

<pre class="ruby"><span class="ruby-identifier">change_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">remove</span> :<span class="ruby-identifier">description</span>, :<span class="ruby-identifier">name</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">part_number</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">index</span> :<span class="ruby-identifier">part_number</span>
  <span class="ruby-identifier">t</span>.<span class="ruby-identifier">rename</span> :<span class="ruby-identifier">upccode</span>, :<span class="ruby-identifier">upc_code</span>
<span class="ruby-keyword">end</span>
</pre>

<p>removes the <code>description</code> and <code>name</code> columns, creates
a <code>part_number</code> string column and adds an index on it. Finally
it renames the <code>upccode</code> column.</p>

<h3 id="label-Changing+Columns">Changing Columns<span><a href="#label-Changing+Columns">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Like the <code>remove_column</code> and <code>add_column</code> Rails
provides the <code>change_column</code> migration method.</p>

<pre class="ruby"><span class="ruby-identifier">change_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">part_number</span>, :<span class="ruby-identifier">text</span>
</pre>

<p>This changes the column <code>part_number</code> on products table to be a
<code>:text</code> field.</p>

<p>Besides <code>change_column</code>, the <code>change_column_null</code> and
<code>change_column_default</code> methods are used specifically to change
the null and default values of a column.</p>

<pre class="ruby"><span class="ruby-identifier">change_column_null</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">name</span>, <span class="ruby-keyword">false</span>
<span class="ruby-identifier">change_column_default</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">approved</span>, <span class="ruby-keyword">false</span>
</pre>

<p>This sets <code>:name</code> field on products to a <code>NOT NULL</code>
column and the default value of the <code>:approved</code> field to false.</p>

<h3 id="label-Column+Modifiers">Column Modifiers<span><a href="#label-Column+Modifiers">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Column modifiers can be applied when creating or changing a column:</p>
<ul><li>
<p><code>limit</code> Sets the maximum size of the
<code>string/text/binary/integer</code> fields.</p>
</li><li>
<p><code>precision</code> Defines the precision for the <code>decimal</code>
fields, representing the total number of digits in the number.</p>
</li><li>
<p><code>scale</code> Defines the scale for the <code>decimal</code> fields,
representing the number of digits after the decimal point.</p>
</li><li>
<p><code>polymorphic</code> Adds a <code>type</code> column for
<code>belongs_to</code> associations.</p>
</li><li>
<p><code>null</code> Allows or disallows <code>NULL</code> values in the
column.</p>
</li><li>
<p><code>default</code> Allows to set a default value on the column. NOTE: If
using a dynamic value (such as date), the default will only be calculated
the first time (e.g. on the date the migration is applied.)</p>
</li><li>
<p><code>index</code> Adds an index for the column.</p>
</li></ul>

<p>Some adapters may support additional options; see the adapter specific API
docs for further information.</p>

<h3 id="label-When+Helpers+aren%27t+Enough">When Helpers aren&#39;t Enough<span><a href="#label-When+Helpers+aren%27t+Enough">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If the helpers provided by Active Record aren&#39;t enough you can use the
<code>execute</code> method to execute arbitrary SQL:</p>

<pre class="ruby"><span class="ruby-constant">Product</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">execute</span>(<span class="ruby-string">&#39;UPDATE `products` SET `price`=`free` WHERE 1&#39;</span>)
</pre>

<p>For more details and examples of individual methods, check the API
documentation. In particular the documentation for <a
href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html">ActiveRecord::ConnectionAdapters::SchemaStatements</a>
(which provides the methods available in the <code>change</code>,
<code>up</code> and <code>down</code> methods), <a
href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html">ActiveRecord::ConnectionAdapters::TableDefinition</a>
(which provides the methods available on the object yielded by
<code>create_table</code>) and <a
href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html">ActiveRecord::ConnectionAdapters::Table</a>
(which provides the methods available on the object yielded by
<code>change_table</code>).</p>

<h3 id="label-Using+the+change+Method">Using the <code>change</code> Method<span><a href="#label-Using+the+change+Method">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>change</code> method is the primary way of writing migrations. It
works for the majority of cases, where Active Record knows how to reverse
the migration automatically. Currently, the <code>change</code> method
supports only these migration definitions:</p>
<ul><li>
<p><code>add_column</code></p>
</li><li>
<p><code>add_index</code></p>
</li><li>
<p><code>add_reference</code></p>
</li><li>
<p><code>add_timestamps</code></p>
</li><li>
<p><code>create_table</code></p>
</li><li>
<p><code>create_join_table</code></p>
</li><li>
<p><code>drop_table</code> (must supply a block)</p>
</li><li>
<p><code>drop_join_table</code> (must supply a block)</p>
</li><li>
<p><code>remove_timestamps</code></p>
</li><li>
<p><code>rename_column</code></p>
</li><li>
<p><code>rename_index</code></p>
</li><li>
<p><code>remove_reference</code></p>
</li><li>
<p><code>rename_table</code></p>
</li></ul>

<p><code>change_table</code> is also reversible, as long as the block does not
call <code>change</code>, <code>change_default</code> or
<code>remove</code>.</p>

<p>If you&#39;re going to need to use any other methods, you should use
<code>reversible</code> or write the <code>up</code> and <code>down</code>
methods instead of using the <code>change</code> method.</p>

<h3 id="label-Using+reversible">Using <code>reversible</code><span><a href="#label-Using+reversible">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Complex migrations may require processing that Active Record doesn&#39;t
know how to reverse. You can use <code>reversible</code> to specify what to
do when running a migration what else to do when reverting it. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ExampleMigration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">references</span> :<span class="ruby-identifier">category</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> <span class="ruby-keyword">do</span>
        <span class="ruby-comment">#add a foreign key</span>
        <span class="ruby-identifier">execute</span> <span class="ruby-value">&lt;&lt;-SQL
          ALTER TABLE products
            ADD CONSTRAINT fk_products_categories
            FOREIGN KEY (category_id)
            REFERENCES categories(id)
        SQL</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">down</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">execute</span> <span class="ruby-value">&lt;&lt;-SQL
          ALTER TABLE products
            DROP FOREIGN KEY fk_products_categories
        SQL</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">users</span>, :<span class="ruby-identifier">home_page_url</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-identifier">rename_column</span> :<span class="ruby-identifier">users</span>, :<span class="ruby-identifier">email</span>, :<span class="ruby-identifier">email_address</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Using <code>reversible</code> will ensure that the instructions are
executed in the right order too. If the previous example migration is
reverted, the <code>down</code> block will be run after the
<code>home_page_url</code> column is removed and right before the table
<code>products</code> is dropped.</p>

<p>Sometimes your migration will do something which is just plain
irreversible; for example, it might destroy some data. In such cases, you
can raise <code>ActiveRecord::IrreversibleMigration</code> in your
<code>down</code> block. If someone tries to revert your migration, an
error message will be displayed saying that it can&#39;t be done.</p>

<h3 id="label-Using+the+up%2Fdown+Methods">Using the <code>up</code>/<code>down</code> Methods<span><a href="#label-Using+the+up%2Fdown+Methods">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can also use the old style of migration using <code>up</code> and
<code>down</code> methods instead of the <code>change</code> method. The
<code>up</code> method should describe the transformation you&#39;d like to
make to your schema, and the <code>down</code> method of your migration
should revert the transformations done by the <code>up</code> method. In
other words, the database schema should be unchanged if you do an
<code>up</code> followed by a <code>down</code>. For example, if you create
a table in the <code>up</code> method, you should drop it in the
<code>down</code> method. It is wise to reverse the transformations in
precisely the reverse order they were made in the <code>up</code> method.
The example in the <code>reversible</code> section is equivalent to:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ExampleMigration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">up</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">references</span> :<span class="ruby-identifier">category</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># add a foreign key</span>
    <span class="ruby-identifier">execute</span> <span class="ruby-value">&lt;&lt;-SQL
      ALTER TABLE products
        ADD CONSTRAINT fk_products_categories
        FOREIGN KEY (category_id)
        REFERENCES categories(id)
    SQL</span>

    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">users</span>, :<span class="ruby-identifier">home_page_url</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-identifier">rename_column</span> :<span class="ruby-identifier">users</span>, :<span class="ruby-identifier">email</span>, :<span class="ruby-identifier">email_address</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">down</span>
    <span class="ruby-identifier">rename_column</span> :<span class="ruby-identifier">users</span>, :<span class="ruby-identifier">email_address</span>, :<span class="ruby-identifier">email</span>
    <span class="ruby-identifier">remove_column</span> :<span class="ruby-identifier">users</span>, :<span class="ruby-identifier">home_page_url</span>

    <span class="ruby-identifier">execute</span> <span class="ruby-value">&lt;&lt;-SQL
      ALTER TABLE products
        DROP FOREIGN KEY fk_products_categories
    SQL</span>

    <span class="ruby-identifier">drop_table</span> :<span class="ruby-identifier">products</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If your migration is irreversible, you should raise
<code>ActiveRecord::IrreversibleMigration</code> from your
<code>down</code> method. If someone tries to revert your migration, an
error message will be displayed saying that it can&#39;t be done.</p>

<h3 id="label-Reverting+Previous+Migrations">Reverting Previous Migrations<span><a href="#label-Reverting+Previous+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can use Active Record&#39;s ability to rollback migrations using the
<code>revert</code> method:</p>

<pre class="ruby"><span class="ruby-identifier">require_relative</span> <span class="ruby-string">&#39;2012121212_example_migration&#39;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">FixupExampleMigration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">revert</span> <span class="ruby-constant">ExampleMigration</span>

    <span class="ruby-identifier">create_table</span>(:<span class="ruby-identifier">apples</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">variety</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>revert</code> method also accepts a block of instructions to
reverse. This could be useful to revert selected parts of previous
migrations. For example, let&#39;s imagine that
<code>ExampleMigration</code> is committed and it is later decided it would
be best to serialize the product list instead. One could write:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">SerializeProductListMigration</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">categories</span>, :<span class="ruby-identifier">product_list</span>

    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> <span class="ruby-keyword">do</span>
        <span class="ruby-comment"># transfer data from Products to Category#product_list</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">down</span> <span class="ruby-keyword">do</span>
        <span class="ruby-comment"># create Products from Category#product_list</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">revert</span> <span class="ruby-keyword">do</span>
      <span class="ruby-comment"># copy-pasted code from ExampleMigration</span>
      <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">t</span>.<span class="ruby-identifier">references</span> :<span class="ruby-identifier">category</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> <span class="ruby-keyword">do</span>
          <span class="ruby-comment">#add a foreign key</span>
          <span class="ruby-identifier">execute</span> <span class="ruby-value">&lt;&lt;-SQL
            ALTER TABLE products
              ADD CONSTRAINT fk_products_categories
              FOREIGN KEY (category_id)
              REFERENCES categories(id)
          SQL</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">down</span> <span class="ruby-keyword">do</span>
          <span class="ruby-identifier">execute</span> <span class="ruby-value">&lt;&lt;-SQL
            ALTER TABLE products
              DROP FOREIGN KEY fk_products_categories
          SQL</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># The rest of the migration was ok</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The same migration could also have been written without using
<code>revert</code> but this would have involved a few more steps:
reversing the order of <code>create_table</code> and
<code>reversible</code>, replacing <code>create_table</code> by
<code>drop_table</code>, and finally replacing <code>up</code> by
<code>down</code> and vice-versa. This is all taken care of by
<code>revert</code>.</p>

<h2 id="label-Running+Migrations">Running Migrations<span><a href="#label-Running+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Rails provides a set of Rake tasks to run certain sets of migrations.</p>

<p>The very first migration related Rake task you will use will probably be
<code>rake db:migrate</code>. In its most basic form it just runs the
<code>change</code> or <code>up</code> method for all the migrations that
have not yet been run. If there are no such migrations, it exits. It will
run these migrations in order based on the date of the migration.</p>

<p>Note that running the <code>db:migrate</code> task also invokes the
<code>db:schema:dump</code> task, which will update your
<code>db/schema.rb</code> file to match the structure of your database.</p>

<p>If you specify a target version, Active Record will run the required
migrations (change, up, down) until it has reached the specified version.
The version is the numerical prefix on the migration&#39;s filename. For
example, to migrate to version 20080906120000 run:</p>

<pre>$ bin/rake db:migrate VERSION=20080906120000</pre>

<p>If version 20080906120000 is greater than the current version (i.e., it is
migrating upwards), this will run the <code>change</code> (or
<code>up</code>) method on all migrations up to and including
20080906120000, and will not execute any later migrations. If migrating
downwards, this will run the <code>down</code> method on all the migrations
down to, but not including, 20080906120000.</p>

<h3 id="label-Rolling+Back">Rolling Back<span><a href="#label-Rolling+Back">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>A common task is to rollback the last migration. For example, if you made a
mistake in it and wish to correct it. Rather than tracking down the version
number associated with the previous migration you can run:</p>

<pre>$ bin/rake db:rollback</pre>

<p>This will rollback the latest migration, either by reverting the
<code>change</code> method or by running the <code>down</code> method. If
you need to undo several migrations you can provide a <code>STEP</code>
parameter:</p>

<pre>$ bin/rake db:rollback STEP=3</pre>

<p>will revert the last 3 migrations.</p>

<p>The <code>db:migrate:redo</code> task is a shortcut for doing a rollback
and then migrating back up again. As with the <code>db:rollback</code>
task, you can use the <code>STEP</code> parameter if you need to go more
than one version back, for example:</p>

<pre>$ bin/rake db:migrate:redo STEP=3</pre>

<p>Neither of these Rake tasks do anything you could not do with
<code>db:migrate</code>. They are simply more convenient, since you do not
need to explicitly specify the version to migrate to.</p>

<h3 id="label-Setup+the+Database">Setup the Database<span><a href="#label-Setup+the+Database">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>rake db:setup</code> task will create the database, load the
schema and initialize it with the seed data.</p>

<h3 id="label-Resetting+the+Database">Resetting the Database<span><a href="#label-Resetting+the+Database">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>rake db:reset</code> task will drop the database and set it up
again. This is functionally equivalent to <code>rake db:drop
db:setup</code>.</p>

<p>NOTE: This is not the same as running all the migrations. It will only use
the contents of the current <code>schema.rb</code> file. If a migration
can&#39;t be rolled back, <code>rake db:reset</code> may not help you. To
find out more about dumping the schema see <a
href="#schema-dumping-and-you">Schema Dumping and You</a> section.</p>

<h3 id="label-Running+Specific+Migrations">Running Specific Migrations<span><a href="#label-Running+Specific+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you need to run a specific migration up or down, the
<code>db:migrate:up</code> and <code>db:migrate:down</code> tasks will do
that. Just specify the appropriate version and the corresponding migration
will have its <code>change</code>, <code>up</code> or <code>down</code>
method invoked, for example:</p>

<pre>$ bin/rake db:migrate:up VERSION=20080906120000</pre>

<p>will run the 20080906120000 migration by running the <code>change</code>
method (or the <code>up</code> method). This task will first check whether
the migration is already performed and will do nothing if Active Record
believes that it has already been run.</p>

<h3 id="label-Running+Migrations+in+Different+Environments">Running Migrations in Different Environments<span><a href="#label-Running+Migrations+in+Different+Environments">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>By default running <code>rake db:migrate</code> will run in the
<code>development</code> environment. To run migrations against another
environment you can specify it using the <code>RAILS_ENV</code> environment
variable while running the command. For example to run migrations against
the <code>test</code> environment you could run:</p>

<pre>$ bin/rake db:migrate RAILS_ENV=test</pre>

<h3 id="label-Changing+the+Output+of+Running+Migrations">Changing the Output of Running Migrations<span><a href="#label-Changing+the+Output+of+Running+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>By default migrations tell you exactly what they&#39;re doing and how long
it took. A migration creating a table and adding an index might produce
output like this</p>

<pre>==  CreateProducts: migrating =================================================
-- create_table(:products)
   -&gt; 0.0028s
==  CreateProducts: migrated (0.0028s) ========================================</pre>

<p>Several methods are provided in migrations that allow you to control all
this:</p>

<p>| Method | Purpose | ——————– | ——- | suppress_messages | Takes a block as
an argument and suppresses any output generated by the block. | say | Takes
a message argument and outputs it as is. A second boolean argument can be
passed to specify whether to indent or not. | say_with_time | Outputs text
along with how long it took to run its block. If the block returns an
integer it assumes it is the number of rows affected.</p>

<p>For example, this migration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">suppress_messages</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">products</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
        <span class="ruby-identifier">t</span>.<span class="ruby-identifier">text</span> :<span class="ruby-identifier">description</span>
        <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;Created a table&quot;</span>

    <span class="ruby-identifier">suppress_messages</span> {<span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">name</span>}
    <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;and an index!&quot;</span>, <span class="ruby-keyword">true</span>

    <span class="ruby-identifier">say_with_time</span> <span class="ruby-string">&#39;Waiting for a while&#39;</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">sleep</span> <span class="ruby-value">10</span>
      <span class="ruby-value">250</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>generates the following output</p>

<pre>==  CreateProducts: migrating =================================================
-- Created a table
   -&gt; and an index!
-- Waiting for a while
   -&gt; 10.0013s
   -&gt; 250 rows
==  CreateProducts: migrated (10.0054s) =======================================</pre>

<p>If you want Active Record to not output anything, then running <code>rake
db:migrate VERBOSE=false</code> will suppress all output.</p>

<h2 id="label-Changing+Existing+Migrations">Changing Existing Migrations<span><a href="#label-Changing+Existing+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Occasionally you will make a mistake when writing a migration. If you have
already run the migration then you cannot just edit the migration and run
the migration again: Rails thinks it has already run the migration and so
will do nothing when you run <code>rake db:migrate</code>. You must
rollback the migration (for example with <code>rake db:rollback</code>),
edit your migration and then run <code>rake db:migrate</code> to run the
corrected version.</p>

<p>In general, editing existing migrations is not a good idea. You will be
creating extra work for yourself and your co-workers and cause major
headaches if the existing version of the migration has already been run on
production machines. Instead, you should write a new migration that
performs the changes you require. Editing a freshly generated migration
that has not yet been committed to source control (or, more generally,
which has not been propagated beyond your development machine) is
relatively harmless.</p>

<p>The <code>revert</code> method can be helpful when writing a new migration
to undo previous migrations in whole or in part (see <a
href="#reverting-previous-migrations">Reverting Previous Migrations</a>
above).</p>

<h2 id="label-Using+Models+in+Your+Migrations">Using Models in Your Migrations<span><a href="#label-Using+Models+in+Your+Migrations">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>When creating or updating data in a migration it is often tempting to use
one of your models. After all, they exist to provide easy access to the
underlying data. This can be done, but some caution should be observed.</p>

<p>For example, problems occur when the model uses database columns which are
(1) not currently in the database and (2) will be created by this or a
subsequent migration.</p>

<p>Consider this example, where Alice and Bob are working on the same code
base which contains a <code>Product</code> model:</p>

<p>Bob goes on vacation.</p>

<p>Alice creates a migration for the <code>products</code> table which adds a
new column and initializes it:</p>

<pre class="ruby"><span class="ruby-comment"># db/migrate/20100513121110_add_flag_to_product.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">AddFlagToProduct</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">flag</span>, :<span class="ruby-identifier">boolean</span>
    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> { <span class="ruby-constant">Product</span>.<span class="ruby-identifier">update_all</span> <span class="ruby-identifier">flag</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span> }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>She also adds a validation to the <code>Product</code> model for the new
column:</p>

<pre class="ruby"><span class="ruby-comment"># app/models/product.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Product</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">validates</span> :<span class="ruby-identifier">flag</span>, <span class="ruby-identifier">inclusion</span><span class="ruby-operator">:</span> { <span class="ruby-keyword">in</span><span class="ruby-operator">:</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>] }
<span class="ruby-keyword">end</span>
</pre>

<p>Alice adds a second migration which adds another column to the
<code>products</code> table and initializes it:</p>

<pre class="ruby"><span class="ruby-comment"># db/migrate/20100515121110_add_fuzz_to_product.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">AddFuzzToProduct</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">fuzz</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> { <span class="ruby-constant">Product</span>.<span class="ruby-identifier">update_all</span> <span class="ruby-identifier">fuzz</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;fuzzy&#39;</span> }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>She also adds a validation to the <code>Product</code> model for the new
column:</p>

<pre class="ruby"><span class="ruby-comment"># app/models/product.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Product</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">validates</span> :<span class="ruby-identifier">flag</span>, <span class="ruby-identifier">inclusion</span><span class="ruby-operator">:</span> { <span class="ruby-keyword">in</span><span class="ruby-operator">:</span> [<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>] }
  <span class="ruby-identifier">validates</span> :<span class="ruby-identifier">fuzz</span>, <span class="ruby-identifier">presence</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Both migrations work for Alice.</p>

<p>Bob comes back from vacation and:</p>
<ul><li>
<p>Updates the source - which contains both migrations and the latest version
of the Product model.</p>
</li><li>
<p>Runs outstanding migrations with <code>rake db:migrate</code>, which
includes the one that updates the <code>Product</code> model.</p>
</li></ul>

<p>The migration crashes because when the model attempts to save, it tries to
validate the second added column, which is not in the database when the
<em>first</em> migration runs:</p>

<pre>rake aborted!
An error has occurred, this and all later migrations canceled:

undefined method `fuzz&#39; for #&lt;Product:0x000001049b14a0&gt;</pre>

<p>A fix for this is to create a local model within the migration. This keeps
Rails from running the validations, so that the migrations run to
completion.</p>

<p>When using a local model, it&#39;s a good idea to call
<code>Product.reset_column_information</code> to refresh the Active Record
cache for the <code>Product</code> model prior to updating data in the
database.</p>

<p>If Alice had done this instead, there would have been no problem:</p>

<pre class="ruby"><span class="ruby-comment"># db/migrate/20100513121110_add_flag_to_product.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">AddFlagToProduct</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Product</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">flag</span>, :<span class="ruby-identifier">boolean</span>
    <span class="ruby-constant">Product</span>.<span class="ruby-identifier">reset_column_information</span>
    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> { <span class="ruby-constant">Product</span>.<span class="ruby-identifier">update_all</span> <span class="ruby-identifier">flag</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span> }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># db/migrate/20100515121110_add_fuzz_to_product.rb</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">AddFuzzToProduct</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Product</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">add_column</span> :<span class="ruby-identifier">products</span>, :<span class="ruby-identifier">fuzz</span>, :<span class="ruby-identifier">string</span>
    <span class="ruby-constant">Product</span>.<span class="ruby-identifier">reset_column_information</span>
    <span class="ruby-identifier">reversible</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dir</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dir</span>.<span class="ruby-identifier">up</span> { <span class="ruby-constant">Product</span>.<span class="ruby-identifier">update_all</span> <span class="ruby-identifier">fuzz</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;fuzzy&#39;</span> }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>There are other ways in which the above example could have gone badly.</p>

<p>For example, imagine that Alice creates a migration that selectively
updates the <code>description</code> field on certain products. She runs
the migration, commits the code, and then begins working on the next
feature, which is to add a new column <code>fuzz</code> to the products
table.</p>

<p>She creates two migrations for this new feature, one which adds the new
column, and a second which selectively updates the <code>fuzz</code> column
based on other product attributes.</p>

<p>These migrations run just fine, but when Bob comes back from his vacation
and calls <code>rake db:migrate</code> to run all the outstanding
migrations, he gets a subtle bug: The descriptions have defaults, and the
<code>fuzz</code> column is present, but <code>fuzz</code> is
<code>nil</code> on all products.</p>

<p>The solution is again to use <code>Product.reset_column_information</code>
before referencing the Product model in a migration, ensuring the Active
Record&#39;s knowledge of the table structure is current before
manipulating data in those records.</p>

<h2 id="label-Schema+Dumping+and+You">Schema Dumping and You<span><a href="#label-Schema+Dumping+and+You">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<h3 id="label-What+are+Schema+Files+for%3F">What are Schema Files for?<span><a href="#label-What+are+Schema+Files+for%3F">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Migrations, mighty as they may be, are not the authoritative source for
your database schema. That role falls to either <code>db/schema.rb</code>
or an SQL file which Active Record generates by examining the database.
They are not designed to be edited, they just represent the current state
of the database.</p>

<p>There is no need (and it is error prone) to deploy a new instance of an app
by replaying the entire migration history. It is much simpler and faster to
just load into the database a description of the current schema.</p>

<p>For example, this is how the test database is created: the current
development database is dumped (either to <code>db/schema.rb</code> or
<code>db/structure.sql</code>) and then loaded into the test database.</p>

<p>Schema files are also useful if you want a quick look at what attributes an
Active Record object has. This information is not in the model&#39;s code
and is frequently spread across several migrations, but the information is
nicely summed up in the schema file. The <a
href="https://github.com/ctran/annotate_models">annotate_models</a> gem
automatically adds and updates comments at the top of each model
summarizing the schema if you desire that functionality.</p>

<h3 id="label-Types+of+Schema+Dumps">Types of Schema Dumps<span><a href="#label-Types+of+Schema+Dumps">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>There are two ways to dump the schema. This is set in
<code>config/application.rb</code> by the
<code>config.active_record.schema_format</code> setting, which may be
either <code>:sql</code> or <code>:ruby</code>.</p>

<p>If <code>:ruby</code> is selected then the schema is stored in
<code>db/schema.rb</code>. If you look at this file you&#39;ll find that it
looks an awful lot like one very big migration:</p>

<pre class="ruby"><span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Schema</span>.<span class="ruby-identifier">define</span>(<span class="ruby-identifier">version</span><span class="ruby-operator">:</span> <span class="ruby-value">20080906171750</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">create_table</span> <span class="ruby-string">&quot;authors&quot;</span>, <span class="ruby-identifier">force</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>   <span class="ruby-string">&quot;name&quot;</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> <span class="ruby-string">&quot;created_at&quot;</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> <span class="ruby-string">&quot;updated_at&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">create_table</span> <span class="ruby-string">&quot;products&quot;</span>, <span class="ruby-identifier">force</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>   <span class="ruby-string">&quot;name&quot;</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">text</span> <span class="ruby-string">&quot;description&quot;</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> <span class="ruby-string">&quot;created_at&quot;</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> <span class="ruby-string">&quot;updated_at&quot;</span>
    <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> <span class="ruby-string">&quot;part_number&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>In many ways this is exactly what it is. This file is created by inspecting
the database and expressing its structure using <code>create_table</code>,
<code>add_index</code>, and so on. Because this is database-independent, it
could be loaded into any database that Active Record supports. This could
be very useful if you were to distribute an application that is able to run
against multiple databases.</p>

<p>There is however a trade-off: <code>db/schema.rb</code> cannot express
database specific items such as foreign key constraints, triggers, or
stored procedures. While in a migration you can execute custom SQL
statements, the schema dumper cannot reconstitute those statements from the
database. If you are using features like this, then you should set the
schema format to <code>:sql</code>.</p>

<p>Instead of using Active Record&#39;s schema dumper, the database&#39;s
structure will be dumped using a tool specific to the database (via the
<code>db:structure:dump</code> Rake task) into
<code>db/structure.sql</code>. For example, for PostgreSQL, the
<code>pg_dump</code> utility is used. For MySQL, this file will contain the
output of <code>SHOW CREATE TABLE</code> for the various tables.</p>

<p>Loading these schemas is simply a question of executing the SQL statements
they contain. By definition, this will create a perfect copy of the
database&#39;s structure. Using the <code>:sql</code> schema format will,
however, prevent loading the schema into a RDBMS other than the one used to
create it.</p>

<h3 id="label-Schema+Dumps+and+Source+Control">Schema Dumps and Source Control<span><a href="#label-Schema+Dumps+and+Source+Control">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Because schema dumps are the authoritative source for your database schema,
it is strongly recommended that you check them into source control.</p>

<h2 id="label-Active+Record+and+Referential+Integrity">Active Record and Referential Integrity<span><a href="#label-Active+Record+and+Referential+Integrity">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>The Active Record way claims that intelligence belongs in your models, not
in the database. As such, features such as triggers or foreign key
constraints, which push some of that intelligence back into the database,
are not heavily used.</p>

<p>Validations such as <code>validates :foreign_key, uniqueness: true</code>
are one way in which models can enforce data integrity. The
<code>:dependent</code> option on associations allows models to
automatically destroy child objects when the parent is destroyed. Like
anything which operates at the application level, these cannot guarantee
referential integrity and so some people augment them with foreign key
constraints in the database.</p>

<p>Although Active Record does not provide any tools for working directly with
such features, the <code>execute</code> method can be used to execute
arbitrary SQL. You can also use a gem like <a
href="https://github.com/matthuhiggins/foreigner">foreigner</a> which adds
foreign key support to Active Record (including support for dumping foreign
keys in <code>db/schema.rb</code>).</p>

<h2 id="label-Migrations+and+Seed+Data">Migrations and Seed Data<span><a href="#label-Migrations+and+Seed+Data">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Some people use migrations to add data to the database:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">AddInitialProducts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">up</span>
    <span class="ruby-value">5</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">Product</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;Product ##{i}&quot;</span>, <span class="ruby-identifier">description</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;A product.&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">down</span>
    <span class="ruby-constant">Product</span>.<span class="ruby-identifier">delete_all</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>However, Rails has a &#39;seeds&#39; feature that should be used for
seeding a database with initial data. It&#39;s a really simple feature:
just fill up <code>db/seeds.rb</code> with some Ruby code, and run
<code>rake db:seed</code>:</p>

<pre class="ruby"><span class="ruby-value">5</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">Product</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-node">&quot;Product ##{i}&quot;</span>, <span class="ruby-identifier">description</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;A product.&quot;</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>This is generally a much cleaner way to set up the database of a blank
application.</p>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

