<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>upgrading_ruby_on_rails - rails-4.1.8 Documentation</title>

<link href="../../fonts.css" rel="stylesheet">
<link href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/navigation.js"></script>
<script src="../../js/search_index.js"></script>
<script src="../../js/search.js"></script>
<script src="../../js/searcher.js"></script>
<script src="../../js/darkfish.js"></script>


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-A+Guide+for+Upgrading+Ruby+on+Rails">A Guide for Upgrading Ruby on Rails</a>
    <li><a href="#label-General+Advice">General Advice</a>
    <li><a href="#label-Test+Coverage">Test Coverage</a>
    <li><a href="#label-Ruby+Versions">Ruby Versions</a>
    <li><a href="#label-Upgrading+from+Rails+4.0+to+Rails+4.1">Upgrading from Rails 4.0 to Rails 4.1</a>
    <li><a href="#label-CSRF+protection+from+remote+%3Cscript%3E+tags">CSRF protection from remote <code>&lt;script&gt;</code> tags</a>
    <li><a href="#label-Spring">Spring</a>
    <li><a href="#label-config%2Fsecrets.yml"><code>config/secrets.yml</code></a>
    <li><a href="#label-Changes+to+test+helper">Changes to test helper</a>
    <li><a href="#label-Cookies+serializer">Cookies serializer</a>
    <li><a href="#label-Flash+structure+changes">Flash structure changes</a>
    <li><a href="#label-Changes+in+JSON+handling">Changes in JSON handling</a>
    <li><a href="#label-MultiJSON+removal">MultiJSON removal</a>
    <li><a href="#label-JSON+gem+compatibility">JSON gem compatibility</a>
    <li><a href="#label-New+JSON+encoder">New JSON encoder</a>
    <li><a href="#label-JSON+representation+of+Time+objects">JSON representation of Time objects</a>
    <li><a href="#label-Usage+of+return+within+inline+callback+blocks">Usage of <code>return</code> within inline callback blocks</a>
    <li><a href="#label-Methods+defined+in+Active+Record+fixtures">Methods defined in Active Record fixtures</a>
    <li><a href="#label-I18n+enforcing+available+locales">I18n enforcing available locales</a>
    <li><a href="#label-Mutator+methods+called+on+Relation">Mutator methods called on Relation</a>
    <li><a href="#label-Changes+on+Default+Scopes">Changes on Default Scopes</a>
    <li><a href="#label-Rendering+content+from+string">Rendering content from string</a>
    <li><a href="#label-PostgreSQL+json+and+hstore+datatypes">PostgreSQL json and hstore datatypes</a>
    <li><a href="#label-Explicit+block+use+for+ActiveSupport%3A%3ACallbacks">Explicit block use for <code>ActiveSupport::Callbacks</code></a>
    <li><a href="#label-Upgrading+from+Rails+3.2+to+Rails+4.0">Upgrading from Rails 3.2 to Rails 4.0</a>
    <li><a href="#label-HTTP+PATCH">HTTP PATCH</a>
    <li><a href="#label-A+note+about+media+types">A note about media types</a>
    <li><a href="#label-Gemfile">Gemfile</a>
    <li><a href="#label-vendor%2Fplugins">vendor/plugins</a>
    <li><a href="#label-Active+Record">Active Record</a>
    <li><a href="#label-Active+Resource">Active Resource</a>
    <li><a href="#label-Active+Model">Active Model</a>
    <li><a href="#label-Action+Pack">Action Pack</a>
    <li><a href="#label-Active+Support">Active Support</a>
    <li><a href="#label-Helpers+Loading+Order">Helpers Loading Order</a>
    <li><a href="#label-Active+Record+Observer+and+Action+Controller+Sweeper">Active Record Observer and Action Controller Sweeper</a>
    <li><a href="#label-sprockets-rails">sprockets-rails</a>
    <li><a href="#label-sass-rails">sass-rails</a>
    <li><a href="#label-Upgrading+from+Rails+3.1+to+Rails+3.2">Upgrading from Rails 3.1 to Rails 3.2</a>
    <li><a href="#label-Gemfile">Gemfile</a>
    <li><a href="#label-config%2Fenvironments%2Fdevelopment.rb">config/environments/development.rb</a>
    <li><a href="#label-config%2Fenvironments%2Ftest.rb">config/environments/test.rb</a>
    <li><a href="#label-vendor%2Fplugins">vendor/plugins</a>
    <li><a href="#label-Active+Record">Active Record</a>
    <li><a href="#label-Upgrading+from+Rails+3.0+to+Rails+3.1">Upgrading from Rails 3.0 to Rails 3.1</a>
    <li><a href="#label-Gemfile">Gemfile</a>
    <li><a href="#label-config%2Fapplication.rb">config/application.rb</a>
    <li><a href="#label-config%2Fenvironments%2Fdevelopment.rb">config/environments/development.rb</a>
    <li><a href="#label-config%2Fenvironments%2Fproduction.rb">config/environments/production.rb</a>
    <li><a href="#label-config%2Fenvironments%2Ftest.rb">config/environments/test.rb</a>
    <li><a href="#label-config%2Finitializers%2Fwrap_parameters.rb">config/initializers/wrap_parameters.rb</a>
    <li><a href="#label-config%2Finitializers%2Fsession_store.rb">config/initializers/session_store.rb</a>
    <li><a href="#label-Remove+%3Acache+and+%3Aconcat+options+in+asset+helpers+references+in+views">Remove :cache and :concat options in asset helpers references in views</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile.html">Gemfile</a>
  
    <li><a href="../../guides/code/getting_started/Gemfile_lock.html">Gemfile.lock</a>
  
    <li><a href="../../guides/code/getting_started/README_rdoc.html">README</a>
  
    <li><a href="../../guides/code/getting_started/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/application_js.html">application.js</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/comments_js_coffee.html">comments.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/posts_js_coffee.html">posts.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/javascripts/welcome_js_coffee.html">welcome.js.coffee</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/application_css.html">application.css</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/comments_css_scss.html">comments.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/posts_css_scss.html">posts.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/app/assets/stylesheets/welcome_css_scss.html">welcome.css.scss</a>
  
    <li><a href="../../guides/code/getting_started/config_ru.html">config.ru</a>
  
    <li><a href="../../guides/code/getting_started/public/404_html.html">404.html</a>
  
    <li><a href="../../guides/code/getting_started/public/422_html.html">422.html</a>
  
    <li><a href="../../guides/code/getting_started/public/500_html.html">500.html</a>
  
    <li><a href="../../guides/code/getting_started/public/favicon_ico.html">favicon.ico</a>
  
    <li><a href="../../guides/code/getting_started/public/robots_txt.html">robots</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/migrations_md.html">migrations</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/upgrading_ruby_on_rails.md">

<h1 id="label-A+Guide+for+Upgrading+Ruby+on+Rails">A Guide for Upgrading Ruby on Rails<span><a href="#label-A+Guide+for+Upgrading+Ruby+on+Rails">&para;</a> <a href="#documentation">&uarr;</a></span></h1>

<p>This guide provides steps to be followed when you upgrade your applications
to a newer version of Ruby on Rails. These steps are also available in
individual release guides.</p>
<hr>

<h2 id="label-General+Advice">General Advice<span><a href="#label-General+Advice">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>Before attempting to upgrade an existing application, you should be sure
you have a good reason to upgrade. You need to balance out several factors:
the need for new features, the increasing difficulty of finding support for
old code, and your available time and skills, to name a few.</p>

<h3 id="label-Test+Coverage">Test Coverage<span><a href="#label-Test+Coverage">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The best way to be sure that your application still works after upgrading
is to have good test coverage before you start the process. If you
don&#39;t have automated tests that exercise the bulk of your application,
you&#39;ll need to spend time manually exercising all the parts that have
changed. In the case of a Rails upgrade, that will mean every single piece
of functionality in the application. Do yourself a favor and make sure your
test coverage is good <em>before</em> you start an upgrade.</p>

<h3 id="label-Ruby+Versions">Ruby Versions<span><a href="#label-Ruby+Versions">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails generally stays close to the latest released Ruby version when
it&#39;s released:</p>
<ul><li>
<p>Rails 3 and above require Ruby 1.8.7 or higher. Support for all of the
previous Ruby versions has been dropped officially. You should upgrade as
early as possible.</p>
</li><li>
<p>Rails 3.2.x is the last branch to support Ruby 1.8.7.</p>
</li><li>
<p>Rails 4 prefers Ruby 2.0 and requires 1.9.3 or newer.</p>
</li></ul>

<p>TIP: Ruby 1.8.7 p248 and p249 have marshaling bugs that crash Rails. Ruby
Enterprise Edition has these fixed since the release of 1.8.7-2010.02. On
the 1.9 front, Ruby 1.9.1 is not usable because it outright segfaults, so
if you want to use 1.9.x, jump straight to 1.9.3 for smooth sailing.</p>

<h2 id="label-Upgrading+from+Rails+4.0+to+Rails+4.1">Upgrading from Rails 4.0 to Rails 4.1<span><a href="#label-Upgrading+from+Rails+4.0+to+Rails+4.1">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<h3 id="label-CSRF+protection+from+remote+%3Cscript%3E+tags">CSRF protection from remote <code>&lt;script&gt;</code> tags<span><a href="#label-CSRF+protection+from+remote+%3Cscript%3E+tags">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Or, “whaaat my tests are failing!!!?”</p>

<p>Cross-site request forgery (CSRF) protection now covers GET requests with
JavaScript responses, too. That prevents a third-party site from
referencing your JavaScript URL and attempting to run it to extract
sensitive data.</p>

<p>This means that your functional and integration tests that use</p>

<pre class="ruby"><span class="ruby-identifier">get</span> :<span class="ruby-identifier">index</span>, <span class="ruby-identifier">format</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">js</span>
</pre>

<p>will now trigger CSRF protection. Switch to</p>

<pre class="ruby"><span class="ruby-identifier">xhr</span> :<span class="ruby-identifier">get</span>, :<span class="ruby-identifier">index</span>, <span class="ruby-identifier">format</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">js</span>
</pre>

<p>to explicitly test an XmlHttpRequest.</p>

<p>If you really mean to load JavaScript from remote
<code>&lt;script&gt;</code> tags, skip CSRF protection on that action.</p>

<h3 id="label-Spring">Spring<span><a href="#label-Spring">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you want to use Spring as your application preloader you need to:</p>
<ol><li>
<p>Add <code>gem &#39;spring&#39;, group: :development</code> to your
<code>Gemfile</code>.</p>
</li><li>
<p>Install spring using <code>bundle install</code>.</p>
</li><li>
<p>Springify your binstubs with <code>bundle exec spring binstub --all</code>.</p>
</li></ol>

<p>NOTE: User defined rake tasks will run in the <code>development</code>
environment by default. If you want them to run in other environments
consult the <a href="https://github.com/rails/spring#rake">Spring
README</a>.</p>

<h3 id="label-config%2Fsecrets.yml"><code>config/secrets.yml</code><span><a href="#label-config%2Fsecrets.yml">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If you want to use the new <code>secrets.yml</code> convention to store
your application&#39;s secrets, you need to:</p>
<ol><li>
<p>Create a <code>secrets.yml</code> file in your <code>config</code> folder
with the following content:</p>

<pre>development:
  secret_key_base:

test:
  secret_key_base:

production:
  secret_key_base: &lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;</pre>
</li><li>
<p>Use your existing <code>secret_key_base</code> from the
<code>secret_token.rb</code> initializer to  set the SECRET_KEY_BASE
environment variable for whichever users run the Rails  app in production
mode. Alternately, you can simply copy the existing 
<code>secret_key_base</code> from the <code>secret_token.rb</code>
initializer to <code>secrets.yml</code>  under the <code>production</code>
section, replacing &#39;&lt;%= <a href=""SECRET_KEY_BASE"">ENV</a>
%&gt;&#39;.</p>
</li><li>
<p>Remove the <code>secret_token.rb</code> initializer.</p>
</li><li>
<p>Use <code>rake secret</code> to generate new keys for the
<code>development</code> and <code>test</code> sections.</p>
</li><li>
<p>Restart your server.</p>
</li></ol>

<h3 id="label-Changes+to+test+helper">Changes to test helper<span><a href="#label-Changes+to+test+helper">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>If your test helper contains a call to
<code>ActiveRecord::Migration.check_pending!</code> this can be removed.
The check is now done automatically when you <code>require
&#39;test_help&#39;</code>, although leaving this line in your helper is
not harmful in any way.</p>

<h3 id="label-Cookies+serializer">Cookies serializer<span><a href="#label-Cookies+serializer">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Applications created before Rails 4.1 uses <code>Marshal</code> to
serialize cookie values into the signed and encrypted cookie jars. If you
want to use the new <code>JSON</code>-based format in your application, you
can add an initializer file with the following content:</p>

<pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">action_dispatch</span>.<span class="ruby-identifier">cookies_serializer</span> = :<span class="ruby-identifier">hybrid</span>
</pre>

<p>This would transparently migrate your existing
<code>Marshal</code>-serialized cookies into the new
<code>JSON</code>-based format.</p>

<p>When using the <code>:json</code> or <code>:hybrid</code> serializer, you
should beware that not all Ruby objects can be serialized as JSON. For
example, <code>Date</code> and <code>Time</code> objects will be serialized
as strings, and <code>Hash</code>es will have their keys stringified.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CookiesController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">set_cookie</span>
    <span class="ruby-identifier">cookies</span>.<span class="ruby-identifier">encrypted</span>[:<span class="ruby-identifier">expiration_date</span>] = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">tomorrow</span> <span class="ruby-comment"># =&gt; Thu, 20 Mar 2014</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;read_cookie&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">read_cookie</span>
    <span class="ruby-identifier">cookies</span>.<span class="ruby-identifier">encrypted</span>[:<span class="ruby-identifier">expiration_date</span>] <span class="ruby-comment"># =&gt; &quot;2014-03-20&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>It&#39;s advisable that you only store simple data (strings and numbers) in
cookies. If you have to store complex objects, you would need to handle the
conversion manually when reading the values on subsequent requests.</p>

<p>If you use the cookie session store, this would apply to the
<code>session</code> and <code>flash</code> hash as well.</p>

<h3 id="label-Flash+structure+changes">Flash structure changes<span><a href="#label-Flash+structure+changes">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Flash message keys are <a
href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">normalized
to strings</a>. They can still be accessed using either symbols or strings.
Lopping through the flash will always yield string keys:</p>

<pre class="ruby"><span class="ruby-identifier">flash</span>[<span class="ruby-string">&quot;string&quot;</span>] = <span class="ruby-string">&quot;a string&quot;</span>
<span class="ruby-identifier">flash</span>[:<span class="ruby-identifier">symbol</span>] = <span class="ruby-string">&quot;a symbol&quot;</span>

<span class="ruby-comment"># Rails &lt; 4.1</span>
<span class="ruby-identifier">flash</span>.<span class="ruby-identifier">keys</span> <span class="ruby-comment"># =&gt; [&quot;string&quot;, :symbol]</span>

<span class="ruby-comment"># Rails &gt;= 4.1</span>
<span class="ruby-identifier">flash</span>.<span class="ruby-identifier">keys</span> <span class="ruby-comment"># =&gt; [&quot;string&quot;, &quot;symbol&quot;]</span>
</pre>

<p>Make sure you are comparing Flash message keys against strings.</p>

<h3 id="label-Changes+in+JSON+handling">Changes in JSON handling<span><a href="#label-Changes+in+JSON+handling">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>There are a few major changes related to JSON handling in Rails 4.1.</p>

<h4 id="label-MultiJSON+removal">MultiJSON removal<span><a href="#label-MultiJSON+removal">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>MultiJSON has reached its <a
href="https://github.com/rails/rails/pull/10576">end-of-life</a> and has
been removed from Rails.</p>

<p>If your application currently depend on MultiJSON directly, you have a few
options:</p>
<ol><li>
<p>Add &#39;multi_json&#39; to your <a
href="../code/getting_started/Gemfile.html">Gemfile</a>. Note that this
might cease to work in the future</p>
</li><li>
<p>Migrate away from MultiJSON by using <code>obj.to_json</code>, and
<code>JSON.parse(str)</code> instead.</p>
</li></ol>

<p>WARNING: Do not simply replace <code>MultiJson.dump</code> and
<code>MultiJson.load</code> with <code>JSON.dump</code> and
<code>JSON.load</code>. These JSON gem APIs are meant for serializing and
deserializing arbitrary Ruby objects and are generally <a
href="http://www.ruby-doc.org/stdlib-2.0.0/libdoc/json/rdoc/JSON.html#method-i-load">unsafe</a>.</p>

<h4 id="label-JSON+gem+compatibility">JSON gem compatibility<span><a href="#label-JSON+gem+compatibility">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>Historically, Rails had some compatibility issues with the JSON gem. Using
<code>JSON.generate</code> and <code>JSON.dump</code> inside a Rails
application could produce unexpected errors.</p>

<p>Rails 4.1 fixed these issues by isolating its own encoder from the JSON
gem. The JSON gem APIs will function as normal, but they will not have
access to any Rails-specific features. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">FooBar</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">as_json</span>(<span class="ruby-identifier">options</span> = <span class="ruby-keyword">nil</span>)
    { <span class="ruby-identifier">foo</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;bar&#39;</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-operator">&gt;&gt;</span> <span class="ruby-constant">FooBar</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">to_json</span> <span class="ruby-comment"># =&gt; &quot;{\&quot;foo\&quot;:\&quot;bar\&quot;}&quot;</span>
<span class="ruby-operator">&gt;&gt;</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-constant">FooBar</span>.<span class="ruby-identifier">new</span>, <span class="ruby-identifier">quirks_mode</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) <span class="ruby-comment"># =&gt; &quot;\&quot;#&lt;FooBar:0x007fa80a481610&gt;\&quot;&quot;</span>
</pre>

<h4 id="label-New+JSON+encoder">New JSON encoder<span><a href="#label-New+JSON+encoder">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>The JSON encoder in Rails 4.1 has been rewritten to take advantage of the
JSON gem. For most applications, this should be a transparent change.
However, as part of the rewrite, the following features have been removed
from the encoder:</p>
<ol><li>
<p>Circular data structure detection</p>
</li><li>
<p>Support for the <code>encode_json</code> hook</p>
</li><li>
<p>Option to encode <code>BigDecimal</code> objects as numbers instead of
strings</p>
</li></ol>

<p>If your application depends on one of these features, you can get them back
by adding the <a
href="https://github.com/rails/activesupport-json_encoder">activesupport-json_encoder</a>
gem to your <a href="../code/getting_started/Gemfile.html">Gemfile</a>.</p>

<h4 id="label-JSON+representation+of+Time+objects">JSON representation of Time objects<span><a href="#label-JSON+representation+of+Time+objects">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p><code>#as_json</code> for objects with time component (<code>Time</code>,
<code>DateTime</code>, <code>ActiveSupport::TimeWithZone</code>) now
returns millisecond precision by default. If you need to keep old behavior
with no millisecond precision, set the following in an initializer:</p>

<pre>ActiveSupport::JSON::Encoding.time_precision = 0</pre>

<h3 id="label-Usage+of+return+within+inline+callback+blocks">Usage of <code>return</code> within inline callback blocks<span><a href="#label-Usage+of+return+within+inline+callback+blocks">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Previously, Rails allowed inline callback blocks to use <code>return</code>
this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ReadOnlyModel</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">before_save</span> { <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> } <span class="ruby-comment"># BAD</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This behaviour was never intentionally supported. Due to a change in the
internals of <code>ActiveSupport::Callbacks</code>, this is no longer
allowed in Rails 4.1. Using a <code>return</code> statement in an inline
callback block causes a <code>LocalJumpError</code> to be raised when the
callback is executed.</p>

<p>Inline callback blocks using <code>return</code> can be refactored to
evaluate to the returned value:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ReadOnlyModel</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">before_save</span> { <span class="ruby-keyword">false</span> } <span class="ruby-comment"># GOOD</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Alternatively, if <code>return</code> is preferred it is recommended to
explicitly define a method:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ReadOnlyModel</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">before_save</span> :<span class="ruby-identifier">before_save_callback</span> <span class="ruby-comment"># GOOD</span>

  <span class="ruby-identifier">private</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">before_save_callback</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This change applies to most places in Rails where callbacks are used,
including Active Record and Active Model callbacks, as well as filters in
Action Controller (e.g. <code>before_action</code>).</p>

<p>See <a href="https://github.com/rails/rails/pull/13271">this pull
request</a> for more details.</p>

<h3 id="label-Methods+defined+in+Active+Record+fixtures">Methods defined in Active Record fixtures<span><a href="#label-Methods+defined+in+Active+Record+fixtures">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.1 evaluates each fixture&#39;s ERB in a separate context, so helper
methods defined in a fixture will not be available in other fixtures.</p>

<p>Helper methods that are used in multiple fixtures should be defined on
modules included in the newly introduced
<code>ActiveRecord::FixtureSet.context_class</code>, in
<code>test_helper.rb</code>.</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">FixtureFileHelpers</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">file_sha</span>(<span class="ruby-identifier">path</span>)
    <span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">SHA2</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;test/fixtures&#39;</span>, <span class="ruby-identifier">path</span>)))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">FixtureSet</span>.<span class="ruby-identifier">context_class</span>.<span class="ruby-identifier">send</span> :<span class="ruby-identifier">include</span>, <span class="ruby-constant">FixtureFileHelpers</span>
</pre>

<h3 id="label-I18n+enforcing+available+locales">I18n enforcing available locales<span><a href="#label-I18n+enforcing+available+locales">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.1 now defaults the I18n option
<code>enforce_available_locales</code> to <code>true</code>, meaning that
it will make sure that all locales passed to it must be declared in the
<code>available_locales</code> list.</p>

<p>To disable it (and allow I18n to accept <em>any</em> locale option) add the
following configuration to your application:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">i18n</span>.<span class="ruby-identifier">enforce_available_locales</span> = <span class="ruby-keyword">false</span>
</pre>

<p>Note that this option was added as a security measure, to ensure user input
could not be used as locale information unless previously known, so
it&#39;s recommended not to disable this option unless you have a strong
reason for doing so.</p>

<h3 id="label-Mutator+methods+called+on+Relation">Mutator methods called on Relation<span><a href="#label-Mutator+methods+called+on+Relation">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p><code>Relation</code> no longer has mutator methods like <code>#map!</code>
and <code>#delete_if</code>. Convert to an <code>Array</code> by calling
<code>#to_a</code> before using these methods.</p>

<p>It intends to prevent odd bugs and confusion in code that call mutator
methods directly on the <code>Relation</code>.</p>

<pre class="ruby"><span class="ruby-comment"># Instead of this</span>
<span class="ruby-constant">Author</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Hank Moody&#39;</span>).<span class="ruby-identifier">compact!</span>

<span class="ruby-comment"># Now you have to do this</span>
<span class="ruby-identifier">authors</span> = <span class="ruby-constant">Author</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Hank Moody&#39;</span>).<span class="ruby-identifier">to_a</span>
<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">compact!</span>
</pre>

<h3 id="label-Changes+on+Default+Scopes">Changes on Default Scopes<span><a href="#label-Changes+on+Default+Scopes">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Default scopes are no longer overriden by chained conditions.</p>

<p>In previous versions when you defined a <code>default_scope</code> in a
model it was overriden by chained conditions in the same field. Now it is
merged like any other scope.</p>

<p>Before:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">User</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">default_scope</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;pending&#39;</span> }
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">active</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;active&#39;</span> }
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">inactive</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;inactive&#39;</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">all</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39;</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">active</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;active&#39;</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;inactive&#39;</span>)
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;inactive&#39;</span>
</pre>

<p>After:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">User</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">default_scope</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;pending&#39;</span> }
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">active</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;active&#39;</span> }
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">inactive</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;inactive&#39;</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">all</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39;</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">active</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39; AND &quot;users&quot;.&quot;state&quot; = &#39;active&#39;</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;inactive&#39;</span>)
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39; AND &quot;users&quot;.&quot;state&quot; = &#39;inactive&#39;</span>
</pre>

<p>To get the previous behavior it is needed to explicitly remove the
<code>default_scope</code> condition using <code>unscoped</code>,
<code>unscope</code>, <code>rewhere</code> or <code>except</code>.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">User</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">default_scope</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;pending&#39;</span> }
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">active</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">unscope</span>(<span class="ruby-identifier">where</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">state</span>).<span class="ruby-identifier">where</span>(<span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;active&#39;</span>) }
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">inactive</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">rewhere</span> <span class="ruby-identifier">state</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;inactive&#39;</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">all</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;pending&#39;</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">active</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;active&#39;</span>

<span class="ruby-constant">User</span>.<span class="ruby-identifier">inactive</span>
<span class="ruby-comment"># SELECT &quot;users&quot;.* FROM &quot;users&quot; WHERE &quot;users&quot;.&quot;state&quot; = &#39;inactive&#39;</span>
</pre>

<h3 id="label-Rendering+content+from+string">Rendering content from string<span><a href="#label-Rendering+content+from+string">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.1 introduces <code>:plain</code>, <code>:html</code>, and
<code>:body</code> options to <code>render</code>. Those options are now
the preferred way to render string-based content, as it allows you to
specify which content type you want the response sent as.</p>
<ul><li>
<p><code>render :plain</code> will set the content type to
<code>text/plain</code></p>
</li><li>
<p><code>render :html</code> will set the content type to
<code>text/html</code></p>
</li><li>
<p><code>render :body</code> will <em>not</em> set the content type header.</p>
</li></ul>

<p>From the security standpoint, if you don&#39;t expect to have any markup in
your response body, you should be using <code>render :plain</code> as most
browsers will escape unsafe content in the response for you.</p>

<p>We will be deprecating the use of <code>render :text</code> in a future
version. So please start using the more precise <code>:plain:</code>,
<code>:html</code>, and <code>:body</code> options instead. Using
<code>render :text</code> may pose a security risk, as the content is sent
as <code>text/html</code>.</p>

<h3 id="label-PostgreSQL+json+and+hstore+datatypes">PostgreSQL json and hstore datatypes<span><a href="#label-PostgreSQL+json+and+hstore+datatypes">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.1 will map <code>json</code> and <code>hstore</code> columns to a
string-keyed Ruby <code>Hash</code>. In earlier versions a
<code>HashWithIndifferentAccess</code> was used. This means that symbol
access is no longer supported. This is also the case for
<code>store_accessors</code> based on top of <code>json</code> or
<code>hstore</code> columns. Make sure to use string keys consistently.</p>

<h3 id="label-Explicit+block+use+for+ActiveSupport%3A%3ACallbacks">Explicit block use for <code>ActiveSupport::Callbacks</code><span><a href="#label-Explicit+block+use+for+ActiveSupport%3A%3ACallbacks">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.1 now expects an explicit block to be passed when calling
<code>ActiveSupport::Callbacks.set_callback</code>. This change stems from
<code>ActiveSupport::Callbacks</code> being largely rewritten for the 4.1
release.</p>

<pre class="ruby"><span class="ruby-comment"># Previously in Rails 4.0</span>
<span class="ruby-identifier">set_callback</span> :<span class="ruby-identifier">save</span>, :<span class="ruby-identifier">around</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span>(<span class="ruby-identifier">r</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) { <span class="ruby-identifier">stuff</span>; <span class="ruby-identifier">result</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>; <span class="ruby-identifier">stuff</span> }

<span class="ruby-comment"># Now in Rails 4.1</span>
<span class="ruby-identifier">set_callback</span> :<span class="ruby-identifier">save</span>, :<span class="ruby-identifier">around</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span>(<span class="ruby-identifier">r</span>, <span class="ruby-identifier">block</span>) { <span class="ruby-identifier">stuff</span>; <span class="ruby-identifier">result</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>; <span class="ruby-identifier">stuff</span> }
</pre>

<h2 id="label-Upgrading+from+Rails+3.2+to+Rails+4.0">Upgrading from Rails 3.2 to Rails 4.0<span><a href="#label-Upgrading+from+Rails+3.2+to+Rails+4.0">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>If your application is currently on any version of Rails older than 3.2.x,
you should upgrade to Rails 3.2 before attempting one to Rails 4.0.</p>

<p>The following changes are meant for upgrading your application to Rails
4.0.</p>

<h3 id="label-HTTP+PATCH">HTTP PATCH<span><a href="#label-HTTP+PATCH">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4 now uses <code>PATCH</code> as the primary HTTP verb for updates
when a RESTful resource is declared in <code>config/routes.rb</code>. The
<code>update</code> action is still used, and <code>PUT</code> requests
will continue to be routed to the <code>update</code> action as well. So,
if you&#39;re using only the standard RESTful routes, no changes need to be
made:</p>

<pre class="ruby"><span class="ruby-identifier">resources</span> :<span class="ruby-identifier">users</span>
</pre>

<pre>&lt;%= form_for @user do |f| %&gt;</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">UsersController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
    <span class="ruby-comment"># No change needed; PATCH will be preferred, and PUT will still work.</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>However, you will need to make a change if you are using
<code>form_for</code> to update a resource in conjunction with a custom
route using the <code>PUT</code> HTTP method:</p>

<pre class="ruby"><span class="ruby-identifier">resources</span> :<span class="ruby-identifier">users</span>, <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">put</span> :<span class="ruby-identifier">update_name</span>, <span class="ruby-identifier">on</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">member</span>
<span class="ruby-keyword">end</span>
</pre>

<pre>&lt;%= form_for [ :update_name, @user ] do |f| %&gt;</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">UsersController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ApplicationController</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">update_name</span>
    <span class="ruby-comment"># Change needed; form_for will try to use a non-existent PATCH route.</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If the action is not being used in a public API and you are free to change
the HTTP method, you can update your route to use <code>patch</code>
instead of <code>put</code>:</p>

<p><code>PUT</code> requests to <code>/users/:id</code> in Rails 4 get routed
to <code>update</code> as they are today. So, if you have an API that gets
real PUT requests it is going to work. The router also routes
<code>PATCH</code> requests to <code>/users/:id</code> to the
<code>update</code> action.</p>

<pre class="ruby"><span class="ruby-identifier">resources</span> :<span class="ruby-identifier">users</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">patch</span> :<span class="ruby-identifier">update_name</span>, <span class="ruby-identifier">on</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">member</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If the action is being used in a public API and you can&#39;t change to
HTTP method being used, you can update your form to use the
<code>PUT</code> method instead:</p>

<pre>&lt;%= form_for [ :update_name, @user ], method: :put do |f| %&gt;</pre>

<p>For more on PATCH and why this change was made, see <a
href="http://weblog.rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method-for-updates/">this
post</a> on the Rails blog.</p>

<h4 id="label-A+note+about+media+types">A note about media types<span><a href="#label-A+note+about+media+types">&para;</a> <a href="#documentation">&uarr;</a></span></h4>

<p>The errata for the <code>PATCH</code> verb <a
href="http://www.rfc-editor.org/errata_search.php?rfc=5789">specifies that
a ‘diff’ media type should be used with PATCH</a>. One such format is <a
href="http://tools.ietf.org/html/rfc6902">JSON Patch</a>. While Rails does
not support JSON Patch natively, it&#39;s easy enough to add support:</p>

<pre class="ruby"><span class="ruby-comment"># in your controller</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
  <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> <span class="ruby-keyword">do</span>
      <span class="ruby-comment"># perform a partial update</span>
      <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">update</span> <span class="ruby-identifier">params</span>[:<span class="ruby-identifier">post</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json_patch</span> <span class="ruby-keyword">do</span>
      <span class="ruby-comment"># perform sophisticated change</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># In config/initializers/json_patch.rb:</span>
<span class="ruby-constant">Mime</span><span class="ruby-operator">::</span><span class="ruby-constant">Type</span>.<span class="ruby-identifier">register</span> <span class="ruby-string">&#39;application/json-patch+json&#39;</span>, :<span class="ruby-identifier">json_patch</span>
</pre>

<p>As JSON Patch was only recently made into an RFC, there aren&#39;t a lot of
great Ruby libraries yet. Aaron Patterson&#39;s <a
href="https://github.com/tenderlove/hana">hana</a> is one such gem, but
doesn&#39;t have full support for the last few changes in the
specification.</p>

<h3 id="label-Gemfile"><a href="../code/getting_started/Gemfile.html">Gemfile</a><span><a href="#label-Gemfile">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.0 removed the <code>assets</code> group from <a
href="../code/getting_started/Gemfile.html">Gemfile</a>. You&#39;d need to
remove that line from your <a
href="../code/getting_started/Gemfile.html">Gemfile</a> when upgrading. You
should also update your application file (in
<code>config/application.rb</code>):</p>

<pre class="ruby"><span class="ruby-comment"># Require the gems listed in Gemfile, including any gems</span>
<span class="ruby-comment"># you&#39;ve limited to :test, :development, or :production.</span>
<span class="ruby-constant">Bundler</span>.<span class="ruby-identifier">require</span>(:<span class="ruby-identifier">default</span>, <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">env</span>)
</pre>

<h3 id="label-vendor%2Fplugins">vendor/plugins<span><a href="#label-vendor%2Fplugins">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.0 no longer supports loading plugins from
<code>vendor/plugins</code>. You must replace any plugins by extracting
them to gems and adding them to your <a
href="../code/getting_started/Gemfile.html">Gemfile</a>. If you choose not
to make them gems, you can move them into, say,
<code>lib/my_plugin/*</code> and add an appropriate initializer in
<code>config/initializers/my_plugin.rb</code>.</p>

<h3 id="label-Active+Record">Active Record<span><a href="#label-Active+Record">&para;</a> <a href="#documentation">&uarr;</a></span></h3>
<ul><li>
<p>Rails 4.0 has removed the identity map from Active Record, due to <a
href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">some
inconsistencies with associations</a>. If you have manually enabled it in
your application, you will have to remove the following config that has no
effect anymore: <code>config.active_record.identity_map</code>.</p>
</li><li>
<p>The <code>delete</code> method in collection associations can now receive
<code>Fixnum</code> or <code>String</code> arguments as record ids, besides
records, pretty much like the <code>destroy</code> method does. Previously
it raised <code>ActiveRecord::AssociationTypeMismatch</code> for such
arguments. From Rails 4.0 on <code>delete</code> automatically tries to
find the records matching the given ids before deleting them.</p>
</li><li>
<p>In Rails 4.0 when a column or a table is renamed the related indexes are
also renamed. If you have migrations which rename the indexes, they are no
longer needed.</p>
</li><li>
<p>Rails 4.0 has changed <code>serialized_attributes</code> and
<code>attr_readonly</code> to class methods only. You shouldn&#39;t use
instance methods since it&#39;s now deprecated. You should change them to
use class methods, e.g. <code>self.serialized_attributes</code> to
<code>self.class.serialized_attributes</code>.</p>
</li><li>
<p>When using the default coder, assigning <code>nil</code> to a serialized
attribute will save it to the database as <code>NULL</code> instead of
passing the <code>nil</code> value through YAML (<code>&quot;---
\n...\n&quot;</code>).</p>
</li><li>
<p>Rails 4.0 has removed <code>attr_accessible</code> and
<code>attr_protected</code> feature in favor of Strong Parameters. You can
use the <a href="https://github.com/rails/protected_attributes">Protected
Attributes gem</a> for a smooth upgrade path.</p>
</li><li>
<p>If you are not using Protected Attributes, you can remove any options
related to this gem such as <code>whitelist_attributes</code> or
<code>mass_assignment_sanitizer</code> options.</p>
</li><li>
<p>Rails 4.0 requires that scopes use a callable object such as a Proc or
lambda:</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">scope</span> :<span class="ruby-identifier">active</span>, <span class="ruby-identifier">where</span>(<span class="ruby-identifier">active</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)

  <span class="ruby-comment"># becomes</span>
  <span class="ruby-identifier">scope</span> :<span class="ruby-identifier">active</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">active</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> }
</pre>
<ul><li>
<p>Rails 4.0 has deprecated <code>ActiveRecord::Fixtures</code> in favor of
<code>ActiveRecord::FixtureSet</code>.</p>
</li><li>
<p>Rails 4.0 has deprecated <code>ActiveRecord::TestCase</code> in favor of
<code>ActiveSupport::TestCase</code>.</p>
</li><li>
<p>Rails 4.0 has deprecated the old-style hash based finder API. This means
that  methods which previously accepted “finder options” no longer do.</p>
</li><li>
<p>All dynamic methods except for <code>find_by_...</code> and
<code>find_by_...!</code> are deprecated.  Here&#39;s how you can handle
the changes:</p>
<ul><li>
<p><code>find_all_by_...</code> becomes <code>where(...)</code>.</p>
</li><li>
<p><code>find_last_by_...</code> becomes <code>where(...).last</code>.</p>
</li><li>
<p><code>scoped_by_...</code> becomes <code>where(...)</code>.</p>
</li><li>
<p><code>find_or_initialize_by_...</code> becomes
<code>find_or_initialize_by(...)</code>.</p>
</li><li>
<p><code>find_or_create_by_...</code> becomes
<code>find_or_create_by(...)</code>.</p>
</li></ul>
</li><li>
<p>Note that <code>where(...)</code> returns a relation, not an array like the
old finders. If you require an <code>Array</code>, use
<code>where(...).to_a</code>.</p>
</li><li>
<p>These equivalent methods may not execute the same SQL as the previous
implementation.</p>
</li><li>
<p>To re-enable the old finders, you can use the <a
href="https://github.com/rails/activerecord-deprecated_finders">activerecord-deprecated_finders
gem</a>.</p>
</li></ul>

<h3 id="label-Active+Resource">Active Resource<span><a href="#label-Active+Resource">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.0 extracted Active Resource to its own gem. If you still need the
feature you can add the <a
href="https://github.com/rails/activeresource">Active Resource gem</a> in
your <a href="../code/getting_started/Gemfile.html">Gemfile</a>.</p>

<h3 id="label-Active+Model">Active Model<span><a href="#label-Active+Model">&para;</a> <a href="#documentation">&uarr;</a></span></h3>
<ul><li>
<p>Rails 4.0 has changed how errors attach with the
<code>ActiveModel::Validations::ConfirmationValidator</code>. Now when
confirmation validations fail, the error will be attached to
<code>:#{attribute}_confirmation</code> instead of <code>attribute</code>.</p>
</li><li>
<p>Rails 4.0 has changed
<code>ActiveModel::Serializers::JSON.include_root_in_json</code> default
value to <code>false</code>. Now, Active Model Serializers and Active
Record objects have the same default behaviour. This means that you can
comment or remove the following option in the
<code>config/initializers/wrap_parameters.rb</code> file:</p>
</li></ul>

<pre class="ruby"><span class="ruby-comment"># Disable root element in JSON by default.</span>
<span class="ruby-comment"># ActiveSupport.on_load(:active_record) do</span>
<span class="ruby-comment">#   self.include_root_in_json = false</span>
<span class="ruby-comment"># end</span>
</pre>

<h3 id="label-Action+Pack">Action Pack<span><a href="#label-Action+Pack">&para;</a> <a href="#documentation">&uarr;</a></span></h3>
<ul><li>
<p>Rails 4.0 introduces <code>ActiveSupport::KeyGenerator</code> and uses this
as a base from which to generate and verify signed cookies (among other
things). Existing signed cookies generated with Rails 3.x will be
transparently upgraded if you leave your existing <code>secret_token</code>
in place and add the new <code>secret_key_base</code>.</p>
</li></ul>

<pre class="ruby"><span class="ruby-comment"># config/initializers/secret_token.rb</span>
  <span class="ruby-constant">Myapp</span><span class="ruby-operator">::</span><span class="ruby-constant">Application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">secret_token</span> = <span class="ruby-string">&#39;existing secret token&#39;</span>
  <span class="ruby-constant">Myapp</span><span class="ruby-operator">::</span><span class="ruby-constant">Application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">secret_key_base</span> = <span class="ruby-string">&#39;new secret key base&#39;</span>
</pre>

<p>Please note that you should wait to set <code>secret_key_base</code> until
you have 100% of your userbase on Rails 4.x and are reasonably sure you
will not need to rollback to Rails 3.x. This is because cookies signed
based on the new <code>secret_key_base</code> in Rails 4.x are not
backwards compatible with Rails 3.x. You are free to leave your existing
<code>secret_token</code> in place, not set the new
<code>secret_key_base</code>, and ignore the deprecation warnings until you
are reasonably sure that your upgrade is otherwise complete.</p>

<p>If you are relying on the ability for external applications or Javascript
to be able to read your Rails app&#39;s signed session cookies (or signed
cookies in general) you should not set <code>secret_key_base</code> until
you have decoupled these concerns.</p>
<ul><li>
<p>Rails 4.0 encrypts the contents of cookie-based sessions if
<code>secret_key_base</code> has been set. Rails 3.x signed, but did not
encrypt, the contents of cookie-based session. Signed cookies are “secure”
in that they are verified to have been generated by your app and are
tamper-proof. However, the contents can be viewed by end users, and
encrypting the contents eliminates this caveat/concern without a
significant performance penalty.</p>
</li></ul>

<p>Please read <a href="https://github.com/rails/rails/pull/9978">Pull Request
#9978</a> for details on the move to encrypted session cookies.</p>
<ul><li>
<p>Rails 4.0 removed the <code>ActionController::Base.asset_path</code>
option. Use the assets pipeline feature.</p>
</li><li>
<p>Rails 4.0 has deprecated
<code>ActionController::Base.page_cache_extension</code> option. Use
<code>ActionController::Base.default_static_extension</code> instead.</p>
</li><li>
<p>Rails 4.0 has removed Action and Page caching from Action Pack. You will
need to add the <code>actionpack-action_caching</code> gem in order to use
<code>caches_action</code> and the <code>actionpack-page_caching</code> to
use <code>caches_pages</code> in your controllers.</p>
</li><li>
<p>Rails 4.0 has removed the XML parameters parser. You will need to add the
<code>actionpack-xml_parser</code> gem if you require this feature.</p>
</li><li>
<p>Rails 4.0 changes the default memcached client from
<code>memcache-client</code> to <code>dalli</code>. To upgrade, simply add
<code>gem &#39;dalli&#39;</code> to your <code>Gemfile</code>.</p>
</li><li>
<p>Rails 4.0 deprecates the <code>dom_id</code> and <code>dom_class</code>
methods in controllers (they are fine in views). You will need to include
the <code>ActionView::RecordIdentifier</code> module in controllers
requiring this feature.</p>
</li><li>
<p>Rails 4.0 deprecates the <code>:confirm</code> option for the
<code>link_to</code> helper. You should instead rely on a data attribute
(e.g. <code>data: { confirm: &#39;Are you sure?&#39; }</code>). This
deprecation also concerns the helpers based on this one (such as
<code>link_to_if</code> or <code>link_to_unless</code>).</p>
</li><li>
<p>Rails 4.0 changed how <code>assert_generates</code>,
<code>assert_recognizes</code>, and <code>assert_routing</code> work. Now
all these assertions raise <code>Assertion</code> instead of
<code>ActionController::RoutingError</code>.</p>
</li><li>
<p>Rails 4.0 raises an <code>ArgumentError</code> if clashing named routes are
defined. This can be triggered by explicitly defined named routes or by the
<code>resources</code> method. Here are two examples that clash with routes
named <code>example_path</code>:</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">get</span> <span class="ruby-string">&#39;one&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test#example&#39;</span>, <span class="ruby-identifier">as</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">example</span>
  <span class="ruby-identifier">get</span> <span class="ruby-string">&#39;two&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test#example&#39;</span>, <span class="ruby-identifier">as</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">example</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">resources</span> :<span class="ruby-identifier">examples</span>
  <span class="ruby-identifier">get</span> <span class="ruby-string">&#39;clashing/:id&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test#example&#39;</span>, <span class="ruby-identifier">as</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">example</span>
</pre>

<p>In the first case, you can simply avoid using the same name for multiple
routes. In the second, you can use the <code>only</code> or
<code>except</code> options provided by the <code>resources</code> method
to restrict the routes created as detailed in the <a
href="routing.html#restricting-the-routes-created">Routing Guide</a>.</p>
<ul><li>
<p>Rails 4.0 also changed the way unicode character routes are drawn. Now you
can draw unicode character routes directly. If you already draw such
routes, you must change them, for example:</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">get</span> <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Utils</span>.<span class="ruby-identifier">escape</span>(<span class="ruby-string">&#39;こんにちは&#39;</span>), <span class="ruby-identifier">controller</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;welcome&#39;</span>, <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;index&#39;</span>
</pre>

<p>becomes</p>

<pre class="ruby"><span class="ruby-identifier">get</span> <span class="ruby-string">&#39;こんにちは&#39;</span>, <span class="ruby-identifier">controller</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;welcome&#39;</span>, <span class="ruby-identifier">action</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;index&#39;</span>
</pre>
<ul><li>
<p>Rails 4.0 requires that routes using <code>match</code> must specify the
request method. For example:</p>
</li></ul>

<pre class="ruby"><span class="ruby-comment"># Rails 3.x</span>
  <span class="ruby-identifier">match</span> <span class="ruby-string">&#39;/&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;root#index&#39;</span>

  <span class="ruby-comment"># becomes</span>
  <span class="ruby-identifier">match</span> <span class="ruby-string">&#39;/&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;root#index&#39;</span>, <span class="ruby-identifier">via</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">get</span>

  <span class="ruby-comment"># or</span>
  <span class="ruby-identifier">get</span> <span class="ruby-string">&#39;/&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;root#index&#39;</span>
</pre>
<ul><li>
<p>Rails 4.0 has removed <code>ActionDispatch::BestStandardsSupport</code>
middleware, <code>&lt;!DOCTYPE html&gt;</code> already triggers standards
mode per <a
href="http://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx">msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx</a>
and ChromeFrame header has been moved to
<code>config.action_dispatch.default_headers</code>.</p>
</li></ul>

<p>Remember you must also remove any references to the middleware from your
application code, for example:</p>

<pre class="ruby"><span class="ruby-comment"># Raise exception</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">middleware</span>.<span class="ruby-identifier">insert_before</span>(<span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Lock</span>, <span class="ruby-constant">ActionDispatch</span><span class="ruby-operator">::</span><span class="ruby-constant">BestStandardsSupport</span>)
</pre>

<p>Also check your environment settings for
<code>config.action_dispatch.best_standards_support</code> and remove it if
present.</p>
<ul><li>
<p>In Rails 4.0, precompiling assets no longer automatically copies non-JS/CSS
assets from <code>vendor/assets</code> and <code>lib/assets</code>. Rails
application and engine developers should put these assets in
<code>app/assets</code> or configure <code>config.assets.precompile</code>.</p>
</li><li>
<p>In Rails 4.0, <code>ActionController::UnknownFormat</code> is raised when
the action doesn&#39;t handle the request format. By default, the exception
is handled by responding with 406 Not Acceptable, but you can override that
now. In Rails 3, 406 Not Acceptable was always returned. No overrides.</p>
</li><li>
<p>In Rails 4.0, a generic
<code>ActionDispatch::ParamsParser::ParseError</code> exception is raised
when <code>ParamsParser</code> fails to parse request params. You will want
to rescue this exception instead of the low-level
<code>MultiJson::DecodeError</code>, for example.</p>
</li><li>
<p>In Rails 4.0, <code>SCRIPT_NAME</code> is properly nested when engines are
mounted on an app that&#39;s served from a URL prefix. You no longer have
to set <code>default_url_options[:script_name]</code> to work around
overwritten URL prefixes.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::Integration</code> in favor of
<code>ActionDispatch::Integration</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::IntegrationTest</code> in
favor of <code>ActionDispatch::IntegrationTest</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::PerformanceTest</code> in
favor of <code>ActionDispatch::PerformanceTest</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::AbstractRequest</code> in
favor of <code>ActionDispatch::Request</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::Request</code> in favor of
<code>ActionDispatch::Request</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::AbstractResponse</code> in
favor of <code>ActionDispatch::Response</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::Response</code> in favor of
<code>ActionDispatch::Response</code>.</p>
</li><li>
<p>Rails 4.0 deprecated <code>ActionController::Routing</code> in favor of
<code>ActionDispatch::Routing</code>.</p>
</li></ul>

<h3 id="label-Active+Support">Active Support<span><a href="#label-Active+Support">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 4.0 removes the <code>j</code> alias for
<code>ERB::Util#json_escape</code> since <code>j</code> is already used for
<code>ActionView::Helpers::JavaScriptHelper#escape_javascript</code>.</p>

<h3 id="label-Helpers+Loading+Order">Helpers Loading Order<span><a href="#label-Helpers+Loading+Order">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The order in which helpers from more than one directory are loaded has
changed in Rails 4.0. Previously, they were gathered and then sorted
alphabetically. After upgrading to Rails 4.0, helpers will preserve the
order of loaded directories and will be sorted alphabetically only within
each directory. Unless you explicitly use the <code>helpers_path</code>
parameter, this change will only impact the way of loading helpers from
engines. If you rely on the ordering, you should check if correct methods
are available after upgrade. If you would like to change the order in which
engines are loaded, you can use <code>config.railties_order=</code> method.</p>

<h3 id="label-Active+Record+Observer+and+Action+Controller+Sweeper">Active Record Observer and Action Controller Sweeper<span><a href="#label-Active+Record+Observer+and+Action+Controller+Sweeper">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Active Record Observer and Action Controller Sweeper have been extracted to
the <code>rails-observers</code> gem. You will need to add the
<code>rails-observers</code> gem if you require these features.</p>

<h3 id="label-sprockets-rails">sprockets-rails<span><a href="#label-sprockets-rails">&para;</a> <a href="#documentation">&uarr;</a></span></h3>
<ul><li>
<p><code>assets:precompile:primary</code> and
<code>assets:precompile:all</code> have been removed. Use
<code>assets:precompile</code> instead.</p>
</li><li>
<p>The <code>config.assets.compress</code> option should be changed to
<code>config.assets.js_compressor</code> like so for instance:</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">js_compressor</span> = :<span class="ruby-identifier">uglifier</span>
</pre>

<h3 id="label-sass-rails">sass-rails<span><a href="#label-sass-rails">&para;</a> <a href="#documentation">&uarr;</a></span></h3>
<ul><li>
<p><code>asset-url</code> with two arguments is deprecated. For example:
<code>asset-url(&quot;rails.png&quot;, image)</code> becomes
<code>asset-url(&quot;rails.png&quot;)</code>.</p>
</li></ul>

<h2 id="label-Upgrading+from+Rails+3.1+to+Rails+3.2">Upgrading from Rails 3.1 to Rails 3.2<span><a href="#label-Upgrading+from+Rails+3.1+to+Rails+3.2">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>If your application is currently on any version of Rails older than 3.1.x,
you should upgrade to Rails 3.1 before attempting an update to Rails 3.2.</p>

<p>The following changes are meant for upgrading your application to Rails
3.2.17, the last 3.2.x version of Rails.</p>

<h3 id="label-Gemfile"><a href="../code/getting_started/Gemfile.html">Gemfile</a><span><a href="#label-Gemfile">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Make the following changes to your <code>Gemfile</code>.</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;rails&#39;</span>, <span class="ruby-string">&#39;3.2.17&#39;</span>

<span class="ruby-identifier">group</span> :<span class="ruby-identifier">assets</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;sass-rails&#39;</span>,   <span class="ruby-string">&#39;~&gt; 3.2.6&#39;</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;coffee-rails&#39;</span>, <span class="ruby-string">&#39;~&gt; 3.2.2&#39;</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;uglifier&#39;</span>,     <span class="ruby-string">&#39;&gt;= 1.0.3&#39;</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-config%2Fenvironments%2Fdevelopment.rb">config/environments/development.rb<span><a href="#label-config%2Fenvironments%2Fdevelopment.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>There are a couple of new configuration settings that you should add to
your development environment:</p>

<pre class="ruby"><span class="ruby-comment"># Raise exception on mass assignment protection for Active Record models</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">active_record</span>.<span class="ruby-identifier">mass_assignment_sanitizer</span> = :<span class="ruby-identifier">strict</span>

<span class="ruby-comment"># Log the query plan for queries taking more than this (works</span>
<span class="ruby-comment"># with SQLite, MySQL, and PostgreSQL)</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">active_record</span>.<span class="ruby-identifier">auto_explain_threshold_in_seconds</span> = <span class="ruby-value">0.5</span>
</pre>

<h3 id="label-config%2Fenvironments%2Ftest.rb">config/environments/test.rb<span><a href="#label-config%2Fenvironments%2Ftest.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The <code>mass_assignment_sanitizer</code> configuration setting should
also be be added to <code>config/environments/test.rb</code>:</p>

<pre class="ruby"><span class="ruby-comment"># Raise exception on mass assignment protection for Active Record models</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">active_record</span>.<span class="ruby-identifier">mass_assignment_sanitizer</span> = :<span class="ruby-identifier">strict</span>
</pre>

<h3 id="label-vendor%2Fplugins">vendor/plugins<span><a href="#label-vendor%2Fplugins">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Rails 3.2 deprecates <code>vendor/plugins</code> and Rails 4.0 will remove
them completely. While it&#39;s not strictly necessary as part of a Rails
3.2 upgrade, you can start replacing any plugins by extracting them to gems
and adding them to your <a
href="../code/getting_started/Gemfile.html">Gemfile</a>. If you choose not
to make them gems, you can move them into, say,
<code>lib/my_plugin/*</code> and add an appropriate initializer in
<code>config/initializers/my_plugin.rb</code>.</p>

<h3 id="label-Active+Record">Active Record<span><a href="#label-Active+Record">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Option <code>:dependent =&gt; :restrict</code> has been removed from
<code>belongs_to</code>. If you want to prevent deleting the object if
there are any associated objects, you can set <code>:dependent =&gt;
:destroy</code> and return <code>false</code> after checking for existence
of association from any of the associated object&#39;s destroy callbacks.</p>

<h2 id="label-Upgrading+from+Rails+3.0+to+Rails+3.1">Upgrading from Rails 3.0 to Rails 3.1<span><a href="#label-Upgrading+from+Rails+3.0+to+Rails+3.1">&para;</a> <a href="#documentation">&uarr;</a></span></h2>

<p>If your application is currently on any version of Rails older than 3.0.x,
you should upgrade to Rails 3.0 before attempting an update to Rails 3.1.</p>

<p>The following changes are meant for upgrading your application to Rails
3.1.12, the last 3.1.x version of Rails.</p>

<h3 id="label-Gemfile"><a href="../code/getting_started/Gemfile.html">Gemfile</a><span><a href="#label-Gemfile">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Make the following changes to your <code>Gemfile</code>.</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;rails&#39;</span>, <span class="ruby-string">&#39;3.1.12&#39;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;mysql2&#39;</span>

<span class="ruby-comment"># Needed for the new asset pipeline</span>
<span class="ruby-identifier">group</span> :<span class="ruby-identifier">assets</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;sass-rails&#39;</span>,   <span class="ruby-string">&#39;~&gt; 3.1.7&#39;</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;coffee-rails&#39;</span>, <span class="ruby-string">&#39;~&gt; 3.1.1&#39;</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;uglifier&#39;</span>,     <span class="ruby-string">&#39;&gt;= 1.0.3&#39;</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># jQuery is the default JavaScript library in Rails 3.1</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;jquery-rails&#39;</span>
</pre>

<h3 id="label-config%2Fapplication.rb">config/application.rb<span><a href="#label-config%2Fapplication.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>The asset pipeline requires the following additions:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">enabled</span> = <span class="ruby-keyword">true</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">version</span> = <span class="ruby-string">&#39;1.0&#39;</span>
</pre>

<p>If your application is using an “/assets” route for a resource you may want
change the prefix used for assets to avoid conflicts:</p>

<pre class="ruby"><span class="ruby-comment"># Defaults to &#39;/assets&#39;</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">prefix</span> = <span class="ruby-string">&#39;/asset-files&#39;</span>
</pre>

<h3 id="label-config%2Fenvironments%2Fdevelopment.rb">config/environments/development.rb<span><a href="#label-config%2Fenvironments%2Fdevelopment.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Remove the RJS setting <code>config.action_view.debug_rjs = true</code>.</p>

<p>Add these settings if you enable the asset pipeline:</p>

<pre class="ruby"><span class="ruby-comment"># Do not compress assets</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">compress</span> = <span class="ruby-keyword">false</span>

<span class="ruby-comment"># Expands the lines which load the assets</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">debug</span> = <span class="ruby-keyword">true</span>
</pre>

<h3 id="label-config%2Fenvironments%2Fproduction.rb">config/environments/production.rb<span><a href="#label-config%2Fenvironments%2Fproduction.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Again, most of the changes below are for the asset pipeline. You can read
more about these in the <a href="asset_pipeline.html">Asset Pipeline</a>
guide.</p>

<pre class="ruby"><span class="ruby-comment"># Compress JavaScripts and CSS</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">compress</span> = <span class="ruby-keyword">true</span>

<span class="ruby-comment"># Don&#39;t fallback to assets pipeline if a precompiled asset is missed</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">compile</span> = <span class="ruby-keyword">false</span>

<span class="ruby-comment"># Generate digests for assets URLs</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">digest</span> = <span class="ruby-keyword">true</span>

<span class="ruby-comment"># Defaults to Rails.root.join(&quot;public/assets&quot;)</span>
<span class="ruby-comment"># config.assets.manifest = YOUR_PATH</span>

<span class="ruby-comment"># Precompile additional assets (application.js, application.css, and all non-JS/CSS are already added)</span>
<span class="ruby-comment"># config.assets.precompile += %w( search.js )</span>

<span class="ruby-comment"># Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.</span>
<span class="ruby-comment"># config.force_ssl = true</span>
</pre>

<h3 id="label-config%2Fenvironments%2Ftest.rb">config/environments/test.rb<span><a href="#label-config%2Fenvironments%2Ftest.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You can help test performance with these additions to your test
environment:</p>

<pre class="ruby"><span class="ruby-comment"># Configure static asset server for tests with Cache-Control for performance</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">serve_static_assets</span> = <span class="ruby-keyword">true</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">static_cache_control</span> = <span class="ruby-string">&#39;public, max-age=3600&#39;</span>
</pre>

<h3 id="label-config%2Finitializers%2Fwrap_parameters.rb">config/initializers/wrap_parameters.rb<span><a href="#label-config%2Finitializers%2Fwrap_parameters.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>Add this file with the following contents, if you wish to wrap parameters
into a nested hash. This is on by default in new applications.</p>

<pre class="ruby"><span class="ruby-comment"># Be sure to restart your server when you modify this file.</span>
<span class="ruby-comment"># This file contains settings for ActionController::ParamsWrapper which</span>
<span class="ruby-comment"># is enabled by default.</span>

<span class="ruby-comment"># Enable parameter wrapping for JSON. You can disable this by setting :format to an empty array.</span>
<span class="ruby-constant">ActiveSupport</span>.<span class="ruby-identifier">on_load</span>(:<span class="ruby-identifier">action_controller</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">wrap_parameters</span> <span class="ruby-identifier">format</span><span class="ruby-operator">:</span> [:<span class="ruby-identifier">json</span>]
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># Disable root element in JSON by default.</span>
<span class="ruby-constant">ActiveSupport</span>.<span class="ruby-identifier">on_load</span>(:<span class="ruby-identifier">active_record</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">include_root_in_json</span> = <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-config%2Finitializers%2Fsession_store.rb">config/initializers/session_store.rb<span><a href="#label-config%2Finitializers%2Fsession_store.rb">&para;</a> <a href="#documentation">&uarr;</a></span></h3>

<p>You need to change your session key to something new, or remove all
sessions:</p>

<pre class="ruby"><span class="ruby-comment"># in config/initializers/session_store.rb</span>
<span class="ruby-constant">AppName</span><span class="ruby-operator">::</span><span class="ruby-constant">Application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">session_store</span> :<span class="ruby-identifier">cookie_store</span>, <span class="ruby-identifier">key</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;SOMETHINGNEW&#39;</span>
</pre>

<p>or</p>

<pre>$ bin/rake db:sessions:clear</pre>

<h3 id="label-Remove+%3Acache+and+%3Aconcat+options+in+asset+helpers+references+in+views">Remove :cache and :concat options in asset helpers references in views<span><a href="#label-Remove+%3Acache+and+%3Aconcat+options+in+asset+helpers+references+in+views">&para;</a> <a href="#documentation">&uarr;</a></span></h3>
<ul><li>
<p>With the Asset Pipeline the :cache and :concat options aren&#39;t used
anymore, delete these options from your views.</p>
</li></ul>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://rdoc.rubyforge.org">RDoc</a> 4.1.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

