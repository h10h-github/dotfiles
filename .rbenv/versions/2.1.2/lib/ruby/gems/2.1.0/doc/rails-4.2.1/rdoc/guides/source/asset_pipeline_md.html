<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>asset_pipeline - rails-4.2.1 Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-The+Asset+Pipeline">The Asset Pipeline</a>
    <li><a href="#label-What+is+the+Asset+Pipeline-3F">What is the Asset Pipeline?</a>
    <li><a href="#label-Main+Features">Main Features</a>
    <li><a href="#label-What+is+Fingerprinting+and+Why+Should+I+Care-3F">What is Fingerprinting and Why Should I Care?</a>
    <li><a href="#label-How+to+Use+the+Asset+Pipeline">How to Use the Asset Pipeline</a>
    <li><a href="#label-Controller+Specific+Assets">Controller Specific Assets</a>
    <li><a href="#label-Asset+Organization">Asset Organization</a>
    <li><a href="#label-Search+Paths">Search Paths</a>
    <li><a href="#label-Using+Index+Files">Using Index Files</a>
    <li><a href="#label-Coding+Links+to+Assets">Coding Links to Assets</a>
    <li><a href="#label-CSS+and+ERB">CSS and ERB</a>
    <li><a href="#label-CSS+and+Sass">CSS and Sass</a>
    <li><a href="#label-JavaScript-2FCoffeeScript+and+ERB">JavaScript/CoffeeScript and ERB</a>
    <li><a href="#label-Manifest+Files+and+Directives">Manifest Files and Directives</a>
    <li><a href="#label-Preprocessing">Preprocessing</a>
    <li><a href="#label-In+Development">In Development</a>
    <li><a href="#label-Runtime+Error+Checking">Runtime Error Checking</a>
    <li><a href="#label-Turning+Digests+Off">Turning Digests Off</a>
    <li><a href="#label-Turning+Debugging+Off">Turning Debugging Off</a>
    <li><a href="#label-In+Production">In Production</a>
    <li><a href="#label-Precompiling+Assets">Precompiling Assets</a>
    <li><a href="#label-Far-future+Expires+Header">Far-future Expires Header</a>
    <li><a href="#label-GZip+Compression">GZip Compression</a>
    <li><a href="#label-Local+Precompilation">Local Precompilation</a>
    <li><a href="#label-Live+Compilation">Live Compilation</a>
    <li><a href="#label-CDNs">CDNs</a>
    <li><a href="#label-Set+up+a+CDN+to+Serve+Static+Assets">Set up a CDN to Serve Static Assets</a>
    <li><a href="#label-Customize+CDN+Caching+Behavior">Customize CDN Caching Behavior</a>
    <li><a href="#label-CDN+Request+Caching">CDN Request Caching</a>
    <li><a href="#label-CDN+Header+Debugging">CDN Header Debugging</a>
    <li><a href="#label-CDNs+and+the+Cache-Control+Header">CDNs and the Cache-Control Header</a>
    <li><a href="#label-CDNs+and+URL+based+Cache+Invalidation">CDNs and URL based Cache Invalidation</a>
    <li><a href="#label-Customizing+the+Pipeline">Customizing the Pipeline</a>
    <li><a href="#label-CSS+Compression">CSS Compression</a>
    <li><a href="#label-JavaScript+Compression">JavaScript Compression</a>
    <li><a href="#label-Using+Your+Own+Compressor">Using Your Own Compressor</a>
    <li><a href="#label-Changing+the+assets+Path">Changing the <em>assets</em> Path</a>
    <li><a href="#label-X-Sendfile+Headers">X-Sendfile Headers</a>
    <li><a href="#label-Assets+Cache+Store">Assets Cache Store</a>
    <li><a href="#label-Adding+Assets+to+Your+Gems">Adding Assets to Your Gems</a>
    <li><a href="#label-Making+Your+Library+or+Gem+a+Pre-Processor">Making Your Library or Gem a Pre-Processor</a>
    <li><a href="#label-Upgrading+from+Old+Versions+of+Rails">Upgrading from Old Versions of Rails</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/4_2_release_notes_md.html">4_2_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_job_basics_md.html">active_job_basics</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_migrations_md.html">active_record_migrations</a>
  
    <li><a href="../../guides/source/active_record_postgresql_md.html">active_record_postgresql</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/autoloading_and_reloading_constants_md.html">autoloading_and_reloading_constants</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/asset_pipeline.md">

<h1 id="label-The+Asset+Pipeline">The Asset Pipeline<span><a href="#label-The+Asset+Pipeline">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>This guide covers the asset pipeline.</p>

<p>After reading this guide, you will know:</p>

<p>What the asset pipeline is and what it does.  How to properly organize your
application assets.  The benefits of the asset pipeline.  How to add a
pre-processor to the pipeline.  How to package assets with a gem.</p>
<hr>

<h2 id="label-What+is+the+Asset+Pipeline-3F">What is the Asset Pipeline?<span><a href="#label-What+is+the+Asset+Pipeline-3F">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The asset pipeline provides a framework to concatenate and minify or
compress JavaScript and CSS assets. It also adds the ability to write these
assets in other languages and pre-processors such as CoffeeScript, Sass and
ERB.</p>

<p>The asset pipeline is technically no longer a core feature of Rails 4, it
has been extracted out of the framework into the <a
href="https://github.com/rails/sprockets-rails">sprockets-rails</a> gem.</p>

<p>The asset pipeline is enabled by default.</p>

<p>You can disable the asset pipeline while creating a new application by
passing the <code>--skip-sprockets</code> option.</p>

<pre class="ruby"><span class="ruby-identifier">rails</span> <span class="ruby-identifier">new</span> <span class="ruby-identifier">appname</span> <span class="ruby-operator">-</span><span class="ruby-operator">-</span><span class="ruby-identifier">skip</span><span class="ruby-operator">-</span><span class="ruby-identifier">sprockets</span>
</pre>

<p>Rails 4 automatically adds the <code>sass-rails</code>,
<code>coffee-rails</code> and <code>uglifier</code> gems to your Gemfile,
which are used by Sprockets for asset compression:</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;sass-rails&#39;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;uglifier&#39;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;coffee-rails&#39;</span>
</pre>

<p>Using the <code>--skip-sprockets</code> option will prevent Rails 4 from
adding <code>sass-rails</code> and <code>uglifier</code> to Gemfile, so if
you later want to enable the asset pipeline you will have to add those gems
to your Gemfile. Also, creating an application with the
<code>--skip-sprockets</code> option will generate a slightly different
<code>config/application.rb</code> file, with a require statement for the
sprockets railtie that is commented-out. You will have to remove the
comment operator on that line to later enable the asset pipeline:</p>

<pre class="ruby"><span class="ruby-comment"># require &quot;sprockets/railtie&quot;</span>
</pre>

<p>To set asset compression methods, set the appropriate configuration options
in <code>production.rb</code> - <code>config.assets.css_compressor</code>
for your CSS and <code>config.assets.js_compressor</code> for your
JavaScript:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">css_compressor</span> = :<span class="ruby-identifier">yui</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">js_compressor</span> = :<span class="ruby-identifier">uglifier</span>
</pre>

<p>NOTE: The <code>sass-rails</code> gem is automatically used for CSS
compression if included in Gemfile and no
<code>config.assets.css_compressor</code> option is set.</p>

<h3 id="label-Main+Features">Main Features<span><a href="#label-Main+Features">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The first feature of the pipeline is to concatenate assets, which can
reduce the number of requests that a browser makes to render a web page.
Web browsers are limited in the number of requests that they can make in
parallel, so fewer requests can mean faster loading for your application.</p>

<p>Sprockets concatenates all JavaScript files into one master
<code>.js</code> file and all CSS files into one master <code>.css</code>
file. As you&#39;ll learn later in this guide, you can customize this
strategy to group files any way you like. In production, Rails inserts an
MD5 fingerprint into each filename so that the file is cached by the web
browser. You can invalidate the cache by altering this fingerprint, which
happens automatically whenever you change the file contents.</p>

<p>The second feature of the asset pipeline is asset minification or
compression. For CSS files, this is done by removing whitespace and
comments. For JavaScript, more complex processes can be applied. You can
choose from a set of built in options or specify your own.</p>

<p>The third feature of the asset pipeline is it allows coding assets via a
higher-level language, with precompilation down to the actual assets.
Supported languages include Sass for CSS, CoffeeScript for JavaScript, and
ERB for both by default.</p>

<h3 id="label-What+is+Fingerprinting+and+Why+Should+I+Care-3F">What is Fingerprinting and Why Should I Care?<span><a href="#label-What+is+Fingerprinting+and+Why+Should+I+Care-3F">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Fingerprinting is a technique that makes the name of a file dependent on
the contents of the file. When the file contents change, the filename is
also changed. For content that is static or infrequently changed, this
provides an easy way to tell whether two versions of a file are identical,
even across different servers or deployment dates.</p>

<p>When a filename is unique and based on its content, HTTP headers can be set
to encourage caches everywhere (whether at CDNs, at ISPs, in networking
equipment, or in web browsers) to keep their own copy of the content. When
the content is updated, the fingerprint will change. This will cause the
remote clients to request a new copy of the content. This is generally
known as <em>cache busting</em>.</p>

<p>The technique sprockets uses for fingerprinting is to insert a hash of the
content into the name, usually at the end. For example a CSS file
<code>global.css</code></p>

<pre>global-908e25f4bf641868d8683022a5b62f54.css</pre>

<p>This is the strategy adopted by the Rails asset pipeline.</p>

<p>Rails&#39; old strategy was to append a date-based query string to every
asset linked with a built-in helper. In the source the generated code
looked like this:</p>

<pre>/stylesheets/global.css?1309495796</pre>

<p>The query string strategy has several disadvantages:</p>
<ol><li>
<p><strong>Not all caches will reliably cache content where the filename only
differs by query parameters</strong></p>

<p><a
href="http://www.stevesouders.com/blog/2008/08/23/revving-filenames-dont-use-querystring/">Steve
Souders recommends</a>,  “…avoiding a querystring for cacheable resources”.
He found that in this case 5-20% of requests will not be cached. Query
strings in particular do not work at all with some CDNs for cache
invalidation.</p>
</li><li>
<p><strong>The file name can change between nodes in multi-server
environments.</strong></p>

<p>The default query string in Rails 2.x is based on the modification time of
the files. When assets are deployed to a cluster, there is no guarantee
that the timestamps will be the same, resulting in different values being
used depending on which server handles the request.</p>
</li><li>
<p><strong>Too much cache invalidation</strong></p>

<p>When static assets are deployed with each new release of code, the mtime
(time of last modification) of <em>all</em> these files changes, forcing
all remote clients to fetch them again, even when the content of those
assets has not changed.</p>
</li></ol>

<p>Fingerprinting fixes these problems by avoiding query strings, and by
ensuring that filenames are consistent based on their content.</p>

<p>Fingerprinting is enabled by default for production and disabled for all
other environments. You can enable or disable it in your configuration
through the <code>config.assets.digest</code> option.</p>

<p>More reading:</p>

<p><a
href="http://code.google.com/speed/page-speed/docs/caching.html">Optimize
caching</a>  <a
href="http://www.stevesouders.com/blog/2008/08/23/revving-filenames-dont-use-querystring/">Revving
Filenames: don’t use querystring</a></p>

<h2 id="label-How+to+Use+the+Asset+Pipeline">How to Use the Asset Pipeline<span><a href="#label-How+to+Use+the+Asset+Pipeline">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In previous versions of Rails, all assets were located in subdirectories of
<code>public</code> such as <code>images</code>, <code>javascripts</code>
and <code>stylesheets</code>. With the asset pipeline, the preferred
location for these assets is now the <code>app/assets</code> directory.
Files in this directory are served by the Sprockets middleware.</p>

<p>Assets can still be placed in the <code>public</code> hierarchy. Any assets
under <code>public</code> will be served as static files by the application
or web server when <code>config.serve_static_files</code> is set to true.
You should use <code>app/assets</code> for files that must undergo some
pre-processing before they are served.</p>

<p>In production, Rails precompiles these files to <code>public/assets</code>
by default. The precompiled copies are then served as static assets by the
web server. The files in <code>app/assets</code> are never served directly
in production.</p>

<h3 id="label-Controller+Specific+Assets">Controller Specific Assets<span><a href="#label-Controller+Specific+Assets">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>When you generate a scaffold or a controller, Rails also generates a
JavaScript file (or CoffeeScript file if the <code>coffee-rails</code> gem
is in the <code>Gemfile</code>) and a Cascading Style Sheet file (or SCSS
file if <code>sass-rails</code> is in the <code>Gemfile</code>) for that
controller. Additionally, when generating a scaffold, Rails generates the
file scaffolds.css (or scaffolds.css.scss if <code>sass-rails</code> is in
the <code>Gemfile</code>.)</p>

<p>For example, if you generate a <code>ProjectsController</code>, Rails will
also add a new file at
<code>app/assets/javascripts/projects.js.coffee</code> and another at
<code>app/assets/stylesheets/projects.css.scss</code>. By default these
files will be ready to use by your application immediately using the
<code>require_tree</code> directive. See <a
href="#manifest-files-and-directives">Manifest Files and Directives</a> for
more details on require_tree.</p>

<p>You can also opt to include controller specific stylesheets and JavaScript
files only in their respective controllers using the following:</p>

<p><code>&lt;%= javascript_include_tag params[:controller] %&gt;</code> or
<code>&lt;%= stylesheet_link_tag params[:controller] %&gt;</code></p>

<p>When doing this, ensure you are not using the <code>require_tree</code>
directive, as that will result in your assets being included more than
once.</p>

<p>WARNING: When using asset precompilation, you will need to ensure that your
controller assets will be precompiled when loading them on a per page
basis. By default .coffee and .scss files will not be precompiled on their
own. See <a href="#precompiling-assets">Precompiling Assets</a> for more
information on how precompiling works.</p>

<p>NOTE: You must have an ExecJS supported runtime in order to use
CoffeeScript. If you are using Mac OS X or Windows, you have a JavaScript
runtime installed in your operating system. Check <a
href="https://github.com/rails/execjs#readme">ExecJS</a> documentation to
know all supported JavaScript runtimes.</p>

<p>You can also disable generation of controller specific asset files by
adding the following to your <code>config/application.rb</code>
configuration:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">generators</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">g</span>.<span class="ruby-identifier">assets</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Asset+Organization">Asset Organization<span><a href="#label-Asset+Organization">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Pipeline assets can be placed inside an application in one of three
locations: <code>app/assets</code>, <code>lib/assets</code> or
<code>vendor/assets</code>.</p>

<p><code>app/assets</code> is for assets that are owned by the application,
such as custom images, JavaScript files or stylesheets.</p>

<p><code>lib/assets</code> is for your own libraries&#39; code that
doesn&#39;t really fit into the scope of the application or those libraries
which are shared across applications.</p>

<p><code>vendor/assets</code> is for assets that are owned by outside
entities, such as code for JavaScript plugins and CSS frameworks. Keep in
mind that third party code with references to other files also processed by
the asset Pipeline (images, stylesheets, etc.), will need to be rewritten
to use helpers like <code>asset_path</code>.</p>

<p>WARNING: If you are upgrading from Rails 3, please take into account that
assets under <code>lib/assets</code> or <code>vendor/assets</code> are
available for inclusion via the application manifests but no longer part of
the precompile array. See <a href="#precompiling-assets">Precompiling
Assets</a> for guidance.</p>

<h4 id="label-Search+Paths">Search Paths<span><a href="#label-Search+Paths">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When a file is referenced from a manifest or a helper, Sprockets searches
the three default asset locations for it.</p>

<p>The default locations are: the <code>images</code>,
<code>javascripts</code> and <code>stylesheets</code> directories under the
<code>app/assets</code> folder, but these subdirectories are not special -
any path under <code>assets</code> will be searched.</p>

<p>For example, these files:</p>

<pre class="ruby"><span class="ruby-identifier">app</span><span class="ruby-operator">/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">javascripts</span><span class="ruby-operator">/</span><span class="ruby-identifier">home</span>.<span class="ruby-identifier">js</span>
<span class="ruby-identifier">lib</span><span class="ruby-operator">/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">javascripts</span><span class="ruby-operator">/</span><span class="ruby-identifier">moovinator</span>.<span class="ruby-identifier">js</span>
<span class="ruby-identifier">vendor</span><span class="ruby-operator">/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">javascripts</span><span class="ruby-operator">/</span><span class="ruby-identifier">slider</span>.<span class="ruby-identifier">js</span>
<span class="ruby-identifier">vendor</span><span class="ruby-operator">/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">somepackage</span><span class="ruby-operator">/</span><span class="ruby-identifier">phonebox</span>.<span class="ruby-identifier">js</span>
</pre>

<p>would be referenced in a manifest like this:</p>

<pre>//= require home
//= require moovinator
//= require slider
//= require phonebox</pre>

<p>Assets inside subdirectories can also be accessed.</p>

<pre class="ruby"><span class="ruby-identifier">app</span><span class="ruby-operator">/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">javascripts</span><span class="ruby-operator">/</span><span class="ruby-identifier">sub</span><span class="ruby-operator">/</span><span class="ruby-identifier">something</span>.<span class="ruby-identifier">js</span>
</pre>

<p>is referenced as:</p>

<pre>//= require sub/something</pre>

<p>You can view the search path by inspecting
<code>Rails.application.config.assets.paths</code> in the Rails console.</p>

<p>Besides the standard <code>assets</code> paths, additional (fully
qualified) paths can be added to the pipeline in
<code>config/application.rb</code>. For example:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">paths</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;lib&quot;</span>, <span class="ruby-string">&quot;videoplayer&quot;</span>, <span class="ruby-string">&quot;flash&quot;</span>)
</pre>

<p>Paths are traversed in the order they occur in the search path. By default,
this means the files in <code>app/assets</code> take precedence, and will
mask corresponding paths in <code>lib</code> and <code>vendor</code>.</p>

<p>It is important to note that files you want to reference outside a manifest
must be added to the precompile array or they will not be available in the
production environment.</p>

<h4 id="label-Using+Index+Files">Using Index Files<span><a href="#label-Using+Index+Files">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Sprockets uses files named <code>index</code> (with the relevant
extensions) for a special purpose.</p>

<p>For example, if you have a jQuery library with many modules, which is
stored in <code>lib/assets/javascripts/library_name</code>, the file
<code>lib/assets/javascripts/library_name/index.js</code> serves as the
manifest for all files in this library. This file could include a list of
all the required files in order, or a simple <code>require_tree</code>
directive.</p>

<p>The library as a whole can be accessed in the application manifest like so:</p>

<pre>//= require library_name</pre>

<p>This simplifies maintenance and keeps things clean by allowing related code
to be grouped before inclusion elsewhere.</p>

<h3 id="label-Coding+Links+to+Assets">Coding Links to Assets<span><a href="#label-Coding+Links+to+Assets">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Sprockets does not add any new methods to access your assets - you still
use the familiar <code>javascript_include_tag</code> and
<code>stylesheet_link_tag</code>:</p>

<pre>&lt;%= stylesheet_link_tag &quot;application&quot;, media: &quot;all&quot; %&gt;
&lt;%= javascript_include_tag &quot;application&quot; %&gt;</pre>

<p>If using the turbolinks gem, which is included by default in Rails 4, then
include the &#39;data-turbolinks-track&#39; option which causes turbolinks
to check if an asset has been updated and if so loads it into the page:</p>

<pre>&lt;%= stylesheet_link_tag &quot;application&quot;, media: &quot;all&quot;, &quot;data-turbolinks-track&quot; =&gt; true %&gt;
&lt;%= javascript_include_tag &quot;application&quot;, &quot;data-turbolinks-track&quot; =&gt; true %&gt;</pre>

<p>In regular views you can access images in the
<code>public/assets/images</code> directory like this:</p>

<pre>&lt;%= image_tag &quot;rails.png&quot; %&gt;</pre>

<p>Provided that the pipeline is enabled within your application (and not
disabled in the current environment context), this file is served by
Sprockets. If a file exists at <code>public/assets/rails.png</code> it is
served by the web server.</p>

<p>Alternatively, a request for a file with an MD5 hash such as
<code>public/assets/rails-af27b6a414e6da00003503148be9b409.png</code> is
treated the same way. How these hashes are generated is covered in the <a
href="#in-production">In Production</a> section later on in this guide.</p>

<p>Sprockets will also look through the paths specified in
<code>config.assets.paths</code>, which includes the standard application
paths and any paths added by Rails engines.</p>

<p>Images can also be organized into subdirectories if required, and then can
be accessed by specifying the directory&#39;s name in the tag:</p>

<pre>&lt;%= image_tag &quot;icons/rails.png&quot; %&gt;</pre>

<p>WARNING: If you&#39;re precompiling your assets (see <a
href="#in-production">In Production</a> below), linking to an asset that
does not exist will raise an exception in the calling page. This includes
linking to a blank string. As such, be careful using <code>image_tag</code>
and the other helpers with user-supplied data.</p>

<h4 id="label-CSS+and+ERB">CSS and ERB<span><a href="#label-CSS+and+ERB">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The asset pipeline automatically evaluates ERB. This means if you add an
<code>erb</code> extension to a CSS asset (for example,
<code>application.css.erb</code>), then helpers like
<code>asset_path</code> are available in your CSS rules:</p>

<pre>.class { background-image: url(&lt;%= asset_path &#39;image.png&#39; %&gt;) }</pre>

<p>This writes the path to the particular asset being referenced. In this
example, it would make sense to have an image in one of the asset load
paths, such as <code>app/assets/images/image.png</code>, which would be
referenced here. If this image is already available in
<code>public/assets</code> as a fingerprinted file, then that path is
referenced.</p>

<p>If you want to use a <a
href="http://en.wikipedia.org/wiki/Data_URI_scheme">data URI</a> - a method
of embedding the image data directly into the CSS file - you can use the
<code>asset_data_uri</code> helper.</p>

<pre class="ruby"><span class="ruby-comment">#logo { background: url(&lt;%= asset_data_uri &#39;logo.png&#39; %&gt;) }</span>
</pre>

<p>This inserts a correctly-formatted data URI into the CSS source.</p>

<p>Note that the closing tag cannot be of the style <code>-%&gt;</code>.</p>

<h4 id="label-CSS+and+Sass">CSS and Sass<span><a href="#label-CSS+and+Sass">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When using the asset pipeline, paths to assets must be re-written and
<code>sass-rails</code> provides <code>-url</code> and <code>-path</code>
helpers (hyphenated in Sass, underscored in Ruby) for the following asset
classes: image, font, video, audio, JavaScript and stylesheet.</p>

<p><code>image-url(&quot;rails.png&quot;)</code> becomes
<code>url(/assets/rails.png)</code> 
<code>image-path(&quot;rails.png&quot;)</code> becomes
<code>&quot;/assets/rails.png&quot;</code>.</p>

<p>The more generic form can also be used:</p>

<p><code>asset-url(&quot;rails.png&quot;)</code> becomes
<code>url(/assets/rails.png)</code> 
<code>asset-path(&quot;rails.png&quot;)</code> becomes
<code>&quot;/assets/rails.png&quot;</code></p>

<h4 id="label-JavaScript-2FCoffeeScript+and+ERB">JavaScript/CoffeeScript and ERB<span><a href="#label-JavaScript-2FCoffeeScript+and+ERB">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If you add an <code>erb</code> extension to a JavaScript asset, making it
something such as <code>application.js.erb</code>, you can then use the
<code>asset_path</code> helper in your JavaScript code:</p>

<pre>$(&#39;#logo&#39;).attr({ src: &quot;&lt;%= asset_path(&#39;logo.png&#39;) %&gt;&quot; });</pre>

<p>This writes the path to the particular asset being referenced.</p>

<p>Similarly, you can use the <code>asset_path</code> helper in CoffeeScript
files with <code>erb</code> extension (e.g.,
<code>application.js.coffee.erb</code>):</p>

<pre>$(&#39;#logo&#39;).attr src: &quot;&lt;%= asset_path(&#39;logo.png&#39;) %&gt;&quot;</pre>

<h3 id="label-Manifest+Files+and+Directives">Manifest Files and Directives<span><a href="#label-Manifest+Files+and+Directives">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Sprockets uses manifest files to determine which assets to include and
serve. These manifest files contain <em>directives</em> - instructions that
tell Sprockets which files to require in order to build a single CSS or
JavaScript file. With these directives, Sprockets loads the files
specified, processes them if necessary, concatenates them into one single
file and then compresses them (if
<code>Rails.application.config.assets.compress</code> is true). By serving
one file rather than many, the load time of pages can be greatly reduced
because the browser makes fewer requests. Compression also reduces file
size, enabling the browser to download them faster.</p>

<p>For example, a new Rails 4 application includes a default
<code>app/assets/javascripts/application.js</code> file containing the
following lines:</p>

<pre>// ...
//= require jquery
//= require jquery_ujs
//= require_tree .</pre>

<p>In JavaScript files, Sprockets directives begin with <code>//=</code>. In
the above case, the file is using the <code>require</code> and the
<code>require_tree</code> directives. The <code>require</code> directive is
used to tell Sprockets the files you wish to require. Here, you are
requiring the files <code>jquery.js</code> and <code>jquery_ujs.js</code>
that are available somewhere in the search path for Sprockets. You need not
supply the extensions explicitly. Sprockets assumes you are requiring a
<code>.js</code> file when done from within a <code>.js</code> file.</p>

<p>The <code>require_tree</code> directive tells Sprockets to recursively
include <em>all</em> JavaScript files in the specified directory into the
output. These paths must be specified relative to the manifest file. You
can also use the <code>require_directory</code> directive which includes
all JavaScript files only in the directory specified, without recursion.</p>

<p>Directives are processed top to bottom, but the order in which files are
included by <code>require_tree</code> is unspecified. You should not rely
on any particular order among those. If you need to ensure some particular
JavaScript ends up above some other in the concatenated file, require the
prerequisite file first in the manifest. Note that the family of
<code>require</code> directives prevents files from being included twice in
the output.</p>

<p>Rails also creates a default
<code>app/assets/stylesheets/application.css</code> file which contains
these lines:</p>

<pre>/* ...
 = require_self
 = require_tree .</pre>

<p>Rails 4 creates both <code>app/assets/javascripts/application.js</code> and
<code>app/assets/stylesheets/application.css</code> regardless of whether
the –skip-sprockets option is used when creating a new rails application.
This is so you can easily add asset pipelining later if you like.</p>

<p>The directives that work in JavaScript files also work in stylesheets
(though obviously including stylesheets rather than JavaScript files). The
<code>require_tree</code> directive in a CSS manifest works the same way as
the JavaScript one, requiring all stylesheets from the current directory.</p>

<p>In this example, <code>require_self</code> is used. This puts the CSS
contained within the file (if any) at the precise location of the
<code>require_self</code> call.</p>

<p>NOTE. If you want to use multiple Sass files, you should generally use the
<a
href="http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#import">Sass
@import rule</a> instead of these Sprockets directives. When using
Sprockets directives, Sass files exist within their own scope, making
variables or mixins only available within the document they were defined
in.</p>

<p>You can do file globbing as well using <code>@import &quot;*&quot;</code>,
and <code>@import &quot;   *&quot;</code> to add the whole tree which is
equivalent to how <code>require_tree</code> works. Check the <a
href="https://github.com/rails/sass-rails#features">sass-rails
documentation</a> for more info and important caveats.</p>

<p>You can have as many manifest files as you need. For example, the
<code>admin.css</code> and <code>admin.js</code> manifest could contain the
JS and CSS files that are used for the admin section of an application.</p>

<p>The same remarks about ordering made above apply. In particular, you can
specify individual files and they are compiled in the order specified. For
example, you might concatenate three CSS files together this way:</p>

<pre>/* ...
 = require reset
 = require layout
 = require chrome
 /</pre>

<h3 id="label-Preprocessing">Preprocessing<span><a href="#label-Preprocessing">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The file extensions used on an asset determine what preprocessing is
applied. When a controller or a scaffold is generated with the default
Rails gemset, a CoffeeScript file and a SCSS file are generated in place of
a regular JavaScript and CSS file. The example used before was a controller
called “projects”, which generated an
<code>app/assets/javascripts/projects.js.coffee</code> and an
<code>app/assets/stylesheets/projects.css.scss</code> file.</p>

<p>In development mode, or if the asset pipeline is disabled, when these files
are requested they are processed by the processors provided by the
<code>coffee-script</code> and <code>sass</code> gems and then sent back to
the browser as JavaScript and CSS respectively. When asset pipelining is
enabled, these files are preprocessed and placed in the
<code>public/assets</code> directory for serving by either the Rails app or
web server.</p>

<p>Additional layers of preprocessing can be requested by adding other
extensions, where each extension is processed in a right-to-left manner.
These should be used in the order the processing should be applied. For
example, a stylesheet called
<code>app/assets/stylesheets/projects.css.scss.erb</code> is first
processed as ERB, then SCSS, and finally served as CSS. The same applies to
a JavaScript file -
<code>app/assets/javascripts/projects.js.coffee.erb</code> is processed as
ERB, then CoffeeScript, and served as JavaScript.</p>

<p>Keep in mind the order of these preprocessors is important. For example, if
you called your JavaScript file
<code>app/assets/javascripts/projects.js.erb.coffee</code> then it would be
processed with the CoffeeScript interpreter first, which wouldn&#39;t
understand ERB and therefore you would run into problems.</p>

<h2 id="label-In+Development">In Development<span><a href="#label-In+Development">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In development mode, assets are served as separate files in the order they
are specified in the manifest file.</p>

<p>This manifest <code>app/assets/javascripts/application.js</code>:</p>

<pre>//= require core
//= require projects
//= require tickets</pre>

<p>would generate this HTML:</p>

<pre>&lt;script src=&quot;/assets/core.js?body=1&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/assets/projects.js?body=1&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;/assets/tickets.js?body=1&quot;&gt;&lt;/script&gt;</pre>

<p>The <code>body</code> param is required by Sprockets.</p>

<h3 id="label-Runtime+Error+Checking">Runtime Error Checking<span><a href="#label-Runtime+Error+Checking">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>By default the asset pipeline will check for potential errors in
development mode during runtime. To disable this behavior you can set:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">raise_runtime_errors</span> = <span class="ruby-keyword">false</span>
</pre>

<p>When this option is true, the asset pipeline will check if all the assets
loaded in your application are included in the
<code>config.assets.precompile</code> list. If
<code>config.assets.digest</code> is also true, the asset pipeline will
require that all requests for assets include digests.</p>

<h3 id="label-Turning+Digests+Off">Turning Digests Off<span><a href="#label-Turning+Digests+Off">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can turn off digests by updating
<code>config/environments/development.rb</code> to include:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">digest</span> = <span class="ruby-keyword">false</span>
</pre>

<p>When this option is true, digests will be generated for asset URLs.</p>

<h3 id="label-Turning+Debugging+Off">Turning Debugging Off<span><a href="#label-Turning+Debugging+Off">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can turn off debug mode by updating
<code>config/environments/development.rb</code> to include:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">debug</span> = <span class="ruby-keyword">false</span>
</pre>

<p>When debug mode is off, Sprockets concatenates and runs the necessary
preprocessors on all files. With debug mode turned off the manifest above
would generate instead:</p>

<pre>&lt;script src=&quot;/assets/application.js&quot;&gt;&lt;/script&gt;</pre>

<p>Assets are compiled and cached on the first request after the server is
started. Sprockets sets a <code>must-revalidate</code> Cache-Control HTTP
header to reduce request overhead on subsequent requests - on these the
browser gets a 304 (Not Modified) response.</p>

<p>If any of the files in the manifest have changed between requests, the
server responds with a new compiled file.</p>

<p>Debug mode can also be enabled in Rails helper methods:</p>

<pre>&lt;%= stylesheet_link_tag &quot;application&quot;, debug: true %&gt;
&lt;%= javascript_include_tag &quot;application&quot;, debug: true %&gt;</pre>

<p>The <code>:debug</code> option is redundant if debug mode is already on.</p>

<p>You can also enable compression in development mode as a sanity check, and
disable it on-demand as required for debugging.</p>

<h2 id="label-In+Production">In Production<span><a href="#label-In+Production">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In the production environment Sprockets uses the fingerprinting scheme
outlined above. By default Rails assumes assets have been precompiled and
will be served as static assets by your web server.</p>

<p>During the precompilation phase an MD5 is generated from the contents of
the compiled files, and inserted into the filenames as they are written to
disc. These fingerprinted names are used by the Rails helpers in place of
the manifest name.</p>

<p>For example this:</p>

<pre>&lt;%= javascript_include_tag &quot;application&quot; %&gt;
&lt;%= stylesheet_link_tag &quot;application&quot; %&gt;</pre>

<p>generates something like this:</p>

<pre>&lt;script src=&quot;/assets/application-908e25f4bf641868d8683022a5b62f54.js&quot;&gt;&lt;/script&gt;
&lt;link href=&quot;/assets/application-4dd5b109ee3439da54f5bdfd78a80473.css&quot; media=&quot;screen&quot;
rel=&quot;stylesheet&quot; /&gt;</pre>

<p>Note: with the Asset Pipeline the :cache and :concat options aren&#39;t
used anymore, delete these options from the
<code>javascript_include_tag</code> and <code>stylesheet_link_tag</code>.</p>

<p>The fingerprinting behavior is controlled by the
<code>config.assets.digest</code> initialization option (which defaults to
<code>true</code> for production and <code>false</code> for everything
else).</p>

<p>NOTE: Under normal circumstances the default
<code>config.assets.digest</code> option should not be changed. If there
are no digests in the filenames, and far-future headers are set, remote
clients will never know to refetch the files when their content changes.</p>

<h3 id="label-Precompiling+Assets">Precompiling Assets<span><a href="#label-Precompiling+Assets">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Rails comes bundled with a rake task to compile the asset manifests and
other files in the pipeline.</p>

<p>Compiled assets are written to the location specified in
<code>config.assets.prefix</code>. By default, this is the
<code>/assets</code> directory.</p>

<p>You can call this task on the server during deployment to create compiled
versions of your assets directly on the server. See the next section for
information on compiling locally.</p>

<p>The rake task is:</p>

<pre>$ RAILS_ENV=production bin/rake assets:precompile</pre>

<p>Capistrano (v2.15.1 and above) includes a recipe to handle this in
deployment. Add the following line to <code>Capfile</code>:</p>

<pre class="ruby"><span class="ruby-identifier">load</span> <span class="ruby-string">&#39;deploy/assets&#39;</span>
</pre>

<p>This links the folder specified in <code>config.assets.prefix</code> to
<code>shared/assets</code>. If you already use this shared folder
you&#39;ll need to write your own deployment task.</p>

<p>It is important that this folder is shared between deployments so that
remotely cached pages referencing the old compiled assets still work for
the life of the cached page.</p>

<p>The default matcher for compiling files includes
<code>application.js</code>, <code>application.css</code> and all
non-JS/CSS files (this will include all image assets automatically) from
<code>app/assets</code> folders including your gems:</p>

<pre class="ruby">[ <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">filename</span>, <span class="ruby-identifier">path</span><span class="ruby-operator">|</span> <span class="ruby-identifier">path</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/app\/assets/</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-node">%w(.js .css)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">filename</span>)) },
<span class="ruby-regexp">/application.(css|js)$/</span> ]
</pre>

<p>NOTE: The matcher (and other members of the precompile array; see below) is
applied to final compiled file names. This means anything that compiles to
JS/CSS is excluded, as well as raw JS/CSS files; for example,
<code>.coffee</code> and <code>.scss</code> files are <strong>not</strong>
automatically included as they compile to JS/CSS.</p>

<p>If you have other manifests or individual stylesheets and JavaScript files
to include, you can add them to the <code>precompile</code> array in
<code>config/initializers/assets.rb</code>:</p>

<pre class="ruby"><span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">precompile</span> <span class="ruby-operator">+=</span> [<span class="ruby-string">&#39;admin.js&#39;</span>, <span class="ruby-string">&#39;admin.css&#39;</span>, <span class="ruby-string">&#39;swfObject.js&#39;</span>]
</pre>

<p>NOTE. Always specify an expected compiled filename that ends with .js or
.css, even if you want to add Sass or CoffeeScript files to the precompile
array.</p>

<p>The rake task also generates a <code>manifest-md5hash.json</code> that
contains a list with all your assets and their respective fingerprints.
This is used by the Rails helper methods to avoid handing the mapping
requests back to Sprockets. A typical manifest file looks like:</p>

<pre class="ruby">{<span class="ruby-string">&quot;files&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;application-723d1be6cc741a3aabb1cec24276d681.js&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;logical_path&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;application.js&quot;</span>,<span class="ruby-string">&quot;mtime&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;2013-07-26T22:55:03-07:00&quot;</span>,<span class="ruby-string">&quot;size&quot;</span><span class="ruby-operator">:</span><span class="ruby-value">302506</span>,
<span class="ruby-string">&quot;digest&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;723d1be6cc741a3aabb1cec24276d681&quot;</span>},<span class="ruby-string">&quot;application-12b3c7dd74d2e9df37e7cbb1efa76a6d.css&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;logical_path&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;application.css&quot;</span>,<span class="ruby-string">&quot;mtime&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;2013-07-26T22:54:54-07:00&quot;</span>,<span class="ruby-string">&quot;size&quot;</span><span class="ruby-operator">:</span><span class="ruby-value">1560</span>,
<span class="ruby-string">&quot;digest&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;12b3c7dd74d2e9df37e7cbb1efa76a6d&quot;</span>},<span class="ruby-string">&quot;application-1c5752789588ac18d7e1a50b1f0fd4c2.css&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;logical_path&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;application.css&quot;</span>,<span class="ruby-string">&quot;mtime&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;2013-07-26T22:56:17-07:00&quot;</span>,<span class="ruby-string">&quot;size&quot;</span><span class="ruby-operator">:</span><span class="ruby-value">1591</span>,
<span class="ruby-string">&quot;digest&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;1c5752789588ac18d7e1a50b1f0fd4c2&quot;</span>},<span class="ruby-string">&quot;favicon-a9c641bf2b81f0476e876f7c5e375969.ico&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;logical_path&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;favicon.ico&quot;</span>,<span class="ruby-string">&quot;mtime&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;2013-07-26T23:00:10-07:00&quot;</span>,<span class="ruby-string">&quot;size&quot;</span><span class="ruby-operator">:</span><span class="ruby-value">1406</span>,
<span class="ruby-string">&quot;digest&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;a9c641bf2b81f0476e876f7c5e375969&quot;</span>},<span class="ruby-string">&quot;my_image-231a680f23887d9dd70710ea5efd3c62.png&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;logical_path&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;my_image.png&quot;</span>,<span class="ruby-string">&quot;mtime&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;2013-07-26T23:00:27-07:00&quot;</span>,<span class="ruby-string">&quot;size&quot;</span><span class="ruby-operator">:</span><span class="ruby-value">6646</span>,
<span class="ruby-string">&quot;digest&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;231a680f23887d9dd70710ea5efd3c62&quot;</span>}},<span class="ruby-string">&quot;assets&quot;</span><span class="ruby-operator">:</span>{<span class="ruby-string">&quot;application.js&quot;</span><span class="ruby-operator">:</span>
<span class="ruby-string">&quot;application-723d1be6cc741a3aabb1cec24276d681.js&quot;</span>,<span class="ruby-string">&quot;application.css&quot;</span><span class="ruby-operator">:</span>
<span class="ruby-string">&quot;application-1c5752789588ac18d7e1a50b1f0fd4c2.css&quot;</span>,
<span class="ruby-string">&quot;favicon.ico&quot;</span><span class="ruby-operator">:</span><span class="ruby-string">&quot;favicona9c641bf2b81f0476e876f7c5e375969.ico&quot;</span>,<span class="ruby-string">&quot;my_image.png&quot;</span><span class="ruby-operator">:</span>
<span class="ruby-string">&quot;my_image-231a680f23887d9dd70710ea5efd3c62.png&quot;</span>}}
</pre>

<p>The default location for the manifest is the root of the location specified
in <code>config.assets.prefix</code> (&#39;/assets&#39; by default).</p>

<p>NOTE: If there are missing precompiled files in production you will get an
<code>Sprockets::Helpers::RailsHelper::AssetPaths::AssetNotPrecompiledError</code>
exception indicating the name of the missing file(s).</p>

<h4 id="label-Far-future+Expires+Header">Far-future Expires Header<span><a href="#label-Far-future+Expires+Header">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Precompiled assets exist on the file system and are served directly by your
web server. They do not have far-future headers by default, so to get the
benefit of fingerprinting you&#39;ll have to update your server
configuration to add those headers.</p>

<p>For Apache:</p>

<pre># The Expires* directives requires the Apache module
# `mod_expires` to be enabled.
&lt;Location /assets/&gt;
  # Use of ETag is discouraged when Last-Modified is present
  Header unset ETag
  FileETag None
  # RFC says only cache for 1 year
  ExpiresActive On
  ExpiresDefault &quot;access plus 1 year&quot;
&lt;/Location&gt;</pre>

<p>For NGINX:</p>

<pre>location ~ ^/assets/ {
  expires 1y;
  add_header Cache-Control public;

  add_header ETag &quot;&quot;;
  break;
}</pre>

<h4 id="label-GZip+Compression">GZip Compression<span><a href="#label-GZip+Compression">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When files are precompiled, Sprockets also creates a <a
href="http://en.wikipedia.org/wiki/Gzip">gzipped</a> (.gz) version of your
assets. Web servers are typically configured to use a moderate compression
ratio as a compromise, but since precompilation happens once, Sprockets
uses the maximum compression ratio, thus reducing the size of the data
transfer to the minimum. On the other hand, web servers can be configured
to serve compressed content directly from disk, rather than deflating
non-compressed files themselves.</p>

<p>NGINX is able to do this automatically enabling <code>gzip_static</code>:</p>

<pre>location ~ ^/(assets)/  {
  root /path/to/public;
  gzip_static on; # to serve pre-gzipped version
  expires max;
  add_header Cache-Control public;
}</pre>

<p>This directive is available if the core module that provides this feature
was compiled with the web server. Ubuntu/Debian packages, even
<code>nginx-light</code>, have the module compiled. Otherwise, you may need
to perform a manual compilation:</p>

<pre>./configure --with-http_gzip_static_module</pre>

<p>If you&#39;re compiling NGINX with Phusion Passenger you&#39;ll need to
pass that option when prompted.</p>

<p>A robust configuration for Apache is possible but tricky; please Google
around. (Or help update this Guide if you have a good configuration example
for Apache.)</p>

<h3 id="label-Local+Precompilation">Local Precompilation<span><a href="#label-Local+Precompilation">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>There are several reasons why you might want to precompile your assets
locally. Among them are:</p>

<p>You may not have write access to your production file system.  You may be
deploying to more than one server, and want to avoid duplication of work. 
You may be doing frequent deploys that do not include asset changes.</p>

<p>Local compilation allows you to commit the compiled files into source
control, and deploy as normal.</p>

<p>There are three caveats:</p>

<p>You must not run the Capistrano deployment task that precompiles assets. 
You must ensure any necessary compressors or minifiers are available on
your development system.  You must change the following application
configuration setting:</p>

<p>In <code>config/environments/development.rb</code>, place the following
line:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">prefix</span> = <span class="ruby-string">&quot;/dev-assets&quot;</span>
</pre>

<p>The <code>prefix</code> change makes Sprockets use a different URL for
serving assets in development mode, and pass all requests to Sprockets. The
prefix is still set to <code>/assets</code> in the production environment.
Without this change, the application would serve the precompiled assets
from <code>/assets</code> in development, and you would not see any local
changes until you compile assets again.</p>

<p>In practice, this will allow you to precompile locally, have those files in
your working tree, and commit those files to source control when needed.
Development mode will work as expected.</p>

<h3 id="label-Live+Compilation">Live Compilation<span><a href="#label-Live+Compilation">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In some circumstances you may wish to use live compilation. In this mode
all requests for assets in the pipeline are handled by Sprockets directly.</p>

<p>To enable this option set:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">compile</span> = <span class="ruby-keyword">true</span>
</pre>

<p>On the first request the assets are compiled and cached as outlined in
development above, and the manifest names used in the helpers are altered
to include the MD5 hash.</p>

<p>Sprockets also sets the <code>Cache-Control</code> HTTP header to
<code>max-age=31536000</code>. This signals all caches between your server
and the client browser that this content (the file served) can be cached
for 1 year. The effect of this is to reduce the number of requests for this
asset from your server; the asset has a good chance of being in the local
browser cache or some intermediate cache.</p>

<p>This mode uses more memory, performs more poorly than the default and is
not recommended.</p>

<p>If you are deploying a production application to a system without any
pre-existing JavaScript runtimes, you may want to add one to your Gemfile:</p>

<pre class="ruby"><span class="ruby-identifier">group</span> :<span class="ruby-identifier">production</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;therubyracer&#39;</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-CDNs">CDNs<span><a href="#label-CDNs">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>CDN stands for <a
href="http://en.wikipedia.org/wiki/Content_delivery_network">Content
Delivery Network</a>, they are primarily designed to cache assets all over
the world so that when a browser requests the asset, a cached copy will be
geographically close to that browser. If you are serving assets directly
from your Rails server in production, the best practice is to use a CDN in
front of your application.</p>

<p>A common pattern for using a CDN is to set your production application as
the “origin” server. This means when a browser requests an asset from the
CDN and there is a cache miss, it will grab the file from your server on
the fly and then cache it. For example if you are running a Rails
application on <code>example.com</code> and have a CDN configured at
<code>mycdnsubdomain.fictional-cdn.com</code>, then when a request is made
to <code>mycdnsubdomain.fictional- cdn.com/assets/smile.png</code>, the CDN
will query your server once at <code>example.com/assets/smile.png</code>
and cache the request. The next request to the CDN that comes in to the
same URL will hit the cached copy. When the CDN can serve an asset directly
the request never touches your Rails server. Since the assets from a CDN
are geographically closer to the browser, the request is faster, and since
your server doesn&#39;t need to spend time serving assets, it can focus on
serving application code as fast as possible.</p>

<h4 id="label-Set+up+a+CDN+to+Serve+Static+Assets">Set up a CDN to Serve Static Assets<span><a href="#label-Set+up+a+CDN+to+Serve+Static+Assets">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>To set up your CDN you have to have your application running in production
on the internet at a publically available URL, for example
<code>example.com</code>. Next you&#39;ll need to sign up for a CDN service
from a cloud hosting provider. When you do this you need to configure the
“origin” of the CDN to point back at your website <code>example.com</code>,
check your provider for documentation on configuring the origin server.</p>

<p>The CDN you provisioned should give you a custom subdomain for your
application such as <code>mycdnsubdomain.fictional-cdn.com</code> (note
fictional-cdn.com is not a valid CDN provider at the time of this writing).
Now that you have configured your CDN server, you need to tell browsers to
use your CDN to grab assets instead of your Rails server directly. You can
do this by configuring Rails to set your CDN as the asset host instead of
using a relative path. To set your asset host in Rails, you need to set
<code>config.action_controller.asset_host</code> in
<code>config/production.rb</code>:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">action_controller</span>.<span class="ruby-identifier">asset_host</span> = <span class="ruby-string">&#39;mycdnsubdomain.fictional-cdn.com&#39;</span>
</pre>

<p>NOTE: You only need to provide the “host”, this is the subdomain and root
domain, you do not need to specify a protocol or “scheme” such as
<code>http://</code> or <code>https://</code>. When a web page is
requested, the protocol in the link to your asset that is generated will
match how the webpage is accessed by default.</p>

<p>You can also set this value through an <a
href="http://en.wikipedia.org/wiki/Environment_variable">environment
variable</a> to make running a staging copy of your site easier:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">action_controller</span>.<span class="ruby-identifier">asset_host</span> = <span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;CDN_HOST&#39;</span>]
</pre>

<p>Note: You would need to set <code>CDN_HOST</code> on your server to
<code>mycdnsubdomain .fictional-cdn.com</code> for this to work.</p>

<p>Once you have configured your server and your CDN when you serve a webpage
that has an asset:</p>

<pre>&lt;%= asset_path(&#39;smile.png&#39;) %&gt;</pre>

<p>Instead of returning a path such as <code>/assets/smile.png</code> (digests
are left out for readability). The URL generated will have the full path to
your CDN.</p>

<pre class="ruby"><span class="ruby-identifier">http</span>:<span class="ruby-operator">/</span><span class="ruby-regexp">/mycdnsubdomain.fictional-cdn.com/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">smile</span>.<span class="ruby-identifier">png</span>
</pre>

<p>If the CDN has a copy of <code>smile.png</code> it will serve it to the
browser and your server doesn&#39;t even know it was requested. If the CDN
does not have a copy it will try to find it a the “origin”
<code>example.com/assets/smile.png</code> and then store it for future use.</p>

<p>If you want to serve only some assets from your CDN, you can use custom
<code>:host</code> option your asset helper, which overwrites value set in
<code>config.action_controller.asset_host</code>.</p>

<pre>&lt;%= asset_path &#39;image.png&#39;, host: &#39;mycdnsubdomain.fictional-cdn.com&#39; %&gt;</pre>

<h4 id="label-Customize+CDN+Caching+Behavior">Customize CDN Caching Behavior<span><a href="#label-Customize+CDN+Caching+Behavior">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>A CDN works by caching content. If the CDN has stale or bad content, then
it is hurting rather than helping your application. The purpose of this
section is to describe general caching behavior of most CDNs, your specific
provider may behave slightly differently.</p>

<h5 id="label-CDN+Request+Caching">CDN Request Caching<span><a href="#label-CDN+Request+Caching">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>While a CDN is described as being good for caching assets, in reality
caches the entire request. This includes the body of the asset as well as
any headers. The most important one being <code>Cache-Control</code> which
tells the CDN (and web browsers) how to cache contents. This means that if
someone requests an asset that does not exist
<code>/assets/i-dont-exist.png</code> and your Rails application returns a
404, then your CDN will likely cache the 404 page if a valid
<code>Cache-Control</code> header is present.</p>

<h5 id="label-CDN+Header+Debugging">CDN Header Debugging<span><a href="#label-CDN+Header+Debugging">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>One way to check the headers are cached properly in your CDN is by using
[curl]( <a
href="http://explainshell.com/explain?cmd=curl+-I+http%3A%2F%2Fwww.example.com">explainshell.com/explain?cmd=curl+-I+http%3A%2F%2Fwww.example.com</a>).
You can request the headers from both your server and your CDN to verify
they are the same:</p>

<pre>$ curl -I http://www.example/assets/application-
d0e099e021c95eb0de3615fd1d8c4d83.css
HTTP/1.1 200 OK
Server: Cowboy
Date: Sun, 24 Aug 2014 20:27:50 GMT
Connection: keep-alive
Last-Modified: Thu, 08 May 2014 01:24:14 GMT
Content-Type: text/css
Cache-Control: public, max-age=2592000
Content-Length: 126560
Via: 1.1 vegur</pre>

<p>Versus the CDN copy.</p>

<pre>$ curl -I http://mycdnsubdomain.fictional-cdn.com/application-
d0e099e021c95eb0de3615fd1d8c4d83.css
HTTP/1.1 200 OK Server: Cowboy Last-
Modified: Thu, 08 May 2014 01:24:14 GMT Content-Type: text/css
Cache-Control:
public, max-age=2592000
Via: 1.1 vegur
Content-Length: 126560
Accept-Ranges:
bytes
Date: Sun, 24 Aug 2014 20:28:45 GMT
Via: 1.1 varnish
Age: 885814
Connection: keep-alive
X-Served-By: cache-dfw1828-DFW
X-Cache: HIT
X-Cache-Hits:
68
X-Timer: S1408912125.211638212,VS0,VE0</pre>

<p>Check your CDN documentation for any additional information they may
provide such as <code>X-Cache</code> or for any additional headers they may
add.</p>

<h5 id="label-CDNs+and+the+Cache-Control+Header">CDNs and the Cache-Control Header<span><a href="#label-CDNs+and+the+Cache-Control+Header">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <a
href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9">cache
control header</a> is a W3C specification that describes how a request can
be cached. When no CDN is used, a browser will use this information to
cache contents. This is very helpful for assets that are not modified so
that a browser does not need to re-download a website&#39;s CSS or
javascript on every request. Generally we want our Rails server to tell our
CDN (and browser) that the asset is “public”, that means any cache can
store the request. Also we commonly want to set <code>max-age</code> which
is how long the cache will store the object before invalidating the cache.
The <code>max-age</code> value is set to seconds with a maximum possible
value of <code>31536000</code> which is one year. You can do this in your
rails application by setting</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">static_cache_control</span> = <span class="ruby-string">&quot;public, max-age=31536000&quot;</span>
</pre>

<p>Now when your application serves an asset in production, the CDN will store
the asset for up to a year. Since most CDNs also cache headers of the
request, this <code>Cache-Control</code> will be passed along to all future
browsers seeking this asset, the browser then knows that it can store this
asset for a very long time before needing to re-request it.</p>

<h5 id="label-CDNs+and+URL+based+Cache+Invalidation">CDNs and URL based Cache Invalidation<span><a href="#label-CDNs+and+URL+based+Cache+Invalidation">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Most CDNs will cache contents of an asset based on the complete URL. This
means that a request to</p>

<pre class="ruby"><span class="ruby-identifier">http</span>:<span class="ruby-operator">/</span><span class="ruby-regexp">/mycdnsubdomain.fictional-cdn.com/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">smile</span><span class="ruby-operator">-</span><span class="ruby-value">123</span>.<span class="ruby-identifier">png</span>
</pre>

<p>Will be a completely different cache from</p>

<pre class="ruby"><span class="ruby-identifier">http</span>:<span class="ruby-operator">/</span><span class="ruby-regexp">/mycdnsubdomain.fictional-cdn.com/</span><span class="ruby-identifier">assets</span><span class="ruby-operator">/</span><span class="ruby-identifier">smile</span>.<span class="ruby-identifier">png</span>
</pre>

<p>If you want to set far future <code>max-age</code> in your
<code>Cache-Control</code> (and you do), then make sure when you change
your assets that your cache is invalidated. For example when changing the
smiley face in an image from yellow to blue, you want all visitors of your
site to get the new blue face. When using a CDN with the Rails asset
pipeline <code>config.assets.digest</code> is set to true by default so
that each asset will have a different file name when it is changed. This
way you don&#39;t have to ever manually invalidate any items in your cache.
By using a different unique asset name instead, your users get the latest
asset.</p>

<h2 id="label-Customizing+the+Pipeline">Customizing the Pipeline<span><a href="#label-Customizing+the+Pipeline">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-CSS+Compression">CSS Compression<span><a href="#label-CSS+Compression">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>One of the options for compressing CSS is YUI. The <a
href="http://yui.github.io/yuicompressor/css.html">YUI CSS compressor</a>
provides minification.</p>

<p>The following line enables YUI compression, and requires the
<code>yui-compressor</code> gem.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">css_compressor</span> = :<span class="ruby-identifier">yui</span>
</pre>

<p>The other option for compressing CSS if you have the sass-rails gem
installed is</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">css_compressor</span> = :<span class="ruby-identifier">sass</span>
</pre>

<h3 id="label-JavaScript+Compression">JavaScript Compression<span><a href="#label-JavaScript+Compression">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Possible options for JavaScript compression are <code>:closure</code>,
<code>:uglifier</code> and <code>:yui</code>. These require the use of the
<code>closure-compiler</code>, <code>uglifier</code> or
<code>yui-compressor</code> gems, respectively.</p>

<p>The default Gemfile includes <a
href="https://github.com/lautis/uglifier">uglifier</a>. This gem wraps <a
href="https://github.com/mishoo/UglifyJS">UglifyJS</a> (written for NodeJS)
in Ruby. It compresses your code by removing white space and comments,
shortening local variable names, and performing other micro-optimizations
such as changing <code>if</code> and <code>else</code> statements to
ternary operators where possible.</p>

<p>The following line invokes <code>uglifier</code> for JavaScript
compression.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">js_compressor</span> = :<span class="ruby-identifier">uglifier</span>
</pre>

<p>NOTE: You will need an <a
href="https://github.com/rails/execjs#readme">ExecJS</a> supported runtime
in order to use <code>uglifier</code>. If you are using Mac OS X or Windows
you have a JavaScript runtime installed in your operating system.</p>

<p>NOTE: The <code>config.assets.compress</code> initialization option is no
longer used in Rails 4 to enable either CSS or JavaScript compression.
Setting it will have no effect on the application. Instead, setting
<code>config.assets.css_compressor</code> and
<code>config.assets.js_compressor</code> will control compression of CSS
and JavaScript assets.</p>

<h3 id="label-Using+Your+Own+Compressor">Using Your Own Compressor<span><a href="#label-Using+Your+Own+Compressor">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The compressor config settings for CSS and JavaScript also take any object.
This object must have a <code>compress</code> method that takes a string as
the sole argument and it must return a string.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Transformer</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">compress</span>(<span class="ruby-identifier">string</span>)
    <span class="ruby-identifier">do_something_returning_a_string</span>(<span class="ruby-identifier">string</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To enable this, pass a new object to the config option in
<code>application.rb</code>:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">css_compressor</span> = <span class="ruby-constant">Transformer</span>.<span class="ruby-identifier">new</span>
</pre>

<h3 id="label-Changing+the+assets+Path">Changing the <em>assets</em> Path<span><a href="#label-Changing+the+assets+Path">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The public path that Sprockets uses by default is <code>/assets</code>.</p>

<p>This can be changed to something else:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">prefix</span> = <span class="ruby-string">&quot;/some_other_path&quot;</span>
</pre>

<p>This is a handy option if you are updating an older project that didn&#39;t
use the asset pipeline and already uses this path or you wish to use this
path for a new resource.</p>

<h3 id="label-X-Sendfile+Headers">X-Sendfile Headers<span><a href="#label-X-Sendfile+Headers">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The X-Sendfile header is a directive to the web server to ignore the
response from the application, and instead serve a specified file from
disk. This option is off by default, but can be enabled if your server
supports it. When enabled, this passes responsibility for serving the file
to the web server, which is faster. Have a look at <a
href="http://api.rubyonrails.org/classes/ActionController/DataStreaming.html#method-i-send_file">send_file</a>
on how to use this feature.</p>

<p>Apache and NGINX support this option, which can be enabled in
<code>config/environments/production.rb</code>:</p>

<pre class="ruby"><span class="ruby-comment"># config.action_dispatch.x_sendfile_header = &quot;X-Sendfile&quot; # for Apache</span>
<span class="ruby-comment"># config.action_dispatch.x_sendfile_header = &#39;X-Accel-Redirect&#39; # for NGINX</span>
</pre>

<p>WARNING: If you are upgrading an existing application and intend to use
this option, take care to paste this configuration option only into
<code>production.rb</code> and any other environments you define with
production behavior (not <code>application.rb</code>).</p>

<p>TIP: For further details have a look at the docs of your production web
server: - <a href="https://tn123.org/mod_xsendfile/">Apache</a> - <a
href="http://wiki.nginx.org/XSendfile">NGINX</a></p>

<h2 id="label-Assets+Cache+Store">Assets Cache Store<span><a href="#label-Assets+Cache+Store">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The default Rails cache store will be used by Sprockets to cache assets in
development and production. This can be changed by setting
<code>config.assets.cache_store</code>:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">memory_store</span>
</pre>

<p>The options accepted by the assets cache store are the same as the
application&#39;s cache store.</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">cache_store</span> = :<span class="ruby-identifier">memory_store</span>, { <span class="ruby-identifier">size</span><span class="ruby-operator">:</span> <span class="ruby-value">32</span>.<span class="ruby-identifier">megabytes</span> }
</pre>

<p>To disable the assets cache store:</p>

<pre class="ruby"><span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">configure</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">env</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">env</span>.<span class="ruby-identifier">cache</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Cache</span>.<span class="ruby-identifier">lookup_store</span>(:<span class="ruby-identifier">null_store</span>)
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Adding+Assets+to+Your+Gems">Adding Assets to Your Gems<span><a href="#label-Adding+Assets+to+Your+Gems">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Assets can also come from external sources in the form of gems.</p>

<p>A good example of this is the <code>jquery-rails</code> gem which comes
with Rails as the standard JavaScript library gem. This gem contains an
engine class which inherits from <code>Rails::Engine</code>. By doing this,
Rails is informed that the directory for this gem may contain assets and
the <code>app/assets</code>, <code>lib/assets</code> and
<code>vendor/assets</code> directories of this engine are added to the
search path of Sprockets.</p>

<h2 id="label-Making+Your+Library+or+Gem+a+Pre-Processor">Making Your Library or Gem a Pre-Processor<span><a href="#label-Making+Your+Library+or+Gem+a+Pre-Processor">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>As Sprockets uses <a href="https://github.com/rtomayko/tilt">Tilt</a> as a
generic interface to different templating engines, your gem should just
implement the Tilt template protocol. Normally, you would subclass
<code>Tilt::Template</code> and reimplement the <code>prepare</code>
method, which initializes your template, and the <code>evaluate</code>
method, which returns the processed source. The original source is stored
in <code>data</code>. Have a look at <a
href="https://github.com/rtomayko/tilt/blob/master/lib/tilt/template.rb">Tilt::Template</a>
sources to learn more.</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">BangBang</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">Template</span> <span class="ruby-operator">&lt;</span> <span class="ruby-operator">::</span><span class="ruby-constant">Tilt</span><span class="ruby-operator">::</span><span class="ruby-constant">Template</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">prepare</span>
      <span class="ruby-comment"># Do any initialization here</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Adds a &quot;!&quot; to original template.</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">evaluate</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">locals</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
      <span class="ruby-node">&quot;#{data}!&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now that you have a <code>Template</code> class, it&#39;s time to associate
it with an extension for template files:</p>

<pre class="ruby"><span class="ruby-constant">Sprockets</span>.<span class="ruby-identifier">register_engine</span> <span class="ruby-string">&#39;.bang&#39;</span>, <span class="ruby-constant">BangBang</span><span class="ruby-operator">::</span><span class="ruby-constant">Template</span>
</pre>

<h2 id="label-Upgrading+from+Old+Versions+of+Rails">Upgrading from Old Versions of Rails<span><a href="#label-Upgrading+from+Old+Versions+of+Rails">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>There are a few issues when upgrading from Rails 3.0 or Rails 2.x. The
first is moving the files from <code>public/</code> to the new locations.
See <a href="#asset-organization">Asset Organization</a> above for guidance
on the correct locations for different file types.</p>

<p>Next will be avoiding duplicate JavaScript files. Since jQuery is the
default JavaScript library from Rails 3.1 onwards, you don&#39;t need to
copy <code>jquery.js</code> into <code>app/assets</code> and it will be
included automatically.</p>

<p>The third is updating the various environment files with the correct
default options.</p>

<p>In <code>application.rb</code>:</p>

<pre class="ruby"><span class="ruby-comment"># Version of your assets, change this if you want to expire all your assets</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">version</span> = <span class="ruby-string">&#39;1.0&#39;</span>

<span class="ruby-comment"># Change the path that assets are served from config.assets.prefix = &quot;/assets&quot;</span>
</pre>

<p>In <code>development.rb</code>:</p>

<pre class="ruby"><span class="ruby-comment"># Expands the lines which load the assets</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">debug</span> = <span class="ruby-keyword">true</span>
</pre>

<p>And in <code>production.rb</code>:</p>

<pre class="ruby"><span class="ruby-comment"># Choose the compressors to use (if any) config.assets.js_compressor  =</span>
<span class="ruby-comment"># :uglifier config.assets.css_compressor = :yui</span>

<span class="ruby-comment"># Don&#39;t fallback to assets pipeline if a precompiled asset is missed</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">compile</span> = <span class="ruby-keyword">false</span>

<span class="ruby-comment"># Generate digests for assets URLs. This is planned for deprecation.</span>
<span class="ruby-identifier">config</span>.<span class="ruby-identifier">assets</span>.<span class="ruby-identifier">digest</span> = <span class="ruby-keyword">true</span>

<span class="ruby-comment"># Precompile additional assets (application.js, application.css, and all</span>
<span class="ruby-comment"># non-JS/CSS are already added) config.assets.precompile += %w( search.js )</span>
</pre>

<p>Rails 4 no longer sets default config values for Sprockets in
<code>test.rb</code>, so <code>test.rb</code> now requires Sprockets
configuration. The old defaults in the test environment are:
<code>config.assets.compile = true</code>, <code>config.assets.compress =
false</code>, <code>config.assets.debug = false</code> and
<code>config.assets.digest = false</code>.</p>

<p>The following should also be added to <code>Gemfile</code>:</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;sass-rails&#39;</span>,   <span class="ruby-string">&quot;~&gt; 3.2.3&quot;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;coffee-rails&#39;</span>, <span class="ruby-string">&quot;~&gt; 3.2.1&quot;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;uglifier&#39;</span>
</pre>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

