<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>association_basics - rails-4.2.1 Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>

  <ul class="link-list" role="directory">
    <li><a href="#label-Active+Record+Associations">Active Record Associations</a>
    <li><a href="#label-Why+Associations-3F">Why Associations?</a>
    <li><a href="#label-The+Types+of+Associations">The Types of Associations</a>
    <li><a href="#label-The+belongs_to+Association">The <code>belongs_to</code> Association</a>
    <li><a href="#label-The+has_one+Association">The <code>has_one</code> Association</a>
    <li><a href="#label-The+has_many+Association">The <code>has_many</code> Association</a>
    <li><a href="#label-The+has_many+-3Athrough+Association">The <code>has_many :through</code> Association</a>
    <li><a href="#label-The+has_one+-3Athrough+Association">The <code>has_one :through</code> Association</a>
    <li><a href="#label-The+has_and_belongs_to_many+Association">The <code>has_and_belongs_to_many</code> Association</a>
    <li><a href="#label-Choosing+Between+belongs_to+and+has_one">Choosing Between <code>belongs_to</code> and <code>has_one</code></a>
    <li><a href="#label-Choosing+Between+has_many+-3Athrough+and+has_and_belongs_to_many">Choosing Between <code>has_many :through</code> and <code>has_and_belongs_to_many</code></a>
    <li><a href="#label-Polymorphic+Associations">Polymorphic Associations</a>
    <li><a href="#label-Self+Joins">Self Joins</a>
    <li><a href="#label-Tips-2C+Tricks-2C+and+Warnings">Tips, Tricks, and Warnings</a>
    <li><a href="#label-Controlling+Caching">Controlling Caching</a>
    <li><a href="#label-Avoiding+Name+Collisions">Avoiding Name Collisions</a>
    <li><a href="#label-Updating+the+Schema">Updating the Schema</a>
    <li><a href="#label-Creating+Foreign+Keys+for+belongs_to+Associations">Creating Foreign Keys for <code>belongs_to</code> Associations</a>
    <li><a href="#label-Creating+Join+Tables+for+has_and_belongs_to_many+Associations">Creating Join Tables for <code>has_and_belongs_to_many</code> Associations</a>
    <li><a href="#label-Controlling+Association+Scope">Controlling Association Scope</a>
    <li><a href="#label-Bi-directional+Associations">Bi-directional Associations</a>
    <li><a href="#label-Detailed+Association+Reference">Detailed Association Reference</a>
    <li><a href="#label-belongs_to+Association+Reference"><code>belongs_to</code> Association Reference</a>
    <li><a href="#label-Methods+Added+by+belongs_to">Methods Added by <code>belongs_to</code></a>
    <li><a href="#label-association-28force_reload+-3D+false-29"><code>association(force_reload = false)</code></a>
    <li><a href="#label-association-3D-28associate-29"><code>association=(associate)</code></a>
    <li><a href="#label-build_association-28attributes+-3D+-7B-7D-29"><code>build_association(attributes = {})</code></a>
    <li><a href="#label-create_association-28attributes+-3D+-7B-7D-29"><code>create_association(attributes = {})</code></a>
    <li><a href="#label-create_association-21-28attributes+-3D+-7B-7D-29"><code>create_association!(attributes = {})</code></a>
    <li><a href="#label-Options+for+belongs_to">Options for <code>belongs_to</code></a>
    <li><a href="#label-3Aautosave"><code>:autosave</code></a>
    <li><a href="#label-3Aclass_name"><code>:class_name</code></a>
    <li><a href="#label-3Acounter_cache"><code>:counter_cache</code></a>
    <li><a href="#label-3Adependent"><code>:dependent</code></a>
    <li><a href="#label-3Aforeign_key"><code>:foreign_key</code></a>
    <li><a href="#label-3Ainverse_of"><code>:inverse_of</code></a>
    <li><a href="#label-3Apolymorphic"><code>:polymorphic</code></a>
    <li><a href="#label-3Atouch"><code>:touch</code></a>
    <li><a href="#label-3Avalidate"><code>:validate</code></a>
    <li><a href="#label-Scopes+for+belongs_to">Scopes for <code>belongs_to</code></a>
    <li><a href="#label-where"><code>where</code></a>
    <li><a href="#label-includes"><code>includes</code></a>
    <li><a href="#label-readonly"><code>readonly</code></a>
    <li><a href="#label-select"><code>select</code></a>
    <li><a href="#label-Do+Any+Associated+Objects+Exist-3F">Do Any Associated Objects Exist?</a>
    <li><a href="#label-When+are+Objects+Saved-3F">When are Objects Saved?</a>
    <li><a href="#label-has_one+Association+Reference"><code>has_one</code> Association Reference</a>
    <li><a href="#label-Methods+Added+by+has_one">Methods Added by <code>has_one</code></a>
    <li><a href="#label-association-28force_reload+-3D+false-29"><code>association(force_reload = false)</code></a>
    <li><a href="#label-association-3D-28associate-29"><code>association=(associate)</code></a>
    <li><a href="#label-build_association-28attributes+-3D+-7B-7D-29"><code>build_association(attributes = {})</code></a>
    <li><a href="#label-create_association-28attributes+-3D+-7B-7D-29"><code>create_association(attributes = {})</code></a>
    <li><a href="#label-create_association-21-28attributes+-3D+-7B-7D-29"><code>create_association!(attributes = {})</code></a>
    <li><a href="#label-Options+for+has_one">Options for <code>has_one</code></a>
    <li><a href="#label-3Aas"><code>:as</code></a>
    <li><a href="#label-3Aautosave"><code>:autosave</code></a>
    <li><a href="#label-3Aclass_name"><code>:class_name</code></a>
    <li><a href="#label-3Adependent"><code>:dependent</code></a>
    <li><a href="#label-3Aforeign_key"><code>:foreign_key</code></a>
    <li><a href="#label-3Ainverse_of"><code>:inverse_of</code></a>
    <li><a href="#label-3Aprimary_key"><code>:primary_key</code></a>
    <li><a href="#label-3Asource"><code>:source</code></a>
    <li><a href="#label-3Asource_type"><code>:source_type</code></a>
    <li><a href="#label-3Athrough"><code>:through</code></a>
    <li><a href="#label-3Avalidate"><code>:validate</code></a>
    <li><a href="#label-Scopes+for+has_one">Scopes for <code>has_one</code></a>
    <li><a href="#label-where"><code>where</code></a>
    <li><a href="#label-includes"><code>includes</code></a>
    <li><a href="#label-readonly"><code>readonly</code></a>
    <li><a href="#label-select"><code>select</code></a>
    <li><a href="#label-Do+Any+Associated+Objects+Exist-3F">Do Any Associated Objects Exist?</a>
    <li><a href="#label-When+are+Objects+Saved-3F">When are Objects Saved?</a>
    <li><a href="#label-has_many+Association+Reference"><code>has_many</code> Association Reference</a>
    <li><a href="#label-Methods+Added+by+has_many">Methods Added by <code>has_many</code></a>
    <li><a href="#label-collection-28force_reload+-3D+false-29"><code>collection(force_reload = false)</code></a>
    <li><a href="#label-collection-3C-3C-28object-2C+...-29"><code>collection&lt;&lt;(object, ...)</code></a>
    <li><a href="#label-collection.delete-28object-2C+...-29"><code>collection.delete(object, ...)</code></a>
    <li><a href="#label-collection.destroy-28object-2C+...-29"><code>collection.destroy(object, ...)</code></a>
    <li><a href="#label-collection-3D-28objects-29"><code>collection=(objects)</code></a>
    <li><a href="#label-collection_singular_ids"><code>collection_singular_ids</code></a>
    <li><a href="#label-collection_singular_ids-3D-28ids-29"><code>collection_singular_ids=(ids)</code></a>
    <li><a href="#label-collection.clear"><code>collection.clear</code></a>
    <li><a href="#label-collection.empty-3F"><code>collection.empty?</code></a>
    <li><a href="#label-collection.size"><code>collection.size</code></a>
    <li><a href="#label-collection.find-28...-29"><code>collection.find(...)</code></a>
    <li><a href="#label-collection.where-28...-29"><code>collection.where(...)</code></a>
    <li><a href="#label-collection.exists-3F-28...-29"><code>collection.exists?(...)</code></a>
    <li><a href="#label-collection.build-28attributes+-3D+-7B-7D-2C+...-29"><code>collection.build(attributes = {}, ...)</code></a>
    <li><a href="#label-collection.create-28attributes+-3D+-7B-7D-29"><code>collection.create(attributes = {})</code></a>
    <li><a href="#label-collection.create-21-28attributes+-3D+-7B-7D-29"><code>collection.create!(attributes = {})</code></a>
    <li><a href="#label-Options+for+has_many">Options for <code>has_many</code></a>
    <li><a href="#label-3Aas"><code>:as</code></a>
    <li><a href="#label-3Aautosave"><code>:autosave</code></a>
    <li><a href="#label-3Aclass_name"><code>:class_name</code></a>
    <li><a href="#label-3Adependent"><code>:dependent</code></a>
    <li><a href="#label-3Aforeign_key"><code>:foreign_key</code></a>
    <li><a href="#label-3Ainverse_of"><code>:inverse_of</code></a>
    <li><a href="#label-3Aprimary_key"><code>:primary_key</code></a>
    <li><a href="#label-3Asource"><code>:source</code></a>
    <li><a href="#label-3Asource_type"><code>:source_type</code></a>
    <li><a href="#label-3Athrough"><code>:through</code></a>
    <li><a href="#label-3Avalidate"><code>:validate</code></a>
    <li><a href="#label-Scopes+for+has_many">Scopes for <code>has_many</code></a>
    <li><a href="#label-where"><code>where</code></a>
    <li><a href="#label-extending"><code>extending</code></a>
    <li><a href="#label-group"><code>group</code></a>
    <li><a href="#label-includes"><code>includes</code></a>
    <li><a href="#label-limit"><code>limit</code></a>
    <li><a href="#label-offset"><code>offset</code></a>
    <li><a href="#label-order"><code>order</code></a>
    <li><a href="#label-readonly"><code>readonly</code></a>
    <li><a href="#label-select"><code>select</code></a>
    <li><a href="#label-distinct"><code>distinct</code></a>
    <li><a href="#label-When+are+Objects+Saved-3F">When are Objects Saved?</a>
    <li><a href="#label-has_and_belongs_to_many+Association+Reference"><code>has_and_belongs_to_many</code> Association Reference</a>
    <li><a href="#label-Methods+Added+by+has_and_belongs_to_many">Methods Added by <code>has_and_belongs_to_many</code></a>
    <li><a href="#label-Additional+Column+Methods">Additional Column Methods</a>
    <li><a href="#label-collection-28force_reload+-3D+false-29"><code>collection(force_reload = false)</code></a>
    <li><a href="#label-collection-3C-3C-28object-2C+...-29"><code>collection&lt;&lt;(object, ...)</code></a>
    <li><a href="#label-collection.delete-28object-2C+...-29"><code>collection.delete(object, ...)</code></a>
    <li><a href="#label-collection.destroy-28object-2C+...-29"><code>collection.destroy(object, ...)</code></a>
    <li><a href="#label-collection-3D-28objects-29"><code>collection=(objects)</code></a>
    <li><a href="#label-collection_singular_ids"><code>collection_singular_ids</code></a>
    <li><a href="#label-collection_singular_ids-3D-28ids-29"><code>collection_singular_ids=(ids)</code></a>
    <li><a href="#label-collection.clear"><code>collection.clear</code></a>
    <li><a href="#label-collection.empty-3F"><code>collection.empty?</code></a>
    <li><a href="#label-collection.size"><code>collection.size</code></a>
    <li><a href="#label-collection.find-28...-29"><code>collection.find(...)</code></a>
    <li><a href="#label-collection.where-28...-29"><code>collection.where(...)</code></a>
    <li><a href="#label-collection.exists-3F-28...-29"><code>collection.exists?(...)</code></a>
    <li><a href="#label-collection.build-28attributes+-3D+-7B-7D-29"><code>collection.build(attributes = {})</code></a>
    <li><a href="#label-collection.create-28attributes+-3D+-7B-7D-29"><code>collection.create(attributes = {})</code></a>
    <li><a href="#label-collection.create-21-28attributes+-3D+-7B-7D-29"><code>collection.create!(attributes = {})</code></a>
    <li><a href="#label-Options+for+has_and_belongs_to_many">Options for <code>has_and_belongs_to_many</code></a>
    <li><a href="#label-3Aassociation_foreign_key"><code>:association_foreign_key</code></a>
    <li><a href="#label-3Aautosave"><code>:autosave</code></a>
    <li><a href="#label-3Aclass_name"><code>:class_name</code></a>
    <li><a href="#label-3Aforeign_key"><code>:foreign_key</code></a>
    <li><a href="#label-3Ajoin_table"><code>:join_table</code></a>
    <li><a href="#label-3Avalidate"><code>:validate</code></a>
    <li><a href="#label-Scopes+for+has_and_belongs_to_many">Scopes for <code>has_and_belongs_to_many</code></a>
    <li><a href="#label-where"><code>where</code></a>
    <li><a href="#label-extending"><code>extending</code></a>
    <li><a href="#label-group"><code>group</code></a>
    <li><a href="#label-includes"><code>includes</code></a>
    <li><a href="#label-limit"><code>limit</code></a>
    <li><a href="#label-offset"><code>offset</code></a>
    <li><a href="#label-order"><code>order</code></a>
    <li><a href="#label-readonly"><code>readonly</code></a>
    <li><a href="#label-select"><code>select</code></a>
    <li><a href="#label-uniq"><code>uniq</code></a>
    <li><a href="#label-When+are+Objects+Saved-3F">When are Objects Saved?</a>
    <li><a href="#label-Association+Callbacks">Association Callbacks</a>
    <li><a href="#label-Association+Extensions">Association Extensions</a>
  </ul>
</div>


  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../../README_md.html">README</a>
  
    <li><a href="../../guides/CHANGELOG_md.html">CHANGELOG</a>
  
    <li><a href="../../guides/Rakefile.html">Rakefile</a>
  
    <li><a href="../../guides/assets/images/icons/README.html">README</a>
  
    <li><a href="../../guides/assets/javascripts/guides_js.html">guides.js</a>
  
    <li><a href="../../guides/assets/javascripts/jquery_min_js.html">jquery.min.js</a>
  
    <li><a href="../../guides/assets/javascripts/responsive-tables_js.html">responsive-tables.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAS3_js.html">shBrushAS3.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushAppleScript_js.html">shBrushAppleScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushBash_js.html">shBrushBash.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCSharp_js.html">shBrushCSharp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushColdFusion_js.html">shBrushColdFusion.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCpp_js.html">shBrushCpp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushCss_js.html">shBrushCss.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDelphi_js.html">shBrushDelphi.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushDiff_js.html">shBrushDiff.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushErlang_js.html">shBrushErlang.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushGroovy_js.html">shBrushGroovy.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJScript_js.html">shBrushJScript.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJava_js.html">shBrushJava.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushJavaFX_js.html">shBrushJavaFX.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPerl_js.html">shBrushPerl.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPhp_js.html">shBrushPhp.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPlain_js.html">shBrushPlain.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPowerShell_js.html">shBrushPowerShell.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushPython_js.html">shBrushPython.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushRuby_js.html">shBrushRuby.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSass_js.html">shBrushSass.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushScala_js.html">shBrushScala.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushSql_js.html">shBrushSql.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushVb_js.html">shBrushVb.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shBrushXml_js.html">shBrushXml.js</a>
  
    <li><a href="../../guides/assets/javascripts/syntaxhighlighter/shCore_js.html">shCore.js</a>
  
    <li><a href="../../guides/assets/stylesheets/fixes_css.html">fixes.css</a>
  
    <li><a href="../../guides/assets/stylesheets/kindle_css.html">kindle.css</a>
  
    <li><a href="../../guides/assets/stylesheets/main_css.html">main.css</a>
  
    <li><a href="../../guides/assets/stylesheets/print_css.html">print.css</a>
  
    <li><a href="../../guides/assets/stylesheets/reset_css.html">reset.css</a>
  
    <li><a href="../../guides/assets/stylesheets/responsive-tables_css.html">responsive-tables.css</a>
  
    <li><a href="../../guides/assets/stylesheets/style_css.html">style.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCore_css.html">shCore.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDefault_css.html">shCoreDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreDjango_css.html">shCoreDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEclipse_css.html">shCoreEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreEmacs_css.html">shCoreEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreFadeToGrey_css.html">shCoreFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMDUltra_css.html">shCoreMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreMidnight_css.html">shCoreMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shCoreRDark_css.html">shCoreRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDefault_css.html">shThemeDefault.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeDjango_css.html">shThemeDjango.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEclipse_css.html">shThemeEclipse.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeEmacs_css.html">shThemeEmacs.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeFadeToGrey_css.html">shThemeFadeToGrey.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMDUltra_css.html">shThemeMDUltra.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeMidnight_css.html">shThemeMidnight.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRDark_css.html">shThemeRDark.css</a>
  
    <li><a href="../../guides/assets/stylesheets/syntaxhighlighter/shThemeRailsGuides_css.html">shThemeRailsGuides.css</a>
  
    <li><a href="../../guides/source/2_2_release_notes_md.html">2_2_release_notes</a>
  
    <li><a href="../../guides/source/2_3_release_notes_md.html">2_3_release_notes</a>
  
    <li><a href="../../guides/source/3_0_release_notes_md.html">3_0_release_notes</a>
  
    <li><a href="../../guides/source/3_1_release_notes_md.html">3_1_release_notes</a>
  
    <li><a href="../../guides/source/3_2_release_notes_md.html">3_2_release_notes</a>
  
    <li><a href="../../guides/source/4_0_release_notes_md.html">4_0_release_notes</a>
  
    <li><a href="../../guides/source/4_1_release_notes_md.html">4_1_release_notes</a>
  
    <li><a href="../../guides/source/4_2_release_notes_md.html">4_2_release_notes</a>
  
    <li><a href="../../guides/source/action_controller_overview_md.html">action_controller_overview</a>
  
    <li><a href="../../guides/source/action_mailer_basics_md.html">action_mailer_basics</a>
  
    <li><a href="../../guides/source/action_view_overview_md.html">action_view_overview</a>
  
    <li><a href="../../guides/source/active_job_basics_md.html">active_job_basics</a>
  
    <li><a href="../../guides/source/active_model_basics_md.html">active_model_basics</a>
  
    <li><a href="../../guides/source/active_record_basics_md.html">active_record_basics</a>
  
    <li><a href="../../guides/source/active_record_callbacks_md.html">active_record_callbacks</a>
  
    <li><a href="../../guides/source/active_record_migrations_md.html">active_record_migrations</a>
  
    <li><a href="../../guides/source/active_record_postgresql_md.html">active_record_postgresql</a>
  
    <li><a href="../../guides/source/active_record_querying_md.html">active_record_querying</a>
  
    <li><a href="../../guides/source/active_record_validations_md.html">active_record_validations</a>
  
    <li><a href="../../guides/source/active_support_core_extensions_md.html">active_support_core_extensions</a>
  
    <li><a href="../../guides/source/active_support_instrumentation_md.html">active_support_instrumentation</a>
  
    <li><a href="../../guides/source/api_documentation_guidelines_md.html">api_documentation_guidelines</a>
  
    <li><a href="../../guides/source/asset_pipeline_md.html">asset_pipeline</a>
  
    <li><a href="../../guides/source/association_basics_md.html">association_basics</a>
  
    <li><a href="../../guides/source/autoloading_and_reloading_constants_md.html">autoloading_and_reloading_constants</a>
  
    <li><a href="../../guides/source/caching_with_rails_md.html">caching_with_rails</a>
  
    <li><a href="../../guides/source/command_line_md.html">command_line</a>
  
    <li><a href="../../guides/source/configuring_md.html">configuring</a>
  
    <li><a href="../../guides/source/contributing_to_ruby_on_rails_md.html">contributing_to_ruby_on_rails</a>
  
    <li><a href="../../guides/source/debugging_rails_applications_md.html">debugging_rails_applications</a>
  
    <li><a href="../../guides/source/development_dependencies_install_md.html">development_dependencies_install</a>
  
    <li><a href="../../guides/source/documents_yaml.html">documents.yaml</a>
  
    <li><a href="../../guides/source/engines_md.html">engines</a>
  
    <li><a href="../../guides/source/form_helpers_md.html">form_helpers</a>
  
    <li><a href="../../guides/source/generators_md.html">generators</a>
  
    <li><a href="../../guides/source/getting_started_md.html">getting_started</a>
  
    <li><a href="../../guides/source/i18n_md.html">i18n</a>
  
    <li><a href="../../guides/source/initialization_md.html">initialization</a>
  
    <li><a href="../../guides/source/layouts_and_rendering_md.html">layouts_and_rendering</a>
  
    <li><a href="../../guides/source/maintenance_policy_md.html">maintenance_policy</a>
  
    <li><a href="../../guides/source/nested_model_forms_md.html">nested_model_forms</a>
  
    <li><a href="../../guides/source/plugins_md.html">plugins</a>
  
    <li><a href="../../guides/source/rails_application_templates_md.html">rails_application_templates</a>
  
    <li><a href="../../guides/source/rails_on_rack_md.html">rails_on_rack</a>
  
    <li><a href="../../guides/source/routing_md.html">routing</a>
  
    <li><a href="../../guides/source/ruby_on_rails_guides_guidelines_md.html">ruby_on_rails_guides_guidelines</a>
  
    <li><a href="../../guides/source/security_md.html">security</a>
  
    <li><a href="../../guides/source/testing_md.html">testing</a>
  
    <li><a href="../../guides/source/upgrading_ruby_on_rails_md.html">upgrading_ruby_on_rails</a>
  
    <li><a href="../../guides/source/working_with_javascript_in_rails_md.html">working_with_javascript_in_rails</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page guides/source/association_basics.md">

<h1 id="label-Active+Record+Associations">Active Record Associations<span><a href="#label-Active+Record+Associations">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p>This guide covers the association features of Active Record.</p>

<p>After reading this guide, you will know:</p>
<ul><li>
<p>How to declare associations between Active Record models.</p>
</li><li>
<p>How to understand the various types of Active Record associations.</p>
</li><li>
<p>How to use the methods added to your models by creating associations.</p>
</li></ul>
<hr>

<h2 id="label-Why+Associations-3F">Why Associations?<span><a href="#label-Why+Associations-3F">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Why do we need associations between models? Because they make common
operations simpler and easier in your code. For example, consider a simple
Rails application that includes a model for customers and a model for
orders. Each customer can have many orders. Without associations, the model
declarations would look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now, suppose we wanted to add a new order for an existing customer.
We&#39;d need to do something like this:</p>

<pre class="ruby"><span class="ruby-ivar">@order</span> = <span class="ruby-constant">Order</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">order_date</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-identifier">customer_id</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">id</span>)
</pre>

<p>Or consider deleting a customer, and ensuring that all of its orders get
deleted as well:</p>

<pre class="ruby"><span class="ruby-ivar">@orders</span> = <span class="ruby-constant">Order</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">customer_id</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">id</span>)
<span class="ruby-ivar">@orders</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">order</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">order</span>.<span class="ruby-identifier">destroy</span>
<span class="ruby-keyword">end</span>
<span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">destroy</span>
</pre>

<p>With Active Record associations, we can streamline these - and other -
operations by declaratively telling Rails that there is a connection
between the two models. Here&#39;s the revised code for setting up
customers and orders:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">dependent</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">destroy</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With this change, creating a new order for a particular customer is easier:</p>

<pre class="ruby"><span class="ruby-ivar">@order</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">order_date</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
</pre>

<p>Deleting a customer and all of its orders is <em>much</em> easier:</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">destroy</span>
</pre>

<p>To learn more about the different types of associations, read the next
section of this guide. That&#39;s followed by some tips and tricks for
working with associations, and then by a complete reference to the methods
and options for associations in Rails.</p>

<h2 id="label-The+Types+of+Associations">The Types of Associations<span><a href="#label-The+Types+of+Associations">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>In Rails, an <em>association</em> is a connection between two Active Record
models. Associations are implemented using macro-style calls, so that you
can declaratively add features to your models. For example, by declaring
that one model <code>belongs_to</code> another, you instruct Rails to
maintain Primary Key-Foreign Key information between instances of the two
models, and you also get a number of utility methods added to your model.
Rails supports six types of associations:</p>
<ul><li>
<p><code>belongs_to</code></p>
</li><li>
<p><code>has_one</code></p>
</li><li>
<p><code>has_many</code></p>
</li><li>
<p><code>has_many :through</code></p>
</li><li>
<p><code>has_one :through</code></p>
</li><li>
<p><code>has_and_belongs_to_many</code></p>
</li></ul>

<p>In the remainder of this guide, you&#39;ll learn how to declare and use the
various forms of associations. But first, a quick introduction to the
situations where each association type is appropriate.</p>

<h3 id="label-The+belongs_to+Association">The <code>belongs_to</code> Association<span><a href="#label-The+belongs_to+Association">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A <code>belongs_to</code> association sets up a one-to-one connection with
another model, such that each instance of the declaring model “belongs to”
one instance of the other model. For example, if your application includes
customers and orders, and each order can be assigned to exactly one
customer, you&#39;d declare the order model this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>
</pre>

<p><img src="images/belongs_to.png"></p>

<p>NOTE: <code>belongs_to</code> associations <em>must</em> use the singular
term. If you used the pluralized form in the above example for the
<code>customer</code> association in the <code>Order</code> model, you
would be told that there was an “uninitialized constant Order::Customers”.
This is because Rails automatically infers the class name from the
association name. If the association name is wrongly pluralized, then the
inferred class will be wrongly pluralized too.</p>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateOrders</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">customers</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">orders</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> :<span class="ruby-identifier">order_date</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-The+has_one+Association">The <code>has_one</code> Association<span><a href="#label-The+has_one+Association">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A <code>has_one</code> association also sets up a one-to-one connection
with another model, but with somewhat different semantics (and
consequences). This association indicates that each instance of a model
contains or possesses one instance of another model. For example, if each
supplier in your application has only one account, you&#39;d declare the
supplier model like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>
</pre>

<p><img src="images/has_one.png"></p>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateSuppliers</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">suppliers</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">accounts</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">account_number</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-The+has_many+Association">The <code>has_many</code> Association<span><a href="#label-The+has_many+Association">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A <code>has_many</code> association indicates a one-to-many connection with
another model. You&#39;ll often find this association on the “other side”
of a <code>belongs_to</code> association. This association indicates that
each instance of the model has zero or more instances of another model. For
example, in an application containing customers and orders, the customer
model could be declared like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>NOTE: The name of the other model is pluralized when declaring a
<code>has_many</code> association.</p>

<p><img src="images/has_many.png"></p>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateCustomers</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">customers</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">orders</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">index</span>:<span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> :<span class="ruby-identifier">order_date</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-The+has_many+-3Athrough+Association">The <code>has_many :through</code> Association<span><a href="#label-The+has_many+-3Athrough+Association">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A <code>has_many :through</code> association is often used to set up a
many-to-many connection with another model. This association indicates that
the declaring model can be matched with zero or more instances of another
model by proceeding <em>through</em> a third model. For example, consider a
medical practice where patients make appointments to see physicians. The
relevant association declarations could look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Physician</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">appointments</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">patients</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">appointments</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Appointment</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">physician</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">patient</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Patient</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">appointments</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">physicians</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">appointments</span>
<span class="ruby-keyword">end</span>
</pre>

<p><img src="images/has_many_through.png"></p>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateAppointments</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">physicians</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">patients</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">appointments</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">physician</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">patient</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> :<span class="ruby-identifier">appointment_date</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The collection of join models can be managed via the API. For example, if
you assign</p>

<pre class="ruby"><span class="ruby-identifier">physician</span>.<span class="ruby-identifier">patients</span> = <span class="ruby-identifier">patients</span>
</pre>

<p>new join models are created for newly associated objects, and if some are
gone their rows are deleted.</p>

<p>WARNING: Automatic deletion of join models is direct, no destroy callbacks
are triggered.</p>

<p>The <code>has_many :through</code> association is also useful for setting
up “shortcuts” through nested <code>has_many</code> associations. For
example, if a document has many sections, and a section has many
paragraphs, you may sometimes want to get a simple collection of all
paragraphs in the document. You could set that up this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Document</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">sections</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">paragraphs</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">sections</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Section</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">document</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">paragraphs</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Paragraph</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">section</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With <code>through: :sections</code> specified, Rails will now understand:</p>

<pre class="ruby"><span class="ruby-ivar">@document</span>.<span class="ruby-identifier">paragraphs</span>
</pre>

<h3 id="label-The+has_one+-3Athrough+Association">The <code>has_one :through</code> Association<span><a href="#label-The+has_one+-3Athrough+Association">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A <code>has_one :through</code> association sets up a one-to-one connection
with another model. This association indicates that the declaring model can
be matched with one instance of another model by proceeding
<em>through</em> a third model. For example, if each supplier has one
account, and each account is associated with one account history, then the
supplier model could look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account_history</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account_history</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">AccountHistory</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>
</pre>

<p><img src="images/has_one_through.png"></p>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateAccountHistories</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">suppliers</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">accounts</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">account_number</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">account_histories</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">account</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> :<span class="ruby-identifier">credit_rating</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-The+has_and_belongs_to_many+Association">The <code>has_and_belongs_to_many</code> Association<span><a href="#label-The+has_and_belongs_to_many+Association">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A <code>has_and_belongs_to_many</code> association creates a direct
many-to-many connection with another model, with no intervening model. For
example, if your application includes assemblies and parts, with each
assembly having many parts and each part appearing in many assemblies, you
could declare the models this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Assembly</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">parts</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Part</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>
<span class="ruby-keyword">end</span>
</pre>

<p><img src="images/habtm.png"></p>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateAssembliesAndParts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">assemblies</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">parts</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">part_number</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">assemblies_parts</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">assembly</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">part</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Choosing+Between+belongs_to+and+has_one">Choosing Between <code>belongs_to</code> and <code>has_one</code><span><a href="#label-Choosing+Between+belongs_to+and+has_one">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you want to set up a one-to-one relationship between two models,
you&#39;ll need to add <code>belongs_to</code> to one, and
<code>has_one</code> to the other. How do you know which is which?</p>

<p>The distinction is in where you place the foreign key (it goes on the table
for the class declaring the <code>belongs_to</code> association), but you
should give some thought to the actual meaning of the data as well. The
<code>has_one</code> relationship says that one of something is yours -
that is, that something points back to you. For example, it makes more
sense to say that a supplier owns an account than that an account owns a
supplier. This suggests that the correct relationships are like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The corresponding migration might look like this:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateSuppliers</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">suppliers</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>  :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">accounts</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> :<span class="ruby-identifier">supplier_id</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>  :<span class="ruby-identifier">account_number</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">accounts</span>, :<span class="ruby-identifier">supplier_id</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>NOTE: Using <code>t.integer :supplier_id</code> makes the foreign key
naming obvious and explicit. In current versions of Rails, you can abstract
away this implementation detail by using <code>t.references
:supplier</code> instead.</p>

<h3 id="label-Choosing+Between+has_many+-3Athrough+and+has_and_belongs_to_many">Choosing Between <code>has_many :through</code> and <code>has_and_belongs_to_many</code><span><a href="#label-Choosing+Between+has_many+-3Athrough+and+has_and_belongs_to_many">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Rails offers two different ways to declare a many-to-many relationship
between models. The simpler way is to use
<code>has_and_belongs_to_many</code>, which allows you to make the
association directly:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Assembly</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">parts</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Part</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The second way to declare a many-to-many relationship is to use
<code>has_many :through</code>. This makes the association indirectly,
through a join model:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Assembly</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">manifests</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">parts</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">manifests</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Manifest</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">assembly</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">part</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Part</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">manifests</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">assemblies</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">manifests</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The simplest rule of thumb is that you should set up a <code>has_many
:through</code> relationship if you need to work with the relationship
model as an independent entity. If you don&#39;t need to do anything with
the relationship model, it may be simpler to set up a
<code>has_and_belongs_to_many</code> relationship (though you&#39;ll need
to remember to create the joining table in the database).</p>

<p>You should use <code>has_many :through</code> if you need validations,
callbacks, or extra attributes on the join model.</p>

<h3 id="label-Polymorphic+Associations">Polymorphic Associations<span><a href="#label-Polymorphic+Associations">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>A slightly more advanced twist on associations is the <em>polymorphic
association</em>. With polymorphic associations, a model can belong to more
than one other model, on a single association. For example, you might have
a picture model that belongs to either an employee model or a product
model. Here&#39;s how this could be declared:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Picture</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">imageable</span>, <span class="ruby-identifier">polymorphic</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Employee</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">pictures</span>, <span class="ruby-identifier">as</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">imageable</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Product</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">pictures</span>, <span class="ruby-identifier">as</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">imageable</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You can think of a polymorphic <code>belongs_to</code> declaration as
setting up an interface that any other model can use. From an instance of
the <code>Employee</code> model, you can retrieve a collection of pictures:
<code>@employee.pictures</code>.</p>

<p>Similarly, you can retrieve <code>@product.pictures</code>.</p>

<p>If you have an instance of the <code>Picture</code> model, you can get to
its parent via <code>@picture.imageable</code>. To make this work, you need
to declare both a foreign key column and a type column in the model that
declares the polymorphic interface:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreatePictures</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">pictures</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>  :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> :<span class="ruby-identifier">imageable_id</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>  :<span class="ruby-identifier">imageable_type</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">pictures</span>, :<span class="ruby-identifier">imageable_id</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This migration can be simplified by using the <code>t.references</code>
form:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreatePictures</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">pictures</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span> :<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">references</span> :<span class="ruby-identifier">imageable</span>, <span class="ruby-identifier">polymorphic</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p><img src="images/polymorphic.png"></p>

<h3 id="label-Self+Joins">Self Joins<span><a href="#label-Self+Joins">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In designing a data model, you will sometimes find a model that should have
a relation to itself. For example, you may want to store all employees in a
single database model, but be able to trace relationships such as between
manager and subordinates. This situation can be modeled with self-joining
associations:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Employee</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">subordinates</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Employee&quot;</span>,
                          <span class="ruby-identifier">foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;manager_id&quot;</span>

  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">manager</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Employee&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With this setup, you can retrieve <code>@employee.subordinates</code> and
<code>@employee.manager</code>.</p>

<p>In your migrations/schema, you will add a references column to the model
itself.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateEmployees</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">employees</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">references</span> :<span class="ruby-identifier">manager</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">timestamps</span> <span class="ruby-identifier">null</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Tips-2C+Tricks-2C+and+Warnings">Tips, Tricks, and Warnings<span><a href="#label-Tips-2C+Tricks-2C+and+Warnings">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Here are a few things you should know to make efficient use of Active
Record associations in your Rails applications:</p>
<ul><li>
<p>Controlling caching</p>
</li><li>
<p>Avoiding name collisions</p>
</li><li>
<p>Updating the schema</p>
</li><li>
<p>Controlling association scope</p>
</li><li>
<p>Bi-directional associations</p>
</li></ul>

<h3 id="label-Controlling+Caching">Controlling Caching<span><a href="#label-Controlling+Caching">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>All of the association methods are built around caching, which keeps the
result of the most recent query available for further operations. The cache
is even shared across methods. For example:</p>

<pre class="ruby"><span class="ruby-identifier">customer</span>.<span class="ruby-identifier">orders</span>                 <span class="ruby-comment"># retrieves orders from the database</span>
<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">size</span>            <span class="ruby-comment"># uses the cached copy of orders</span>
<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">empty?</span>          <span class="ruby-comment"># uses the cached copy of orders</span>
</pre>

<p>But what if you want to reload the cache, because data might have been
changed by some other part of the application? Just pass <code>true</code>
to the association call:</p>

<pre class="ruby"><span class="ruby-identifier">customer</span>.<span class="ruby-identifier">orders</span>                 <span class="ruby-comment"># retrieves orders from the database</span>
<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">size</span>            <span class="ruby-comment"># uses the cached copy of orders</span>
<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">orders</span>(<span class="ruby-keyword">true</span>).<span class="ruby-identifier">empty?</span>    <span class="ruby-comment"># discards the cached copy of orders</span>
                                <span class="ruby-comment"># and goes back to the database</span>
</pre>

<h3 id="label-Avoiding+Name+Collisions">Avoiding Name Collisions<span><a href="#label-Avoiding+Name+Collisions">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You are not free to use just any name for your associations. Because
creating an association adds a method with that name to the model, it is a
bad idea to give an association a name that is already used for an instance
method of <code>ActiveRecord::Base</code>. The association method would
override the base method and break things. For instance,
<code>attributes</code> or <code>connection</code> are bad names for
associations.</p>

<h3 id="label-Updating+the+Schema">Updating the Schema<span><a href="#label-Updating+the+Schema">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Associations are extremely useful, but they are not magic. You are
responsible for maintaining your database schema to match your
associations. In practice, this means two things, depending on what sort of
associations you are creating. For <code>belongs_to</code> associations you
need to create foreign keys, and for <code>has_and_belongs_to_many</code>
associations you need to create the appropriate join table.</p>

<h4 id="label-Creating+Foreign+Keys+for+belongs_to+Associations">Creating Foreign Keys for <code>belongs_to</code> Associations<span><a href="#label-Creating+Foreign+Keys+for+belongs_to+Associations">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you declare a <code>belongs_to</code> association, you need to create
foreign keys as appropriate. For example, consider this model:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This declaration needs to be backed up by the proper foreign key
declaration on the orders table:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateOrders</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">orders</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">datetime</span> :<span class="ruby-identifier">order_date</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">string</span>   :<span class="ruby-identifier">order_number</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span>  :<span class="ruby-identifier">customer_id</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">orders</span>, :<span class="ruby-identifier">customer_id</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you create an association some time after you build the underlying
model, you need to remember to create an <code>add_column</code> migration
to provide the necessary foreign key.</p>

<h4 id="label-Creating+Join+Tables+for+has_and_belongs_to_many+Associations">Creating Join Tables for <code>has_and_belongs_to_many</code> Associations<span><a href="#label-Creating+Join+Tables+for+has_and_belongs_to_many+Associations">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If you create a <code>has_and_belongs_to_many</code> association, you need
to explicitly create the joining table. Unless the name of the join table
is explicitly specified by using the <code>:join_table</code> option,
Active Record creates the name by using the lexical order of the class
names. So a join between customer and order models will give the default
join table name of “customers_orders” because “c” outranks “o” in lexical
ordering.</p>

<p>WARNING: The precedence between model names is calculated using the
<code>&lt;</code> operator for <code>String</code>. This means that if the
strings are of different lengths, and the strings are equal when compared
up to the shortest length, then the longer string is considered of higher
lexical precedence than the shorter one. For example, one would expect the
tables “paper_boxes” and “papers” to generate a join table name of
“papers_paper_boxes” because of the length of the name “paper_boxes”, but
it in fact generates a join table name of “paper_boxes_papers” (because the
underscore &#39;_&#39; is lexicographically <em>less</em> than &#39;s&#39;
in common encodings).</p>

<p>Whatever the name, you must manually generate the join table with an
appropriate migration. For example, consider these associations:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Assembly</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">parts</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Part</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>
<span class="ruby-keyword">end</span>
</pre>

<p>These need to be backed up by a migration to create the
<code>assemblies_parts</code> table. This table should be created without a
primary key:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">CreateAssembliesPartsJoinTable</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Migration</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change</span>
    <span class="ruby-identifier">create_table</span> :<span class="ruby-identifier">assemblies_parts</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> :<span class="ruby-identifier">assembly_id</span>
      <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> :<span class="ruby-identifier">part_id</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">assemblies_parts</span>, :<span class="ruby-identifier">assembly_id</span>
    <span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">assemblies_parts</span>, :<span class="ruby-identifier">part_id</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>We pass <code>id: false</code> to <code>create_table</code> because that
table does not represent a model. That&#39;s required for the association
to work properly. If you observe any strange behavior in a
<code>has_and_belongs_to_many</code> association like mangled models IDs,
or exceptions about conflicting IDs, chances are you forgot that bit.</p>

<h3 id="label-Controlling+Association+Scope">Controlling Association Scope<span><a href="#label-Controlling+Association+Scope">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>By default, associations look for objects only within the current
module&#39;s scope. This can be important when you declare Active Record
models within a module. For example:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">MyApplication</span>
  <span class="ruby-keyword">module</span> <span class="ruby-constant">Business</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
       <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
       <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This will work fine, because both the <code>Supplier</code> and the
<code>Account</code> class are defined within the same scope. But the
following will <em>not</em> work, because <code>Supplier</code> and
<code>Account</code> are defined in different scopes:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">MyApplication</span>
  <span class="ruby-keyword">module</span> <span class="ruby-constant">Business</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
       <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">module</span> <span class="ruby-constant">Billing</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
       <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To associate a model with a model in a different namespace, you must
specify the complete class name in your association declaration:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">MyApplication</span>
  <span class="ruby-keyword">module</span> <span class="ruby-constant">Business</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
       <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>,
        <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;MyApplication::Billing::Account&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">module</span> <span class="ruby-constant">Billing</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
       <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>,
        <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;MyApplication::Business::Supplier&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Bi-directional+Associations">Bi-directional Associations<span><a href="#label-Bi-directional+Associations">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>It&#39;s normal for associations to work in two directions, requiring
declaration on two different models:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By default, Active Record doesn&#39;t know about the connection between
these associations. This can lead to two copies of an object getting out of
sync:</p>

<pre class="ruby"><span class="ruby-identifier">c</span> = <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">o</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-comment"># =&gt; true</span>
<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span> = <span class="ruby-string">&#39;Manny&#39;</span>
<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-comment"># =&gt; false</span>
</pre>

<p>This happens because c and o.customer are two different in-memory
representations of the same data, and neither one is automatically
refreshed from changes to the other. Active Record provides the
<code>:inverse_of</code> option so that you can inform it of these
relations:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With these changes, Active Record will only load one copy of the customer
object, preventing inconsistencies and making your application more
efficient:</p>

<pre class="ruby"><span class="ruby-identifier">c</span> = <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">o</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-comment"># =&gt; true</span>
<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span> = <span class="ruby-string">&#39;Manny&#39;</span>
<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-comment"># =&gt; true</span>
</pre>

<p>There are a few limitations to <code>inverse_of</code> support:</p>
<ul><li>
<p>They do not work with <code>:through</code> associations.</p>
</li><li>
<p>They do not work with <code>:polymorphic</code> associations.</p>
</li><li>
<p>They do not work with <code>:as</code> associations.</p>
</li><li>
<p>For <code>belongs_to</code> associations, <code>has_many</code> inverse
associations are ignored.</p>
</li></ul>

<p>Every association will attempt to automatically find the inverse
association and set the <code>:inverse_of</code> option heuristically
(based on the association name). Most associations with standard names will
be supported. However, associations that contain the following options will
not have their inverses set automatically:</p>
<ul><li>
<p>:conditions</p>
</li><li>
<p>:through</p>
</li><li>
<p>:polymorphic</p>
</li><li>
<p>:foreign_key</p>
</li></ul>

<h2 id="label-Detailed+Association+Reference">Detailed Association Reference<span><a href="#label-Detailed+Association+Reference">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The following sections give the details of each type of association,
including the methods that they add and the options that you can use when
declaring an association.</p>

<h3 id="label-belongs_to+Association+Reference"><code>belongs_to</code> Association Reference<span><a href="#label-belongs_to+Association+Reference">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>belongs_to</code> association creates a one-to-one match with
another model. In database terms, this association says that this class
contains the foreign key. If the other class contains the foreign key, then
you should use <code>has_one</code> instead.</p>

<h4 id="label-Methods+Added+by+belongs_to">Methods Added by <code>belongs_to</code><span><a href="#label-Methods+Added+by+belongs_to">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you declare a <code>belongs_to</code> association, the declaring class
automatically gains five methods related to the association:</p>
<ul><li>
<p><code>association(force_reload = false)</code></p>
</li><li>
<p><code>association=(associate)</code></p>
</li><li>
<p><code>build_association(attributes = {})</code></p>
</li><li>
<p><code>create_association(attributes = {})</code></p>
</li><li>
<p><code>create_association!(attributes = {})</code></p>
</li></ul>

<p>In all of these methods, <code>association</code> is replaced with the
symbol passed as the first argument to <code>belongs_to</code>. For
example, given the declaration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Each instance of the <code>Order</code> model will have these methods:</p>

<pre class="ruby"><span class="ruby-identifier">customer</span>
<span class="ruby-identifier">customer</span>=
<span class="ruby-identifier">build_customer</span>
<span class="ruby-identifier">create_customer</span>
<span class="ruby-identifier">create_customer!</span>
</pre>

<p>NOTE: When initializing a new <code>has_one</code> or
<code>belongs_to</code> association you must use the <code>build_</code>
prefix to build the association, rather than the
<code>association.build</code> method that would be used for
<code>has_many</code> or <code>has_and_belongs_to_many</code> associations.
To create one, use the <code>create_</code> prefix.</p>

<h5 id="label-association-28force_reload+-3D+false-29"><code>association(force_reload = false)</code><span><a href="#label-association-28force_reload+-3D+false-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>association</code> method returns the associated object, if any.
If no associated object is found, it returns <code>nil</code>.</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span> = <span class="ruby-ivar">@order</span>.<span class="ruby-identifier">customer</span>
</pre>

<p>If the associated object has already been retrieved from the database for
this object, the cached version will be returned. To override this behavior
(and force a database read), pass <code>true</code> as the
<code>force_reload</code> argument.</p>

<h5 id="label-association-3D-28associate-29"><code>association=(associate)</code><span><a href="#label-association-3D-28associate-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>association=</code> method assigns an associated object to this
object. Behind the scenes, this means extracting the primary key from the
associate object and setting this object&#39;s foreign key to the same
value.</p>

<pre class="ruby"><span class="ruby-ivar">@order</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@customer</span>
</pre>

<h5 id="label-build_association-28attributes+-3D+-7B-7D-29"><code>build_association(attributes = {})</code><span><a href="#label-build_association-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>build_association</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, and the link through this object&#39;s foreign key will be set,
but the associated object will <em>not</em> yet be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span> = <span class="ruby-ivar">@order</span>.<span class="ruby-identifier">build_customer</span>(<span class="ruby-identifier">customer_number</span><span class="ruby-operator">:</span> <span class="ruby-value">123</span>,
                                  <span class="ruby-identifier">customer_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;John Doe&quot;</span>)
</pre>

<h5 id="label-create_association-28attributes+-3D+-7B-7D-29"><code>create_association(attributes = {})</code><span><a href="#label-create_association-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>create_association</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, the link through this object&#39;s foreign key will be set,
and, once it passes all of the validations specified on the associated
model, the associated object <em>will</em> be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span> = <span class="ruby-ivar">@order</span>.<span class="ruby-identifier">create_customer</span>(<span class="ruby-identifier">customer_number</span><span class="ruby-operator">:</span> <span class="ruby-value">123</span>,
                                   <span class="ruby-identifier">customer_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;John Doe&quot;</span>)
</pre>

<h5 id="label-create_association-21-28attributes+-3D+-7B-7D-29"><code>create_association!(attributes = {})</code><span><a href="#label-create_association-21-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Does the same as <code>create_association</code> above, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4 id="label-Options+for+belongs_to">Options for <code>belongs_to</code><span><a href="#label-Options+for+belongs_to">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>While Rails uses intelligent defaults that will work well in most
situations, there may be times when you want to customize the behavior of
the <code>belongs_to</code> association reference. Such customizations can
easily be accomplished by passing options and scope blocks when you create
the association. For example, this association uses two such options:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">dependent</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">destroy</span>,
    <span class="ruby-identifier">counter_cache</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>belongs_to</code> association supports these options:</p>
<ul><li>
<p><code>:autosave</code></p>
</li><li>
<p><code>:class_name</code></p>
</li><li>
<p><code>:counter_cache</code></p>
</li><li>
<p><code>:dependent</code></p>
</li><li>
<p><code>:foreign_key</code></p>
</li><li>
<p><code>:inverse_of</code></p>
</li><li>
<p><code>:polymorphic</code></p>
</li><li>
<p><code>:touch</code></p>
</li><li>
<p><code>:validate</code></p>
</li></ul>

<h5 id="label-3Aautosave"><code>:autosave</code><span><a href="#label-3Aautosave">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails
will save any loaded members and destroy members that are marked for
destruction whenever you save the parent object.</p>

<h5 id="label-3Aclass_name"><code>:class_name</code><span><a href="#label-3Aclass_name">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If the name of the other model cannot be derived from the association name,
you can use the <code>:class_name</code> option to supply the model name.
For example, if an order belongs to a customer, but the actual name of the
model containing customers is <code>Patron</code>, you&#39;d set things up
this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Patron&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Acounter_cache"><code>:counter_cache</code><span><a href="#label-3Acounter_cache">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:counter_cache</code> option can be used to make finding the
number of belonging objects more efficient. Consider these models:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With these declarations, asking for the value of
<code>@customer.orders.size</code> requires making a call to the database
to perform a <code>COUNT(*)</code> query. To avoid this call, you can add a
counter cache to the <em>belonging</em> model:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">counter_cache</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With this declaration, Rails will keep the cache value up to date, and then
return that value in response to the <code>size</code> method.</p>

<p>Although the <code>:counter_cache</code> option is specified on the model
that includes the <code>belongs_to</code> declaration, the actual column
must be added to the <em>associated</em> model. In the case above, you
would need to add a column named <code>orders_count</code> to the
<code>Customer</code> model. You can override the default column name if
you need to:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">counter_cache</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">count_of_orders</span>
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Counter cache columns are added to the containing model&#39;s list of
read-only attributes through <code>attr_readonly</code>.</p>

<h5 id="label-3Adependent"><code>:dependent</code><span><a href="#label-3Adependent">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:dependent</code> option to:</p>
<ul><li>
<p><code>:destroy</code>, when the object is destroyed, <code>destroy</code>
will be called on its associated objects.</p>
</li><li>
<p><code>:delete</code>, when the object is destroyed, all its associated
objects will be deleted directly from the database without calling their
<code>destroy</code> method.</p>
</li></ul>

<p>WARNING: You should not specify this option on a <code>belongs_to</code>
association that is connected with a <code>has_many</code> association on
the other class. Doing so can lead to orphaned records in your database.</p>

<h5 id="label-3Aforeign_key"><code>:foreign_key</code><span><a href="#label-3Aforeign_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column used to hold the foreign key
on this model is the name of the association with the suffix
<code>_id</code> added. The <code>:foreign_key</code> option lets you set
the name of the foreign key directly:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Patron&quot;</span>,
                        <span class="ruby-identifier">foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;patron_id&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>TIP: In any case, Rails will not create foreign key columns for you. You
need to explicitly define them as part of your migrations.</p>

<h5 id="label-3Ainverse_of"><code>:inverse_of</code><span><a href="#label-3Ainverse_of">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:inverse_of</code> option specifies the name of the
<code>has_many</code> or <code>has_one</code> association that is the
inverse of this association. Does not work in combination with the
<code>:polymorphic</code> options.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Apolymorphic"><code>:polymorphic</code><span><a href="#label-3Apolymorphic">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Passing <code>true</code> to the <code>:polymorphic</code> option indicates
that this is a polymorphic association. Polymorphic associations were
discussed in detail &lt;a href=“#polymorphic-associations”&gt;earlier in
this guide&lt;/a&gt;.</p>

<h5 id="label-3Atouch"><code>:touch</code><span><a href="#label-3Atouch">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:touch</code> option to <code>:true</code>, then the
<code>updated_at</code> or <code>updated_on</code> timestamp on the
associated object will be set to the current time whenever this object is
saved or destroyed:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>In this case, saving or destroying an order will update the timestamp on
the associated customer. You can also specify a particular timestamp
attribute to update:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">orders_updated_at</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Avalidate"><code>:validate</code><span><a href="#label-3Avalidate">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:validate</code> option to <code>true</code>, then
associated objects will be validated whenever you save this object. By
default, this is <code>false</code>: associated objects will not be
validated when this object is saved.</p>

<h4 id="label-Scopes+for+belongs_to">Scopes for <code>belongs_to</code><span><a href="#label-Scopes+for+belongs_to">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>There may be times when you wish to customize the query used by
<code>belongs_to</code>. Such customizations can be achieved via a scope
block. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">active</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> },
                        <span class="ruby-identifier">dependent</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">destroy</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You can use any of the standard <a
href="active_record_querying.html">querying methods</a> inside the scope
block. The following ones are discussed below:</p>
<ul><li>
<p><code>where</code></p>
</li><li>
<p><code>includes</code></p>
</li><li>
<p><code>readonly</code></p>
</li><li>
<p><code>select</code></p>
</li></ul>

<h5 id="label-where"><code>where</code><span><a href="#label-where">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>where</code> method lets you specify the conditions that the
associated object must meet.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">active</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> }
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-includes"><code>includes</code><span><a href="#label-includes">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>You can use the <code>includes</code> method to specify second-order
associations that should be eager-loaded when this association is used. For
example, consider these models:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LineItem</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">order</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">line_items</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you frequently retrieve customers directly from line items
(<code>@line_item.order.customer</code>), then you can make your code
somewhat more efficient by including customers in the association from line
items to orders:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">LineItem</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">order</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">includes</span> :<span class="ruby-identifier">customer</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">line_items</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>NOTE: There&#39;s no need to use <code>includes</code> for immediate
associations - that is, if you have <code>Order belongs_to
:customer</code>, then the customer is eager-loaded automatically when
it&#39;s needed.</p>

<h5 id="label-readonly"><code>readonly</code><span><a href="#label-readonly">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you use <code>readonly</code>, then the associated object will be
read-only when retrieved via the association.</p>

<h5 id="label-select"><code>select</code><span><a href="#label-select">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>select</code> method lets you override the SQL
<code>SELECT</code> clause that is used to retrieve data about the
associated object. By default, Rails retrieves all columns.</p>

<p>TIP: If you use the <code>select</code> method on a <code>belongs_to</code>
association, you should also set the <code>:foreign_key</code> option to
guarantee the correct results.</p>

<h4 id="label-Do+Any+Associated+Objects+Exist-3F">Do Any Associated Objects Exist?<span><a href="#label-Do+Any+Associated+Objects+Exist-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can see if any associated objects exist by using the
<code>association.nil?</code> method:</p>

<pre class="ruby"><span class="ruby-keyword">if</span> <span class="ruby-ivar">@order</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-ivar">@msg</span> = <span class="ruby-string">&quot;No customer found for this order&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-When+are+Objects+Saved-3F">When are Objects Saved?<span><a href="#label-When+are+Objects+Saved-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Assigning an object to a <code>belongs_to</code> association does
<em>not</em> automatically save the object. It does not save the associated
object either.</p>

<h3 id="label-has_one+Association+Reference"><code>has_one</code> Association Reference<span><a href="#label-has_one+Association+Reference">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>has_one</code> association creates a one-to-one match with
another model. In database terms, this association says that the other
class contains the foreign key. If this class contains the foreign key,
then you should use <code>belongs_to</code> instead.</p>

<h4 id="label-Methods+Added+by+has_one">Methods Added by <code>has_one</code><span><a href="#label-Methods+Added+by+has_one">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you declare a <code>has_one</code> association, the declaring class
automatically gains five methods related to the association:</p>
<ul><li>
<p><code>association(force_reload = false)</code></p>
</li><li>
<p><code>association=(associate)</code></p>
</li><li>
<p><code>build_association(attributes = {})</code></p>
</li><li>
<p><code>create_association(attributes = {})</code></p>
</li><li>
<p><code>create_association!(attributes = {})</code></p>
</li></ul>

<p>In all of these methods, <code>association</code> is replaced with the
symbol passed as the first argument to <code>has_one</code>. For example,
given the declaration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Each instance of the <code>Supplier</code> model will have these methods:</p>

<pre class="ruby"><span class="ruby-identifier">account</span>
<span class="ruby-identifier">account</span>=
<span class="ruby-identifier">build_account</span>
<span class="ruby-identifier">create_account</span>
<span class="ruby-identifier">create_account!</span>
</pre>

<p>NOTE: When initializing a new <code>has_one</code> or
<code>belongs_to</code> association you must use the <code>build_</code>
prefix to build the association, rather than the
<code>association.build</code> method that would be used for
<code>has_many</code> or <code>has_and_belongs_to_many</code> associations.
To create one, use the <code>create_</code> prefix.</p>

<h5 id="label-association-28force_reload+-3D+false-29"><code>association(force_reload = false)</code><span><a href="#label-association-28force_reload+-3D+false-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>association</code> method returns the associated object, if any.
If no associated object is found, it returns <code>nil</code>.</p>

<pre class="ruby"><span class="ruby-ivar">@account</span> = <span class="ruby-ivar">@supplier</span>.<span class="ruby-identifier">account</span>
</pre>

<p>If the associated object has already been retrieved from the database for
this object, the cached version will be returned. To override this behavior
(and force a database read), pass <code>true</code> as the
<code>force_reload</code> argument.</p>

<h5 id="label-association-3D-28associate-29"><code>association=(associate)</code><span><a href="#label-association-3D-28associate-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>association=</code> method assigns an associated object to this
object. Behind the scenes, this means extracting the primary key from this
object and setting the associate object&#39;s foreign key to the same
value.</p>

<pre class="ruby"><span class="ruby-ivar">@supplier</span>.<span class="ruby-identifier">account</span> = <span class="ruby-ivar">@account</span>
</pre>

<h5 id="label-build_association-28attributes+-3D+-7B-7D-29"><code>build_association(attributes = {})</code><span><a href="#label-build_association-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>build_association</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, and the link through its foreign key will be set, but the
associated object will <em>not</em> yet be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@account</span> = <span class="ruby-ivar">@supplier</span>.<span class="ruby-identifier">build_account</span>(<span class="ruby-identifier">terms</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Net 30&quot;</span>)
</pre>

<h5 id="label-create_association-28attributes+-3D+-7B-7D-29"><code>create_association(attributes = {})</code><span><a href="#label-create_association-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>create_association</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, the link through its foreign key will be set, and, once it
passes all of the validations specified on the associated model, the
associated object <em>will</em> be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@account</span> = <span class="ruby-ivar">@supplier</span>.<span class="ruby-identifier">create_account</span>(<span class="ruby-identifier">terms</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Net 30&quot;</span>)
</pre>

<h5 id="label-create_association-21-28attributes+-3D+-7B-7D-29"><code>create_association!(attributes = {})</code><span><a href="#label-create_association-21-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Does the same as <code>create_association</code> above, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4 id="label-Options+for+has_one">Options for <code>has_one</code><span><a href="#label-Options+for+has_one">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>While Rails uses intelligent defaults that will work well in most
situations, there may be times when you want to customize the behavior of
the <code>has_one</code> association reference. Such customizations can
easily be accomplished by passing options when you create the association.
For example, this association uses two such options:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Billing&quot;</span>, <span class="ruby-identifier">dependent</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">nullify</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>has_one</code> association supports these options:</p>
<ul><li>
<p><code>:as</code></p>
</li><li>
<p><code>:autosave</code></p>
</li><li>
<p><code>:class_name</code></p>
</li><li>
<p><code>:dependent</code></p>
</li><li>
<p><code>:foreign_key</code></p>
</li><li>
<p><code>:inverse_of</code></p>
</li><li>
<p><code>:primary_key</code></p>
</li><li>
<p><code>:source</code></p>
</li><li>
<p><code>:source_type</code></p>
</li><li>
<p><code>:through</code></p>
</li><li>
<p><code>:validate</code></p>
</li></ul>

<h5 id="label-3Aas"><code>:as</code><span><a href="#label-3Aas">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Setting the <code>:as</code> option indicates that this is a polymorphic
association. Polymorphic associations were discussed in detail <a
href="#polymorphic-associations">earlier in this guide</a>.</p>

<h5 id="label-3Aautosave"><code>:autosave</code><span><a href="#label-3Aautosave">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails
will save any loaded members and destroy members that are marked for
destruction whenever you save the parent object.</p>

<h5 id="label-3Aclass_name"><code>:class_name</code><span><a href="#label-3Aclass_name">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If the name of the other model cannot be derived from the association name,
you can use the <code>:class_name</code> option to supply the model name.
For example, if a supplier has an account, but the actual name of the model
containing accounts is <code>Billing</code>, you&#39;d set things up this
way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Billing&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Adependent"><code>:dependent</code><span><a href="#label-3Adependent">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Controls what happens to the associated object when its owner is destroyed:</p>
<ul><li>
<p><code>:destroy</code> causes the associated object to also be destroyed</p>
</li><li>
<p><code>:delete</code> causes the associated object to be deleted directly
from the database (so callbacks will not execute)</p>
</li><li>
<p><code>:nullify</code> causes the foreign key to be set to
<code>NULL</code>. Callbacks are not executed.</p>
</li><li>
<p><code>:restrict_with_exception</code> causes an exception to be raised if
there is an associated record</p>
</li><li>
<p><code>:restrict_with_error</code> causes an error to be added to the owner
if there is an associated object</p>
</li></ul>

<p>It&#39;s necessary not to set or leave <code>:nullify</code> option for
those associations that have <code>NOT NULL</code> database constraints. If
you don&#39;t set <code>dependent</code> to destroy such associations you
won&#39;t be able to change the associated object because initial
associated object foreign key will be set to unallowed <code>NULL</code>
value.</p>

<h5 id="label-3Aforeign_key"><code>:foreign_key</code><span><a href="#label-3Aforeign_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column used to hold the foreign key
on the other model is the name of this model with the suffix
<code>_id</code> added. The <code>:foreign_key</code> option lets you set
the name of the foreign key directly:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-identifier">foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;supp_id&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>TIP: In any case, Rails will not create foreign key columns for you. You
need to explicitly define them as part of your migrations.</p>

<h5 id="label-3Ainverse_of"><code>:inverse_of</code><span><a href="#label-3Ainverse_of">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:inverse_of</code> option specifies the name of the
<code>belongs_to</code> association that is the inverse of this
association. Does not work in combination with the <code>:through</code> or
<code>:as</code> options.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">supplier</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Aprimary_key"><code>:primary_key</code><span><a href="#label-3Aprimary_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column used to hold the primary key
of this model is <code>id</code>. You can override this and explicitly
specify the primary key with the <code>:primary_key</code> option.</p>

<h5 id="label-3Asource"><code>:source</code><span><a href="#label-3Asource">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:source</code> option specifies the source association name for a
<code>has_one :through</code> association.</p>

<h5 id="label-3Asource_type"><code>:source_type</code><span><a href="#label-3Asource_type">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:source_type</code> option specifies the source association type
for a <code>has_one :through</code> association that proceeds through a
polymorphic association.</p>

<h5 id="label-3Athrough"><code>:through</code><span><a href="#label-3Athrough">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:through</code> option specifies a join model through which to
perform the query. <code>has_one :through</code> associations were
discussed in detail <a href="#the-has-one-through-association">earlier in
this guide</a>.</p>

<h5 id="label-3Avalidate"><code>:validate</code><span><a href="#label-3Avalidate">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:validate</code> option to <code>true</code>, then
associated objects will be validated whenever you save this object. By
default, this is <code>false</code>: associated objects will not be
validated when this object is saved.</p>

<h4 id="label-Scopes+for+has_one">Scopes for <code>has_one</code><span><a href="#label-Scopes+for+has_one">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>There may be times when you wish to customize the query used by
<code>has_one</code>. Such customizations can be achieved via a scope
block. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">active</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> }
<span class="ruby-keyword">end</span>
</pre>

<p>You can use any of the standard <a
href="active_record_querying.html">querying methods</a> inside the scope
block. The following ones are discussed below:</p>
<ul><li>
<p><code>where</code></p>
</li><li>
<p><code>includes</code></p>
</li><li>
<p><code>readonly</code></p>
</li><li>
<p><code>select</code></p>
</li></ul>

<h5 id="label-where"><code>where</code><span><a href="#label-where">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>where</code> method lets you specify the conditions that the
associated object must meet.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-string">&quot;confirmed = 1&quot;</span> }
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-includes"><code>includes</code><span><a href="#label-includes">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>You can use the <code>includes</code> method to specify second-order
associations that should be eager-loaded when this association is used. For
example, consider these models:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">representative</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Representative</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">accounts</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you frequently retrieve representatives directly from suppliers
(<code>@supplier.account.representative</code>), then you can make your
code somewhat more efficient by including representatives in the
association from suppliers to accounts:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_one</span> :<span class="ruby-identifier">account</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">includes</span> :<span class="ruby-identifier">representative</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Account</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">supplier</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">representative</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Representative</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">accounts</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-readonly"><code>readonly</code><span><a href="#label-readonly">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you use the <code>readonly</code> method, then the associated object
will be read-only when retrieved via the association.</p>

<h5 id="label-select"><code>select</code><span><a href="#label-select">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>select</code> method lets you override the SQL
<code>SELECT</code> clause that is used to retrieve data about the
associated object. By default, Rails retrieves all columns.</p>

<h4 id="label-Do+Any+Associated+Objects+Exist-3F">Do Any Associated Objects Exist?<span><a href="#label-Do+Any+Associated+Objects+Exist-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can see if any associated objects exist by using the
<code>association.nil?</code> method:</p>

<pre class="ruby"><span class="ruby-keyword">if</span> <span class="ruby-ivar">@supplier</span>.<span class="ruby-identifier">account</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-ivar">@msg</span> = <span class="ruby-string">&quot;No account found for this supplier&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-When+are+Objects+Saved-3F">When are Objects Saved?<span><a href="#label-When+are+Objects+Saved-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you assign an object to a <code>has_one</code> association, that
object is automatically saved (in order to update its foreign key). In
addition, any object being replaced is also automatically saved, because
its foreign key will change too.</p>

<p>If either of these saves fails due to validation errors, then the
assignment statement returns <code>false</code> and the assignment itself
is cancelled.</p>

<p>If the parent object (the one declaring the <code>has_one</code>
association) is unsaved (that is, <code>new_record?</code> returns
<code>true</code>) then the child objects are not saved. They will
automatically when the parent object is saved.</p>

<p>If you want to assign an object to a <code>has_one</code> association
without saving the object, use the <code>association.build</code> method.</p>

<h3 id="label-has_many+Association+Reference"><code>has_many</code> Association Reference<span><a href="#label-has_many+Association+Reference">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>has_many</code> association creates a one-to-many relationship
with another model. In database terms, this association says that the other
class will have a foreign key that refers to instances of this class.</p>

<h4 id="label-Methods+Added+by+has_many">Methods Added by <code>has_many</code><span><a href="#label-Methods+Added+by+has_many">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you declare a <code>has_many</code> association, the declaring class
automatically gains 16 methods related to the association:</p>
<ul><li>
<p><code>collection(force_reload = false)</code></p>
</li><li>
<p><code>collection&lt;&lt;(object, ...)</code></p>
</li><li>
<p><code>collection.delete(object, ...)</code></p>
</li><li>
<p><code>collection.destroy(object, ...)</code></p>
</li><li>
<p><code>collection=(objects)</code></p>
</li><li>
<p><code>collection_singular_ids</code></p>
</li><li>
<p><code>collection_singular_ids=(ids)</code></p>
</li><li>
<p><code>collection.clear</code></p>
</li><li>
<p><code>collection.empty?</code></p>
</li><li>
<p><code>collection.size</code></p>
</li><li>
<p><code>collection.find(...)</code></p>
</li><li>
<p><code>collection.where(...)</code></p>
</li><li>
<p><code>collection.exists?(...)</code></p>
</li><li>
<p><code>collection.build(attributes = {}, ...)</code></p>
</li><li>
<p><code>collection.create(attributes = {})</code></p>
</li><li>
<p><code>collection.create!(attributes = {})</code></p>
</li></ul>

<p>In all of these methods, <code>collection</code> is replaced with the
symbol passed as the first argument to <code>has_many</code>, and
<code>collection_singular</code> is replaced with the singularized version
of that symbol. For example, given the declaration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Each instance of the <code>Customer</code> model will have these methods:</p>

<pre class="ruby"><span class="ruby-identifier">orders</span>(<span class="ruby-identifier">force_reload</span> = <span class="ruby-keyword">false</span>)
<span class="ruby-identifier">orders</span><span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">object</span>, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">object</span>, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">destroy</span>(<span class="ruby-identifier">object</span>, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>=(<span class="ruby-identifier">objects</span>)
<span class="ruby-identifier">order_ids</span>
<span class="ruby-identifier">order_ids</span>=(<span class="ruby-identifier">ids</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">clear</span>
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">empty?</span>
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">size</span>
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">find</span>(<span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">where</span>(<span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">attributes</span> = {}, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">attributes</span> = {})
<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">create!</span>(<span class="ruby-identifier">attributes</span> = {})
</pre>

<h5 id="label-collection-28force_reload+-3D+false-29"><code>collection(force_reload = false)</code><span><a href="#label-collection-28force_reload+-3D+false-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection</code> method returns an array of all of the
associated objects. If there are no associated objects, it returns an empty
array.</p>

<pre class="ruby"><span class="ruby-ivar">@orders</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>
</pre>

<h5 id="label-collection-3C-3C-28object-2C+...-29"><code>collection&lt;&lt;(object, ...)</code><span><a href="#label-collection-3C-3C-28object-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection&lt;&lt;</code> method adds one or more objects to the
collection by setting their foreign keys to the primary key of the calling
model.</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@order1</span>
</pre>

<h5 id="label-collection.delete-28object-2C+...-29"><code>collection.delete(object, ...)</code><span><a href="#label-collection.delete-28object-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.delete</code> method removes one or more objects from
the collection by setting their foreign keys to <code>NULL</code>.</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@order1</span>)
</pre>

<p>WARNING: Additionally, objects will be destroyed if they&#39;re associated
with <code>dependent: :destroy</code>, and deleted if they&#39;re
associated with <code>dependent: :delete_all</code>.</p>

<h5 id="label-collection.destroy-28object-2C+...-29"><code>collection.destroy(object, ...)</code><span><a href="#label-collection.destroy-28object-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.destroy</code> method removes one or more objects from
the collection by running <code>destroy</code> on each object.</p>

<pre class="ruby"><span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">destroy</span>(<span class="ruby-ivar">@order1</span>)
</pre>

<p>WARNING: Objects will <em>always</em> be removed from the database,
ignoring the <code>:dependent</code> option.</p>

<h5 id="label-collection-3D-28objects-29"><code>collection=(objects)</code><span><a href="#label-collection-3D-28objects-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection=</code> method makes the collection contain only the
supplied objects, by adding and deleting as appropriate.</p>

<h5 id="label-collection_singular_ids"><code>collection_singular_ids</code><span><a href="#label-collection_singular_ids">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection_singular_ids</code> method returns an array of the ids
of the objects in the collection.</p>

<pre class="ruby"><span class="ruby-ivar">@order_ids</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">order_ids</span>
</pre>

<h5 id="label-collection_singular_ids-3D-28ids-29"><code>collection_singular_ids=(ids)</code><span><a href="#label-collection_singular_ids-3D-28ids-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection_singular_ids=</code> method makes the collection
contain only the objects identified by the supplied primary key values, by
adding and deleting as appropriate.</p>

<h5 id="label-collection.clear"><code>collection.clear</code><span><a href="#label-collection.clear">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.clear</code> method removes every object from the
collection. This destroys the associated objects if they are associated
with <code>dependent: :destroy</code>, deletes them directly from the
database if <code>dependent: :delete_all</code>, and otherwise sets their
foreign keys to <code>NULL</code>.</p>

<h5 id="label-collection.empty-3F"><code>collection.empty?</code><span><a href="#label-collection.empty-3F">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.empty?</code> method returns <code>true</code> if the
collection does not contain any associated objects.</p>

<pre>&lt;% if @customer.orders.empty? %&gt;
  No Orders Found
&lt;% end %&gt;</pre>

<h5 id="label-collection.size"><code>collection.size</code><span><a href="#label-collection.size">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.size</code> method returns the number of objects in
the collection.</p>

<pre class="ruby"><span class="ruby-ivar">@order_count</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">size</span>
</pre>

<h5 id="label-collection.find-28...-29"><code>collection.find(...)</code><span><a href="#label-collection.find-28...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.find</code> method finds objects within the
collection. It uses the same syntax and options as
<code>ActiveRecord::Base.find</code>.</p>

<pre class="ruby"><span class="ruby-ivar">@open_orders</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
</pre>

<h5 id="label-collection.where-28...-29"><code>collection.where(...)</code><span><a href="#label-collection.where-28...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.where</code> method finds objects within the
collection based on the conditions supplied but the objects are loaded
lazily meaning that the database is queried only when the object(s) are
accessed.</p>

<pre class="ruby"><span class="ruby-ivar">@open_orders</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">open</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) <span class="ruby-comment"># No query yet</span>
<span class="ruby-ivar">@open_order</span> = <span class="ruby-ivar">@open_orders</span>.<span class="ruby-identifier">first</span> <span class="ruby-comment"># Now the database will be queried</span>
</pre>

<h5 id="label-collection.exists-3F-28...-29"><code>collection.exists?(...)</code><span><a href="#label-collection.exists-3F-28...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.exists?</code> method checks whether an object meeting
the supplied conditions exists in the collection. It uses the same syntax
and options as <code>ActiveRecord::Base.exists?</code>.</p>

<h5 id="label-collection.build-28attributes+-3D+-7B-7D-2C+...-29"><code>collection.build(attributes = {}, ...)</code><span><a href="#label-collection.build-28attributes+-3D+-7B-7D-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.build</code> method returns one or more new objects of
the associated type. These objects will be instantiated from the passed
attributes, and the link through their foreign key will be created, but the
associated objects will <em>not</em> yet be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@order</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">order_date</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>,
                                <span class="ruby-identifier">order_number</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;A12345&quot;</span>)
</pre>

<h5 id="label-collection.create-28attributes+-3D+-7B-7D-29"><code>collection.create(attributes = {})</code><span><a href="#label-collection.create-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.create</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, the link through its foreign key will be created, and, once it
passes all of the validations specified on the associated model, the
associated object <em>will</em> be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@order</span> = <span class="ruby-ivar">@customer</span>.<span class="ruby-identifier">orders</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">order_date</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>,
                                 <span class="ruby-identifier">order_number</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;A12345&quot;</span>)
</pre>

<h5 id="label-collection.create-21-28attributes+-3D+-7B-7D-29"><code>collection.create!(attributes = {})</code><span><a href="#label-collection.create-21-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Does the same as <code>collection.create</code> above, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4 id="label-Options+for+has_many">Options for <code>has_many</code><span><a href="#label-Options+for+has_many">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>While Rails uses intelligent defaults that will work well in most
situations, there may be times when you want to customize the behavior of
the <code>has_many</code> association reference. Such customizations can
easily be accomplished by passing options when you create the association.
For example, this association uses two such options:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">dependent</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">delete_all</span>, <span class="ruby-identifier">validate</span><span class="ruby-operator">:</span> :<span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>has_many</code> association supports these options:</p>
<ul><li>
<p><code>:as</code></p>
</li><li>
<p><code>:autosave</code></p>
</li><li>
<p><code>:class_name</code></p>
</li><li>
<p><code>:dependent</code></p>
</li><li>
<p><code>:foreign_key</code></p>
</li><li>
<p><code>:inverse_of</code></p>
</li><li>
<p><code>:primary_key</code></p>
</li><li>
<p><code>:source</code></p>
</li><li>
<p><code>:source_type</code></p>
</li><li>
<p><code>:through</code></p>
</li><li>
<p><code>:validate</code></p>
</li></ul>

<h5 id="label-3Aas"><code>:as</code><span><a href="#label-3Aas">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Setting the <code>:as</code> option indicates that this is a polymorphic
association, as discussed <a href="#polymorphic-associations">earlier in
this guide</a>.</p>

<h5 id="label-3Aautosave"><code>:autosave</code><span><a href="#label-3Aautosave">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails
will save any loaded members and destroy members that are marked for
destruction whenever you save the parent object.</p>

<h5 id="label-3Aclass_name"><code>:class_name</code><span><a href="#label-3Aclass_name">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If the name of the other model cannot be derived from the association name,
you can use the <code>:class_name</code> option to supply the model name.
For example, if a customer has many orders, but the actual name of the
model containing orders is <code>Transaction</code>, you&#39;d set things
up this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Transaction&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Adependent"><code>:dependent</code><span><a href="#label-3Adependent">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Controls what happens to the associated objects when their owner is
destroyed:</p>
<ul><li>
<p><code>:destroy</code> causes all the associated objects to also be
destroyed</p>
</li><li>
<p><code>:delete_all</code> causes all the associated objects to be deleted
directly from the database (so callbacks will not execute)</p>
</li><li>
<p><code>:nullify</code> causes the foreign keys to be set to
<code>NULL</code>. Callbacks are not executed.</p>
</li><li>
<p><code>:restrict_with_exception</code> causes an exception to be raised if
there are any associated records</p>
</li><li>
<p><code>:restrict_with_error</code> causes an error to be added to the owner
if there are any associated objects</p>
</li></ul>

<h5 id="label-3Aforeign_key"><code>:foreign_key</code><span><a href="#label-3Aforeign_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column used to hold the foreign key
on the other model is the name of this model with the suffix
<code>_id</code> added. The <code>:foreign_key</code> option lets you set
the name of the foreign key directly:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;cust_id&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>TIP: In any case, Rails will not create foreign key columns for you. You
need to explicitly define them as part of your migrations.</p>

<h5 id="label-3Ainverse_of"><code>:inverse_of</code><span><a href="#label-3Ainverse_of">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:inverse_of</code> option specifies the name of the
<code>belongs_to</code> association that is the inverse of this
association. Does not work in combination with the <code>:through</code> or
<code>:as</code> options.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">customer</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>, <span class="ruby-identifier">inverse_of</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Aprimary_key"><code>:primary_key</code><span><a href="#label-3Aprimary_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column used to hold the primary key
of the association is <code>id</code>. You can override this and explicitly
specify the primary key with the <code>:primary_key</code> option.</p>

<p>Let&#39;s say that <code>users</code> table has <code>id</code> as the
primary_key but it also has <code>guid</code> column. And the requirement
is that <code>todos</code> table should hold <code>guid</code> column value
and not <code>id</code> value. This can be achieved like this</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">User</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">todos</span>, <span class="ruby-identifier">primary_key</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">guid</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now if we execute <code>@user.todos.create</code> then <code>@todo</code>
record will have <code>user_id</code> value as the <code>guid</code> value
of <code>@user</code>.</p>

<h5 id="label-3Asource"><code>:source</code><span><a href="#label-3Asource">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:source</code> option specifies the source association name for a
<code>has_many :through</code> association. You only need to use this
option if the name of the source association cannot be automatically
inferred from the association name.</p>

<h5 id="label-3Asource_type"><code>:source_type</code><span><a href="#label-3Asource_type">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:source_type</code> option specifies the source association type
for a <code>has_many :through</code> association that proceeds through a
polymorphic association.</p>

<h5 id="label-3Athrough"><code>:through</code><span><a href="#label-3Athrough">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>:through</code> option specifies a join model through which to
perform the query. <code>has_many :through</code> associations provide a
way to implement many-to-many relationships, as discussed <a
href="#the-has-many-through-association">earlier in this guide</a>.</p>

<h5 id="label-3Avalidate"><code>:validate</code><span><a href="#label-3Avalidate">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:validate</code> option to <code>false</code>, then
associated objects will not be validated whenever you save this object. By
default, this is <code>true</code>: associated objects will be validated
when this object is saved.</p>

<h4 id="label-Scopes+for+has_many">Scopes for <code>has_many</code><span><a href="#label-Scopes+for+has_many">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>There may be times when you wish to customize the query used by
<code>has_many</code>. Such customizations can be achieved via a scope
block. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">processed</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> }
<span class="ruby-keyword">end</span>
</pre>

<p>You can use any of the standard <a
href="active_record_querying.html">querying methods</a> inside the scope
block. The following ones are discussed below:</p>
<ul><li>
<p><code>where</code></p>
</li><li>
<p><code>extending</code></p>
</li><li>
<p><code>group</code></p>
</li><li>
<p><code>includes</code></p>
</li><li>
<p><code>limit</code></p>
</li><li>
<p><code>offset</code></p>
</li><li>
<p><code>order</code></p>
</li><li>
<p><code>readonly</code></p>
</li><li>
<p><code>select</code></p>
</li><li>
<p><code>uniq</code></p>
</li></ul>

<h5 id="label-where"><code>where</code><span><a href="#label-where">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>where</code> method lets you specify the conditions that the
associated object must meet.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">confirmed_orders</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-string">&quot;confirmed = 1&quot;</span> },
    <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Order&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>You can also set conditions via a hash:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">confirmed_orders</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">confirmed</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> },
                              <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Order&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you use a hash-style <code>where</code> option, then record creation via
this association will be automatically scoped using the hash. In this case,
using <code>@customer.confirmed_orders.create</code> or
<code>@customer.confirmed_orders.build</code> will create orders where the
confirmed column has the value <code>true</code>.</p>

<h5 id="label-extending"><code>extending</code><span><a href="#label-extending">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>extending</code> method specifies a named module to extend the
association proxy. Association extensions are discussed in detail <a
href="#association-extensions">later in this guide</a>.</p>

<h5 id="label-group"><code>group</code><span><a href="#label-group">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>group</code> method supplies an attribute name to group the
result set by, using a <code>GROUP BY</code> clause in the finder SQL.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">line_items</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">group</span> <span class="ruby-string">&#39;orders.id&#39;</span> },
                        <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-includes"><code>includes</code><span><a href="#label-includes">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>You can use the <code>includes</code> method to specify second-order
associations that should be eager-loaded when this association is used. For
example, consider these models:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">line_items</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">LineItem</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">order</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you frequently retrieve line items directly from customers
(<code>@customer.orders.line_items</code>), then you can make your code
somewhat more efficient by including line items in the association from
customers to orders:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">includes</span> :<span class="ruby-identifier">line_items</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Order</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">customer</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">line_items</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">LineItem</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">belongs_to</span> :<span class="ruby-identifier">order</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-limit"><code>limit</code><span><a href="#label-limit">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>limit</code> method lets you restrict the total number of objects
that will be fetched through an association.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">recent_orders</span>,
    <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;order_date desc&#39;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">100</span>) },
    <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Order&quot;</span>,
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-offset"><code>offset</code><span><a href="#label-offset">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>offset</code> method lets you specify the starting offset for
fetching objects via an association. For example, <code>-&gt; { offset(11)
}</code> will skip the first 11 records.</p>

<h5 id="label-order"><code>order</code><span><a href="#label-order">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>order</code> method dictates the order in which associated
objects will be received (in the syntax used by an SQL <code>ORDER
BY</code> clause).</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">order</span> <span class="ruby-string">&quot;date_confirmed DESC&quot;</span> }
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-readonly"><code>readonly</code><span><a href="#label-readonly">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you use the <code>readonly</code> method, then the associated objects
will be read-only when retrieved via the association.</p>

<h5 id="label-select"><code>select</code><span><a href="#label-select">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>select</code> method lets you override the SQL
<code>SELECT</code> clause that is used to retrieve data about the
associated objects. By default, Rails retrieves all columns.</p>

<p>WARNING: If you specify your own <code>select</code>, be sure to include
the primary key and foreign key columns of the associated model. If you do
not, Rails will throw an error.</p>

<h5 id="label-distinct"><code>distinct</code><span><a href="#label-distinct">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Use the <code>distinct</code> method to keep the collection free of
duplicates. This is mostly useful together with the <code>:through</code>
option.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Person</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">readings</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">articles</span>, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">readings</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">person</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;John&#39;</span>)
<span class="ruby-identifier">article</span>   = <span class="ruby-constant">Article</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;a1&#39;</span>)
<span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">article</span>
<span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">article</span>
<span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span>.<span class="ruby-identifier">inspect</span> <span class="ruby-comment"># =&gt; [#&lt;Article id: 5, name: &quot;a1&quot;&gt;, #&lt;Article id: 5, name: &quot;a1&quot;&gt;]</span>
<span class="ruby-constant">Reading</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">inspect</span>  <span class="ruby-comment"># =&gt; [#&lt;Reading id: 12, person_id: 5, article_id: 5&gt;, #&lt;Reading id: 13, person_id: 5, article_id: 5&gt;]</span>
</pre>

<p>In the above case there are two readings and <code>person.articles</code>
brings out both of them even though these records are pointing to the same
article.</p>

<p>Now let&#39;s set <code>distinct</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Person</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">readings</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">articles</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">distinct</span> }, <span class="ruby-identifier">through</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">readings</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">person</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Honda&#39;</span>)
<span class="ruby-identifier">article</span>   = <span class="ruby-constant">Article</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;a1&#39;</span>)
<span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">article</span>
<span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">article</span>
<span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span>.<span class="ruby-identifier">inspect</span> <span class="ruby-comment"># =&gt; [#&lt;Article id: 7, name: &quot;a1&quot;&gt;]</span>
<span class="ruby-constant">Reading</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">inspect</span>  <span class="ruby-comment"># =&gt; [#&lt;Reading id: 16, person_id: 7, article_id: 7&gt;, #&lt;Reading id: 17, person_id: 7, article_id: 7&gt;]</span>
</pre>

<p>In the above case there are still two readings. However
<code>person.articles</code> shows only one article because the collection
loads only unique records.</p>

<p>If you want to make sure that, upon insertion, all of the records in the
persisted association are distinct (so that you can be sure that when you
inspect the association that you will never find duplicate records), you
should add a unique index on the table itself. For example, if you have a
table named <code>person_articles</code> and you want to make sure all the
articles are unique, you could add the following in a migration:</p>

<pre class="ruby"><span class="ruby-identifier">add_index</span> :<span class="ruby-identifier">person_articles</span>, :<span class="ruby-identifier">article</span>, <span class="ruby-identifier">unique</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
</pre>

<p>Note that checking for uniqueness using something like
<code>include?</code> is subject to race conditions. Do not attempt to use
<code>include?</code> to enforce distinctness in an association. For
instance, using the article example from above, the following code would be
racy because multiple users could be attempting this at the same time:</p>

<pre class="ruby"><span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">article</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">person</span>.<span class="ruby-identifier">articles</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">article</span>)
</pre>

<h4 id="label-When+are+Objects+Saved-3F">When are Objects Saved?<span><a href="#label-When+are+Objects+Saved-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you assign an object to a <code>has_many</code> association, that
object is automatically saved (in order to update its foreign key). If you
assign multiple objects in one statement, then they are all saved.</p>

<p>If any of these saves fails due to validation errors, then the assignment
statement returns <code>false</code> and the assignment itself is
cancelled.</p>

<p>If the parent object (the one declaring the <code>has_many</code>
association) is unsaved (that is, <code>new_record?</code> returns
<code>true</code>) then the child objects are not saved when they are
added. All unsaved members of the association will automatically be saved
when the parent is saved.</p>

<p>If you want to assign an object to a <code>has_many</code> association
without saving the object, use the <code>collection.build</code> method.</p>

<h3 id="label-has_and_belongs_to_many+Association+Reference"><code>has_and_belongs_to_many</code> Association Reference<span><a href="#label-has_and_belongs_to_many+Association+Reference">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>has_and_belongs_to_many</code> association creates a many-to-many
relationship with another model. In database terms, this associates two
classes via an intermediate join table that includes foreign keys referring
to each of the classes.</p>

<h4 id="label-Methods+Added+by+has_and_belongs_to_many">Methods Added by <code>has_and_belongs_to_many</code><span><a href="#label-Methods+Added+by+has_and_belongs_to_many">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you declare a <code>has_and_belongs_to_many</code> association, the
declaring class automatically gains 16 methods related to the association:</p>
<ul><li>
<p><code>collection(force_reload = false)</code></p>
</li><li>
<p><code>collection&lt;&lt;(object, ...)</code></p>
</li><li>
<p><code>collection.delete(object, ...)</code></p>
</li><li>
<p><code>collection.destroy(object, ...)</code></p>
</li><li>
<p><code>collection=(objects)</code></p>
</li><li>
<p><code>collection_singular_ids</code></p>
</li><li>
<p><code>collection_singular_ids=(ids)</code></p>
</li><li>
<p><code>collection.clear</code></p>
</li><li>
<p><code>collection.empty?</code></p>
</li><li>
<p><code>collection.size</code></p>
</li><li>
<p><code>collection.find(...)</code></p>
</li><li>
<p><code>collection.where(...)</code></p>
</li><li>
<p><code>collection.exists?(...)</code></p>
</li><li>
<p><code>collection.build(attributes = {})</code></p>
</li><li>
<p><code>collection.create(attributes = {})</code></p>
</li><li>
<p><code>collection.create!(attributes = {})</code></p>
</li></ul>

<p>In all of these methods, <code>collection</code> is replaced with the
symbol passed as the first argument to
<code>has_and_belongs_to_many</code>, and <code>collection_singular</code>
is replaced with the singularized version of that symbol. For example,
given the declaration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Part</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Each instance of the <code>Part</code> model will have these methods:</p>

<pre class="ruby"><span class="ruby-identifier">assemblies</span>(<span class="ruby-identifier">force_reload</span> = <span class="ruby-keyword">false</span>)
<span class="ruby-identifier">assemblies</span><span class="ruby-operator">&lt;&lt;</span>(<span class="ruby-identifier">object</span>, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">object</span>, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">destroy</span>(<span class="ruby-identifier">object</span>, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>=(<span class="ruby-identifier">objects</span>)
<span class="ruby-identifier">assembly_ids</span>
<span class="ruby-identifier">assembly_ids</span>=(<span class="ruby-identifier">ids</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">clear</span>
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">empty?</span>
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">size</span>
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">find</span>(<span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">where</span>(<span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">attributes</span> = {}, <span class="ruby-operator">...</span>)
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">attributes</span> = {})
<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">create!</span>(<span class="ruby-identifier">attributes</span> = {})
</pre>

<h5 id="label-Additional+Column+Methods">Additional Column Methods<span><a href="#label-Additional+Column+Methods">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If the join table for a <code>has_and_belongs_to_many</code> association
has additional columns beyond the two foreign keys, these columns will be
added as attributes to records retrieved via that association. Records
returned with additional attributes will always be read-only, because Rails
cannot save changes to those attributes.</p>

<p>WARNING: The use of extra attributes on the join table in a
<code>has_and_belongs_to_many</code> association is deprecated. If you
require this sort of complex behavior on the table that joins two models in
a many-to-many relationship, you should use a <code>has_many
:through</code> association instead of
<code>has_and_belongs_to_many</code>.</p>

<h5 id="label-collection-28force_reload+-3D+false-29"><code>collection(force_reload = false)</code><span><a href="#label-collection-28force_reload+-3D+false-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection</code> method returns an array of all of the
associated objects. If there are no associated objects, it returns an empty
array.</p>

<pre class="ruby"><span class="ruby-ivar">@assemblies</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>
</pre>

<h5 id="label-collection-3C-3C-28object-2C+...-29"><code>collection&lt;&lt;(object, ...)</code><span><a href="#label-collection-3C-3C-28object-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection&lt;&lt;</code> method adds one or more objects to the
collection by creating records in the join table.</p>

<pre class="ruby"><span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@assembly1</span>
</pre>

<p>NOTE: This method is aliased as <code>collection.concat</code> and
<code>collection.push</code>.</p>

<h5 id="label-collection.delete-28object-2C+...-29"><code>collection.delete(object, ...)</code><span><a href="#label-collection.delete-28object-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.delete</code> method removes one or more objects from
the collection by deleting records in the join table. This does not destroy
the objects.</p>

<pre class="ruby"><span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-ivar">@assembly1</span>)
</pre>

<p>WARNING: This does not trigger callbacks on the join records.</p>

<h5 id="label-collection.destroy-28object-2C+...-29"><code>collection.destroy(object, ...)</code><span><a href="#label-collection.destroy-28object-2C+...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.destroy</code> method removes one or more objects from
the collection by running <code>destroy</code> on each record in the join
table, including running callbacks. This does not destroy the objects.</p>

<pre class="ruby"><span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">destroy</span>(<span class="ruby-ivar">@assembly1</span>)
</pre>

<h5 id="label-collection-3D-28objects-29"><code>collection=(objects)</code><span><a href="#label-collection-3D-28objects-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection=</code> method makes the collection contain only the
supplied objects, by adding and deleting as appropriate.</p>

<h5 id="label-collection_singular_ids"><code>collection_singular_ids</code><span><a href="#label-collection_singular_ids">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection_singular_ids</code> method returns an array of the ids
of the objects in the collection.</p>

<pre class="ruby"><span class="ruby-ivar">@assembly_ids</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assembly_ids</span>
</pre>

<h5 id="label-collection_singular_ids-3D-28ids-29"><code>collection_singular_ids=(ids)</code><span><a href="#label-collection_singular_ids-3D-28ids-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection_singular_ids=</code> method makes the collection
contain only the objects identified by the supplied primary key values, by
adding and deleting as appropriate.</p>

<h5 id="label-collection.clear"><code>collection.clear</code><span><a href="#label-collection.clear">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.clear</code> method removes every object from the
collection by deleting the rows from the joining table. This does not
destroy the associated objects.</p>

<h5 id="label-collection.empty-3F"><code>collection.empty?</code><span><a href="#label-collection.empty-3F">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.empty?</code> method returns <code>true</code> if the
collection does not contain any associated objects.</p>

<pre class="ruby"><span class="ruby-operator">&lt;</span><span class="ruby-string">%Q if </span><span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-string">%Q&lt;
  This part is not used in any assemblies
&lt;% end %&gt;
</span></pre>

<h5 id="label-collection.size"><code>collection.size</code><span><a href="#label-collection.size">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.size</code> method returns the number of objects in
the collection.</p>

<pre class="ruby"><span class="ruby-ivar">@assembly_count</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">size</span>
</pre>

<h5 id="label-collection.find-28...-29"><code>collection.find(...)</code><span><a href="#label-collection.find-28...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.find</code> method finds objects within the
collection. It uses the same syntax and options as
<code>ActiveRecord::Base.find</code>. It also adds the additional condition
that the object must be in the collection.</p>

<pre class="ruby"><span class="ruby-ivar">@assembly</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">1</span>)
</pre>

<h5 id="label-collection.where-28...-29"><code>collection.where(...)</code><span><a href="#label-collection.where-28...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.where</code> method finds objects within the
collection based on the conditions supplied but the objects are loaded
lazily meaning that the database is queried only when the object(s) are
accessed. It also adds the additional condition that the object must be in
the collection.</p>

<pre class="ruby"><span class="ruby-ivar">@new_assemblies</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;created_at &gt; ?&quot;</span>, <span class="ruby-value">2</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">ago</span>)
</pre>

<h5 id="label-collection.exists-3F-28...-29"><code>collection.exists?(...)</code><span><a href="#label-collection.exists-3F-28...-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.exists?</code> method checks whether an object meeting
the supplied conditions exists in the collection. It uses the same syntax
and options as <code>ActiveRecord::Base.exists?</code>.</p>

<h5 id="label-collection.build-28attributes+-3D+-7B-7D-29"><code>collection.build(attributes = {})</code><span><a href="#label-collection.build-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.build</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, and the link through the join table will be created, but the
associated object will <em>not</em> yet be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@assembly</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">build</span>({<span class="ruby-identifier">assembly_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Transmission housing&quot;</span>})
</pre>

<h5 id="label-collection.create-28attributes+-3D+-7B-7D-29"><code>collection.create(attributes = {})</code><span><a href="#label-collection.create-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>collection.create</code> method returns a new object of the
associated type. This object will be instantiated from the passed
attributes, the link through the join table will be created, and, once it
passes all of the validations specified on the associated model, the
associated object <em>will</em> be saved.</p>

<pre class="ruby"><span class="ruby-ivar">@assembly</span> = <span class="ruby-ivar">@part</span>.<span class="ruby-identifier">assemblies</span>.<span class="ruby-identifier">create</span>({<span class="ruby-identifier">assembly_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Transmission housing&quot;</span>})
</pre>

<h5 id="label-collection.create-21-28attributes+-3D+-7B-7D-29"><code>collection.create!(attributes = {})</code><span><a href="#label-collection.create-21-28attributes+-3D+-7B-7D-29">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Does the same as <code>collection.create</code>, but raises
<code>ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h4 id="label-Options+for+has_and_belongs_to_many">Options for <code>has_and_belongs_to_many</code><span><a href="#label-Options+for+has_and_belongs_to_many">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>While Rails uses intelligent defaults that will work well in most
situations, there may be times when you want to customize the behavior of
the <code>has_and_belongs_to_many</code> association reference. Such
customizations can easily be accomplished by passing options when you
create the association. For example, this association uses two such
options:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">readonly</span> },
                                       <span class="ruby-identifier">autosave</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>has_and_belongs_to_many</code> association supports these
options:</p>
<ul><li>
<p><code>:association_foreign_key</code></p>
</li><li>
<p><code>:autosave</code></p>
</li><li>
<p><code>:class_name</code></p>
</li><li>
<p><code>:foreign_key</code></p>
</li><li>
<p><code>:join_table</code></p>
</li><li>
<p><code>:validate</code></p>
</li></ul>

<h5 id="label-3Aassociation_foreign_key"><code>:association_foreign_key</code><span><a href="#label-3Aassociation_foreign_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column in the join table used to hold
the foreign key pointing to the other model is the name of that model with
the suffix <code>_id</code> added. The
<code>:association_foreign_key</code> option lets you set the name of the
foreign key directly:</p>

<p>TIP: The <code>:foreign_key</code> and
<code>:association_foreign_key</code> options are useful when setting up a
many-to-many self-join. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">User</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">friends</span>,
      <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;User&quot;</span>,
      <span class="ruby-identifier">foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;this_user_id&quot;</span>,
      <span class="ruby-identifier">association_foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;other_user_id&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Aautosave"><code>:autosave</code><span><a href="#label-3Aautosave">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:autosave</code> option to <code>true</code>, Rails
will save any loaded members and destroy members that are marked for
destruction whenever you save the parent object.</p>

<h5 id="label-3Aclass_name"><code>:class_name</code><span><a href="#label-3Aclass_name">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If the name of the other model cannot be derived from the association name,
you can use the <code>:class_name</code> option to supply the model name.
For example, if a part has many assemblies, but the actual name of the
model containing assemblies is <code>Gadget</code>, you&#39;d set things up
this way:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>, <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;Gadget&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Aforeign_key"><code>:foreign_key</code><span><a href="#label-3Aforeign_key">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>By convention, Rails assumes that the column in the join table used to hold
the foreign key pointing to this model is the name of this model with the
suffix <code>_id</code> added. The <code>:foreign_key</code> option lets
you set the name of the foreign key directly:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">User</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">friends</span>,
      <span class="ruby-identifier">class_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;User&quot;</span>,
      <span class="ruby-identifier">foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;this_user_id&quot;</span>,
      <span class="ruby-identifier">association_foreign_key</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;other_user_id&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-3Ajoin_table"><code>:join_table</code><span><a href="#label-3Ajoin_table">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If the default name of the join table, based on lexical ordering, is not
what you want, you can use the <code>:join_table</code> option to override
the default.</p>

<h5 id="label-3Avalidate"><code>:validate</code><span><a href="#label-3Avalidate">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you set the <code>:validate</code> option to <code>false</code>, then
associated objects will not be validated whenever you save this object. By
default, this is <code>true</code>: associated objects will be validated
when this object is saved.</p>

<h4 id="label-Scopes+for+has_and_belongs_to_many">Scopes for <code>has_and_belongs_to_many</code><span><a href="#label-Scopes+for+has_and_belongs_to_many">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>There may be times when you wish to customize the query used by
<code>has_and_belongs_to_many</code>. Such customizations can be achieved
via a scope block. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">active</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span> }
<span class="ruby-keyword">end</span>
</pre>

<p>You can use any of the standard <a
href="active_record_querying.html">querying methods</a> inside the scope
block. The following ones are discussed below:</p>
<ul><li>
<p><code>where</code></p>
</li><li>
<p><code>extending</code></p>
</li><li>
<p><code>group</code></p>
</li><li>
<p><code>includes</code></p>
</li><li>
<p><code>limit</code></p>
</li><li>
<p><code>offset</code></p>
</li><li>
<p><code>order</code></p>
</li><li>
<p><code>readonly</code></p>
</li><li>
<p><code>select</code></p>
</li><li>
<p><code>uniq</code></p>
</li></ul>

<h5 id="label-where"><code>where</code><span><a href="#label-where">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>where</code> method lets you specify the conditions that the
associated object must meet.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>,
    <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-string">&quot;factory = &#39;Seattle&#39;&quot;</span> }
<span class="ruby-keyword">end</span>
</pre>

<p>You can also set conditions via a hash:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>,
    <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">where</span> <span class="ruby-identifier">factory</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;Seattle&#39;</span> }
<span class="ruby-keyword">end</span>
</pre>

<p>If you use a hash-style <code>where</code>, then record creation via this
association will be automatically scoped using the hash. In this case,
using <code>@parts.assemblies.create</code> or
<code>@parts.assemblies.build</code> will create orders where the
<code>factory</code> column has the value “Seattle”.</p>

<h5 id="label-extending"><code>extending</code><span><a href="#label-extending">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>extending</code> method specifies a named module to extend the
association proxy. Association extensions are discussed in detail <a
href="#association-extensions">later in this guide</a>.</p>

<h5 id="label-group"><code>group</code><span><a href="#label-group">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>group</code> method supplies an attribute name to group the
result set by, using a <code>GROUP BY</code> clause in the finder SQL.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">group</span> <span class="ruby-string">&quot;factory&quot;</span> }
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-includes"><code>includes</code><span><a href="#label-includes">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>You can use the <code>includes</code> method to specify second-order
associations that should be eager-loaded when this association is used.</p>

<h5 id="label-limit"><code>limit</code><span><a href="#label-limit">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>limit</code> method lets you restrict the total number of objects
that will be fetched through an association.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>,
    <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;created_at DESC&quot;</span>).<span class="ruby-identifier">limit</span>(<span class="ruby-value">50</span>) }
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-offset"><code>offset</code><span><a href="#label-offset">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>offset</code> method lets you specify the starting offset for
fetching objects via an association. For example, if you set
<code>offset(11)</code>, it will skip the first 11 records.</p>

<h5 id="label-order"><code>order</code><span><a href="#label-order">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>order</code> method dictates the order in which associated
objects will be received (in the syntax used by an SQL <code>ORDER
BY</code> clause).</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Parts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_and_belongs_to_many</span> :<span class="ruby-identifier">assemblies</span>,
    <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">order</span> <span class="ruby-string">&quot;assembly_name ASC&quot;</span> }
<span class="ruby-keyword">end</span>
</pre>

<h5 id="label-readonly"><code>readonly</code><span><a href="#label-readonly">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>If you use the <code>readonly</code> method, then the associated objects
will be read-only when retrieved via the association.</p>

<h5 id="label-select"><code>select</code><span><a href="#label-select">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>The <code>select</code> method lets you override the SQL
<code>SELECT</code> clause that is used to retrieve data about the
associated objects. By default, Rails retrieves all columns.</p>

<h5 id="label-uniq"><code>uniq</code><span><a href="#label-uniq">&para;</a> <a href="#top">&uarr;</a></span></h5>

<p>Use the <code>uniq</code> method to remove duplicates from the collection.</p>

<h4 id="label-When+are+Objects+Saved-3F">When are Objects Saved?<span><a href="#label-When+are+Objects+Saved-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>When you assign an object to a <code>has_and_belongs_to_many</code>
association, that object is automatically saved (in order to update the
join table). If you assign multiple objects in one statement, then they are
all saved.</p>

<p>If any of these saves fails due to validation errors, then the assignment
statement returns <code>false</code> and the assignment itself is
cancelled.</p>

<p>If the parent object (the one declaring the
<code>has_and_belongs_to_many</code> association) is unsaved (that is,
<code>new_record?</code> returns <code>true</code>) then the child objects
are not saved when they are added. All unsaved members of the association
will automatically be saved when the parent is saved.</p>

<p>If you want to assign an object to a <code>has_and_belongs_to_many</code>
association without saving the object, use the
<code>collection.build</code> method.</p>

<h3 id="label-Association+Callbacks">Association Callbacks<span><a href="#label-Association+Callbacks">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Normal callbacks hook into the life cycle of Active Record objects,
allowing you to work with those objects at various points. For example, you
can use a <code>:before_save</code> callback to cause something to happen
just before an object is saved.</p>

<p>Association callbacks are similar to normal callbacks, but they are
triggered by events in the life cycle of a collection. There are four
available association callbacks:</p>
<ul><li>
<p><code>before_add</code></p>
</li><li>
<p><code>after_add</code></p>
</li><li>
<p><code>before_remove</code></p>
</li><li>
<p><code>after_remove</code></p>
</li></ul>

<p>You define association callbacks by adding options to the association
declaration. For example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-identifier">before_add</span><span class="ruby-operator">:</span> :<span class="ruby-identifier">check_credit_limit</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">check_credit_limit</span>(<span class="ruby-identifier">order</span>)
    <span class="ruby-operator">...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Rails passes the object being added or removed to the callback.</p>

<p>You can stack callbacks on a single event by passing them as an array:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>,
    <span class="ruby-identifier">before_add</span><span class="ruby-operator">:</span> [:<span class="ruby-identifier">check_credit_limit</span>, :<span class="ruby-identifier">calculate_shipping_charges</span>]

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">check_credit_limit</span>(<span class="ruby-identifier">order</span>)
    <span class="ruby-operator">...</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">calculate_shipping_charges</span>(<span class="ruby-identifier">order</span>)
    <span class="ruby-operator">...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If a <code>before_add</code> callback throws an exception, the object does
not get added to the collection. Similarly, if a <code>before_remove</code>
callback throws an exception, the object does not get removed from the
collection.</p>

<h3 id="label-Association+Extensions">Association Extensions<span><a href="#label-Association+Extensions">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You&#39;re not limited to the functionality that Rails automatically builds
into association proxy objects. You can also extend these objects through
anonymous modules, adding new finders, creators, or other methods. For
example:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier">find_by_order_prefix</span>(<span class="ruby-identifier">order_number</span>)
      <span class="ruby-identifier">find_by</span>(<span class="ruby-identifier">region_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">order_number</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>])
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>If you have an extension that should be shared by many associations, you
can use a named extension module. For example:</p>

<pre class="ruby"><span class="ruby-keyword">module</span> <span class="ruby-constant">FindRecentExtension</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">find_recent</span>
    <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;created_at &gt; ?&quot;</span>, <span class="ruby-value">5</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">ago</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Customer</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">orders</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">extending</span> <span class="ruby-constant">FindRecentExtension</span> }
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">Supplier</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">has_many</span> :<span class="ruby-identifier">deliveries</span>, <span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">extending</span> <span class="ruby-constant">FindRecentExtension</span> }
<span class="ruby-keyword">end</span>
</pre>

<p>Extensions can refer to the internals of the association proxy using these
three attributes of the <code>proxy_association</code> accessor:</p>
<ul><li>
<p><code>proxy_association.owner</code> returns the object that the
association is a part of.</p>
</li><li>
<p><code>proxy_association.reflection</code> returns the reflection object
that describes the association.</p>
</li><li>
<p><code>proxy_association.target</code> returns the associated object for
<code>belongs_to</code> or <code>has_one</code>, or the collection of
associated objects for <code>has_many</code> or
<code>has_and_belongs_to_many</code>.</p>
</li></ul>
</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

