<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module RubyParserStuff - ruby_parser-3.6.5 Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li class="calls-super" ><a href="#method-c-new">::new</a>
    
    <li ><a href="#method-i-arg_blk_pass">#arg_blk_pass</a>
    
    <li ><a href="#method-i-arg_concat">#arg_concat</a>
    
    <li ><a href="#method-i-argl">#argl</a>
    
    <li ><a href="#method-i-args">#args</a>
    
    <li ><a href="#method-i-array_to_hash">#array_to_hash</a>
    
    <li ><a href="#method-i-aryset">#aryset</a>
    
    <li ><a href="#method-i-assignable">#assignable</a>
    
    <li ><a href="#method-i-backref_assign_error">#backref_assign_error</a>
    
    <li ><a href="#method-i-block_append">#block_append</a>
    
    <li ><a href="#method-i-block_dup_check">#block_dup_check</a>
    
    <li ><a href="#method-i-block_var">#block_var</a>
    
    <li ><a href="#method-i-block_var18">#block_var18</a>
    
    <li ><a href="#method-i-call_args">#call_args</a>
    
    <li ><a href="#method-i-clean_mlhs">#clean_mlhs</a>
    
    <li ><a href="#method-i-cond">#cond</a>
    
    <li ><a href="#method-i-debug20">#debug20</a>
    
    <li ><a href="#method-i-do_parse">#do_parse</a>
    
    <li ><a href="#method-i-get_match_node">#get_match_node</a>
    
    <li ><a href="#method-i-gettable">#gettable</a>
    
    <li ><a href="#method-i-hack_encoding">#hack_encoding</a>
    
    <li ><a href="#method-i-handle_encoding">#handle_encoding</a>
    
    <li ><a href="#method-i-invert_block_call">#invert_block_call</a>
    
    <li ><a href="#method-i-inverted-3F">#inverted?</a>
    
    <li ><a href="#method-i-list_append">#list_append</a>
    
    <li ><a href="#method-i-list_prepend">#list_prepend</a>
    
    <li ><a href="#method-i-literal_concat">#literal_concat</a>
    
    <li ><a href="#method-i-logop">#logop</a>
    
    <li ><a href="#method-i-new_aref">#new_aref</a>
    
    <li ><a href="#method-i-new_body">#new_body</a>
    
    <li ><a href="#method-i-new_call">#new_call</a>
    
    <li ><a href="#method-i-new_case">#new_case</a>
    
    <li ><a href="#method-i-new_class">#new_class</a>
    
    <li ><a href="#method-i-new_compstmt">#new_compstmt</a>
    
    <li ><a href="#method-i-new_defn">#new_defn</a>
    
    <li ><a href="#method-i-new_defs">#new_defs</a>
    
    <li ><a href="#method-i-new_for">#new_for</a>
    
    <li ><a href="#method-i-new_if">#new_if</a>
    
    <li ><a href="#method-i-new_iter">#new_iter</a>
    
    <li ><a href="#method-i-new_masgn">#new_masgn</a>
    
    <li ><a href="#method-i-new_masgn_arg">#new_masgn_arg</a>
    
    <li ><a href="#method-i-new_module">#new_module</a>
    
    <li ><a href="#method-i-new_op_asgn">#new_op_asgn</a>
    
    <li ><a href="#method-i-new_regexp">#new_regexp</a>
    
    <li ><a href="#method-i-new_resbody">#new_resbody</a>
    
    <li ><a href="#method-i-new_sclass">#new_sclass</a>
    
    <li ><a href="#method-i-new_string">#new_string</a>
    
    <li ><a href="#method-i-new_super">#new_super</a>
    
    <li ><a href="#method-i-new_undef">#new_undef</a>
    
    <li ><a href="#method-i-new_until">#new_until</a>
    
    <li ><a href="#method-i-new_until_or_while">#new_until_or_while</a>
    
    <li ><a href="#method-i-new_when">#new_when</a>
    
    <li ><a href="#method-i-new_while">#new_while</a>
    
    <li ><a href="#method-i-new_xstring">#new_xstring</a>
    
    <li ><a href="#method-i-new_yield">#new_yield</a>
    
    <li ><a href="#method-i-next_token">#next_token</a>
    
    <li ><a href="#method-i-node_assign">#node_assign</a>
    
    <li class="calls-super" ><a href="#method-i-on_error">#on_error</a>
    
    <li ><a href="#method-i-process">#process</a>
    
    <li ><a href="#method-i-remove_begin">#remove_begin</a>
    
    <li ><a href="#method-i-reset">#reset</a>
    
    <li ><a href="#method-i-ret_args">#ret_args</a>
    
    <li ><a href="#method-i-s">#s</a>
    
    <li ><a href="#method-i-syntax_error">#syntax_error</a>
    
    <li ><a href="#method-i-value_expr">#value_expr</a>
    
    <li ><a href="#method-i-void_stmts">#void_stmts</a>
    
    <li ><a href="#method-i-warning">#warning</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-RubyParserStuff">
  <h1 id="module-RubyParserStuff" class="module">
    module RubyParserStuff
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="ENCODING_ORDER">ENCODING_ORDER
        
        <dd><p>Rhis is in sorted order of occurrence according to charlock_holmes against
500k files, with UTF_8 forced to the top.</p>

<p>Overwrite this contstant if you need something different.</p>
        
      
        <dt id="VERSION">VERSION
        
        <dd>
        
      
      </dl>
    </section>
    

    
    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      
      <div id="attribute-i-canonicalize_conditions" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">canonicalize_conditions</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Canonicalize conditionals. Eg:</p>

<pre class="ruby"><span class="ruby-keyword">not</span> <span class="ruby-identifier">x</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">b</span>
</pre>

<p>becomes:</p>

<pre class="ruby"><span class="ruby-identifier">x</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">b</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">a</span>
</pre>
        
        </div>
      </div>
      
      <div id="attribute-i-comments" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">comments</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-env" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">env</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-file" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">file</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-in_def" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">in_def</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-in_single" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">in_single</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-lexer" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">lexer</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section>
    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(options = {})</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 405</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">super</span>()

  <span class="ruby-identifier">v</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>[<span class="ruby-regexp">/1[89]|2[01]/</span>]

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span> = <span class="ruby-constant">RubyLexer</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">parser</span> = <span class="ruby-keyword">self</span>

  <span class="ruby-ivar">@env</span> = <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">Environment</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@comments</span> = []

  <span class="ruby-ivar">@canonicalize_conditions</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reset</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-arg_blk_pass" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">arg_blk_pass</span><span
            class="method-args">(node1, node2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="arg_blk_pass-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">arg_blk_pass</span> <span class="ruby-identifier">node1</span>, <span class="ruby-identifier">node2</span> <span class="ruby-comment"># TODO: nuke</span>
  <span class="ruby-identifier">node1</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">node1</span>) <span class="ruby-keyword">unless</span> [<span class="ruby-value">:arglist</span>, <span class="ruby-value">:call_args</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:args</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">node1</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">node1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node2</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node2</span>
  <span class="ruby-identifier">node1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-arg_concat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">arg_concat</span><span
            class="method-args">(node1, node2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="arg_concat-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">arg_concat</span> <span class="ruby-identifier">node1</span>, <span class="ruby-identifier">node2</span> <span class="ruby-comment"># TODO: nuke</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;huh&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node2</span>
  <span class="ruby-identifier">node1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:splat</span>, <span class="ruby-identifier">node2</span>).<span class="ruby-identifier">compact</span>
  <span class="ruby-identifier">node1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-argl" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">argl</span><span
            class="method-args">(x)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="argl-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 540</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">argl</span> <span class="ruby-identifier">x</span>
  <span class="ruby-identifier">x</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">x</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">x</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">x</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
  <span class="ruby-identifier">x</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">args</span><span
            class="method-args">(args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="args-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 219</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">args</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>)

  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Sexp</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">sexp_type</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:args</span>, <span class="ruby-value">:block</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:call_args</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK call_args mismatch</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">arg</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
      <span class="ruby-keyword">when</span> <span class="ruby-value">:block_arg</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:&quot;&amp;#{arg.last}&quot;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:shadow</span> <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">sexp_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:shadow</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">result</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">last</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:masgn</span>, <span class="ruby-value">:block_pass</span>, <span class="ruby-value">:hash</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK: remove. prolly call_args</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unhandled: #{arg.sexp_type} in #{args.inspect}&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Symbol</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">name</span> = <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;&amp;*&quot;</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-value">:lvar</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;,&quot;</span>, <span class="ruby-string">&quot;|&quot;</span>, <span class="ruby-string">&quot;;&quot;</span>, <span class="ruby-string">&quot;(&quot;</span>, <span class="ruby-string">&quot;)&quot;</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
      <span class="ruby-comment"># ignore</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unhandled: #{arg.inspect} in #{args.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-array_to_hash" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">array_to_hash</span><span
            class="method-args">(array)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="array_to_hash-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 186</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">array_to_hash</span> <span class="ruby-identifier">array</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">array</span>.<span class="ruby-identifier">sexp_type</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:kwsplat</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">array</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:hash</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">array</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-aryset" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">aryset</span><span
            class="method-args">(receiver, index)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="aryset-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 255</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">aryset</span> <span class="ruby-identifier">receiver</span>, <span class="ruby-identifier">index</span>
  <span class="ruby-identifier">index</span> <span class="ruby-operator">||=</span> []
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:attrasgn</span>, <span class="ruby-identifier">receiver</span>, <span class="ruby-value">:&quot;[]=&quot;</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">index</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]).<span class="ruby-identifier">compact</span> <span class="ruby-comment"># [][1..-1] =&gt; nil</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-assignable" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">assignable</span><span
            class="method-args">(lhs, value = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="assignable-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 260</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">assignable</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">value</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">id</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lhs</span>
  <span class="ruby-identifier">id</span> = <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">id</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(?:self|nil|true|false|__LINE__|__FILE__)$/</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-node">&quot;Can&#39;t change the value of #{id}&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(?:self|nil|true|false|__LINE__|__FILE__)$/</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">asgn</span> = <span class="ruby-identifier">in_def</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">in_single</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
             <span class="ruby-identifier">s</span>((<span class="ruby-identifier">asgn</span> <span class="ruby-operator">?</span> <span class="ruby-value">:cvasgn</span> <span class="ruby-operator">:</span> <span class="ruby-value">:cvdecl</span>), <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:iasgn</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^\$/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:gasgn</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[A-Z]/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:cdecl</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-keyword">case</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>]
             <span class="ruby-keyword">when</span> <span class="ruby-value">:lvar</span>, <span class="ruby-value">:dvar</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-value">:lasgn</span>, <span class="ruby-identifier">id</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;wtf? unknown type: #{self.env[id]}&quot;</span>
             <span class="ruby-keyword">end</span>
           <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:lvar</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">sexp_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:lasgn</span>

  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-backref_assign_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">backref_assign_error</span><span
            class="method-args">(ref)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="backref_assign_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 545</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">backref_assign_error</span> <span class="ruby-identifier">ref</span>
  <span class="ruby-comment"># TODO: need a test for this... obviously</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:nth_ref</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 2&quot;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can&#39;t set variable %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:back_ref</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 3&quot;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can&#39;t set back reference %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown backref type: #{ref.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-block_append" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_append</span><span
            class="method-args">(head, tail)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="block_append-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 295</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">head</span>, <span class="ruby-identifier">tail</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">tail</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">head</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>

  <span class="ruby-identifier">head</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">head</span>)
  <span class="ruby-identifier">head</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:block</span>, <span class="ruby-identifier">head</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span>

  <span class="ruby-identifier">head</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">head</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-block_dup_check" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_dup_check</span><span
            class="method-args">(call_or_args, block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="block_dup_check-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1058</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_dup_check</span> <span class="ruby-identifier">call_or_args</span>, <span class="ruby-identifier">block</span>
  <span class="ruby-identifier">syntax_error</span> <span class="ruby-string">&quot;Both block arg and actual block given.&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">block</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">call_or_args</span>.<span class="ruby-identifier">block_pass?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-block_var" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_var</span><span
            class="method-args">(*args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="block_var-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_var</span> <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">args</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:masgn</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-block_var18" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_var18</span><span
            class="method-args">(ary, splat, block)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="block_var18-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_var18</span> <span class="ruby-identifier">ary</span>, <span class="ruby-identifier">splat</span>, <span class="ruby-identifier">block</span>
  <span class="ruby-identifier">ary</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">splat</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">splat</span> = <span class="ruby-identifier">splat</span>[<span class="ruby-value">1</span>] <span class="ruby-keyword">unless</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">splat</span>
    <span class="ruby-identifier">ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;*#{splat}&quot;</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&amp;#{block[1]}&quot;</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">splat</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:masgn</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">ary</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-call_args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">call_args</span><span
            class="method-args">(args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="call_args-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 195</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">call_args</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:call_args</span>)

  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Sexp</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">sexp_type</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:array</span>, <span class="ruby-value">:args</span>, <span class="ruby-value">:call_args</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK? remove array at some point</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">arg</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Symbol</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;,&quot;</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
      <span class="ruby-comment"># ignore</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unhandled: #{arg.inspect} in #{args.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-clean_mlhs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clean_mlhs</span><span
            class="method-args">(sexp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="clean_mlhs-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clean_mlhs</span> <span class="ruby-identifier">sexp</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">sexp_type</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:masgn</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">sexp</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">sexp_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:masgn</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">sexp</span>[<span class="ruby-value">1</span>][<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sub</span><span class="ruby-operator">|</span> <span class="ruby-identifier">clean_mlhs</span> <span class="ruby-identifier">sub</span> })
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">debug20</span> <span class="ruby-value">5</span>
      <span class="ruby-identifier">sexp</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:gasgn</span>, <span class="ruby-value">:iasgn</span>, <span class="ruby-value">:lasgn</span>, <span class="ruby-value">:cvasgn</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">debug20</span> <span class="ruby-value">7</span>
      <span class="ruby-identifier">sexp</span> <span class="ruby-comment"># optional value</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unsupported type: #{sexp.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cond" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cond</span><span
            class="method-args">(node)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cond-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 308</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cond</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">node</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">node</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:lit</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">Regexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match</span>, <span class="ruby-identifier">node</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:and</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:and</span>, <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>]), <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]))
  <span class="ruby-keyword">when</span> <span class="ruby-value">:or</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:or</span>,  <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>]), <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]))
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dot2</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">label</span> = <span class="ruby-node">&quot;flip#{node.hash}&quot;</span>
    <span class="ruby-identifier">env</span>[<span class="ruby-identifier">label</span>] = <span class="ruby-value">:lvar</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:flip2</span>, <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>])
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dot3</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">label</span> = <span class="ruby-node">&quot;flip#{node.hash}&quot;</span>
    <span class="ruby-identifier">env</span>[<span class="ruby-identifier">label</span>] = <span class="ruby-value">:lvar</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:flip3</span>, <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-debug20" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">debug20</span><span
            class="method-args">(n, v = nil, r = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="debug20-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 105</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">debug20</span> <span class="ruby-identifier">n</span>, <span class="ruby-identifier">v</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">r</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;not yet #{n} #{v.inspect} =&gt; #{r.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">$good20</span>[<span class="ruby-identifier">n</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-do_parse" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">do_parse</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>for pure ruby systems only</p>
          
          

          
          <div class="method-source-code" id="do_parse-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 339</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">do_parse</span>
  <span class="ruby-identifier">_racc_do_parse_rb</span>(<span class="ruby-identifier">_racc_setup</span>, <span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_match_node" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_match_node</span><span
            class="method-args">(lhs, rhs)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_match_node-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 343</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_match_node</span> <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span> <span class="ruby-comment"># TODO: rename to new_match</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">lhs</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dregx</span>, <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match2</span>, <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">:lit</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match2</span>, <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Regexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">rhs</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">rhs</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dregx</span>, <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match3</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">lhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">:lit</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match3</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">lhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Regexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">rhs</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_call</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-value">:&quot;=~&quot;</span>, <span class="ruby-identifier">argl</span>(<span class="ruby-identifier">rhs</span>)).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-gettable" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">gettable</span><span
            class="method-args">(id)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="gettable-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 365</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">id</span>)
  <span class="ruby-identifier">lineno</span> = <span class="ruby-identifier">id</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:lineno</span>
  <span class="ruby-identifier">id</span> = <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">id</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:cvar</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:ivar</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^\$/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:gvar</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[A-Z]/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:const</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-identifier">type</span> = <span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>]
             <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">id</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-identifier">new_call</span>(<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">id</span>)
             <span class="ruby-keyword">end</span>
           <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-identifier">lineno</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lineno</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;identifier #{id.inspect} is not valid&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-hack_encoding" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hack_encoding</span><span
            class="method-args">(str, extra = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="hack_encoding-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 994</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">extra</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">encodings</span> = <span class="ruby-constant">ENCODING_ORDER</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">extra</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-comment"># terrible, horrible, no good, very bad, last ditch effort.</span>
  <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">enc</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-identifier">enc</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encode!</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UTF_8</span>
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidByteSequenceError</span>
      <span class="ruby-comment"># do nothing</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UndefinedConversionError</span>
      <span class="ruby-comment"># do nothing</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># no amount of pain is enough for you.</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Bad encoding. Need a magic encoding comment.&quot;</span> <span class="ruby-keyword">unless</span>
    <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;UTF-8&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-handle_encoding" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">handle_encoding</span><span
            class="method-args">(str)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Returns a UTF-8 encoded string after processing BOMs and magic encoding
comments.</p>

<p>Holy crap… ok. Here goes:</p>

<p>Ruby&#39;s file handling and encoding support is insane. We need to be able
to lex a file. The lexer file is explicitly UTF-8 to make things cleaner.
This allows us to deal with extended chars in class and method names. In
order to do this, we need to encode all input source files as UTF-8. First,
we look for a UTF-8 BOM by looking at the first line while forcing its
encoding to ASCII-8BIT. If we find a BOM, we strip it and set the expected
encoding to UTF-8. Then, we search for a magic encoding comment. If found,
it overrides the BOM. Finally, we force the encoding of the input string to
whatever was found, and then encode that to UTF-8 for compatibility with
the lexer.</p>
          
          

          
          <div class="method-source-code" id="handle_encoding-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 963</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>
  <span class="ruby-identifier">str</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-identifier">ruby19</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:encoding</span>
  <span class="ruby-identifier">encoding</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">header</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">lines</span>.<span class="ruby-identifier">first</span>(<span class="ruby-value">2</span>)
  <span class="ruby-identifier">header</span>.<span class="ruby-identifier">map!</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-string">&quot;ASCII-8BIT&quot;</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>

  <span class="ruby-identifier">first</span> = <span class="ruby-identifier">header</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">encoding</span>, <span class="ruby-identifier">str</span> = <span class="ruby-string">&quot;utf-8&quot;</span>, <span class="ruby-identifier">str</span>[<span class="ruby-value">3</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">first</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\A\xEF\xBB\xBF/</span>

  <span class="ruby-identifier">encoding</span> = <span class="ruby-node">$1</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">header</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*?-\*-.*?coding:\s*([^ ;]+).*?-\*-/</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">||</span>
    <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*(?:en)?coding(?:\s*[:=])\s*([\w-]+)/</span>, <span class="ruby-value">1</span>]
  }

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoding</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/utf-8-.+$/</span>, <span class="ruby-string">&#39;utf-8&#39;</span>) <span class="ruby-comment"># HACK for stupid emacs formats</span>
      <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">encoding</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;Skipping magic encoding comment&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># nothing specified... ugh. try to encode as utf-8</span>
    <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">str</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-invert_block_call" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">invert_block_call</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="invert_block_call-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1067</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">invert_block_call</span> <span class="ruby-identifier">val</span>
  (<span class="ruby-identifier">type</span>, <span class="ruby-identifier">call</span>), <span class="ruby-identifier">iter</span> = <span class="ruby-identifier">val</span>

  <span class="ruby-identifier">iter</span>.<span class="ruby-identifier">insert</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">call</span>

  [<span class="ruby-identifier">iter</span>, <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>)]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-inverted-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">inverted?</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="inverted-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1063</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">inverted?</span> <span class="ruby-identifier">val</span>
  [<span class="ruby-value">:return</span>, <span class="ruby-value">:next</span>, <span class="ruby-value">:break</span>, <span class="ruby-value">:yield</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">sexp_type</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-list_append" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">list_append</span><span
            class="method-args">(list, item)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="list_append-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 421</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">list_append</span> <span class="ruby-identifier">list</span>, <span class="ruby-identifier">item</span> <span class="ruby-comment"># TODO: nuke me *sigh*</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">item</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">list</span>
  <span class="ruby-identifier">list</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">list</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">list</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">list</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
  <span class="ruby-identifier">list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">item</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-list_prepend" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">list_prepend</span><span
            class="method-args">(item, list)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="list_prepend-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 427</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">list_prepend</span> <span class="ruby-identifier">item</span>, <span class="ruby-identifier">list</span> <span class="ruby-comment"># TODO: nuke me *sigh*</span>
  <span class="ruby-identifier">list</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">list</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">list</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">list</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
  <span class="ruby-identifier">list</span>.<span class="ruby-identifier">insert</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">item</span>
  <span class="ruby-identifier">list</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-literal_concat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">literal_concat</span><span
            class="method-args">(head, tail)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="literal_concat-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 433</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">literal_concat</span> <span class="ruby-identifier">head</span>, <span class="ruby-identifier">tail</span> <span class="ruby-comment"># TODO: ugh. rewrite</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">tail</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">head</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tail</span>

  <span class="ruby-identifier">htype</span>, <span class="ruby-identifier">ttype</span> = <span class="ruby-identifier">head</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">tail</span>[<span class="ruby-value">0</span>]

  <span class="ruby-identifier">head</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dstr</span>, <span class="ruby-string">&#39;&#39;</span>, <span class="ruby-identifier">head</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:evstr</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">ttype</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:str</span>
      <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">head</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">lineno</span> = <span class="ruby-identifier">head</span>.<span class="ruby-identifier">line</span>
      <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>]
      <span class="ruby-identifier">head</span> = <span class="ruby-identifier">tail</span>
      <span class="ruby-identifier">head</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">lineno</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">tail</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:array</span>
      <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>])
      <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-string">&#39;&#39;</span>)

      <span class="ruby-identifier">head</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:evstr</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">head</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dstr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:str</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>][<span class="ruby-value">-1</span>]
      <span class="ruby-identifier">head</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:str</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment"># HACK ?</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">head</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">tail</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">x</span> = [<span class="ruby-identifier">head</span>, <span class="ruby-identifier">tail</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown type: #{x.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-logop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">logop</span><span
            class="method-args">(type, left, right)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="logop-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 479</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">logop</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">left</span>, <span class="ruby-identifier">right</span>) <span class="ruby-comment"># TODO: rename logical_op</span>
    <span class="ruby-identifier">left</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">left</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">left</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">left</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">type</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">left</span>.<span class="ruby-identifier">paren</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span>, <span class="ruby-identifier">second</span> = <span class="ruby-identifier">left</span>, <span class="ruby-keyword">nil</span>

      <span class="ruby-keyword">while</span> (<span class="ruby-identifier">second</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">second</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">type</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">second</span>.<span class="ruby-identifier">paren</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">node</span> = <span class="ruby-identifier">second</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">second</span>, <span class="ruby-identifier">right</span>)

      <span class="ruby-keyword">return</span> <span class="ruby-identifier">left</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">left</span>, <span class="ruby-identifier">right</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_aref</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
    <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-comment"># REFACTOR</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:self</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_body</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">body</span>, <span class="ruby-identifier">resbody</span>, <span class="ruby-identifier">elsebody</span>, <span class="ruby-identifier">ensurebody</span> = <span class="ruby-identifier">val</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">body</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:rescue</span>)
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

      <span class="ruby-identifier">res</span> = <span class="ruby-identifier">resbody</span>

      <span class="ruby-keyword">while</span> <span class="ruby-identifier">res</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">res</span>
        <span class="ruby-identifier">res</span> = <span class="ruby-identifier">res</span>.<span class="ruby-identifier">resbody</span>(<span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span>

      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = (<span class="ruby-identifier">body</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">resbody</span>).<span class="ruby-identifier">line</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;else without rescue is useless&quot;</span>)
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:begin</span>, <span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">result</span>, <span class="ruby-identifier">elsebody</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:ensure</span>, <span class="ruby-identifier">result</span>, <span class="ruby-identifier">ensurebody</span>).<span class="ruby-identifier">compact</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ensurebody</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">argl</span> <span class="ruby-identifier">x</span>
    <span class="ruby-identifier">x</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">x</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">x</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">x</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
    <span class="ruby-identifier">x</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">backref_assign_error</span> <span class="ruby-identifier">ref</span>
    <span class="ruby-comment"># TODO: need a test for this... obviously</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:nth_ref</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 2&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can&#39;t set variable %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:back_ref</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 3&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can&#39;t set back reference %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown backref type: #{ref.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>, <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:call</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>)

    <span class="ruby-comment"># TODO: need a test with f(&amp;b) to produce block_pass</span>
    <span class="ruby-comment"># TODO: need a test with f(&amp;b) { } to produce warning</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span>
      <span class="ruby-keyword">if</span> [<span class="ruby-value">:arglist</span>, <span class="ruby-value">:args</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:call_args</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">sexp_body</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">args</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">line</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:line</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">line</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_case</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">body</span>, <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:case</span>, <span class="ruby-identifier">expr</span>)

    <span class="ruby-keyword">while</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:when</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>
      <span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">3</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">block</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">block</span>(<span class="ruby-value">:delete</span>)
      <span class="ruby-identifier">node</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># else</span>
    <span class="ruby-identifier">body</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:block</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_class</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">5</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:class</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_compstmt</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">void_stmts</span>(<span class="ruby-identifier">val</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>)[<span class="ruby-value">0</span>])
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defn</span> <span class="ruby-identifier">val</span>
    (<span class="ruby-identifier">_</span>, <span class="ruby-identifier">line</span>), <span class="ruby-identifier">name</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>, <span class="ruby-operator">*</span> = <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:nil</span>)

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defn</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">args</span>.<span class="ruby-identifier">line</span> <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defs</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defs</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">recv</span>.<span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_for</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:for</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">var</span>.<span class="ruby-identifier">line</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_if</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>
    <span class="ruby-identifier">l</span> = [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">f</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">c</span>
    <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">f</span>, <span class="ruby-identifier">t</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:if</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">l</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_iter</span> <span class="ruby-identifier">call</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">nil</span>

    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>)
    <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">args</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:iter</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">call</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">args</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

    <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:args</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_masgn_arg</span> <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">wrap</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">rhs</span>)
    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:to_ary</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">wrap</span> <span class="ruby-comment"># HACK: could be array if lhs isn&#39;t right</span>
    <span class="ruby-identifier">rhs</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_masgn</span> <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">wrap</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">rhs</span>)
    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:to_ary</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">wrap</span>

    <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>

    <span class="ruby-identifier">lhs</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_module</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:module</span>, <span class="ruby-identifier">path</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># REFACTOR?</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_op_asgn</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-identifier">name</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">value</span>
    <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">arg</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">asgn_op</span> <span class="ruby-comment"># REFACTOR</span>
             <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;||&quot;</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_or</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
             <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;&amp;&amp;&quot;</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_and</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-comment"># TODO: why [2] ?</span>
               <span class="ruby-identifier">lhs</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">new_call</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">argl</span>(<span class="ruby-identifier">arg</span>))
               <span class="ruby-identifier">lhs</span>
             <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_regexp</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-string">&#39;&#39;</span>)
    <span class="ruby-identifier">options</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]

    <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span> = <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">options</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-comment"># FIX: this has a better home</span>
      <span class="ruby-identifier">v</span> = {
        <span class="ruby-string">&#39;x&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">EXTENDED</span>,
        <span class="ruby-string">&#39;i&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">IGNORECASE</span>,
        <span class="ruby-string">&#39;m&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">MULTILINE</span>,
        <span class="ruby-string">&#39;o&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ONCE</span>,
        <span class="ruby-string">&#39;n&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>,
        <span class="ruby-string">&#39;e&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_EUC</span>,
        <span class="ruby-string">&#39;s&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_SJIS</span>,
        <span class="ruby-string">&#39;u&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_UTF8</span>,
      }[<span class="ruby-identifier">c</span>]
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown regexp option: #{c}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>
      <span class="ruby-identifier">o</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">v</span>

      <span class="ruby-comment"># encoding options are ignored on 1.9+</span>
      <span class="ruby-identifier">k</span> = <span class="ruby-identifier">c</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[esu]/</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">RUBY_VERSION</span> <span class="ruby-operator">&lt;</span> <span class="ruby-string">&quot;1.9&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:lit</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">then</span>
                  <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span>)
                <span class="ruby-keyword">else</span>
                  <span class="ruby-keyword">begin</span>
                    <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>)
                  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RegexpError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;WA\RNING: #{e.message} for #{node[1].inspect} #{options.inspect}&quot;</span>
                    <span class="ruby-keyword">begin</span>
                      <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;WA\RNING: trying to recover with ENC_UTF8&quot;</span>
                      <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_UTF8</span>)
                    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RegexpError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                      <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;WA\RNING: trying to recover with ENC_NONE&quot;</span>
                      <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>)
                    <span class="ruby-keyword">end</span>
                  <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dregx</span>, <span class="ruby-string">&#39;&#39;</span>, <span class="ruby-identifier">node</span>);
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span>
      <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_resbody</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">body</span>.<span class="ruby-identifier">shift</span> <span class="ruby-comment"># remove block and splat it in directly</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">body</span> = [<span class="ruby-identifier">body</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:resbody</span>, <span class="ruby-identifier">cond</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">body</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_sclass</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">in_def</span>, <span class="ruby-identifier">in_single</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:sclass</span>, <span class="ruby-identifier">recv</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-identifier">in_def</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-identifier">in_single</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_string</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">str</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-string">&quot;ASCII-8BIT&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">RUBY_VERSION</span> <span class="ruby-operator">&lt;</span> <span class="ruby-string">&quot;1.9&quot;</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-identifier">str</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">count</span>(<span class="ruby-string">&quot;\n&quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">extra_lineno</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">extra_lineno</span> = <span class="ruby-value">0</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_super</span> <span class="ruby-identifier">args</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, <span class="ruby-identifier">args</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_undef</span> <span class="ruby-identifier">n</span>, <span class="ruby-identifier">m</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">m</span>))
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">n</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
    <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:until</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
    <span class="ruby-identifier">other</span> = <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:until</span> <span class="ruby-operator">?</span> <span class="ruby-value">:while</span> <span class="ruby-operator">:</span> <span class="ruby-value">:until</span>
    <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">last</span>, <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:begin</span>

    <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">expr</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">unless</span> <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>,  <span class="ruby-identifier">expr</span>,      <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-identifier">other</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
             <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_when</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:when</span>, <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_while</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
    <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:while</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_xstring</span> <span class="ruby-identifier">str</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>]
      <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span>
        <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:xstr</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span>
        <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dxstr</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">str</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dxstr</span>, <span class="ruby-string">&#39;&#39;</span>, <span class="ruby-identifier">str</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">str</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:xstr</span>, <span class="ruby-string">&#39;&#39;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_yield</span> <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-comment"># TODO: raise args.inspect unless [:arglist].include? args.first # HACK</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 4&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Block argument should not be given.&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)

    <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:call_args</span>, <span class="ruby-value">:array</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>])
    <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:yield</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">next_token</span>
    <span class="ruby-identifier">token</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">next_token</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">token</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">token</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">token</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">return</span> [<span class="ruby-keyword">false</span>, <span class="ruby-string">&#39;$end&#39;</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">node_assign</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-comment"># TODO: rename new_assign</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lhs</span>

    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">rhs</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:lasgn</span>, <span class="ruby-value">:iasgn</span>, <span class="ruby-value">:cdecl</span>, <span class="ruby-value">:cvdecl</span>, <span class="ruby-value">:gasgn</span>, <span class="ruby-value">:cvasgn</span>, <span class="ruby-value">:attrasgn</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:const</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:cdecl</span>
      <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown lhs #{lhs.inspect} w/ #{rhs.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">lhs</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">##</span>
  <span class="ruby-comment"># Returns a UTF-8 encoded string after processing BOMs and magic</span>
  <span class="ruby-comment"># encoding comments.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Holy crap... ok. Here goes:</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Ruby&#39;s file handling and encoding support is insane. We need to be</span>
  <span class="ruby-comment"># able to lex a file. The lexer file is explicitly UTF-8 to make</span>
  <span class="ruby-comment"># things cleaner. This allows us to deal with extended chars in</span>
  <span class="ruby-comment"># class and method names. In order to do this, we need to encode all</span>
  <span class="ruby-comment"># input source files as UTF-8. First, we look for a UTF-8 BOM by</span>
  <span class="ruby-comment"># looking at the first line while forcing its encoding to</span>
  <span class="ruby-comment"># ASCII-8BIT. If we find a BOM, we strip it and set the expected</span>
  <span class="ruby-comment"># encoding to UTF-8. Then, we search for a magic encoding comment.</span>
  <span class="ruby-comment"># If found, it overrides the BOM. Finally, we force the encoding of</span>
  <span class="ruby-comment"># the input string to whatever was found, and then encode that to</span>
  <span class="ruby-comment"># UTF-8 for compatibility with the lexer.</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>
    <span class="ruby-identifier">str</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-identifier">ruby19</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:encoding</span>
    <span class="ruby-identifier">encoding</span> = <span class="ruby-keyword">nil</span>

    <span class="ruby-identifier">header</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">lines</span>.<span class="ruby-identifier">first</span>(<span class="ruby-value">2</span>)
    <span class="ruby-identifier">header</span>.<span class="ruby-identifier">map!</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-string">&quot;ASCII-8BIT&quot;</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>

    <span class="ruby-identifier">first</span> = <span class="ruby-identifier">header</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>
    <span class="ruby-identifier">encoding</span>, <span class="ruby-identifier">str</span> = <span class="ruby-string">&quot;utf-8&quot;</span>, <span class="ruby-identifier">str</span>[<span class="ruby-value">3</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">first</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\A\xEF\xBB\xBF/</span>

    <span class="ruby-identifier">encoding</span> = <span class="ruby-node">$1</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">header</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*?-\*-.*?coding:\s*([^ ;]+).*?-\*-/</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">||</span>
      <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*(?:en)?coding(?:\s*[:=])\s*([\w-]+)/</span>, <span class="ruby-value">1</span>]
    }

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoding</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/utf-8-.+$/</span>, <span class="ruby-string">&#39;utf-8&#39;</span>) <span class="ruby-comment"># HACK for stupid emacs formats</span>
        <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">encoding</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;Skipping magic encoding comment&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># nothing specified... ugh. try to encode as utf-8</span>
      <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">str</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">extra</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">encodings</span> = <span class="ruby-constant">ENCODING_ORDER</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">extra</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-comment"># terrible, horrible, no good, very bad, last ditch effort.</span>
    <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">enc</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-identifier">enc</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encode!</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UTF_8</span>
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidByteSequenceError</span>
        <span class="ruby-comment"># do nothing</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UndefinedConversionError</span>
        <span class="ruby-comment"># do nothing</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># no amount of pain is enough for you.</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Bad encoding. Need a magic encoding comment.&quot;</span> <span class="ruby-keyword">unless</span>
      <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;UTF-8&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">##</span>
  <span class="ruby-comment"># Parse +str+ at path +file+ and return a sexp. Raises</span>
  <span class="ruby-comment"># Timeout::Error if it runs for more than +time+ seconds.</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">str</span>, <span class="ruby-identifier">file</span> = <span class="ruby-string">&quot;(string)&quot;</span>, <span class="ruby-identifier">time</span> = <span class="ruby-value">10</span>)
    <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span> <span class="ruby-identifier">time</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad val: #{str.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">str</span>

      <span class="ruby-identifier">str</span> = <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>

      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">dup</span>

      <span class="ruby-ivar">@yydebug</span> = <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-string">&#39;DEBUG&#39;</span>

      <span class="ruby-comment"># HACK -- need to get tests passing more than have graceful code</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">ss</span> = <span class="ruby-constant">RPStringScanner</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">str</span>

      <span class="ruby-identifier">do_parse</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">alias</span> <span class="ruby-value">:parse</span> <span class="ruby-operator">:</span><span class="ruby-identifier">process</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">node</span>
    <span class="ruby-identifier">oldnode</span> = <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-value">:begin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">-1</span>]
      <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
    <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">reset</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">reset</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">clear</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">block_dup_check</span> <span class="ruby-identifier">call_or_args</span>, <span class="ruby-identifier">block</span>
    <span class="ruby-identifier">syntax_error</span> <span class="ruby-string">&quot;Both block arg and actual block given.&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">block</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">call_or_args</span>.<span class="ruby-identifier">block_pass?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">inverted?</span> <span class="ruby-identifier">val</span>
    [<span class="ruby-value">:return</span>, <span class="ruby-value">:next</span>, <span class="ruby-value">:break</span>, <span class="ruby-value">:yield</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">sexp_type</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">invert_block_call</span> <span class="ruby-identifier">val</span>
    (<span class="ruby-identifier">type</span>, <span class="ruby-identifier">call</span>), <span class="ruby-identifier">iter</span> = <span class="ruby-identifier">val</span>

    <span class="ruby-identifier">iter</span>.<span class="ruby-identifier">insert</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">call</span>

    [<span class="ruby-identifier">iter</span>, <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>)]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">ret_args</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 5&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

      <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;block argument should not be given&quot;</span> <span class="ruby-keyword">if</span>
        <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:array</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:call_args</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>

      <span class="ruby-comment"># HACK matz wraps ONE of the FOUR splats in a newline to</span>
      <span class="ruby-comment"># distinguish. I use paren for now. ugh</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:svalue</span>, <span class="ruby-identifier">node</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">paren</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:svalue</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">s</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-constant">Sexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">ss</span>          <span class="ruby-comment"># otherwise...</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">file</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">oldnode</span> <span class="ruby-comment"># HACK</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">oldnode</span>
    <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">oldnode</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:if</span>
    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">void_stmts</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block</span>

    <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] = <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">n</span>) }
    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">warning</span> <span class="ruby-identifier">s</span>
    <span class="ruby-comment"># do nothing for now</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">alias</span> <span class="ruby-identifier">yyerror</span> <span class="ruby-identifier">syntax_error</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">on_error</span>(<span class="ruby-identifier">et</span>, <span class="ruby-identifier">ev</span>, <span class="ruby-identifier">values</span>)
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Racc</span><span class="ruby-operator">::</span><span class="ruby-constant">ParseError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-comment"># I don&#39;t like how the exception obscures the error message</span>
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">replace</span> <span class="ruby-string">&quot;%s:%p :: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>, <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">strip</span>]
    <span class="ruby-identifier">warn</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">$DEBUG</span>
    <span class="ruby-identifier">raise</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">class</span> <span class="ruby-constant">Keyword</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">KWtable</span>
      <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value">:name</span>, <span class="ruby-value">:state</span>, <span class="ruby-value">:id0</span>, <span class="ruby-value">:id1</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">id</span>=[], <span class="ruby-identifier">state</span>=<span class="ruby-keyword">nil</span>)
        <span class="ruby-ivar">@name</span>  = <span class="ruby-identifier">name</span>
        <span class="ruby-ivar">@id0</span>, <span class="ruby-ivar">@id1</span> = <span class="ruby-identifier">id</span>
        <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">state</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">##</span>
    <span class="ruby-comment"># :stopdoc:</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># :expr_beg    = ignore newline, +/- is a sign.</span>
    <span class="ruby-comment"># :expr_end    = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_arg    = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_cmdarg = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_endarg = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_mid    = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_fname  = ignore newline, no reserved words.</span>
    <span class="ruby-comment"># :expr_dot    = right after . or ::, no reserved words.</span>
    <span class="ruby-comment"># :expr_class  = immediate after class, no here document.</span>

    <span class="ruby-identifier">wordlist</span> = [
                [<span class="ruby-string">&quot;end&quot;</span>,      [<span class="ruby-value">:kEND</span>,      <span class="ruby-value">:kEND</span>        ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;else&quot;</span>,     [<span class="ruby-value">:kELSE</span>,     <span class="ruby-value">:kELSE</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;case&quot;</span>,     [<span class="ruby-value">:kCASE</span>,     <span class="ruby-value">:kCASE</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;ensure&quot;</span>,   [<span class="ruby-value">:kENSURE</span>,   <span class="ruby-value">:kENSURE</span>     ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;module&quot;</span>,   [<span class="ruby-value">:kMODULE</span>,   <span class="ruby-value">:kMODULE</span>     ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;elsif&quot;</span>,    [<span class="ruby-value">:kELSIF</span>,    <span class="ruby-value">:kELSIF</span>      ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;def&quot;</span>,      [<span class="ruby-value">:kDEF</span>,      <span class="ruby-value">:kDEF</span>        ], <span class="ruby-value">:expr_fname</span> ],
                [<span class="ruby-string">&quot;rescue&quot;</span>,   [<span class="ruby-value">:kRESCUE</span>,   <span class="ruby-value">:kRESCUE_MOD</span> ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;not&quot;</span>,      [<span class="ruby-value">:kNOT</span>,      <span class="ruby-value">:kNOT</span>        ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;then&quot;</span>,     [<span class="ruby-value">:kTHEN</span>,     <span class="ruby-value">:kTHEN</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;yield&quot;</span>,    [<span class="ruby-value">:kYIELD</span>,    <span class="ruby-value">:kYIELD</span>      ], <span class="ruby-value">:expr_arg</span>   ],
                [<span class="ruby-string">&quot;for&quot;</span>,      [<span class="ruby-value">:kFOR</span>,      <span class="ruby-value">:kFOR</span>        ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;self&quot;</span>,     [<span class="ruby-value">:kSELF</span>,     <span class="ruby-value">:kSELF</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;false&quot;</span>,    [<span class="ruby-value">:kFALSE</span>,    <span class="ruby-value">:kFALSE</span>      ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;retry&quot;</span>,    [<span class="ruby-value">:kRETRY</span>,    <span class="ruby-value">:kRETRY</span>      ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;return&quot;</span>,   [<span class="ruby-value">:kRETURN</span>,   <span class="ruby-value">:kRETURN</span>     ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;true&quot;</span>,     [<span class="ruby-value">:kTRUE</span>,     <span class="ruby-value">:kTRUE</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;if&quot;</span>,       [<span class="ruby-value">:kIF</span>,       <span class="ruby-value">:kIF_MOD</span>     ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;defined?&quot;</span>, [<span class="ruby-value">:kDEFINED</span>,  <span class="ruby-value">:kDEFINED</span>    ], <span class="ruby-value">:expr_arg</span>   ],
                [<span class="ruby-string">&quot;super&quot;</span>,    [<span class="ruby-value">:kSUPER</span>,    <span class="ruby-value">:kSUPER</span>      ], <span class="ruby-value">:expr_arg</span>   ],
                [<span class="ruby-string">&quot;undef&quot;</span>,    [<span class="ruby-value">:kUNDEF</span>,    <span class="ruby-value">:kUNDEF</span>      ], <span class="ruby-value">:expr_fname</span> ],
                [<span class="ruby-string">&quot;break&quot;</span>,    [<span class="ruby-value">:kBREAK</span>,    <span class="ruby-value">:kBREAK</span>      ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;in&quot;</span>,       [<span class="ruby-value">:kIN</span>,       <span class="ruby-value">:kIN</span>         ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;do&quot;</span>,       [<span class="ruby-value">:kDO</span>,       <span class="ruby-value">:kDO</span>         ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;nil&quot;</span>,      [<span class="ruby-value">:kNIL</span>,      <span class="ruby-value">:kNIL</span>        ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;until&quot;</span>,    [<span class="ruby-value">:kUNTIL</span>,    <span class="ruby-value">:kUNTIL_MOD</span>  ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;unless&quot;</span>,   [<span class="ruby-value">:kUNLESS</span>,   <span class="ruby-value">:kUNLESS_MOD</span> ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;or&quot;</span>,       [<span class="ruby-value">:kOR</span>,       <span class="ruby-value">:kOR</span>         ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;next&quot;</span>,     [<span class="ruby-value">:kNEXT</span>,     <span class="ruby-value">:kNEXT</span>       ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;when&quot;</span>,     [<span class="ruby-value">:kWHEN</span>,     <span class="ruby-value">:kWHEN</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;redo&quot;</span>,     [<span class="ruby-value">:kREDO</span>,     <span class="ruby-value">:kREDO</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;and&quot;</span>,      [<span class="ruby-value">:kAND</span>,      <span class="ruby-value">:kAND</span>        ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;begin&quot;</span>,    [<span class="ruby-value">:kBEGIN</span>,    <span class="ruby-value">:kBEGIN</span>      ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;__LINE__&quot;</span>, [<span class="ruby-value">:k__LINE__</span>, <span class="ruby-value">:k__LINE__</span>   ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;class&quot;</span>,    [<span class="ruby-value">:kCLASS</span>,    <span class="ruby-value">:kCLASS</span>      ], <span class="ruby-value">:expr_class</span> ],
                [<span class="ruby-string">&quot;__FILE__&quot;</span>, [<span class="ruby-value">:k__FILE__</span>, <span class="ruby-value">:k__FILE__</span>   ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;END&quot;</span>,      [<span class="ruby-value">:klEND</span>,     <span class="ruby-value">:klEND</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;BEGIN&quot;</span>,    [<span class="ruby-value">:klBEGIN</span>,   <span class="ruby-value">:klBEGIN</span>     ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;while&quot;</span>,    [<span class="ruby-value">:kWHILE</span>,    <span class="ruby-value">:kWHILE_MOD</span>  ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;alias&quot;</span>,    [<span class="ruby-value">:kALIAS</span>,    <span class="ruby-value">:kALIAS</span>      ], <span class="ruby-value">:expr_fname</span> ],
                [<span class="ruby-string">&quot;__ENCODING__&quot;</span>, [<span class="ruby-value">:k__ENCODING__</span>, <span class="ruby-value">:k__ENCODING__</span>], <span class="ruby-value">:expr_end</span>],
               ].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-constant">KWtable</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>) }

    <span class="ruby-comment"># :startdoc:</span>

    <span class="ruby-constant">WORDLIST18</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">wordlist</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">o</span>] }.<span class="ruby-identifier">flatten</span>]
    <span class="ruby-constant">WORDLIST19</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">wordlist</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">o</span>] }.<span class="ruby-identifier">flatten</span>]

    <span class="ruby-constant">WORDLIST18</span>.<span class="ruby-identifier">delete</span> <span class="ruby-string">&quot;__ENCODING__&quot;</span>

    <span class="ruby-node">%w[and case elsif for if in module or unless until when while]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">dup</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">state</span> = <span class="ruby-value">:expr_value</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-node">%w[not]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">dup</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">state</span> = <span class="ruby-value">:expr_arg</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">keyword18</span> <span class="ruby-identifier">str</span> <span class="ruby-comment"># REFACTOR</span>
      <span class="ruby-constant">WORDLIST18</span>[<span class="ruby-identifier">str</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">keyword19</span> <span class="ruby-identifier">str</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">str</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">class</span> <span class="ruby-constant">Environment</span>
    <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:env</span>, <span class="ruby-value">:dyn</span>

    <span class="ruby-keyword">def</span> <span class="ruby-operator">[]</span> <span class="ruby-identifier">k</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">all</span>[<span class="ruby-identifier">k</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-operator">[]=</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;no&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">all</span>
      <span class="ruby-identifier">idx</span> = <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">index</span>(<span class="ruby-keyword">false</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
      <span class="ruby-ivar">@env</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">idx</span>].<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">inject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">env</span>, <span class="ruby-identifier">scope</span><span class="ruby-operator">|</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">scope</span> }
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">current</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">extend</span> <span class="ruby-identifier">dyn</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">dyn</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">unshift</span>({})
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span> <span class="ruby-identifier">dyn</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@dyn</span> = []
      <span class="ruby-ivar">@env</span> = []
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reset</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
      <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">clear</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">clear</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">extend</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">unextend</span>
      <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;You went too far unextending env&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">class</span> <span class="ruby-constant">StackState</span>
    <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:name</span>
    <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:stack</span>
    <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value">:debug</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">name</span>)
      <span class="ruby-ivar">@name</span> = <span class="ruby-identifier">name</span>
      <span class="ruby-ivar">@stack</span> = [<span class="ruby-keyword">false</span>]
      <span class="ruby-ivar">@debug</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">inspect</span>
      <span class="ruby-node">&quot;StackState(#{@name}, #{@stack.inspect})&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">is_in_state</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_is_in_state</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">name</span>, <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">lexpop</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_lexpop</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">a</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-identifier">b</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">a</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">b</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">pop</span>
      <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_pop</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">name</span>, <span class="ruby-identifier">r</span>, <span class="ruby-ivar">@stack</span>, <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">r</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">push</span> <span class="ruby-identifier">val</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">val</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_push</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">name</span>, <span class="ruby-ivar">@stack</span>, <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">store</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">dup</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">replace</span> [<span class="ruby-keyword">false</span>]
      <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">restore</span> <span class="ruby-identifier">oldstate</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">replace</span> <span class="ruby-identifier">oldstate</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_aref" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_aref</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_aref-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 497</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_aref</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
  <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-comment"># REFACTOR</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:self</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_body" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_body</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_body-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 508</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_body</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">body</span>, <span class="ruby-identifier">resbody</span>, <span class="ruby-identifier">elsebody</span>, <span class="ruby-identifier">ensurebody</span> = <span class="ruby-identifier">val</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">body</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:rescue</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

    <span class="ruby-identifier">res</span> = <span class="ruby-identifier">resbody</span>

    <span class="ruby-keyword">while</span> <span class="ruby-identifier">res</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">res</span>
      <span class="ruby-identifier">res</span> = <span class="ruby-identifier">res</span>.<span class="ruby-identifier">resbody</span>(<span class="ruby-keyword">true</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = (<span class="ruby-identifier">body</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">resbody</span>).<span class="ruby-identifier">line</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;else without rescue is useless&quot;</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:begin</span>, <span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">result</span>, <span class="ruby-identifier">elsebody</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:ensure</span>, <span class="ruby-identifier">result</span>, <span class="ruby-identifier">ensurebody</span>).<span class="ruby-identifier">compact</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ensurebody</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_call" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_call</span><span
            class="method-args">(recv, meth, args = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_call-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 559</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>, <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:call</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>)

  <span class="ruby-comment"># TODO: need a test with f(&amp;b) to produce block_pass</span>
  <span class="ruby-comment"># TODO: need a test with f(&amp;b) { } to produce warning</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span>
    <span class="ruby-keyword">if</span> [<span class="ruby-value">:arglist</span>, <span class="ruby-value">:args</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:call_args</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">sexp_body</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">args</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">line</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:line</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">line</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_case" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_case</span><span
            class="method-args">(expr, body, line)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_case-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 579</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_case</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">body</span>, <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:case</span>, <span class="ruby-identifier">expr</span>)

  <span class="ruby-keyword">while</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:when</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">3</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">block</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">block</span>(<span class="ruby-value">:delete</span>)
    <span class="ruby-identifier">node</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># else</span>
  <span class="ruby-identifier">body</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:block</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_class" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_class</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_class-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 600</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_class</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">5</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:class</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_compstmt" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_compstmt</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_compstmt-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 618</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_compstmt</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">void_stmts</span>(<span class="ruby-identifier">val</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>)[<span class="ruby-value">0</span>])
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_defn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_defn</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_defn-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 624</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defn</span> <span class="ruby-identifier">val</span>
  (<span class="ruby-identifier">_</span>, <span class="ruby-identifier">line</span>), <span class="ruby-identifier">name</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>, <span class="ruby-operator">*</span> = <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:nil</span>)

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defn</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">line</span> <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_defs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_defs</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_defs-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 645</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defs</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defs</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">recv</span>.<span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_for" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_for</span><span
            class="method-args">(expr, var, body)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_for-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 663</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_for</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:for</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">var</span>.<span class="ruby-identifier">line</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_if" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_if</span><span
            class="method-args">(c, t, f)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_if-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 669</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_if</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>
  <span class="ruby-identifier">l</span> = [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">f</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">c</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">c</span>
  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">f</span>, <span class="ruby-identifier">t</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span>
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:if</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">l</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_iter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_iter</span><span
            class="method-args">(call, args, body)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_iter-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 676</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_iter</span> <span class="ruby-identifier">call</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>)
  <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">args</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:iter</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">call</span>
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

  <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:args</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_masgn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_masgn</span><span
            class="method-args">(lhs, rhs, wrap = false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_masgn-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 698</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_masgn</span> <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">wrap</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">rhs</span>)
  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:to_ary</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">wrap</span>

  <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>

  <span class="ruby-identifier">lhs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_masgn_arg" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_masgn_arg</span><span
            class="method-args">(rhs, wrap = false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_masgn_arg-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 692</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_masgn_arg</span> <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">wrap</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">rhs</span>)
  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:to_ary</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">wrap</span> <span class="ruby-comment"># HACK: could be array if lhs isn&#39;t right</span>
  <span class="ruby-identifier">rhs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_module" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_module</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_module-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 708</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_module</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:module</span>, <span class="ruby-identifier">path</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># REFACTOR?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_op_asgn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_op_asgn</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_op_asgn-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 726</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_op_asgn</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-identifier">name</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">value</span>
  <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">arg</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">asgn_op</span> <span class="ruby-comment"># REFACTOR</span>
           <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;||&quot;</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_or</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;&amp;&amp;&quot;</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_and</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-comment"># TODO: why [2] ?</span>
             <span class="ruby-identifier">lhs</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">new_call</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">argl</span>(<span class="ruby-identifier">arg</span>))
             <span class="ruby-identifier">lhs</span>
           <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_regexp" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_regexp</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_regexp-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 746</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_regexp</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">node</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-string">&#39;&#39;</span>)
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]

  <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span> = <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">options</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-comment"># FIX: this has a better home</span>
    <span class="ruby-identifier">v</span> = {
      <span class="ruby-string">&#39;x&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">EXTENDED</span>,
      <span class="ruby-string">&#39;i&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">IGNORECASE</span>,
      <span class="ruby-string">&#39;m&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">MULTILINE</span>,
      <span class="ruby-string">&#39;o&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ONCE</span>,
      <span class="ruby-string">&#39;n&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>,
      <span class="ruby-string">&#39;e&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_EUC</span>,
      <span class="ruby-string">&#39;s&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_SJIS</span>,
      <span class="ruby-string">&#39;u&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_UTF8</span>,
    }[<span class="ruby-identifier">c</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown regexp option: #{c}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>
    <span class="ruby-identifier">o</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">v</span>

    <span class="ruby-comment"># encoding options are ignored on 1.9+</span>
    <span class="ruby-identifier">k</span> = <span class="ruby-identifier">c</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[esu]/</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">RUBY_VERSION</span> <span class="ruby-operator">&lt;</span> <span class="ruby-string">&quot;1.9&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:lit</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">then</span>
                <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span>)
              <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">begin</span>
                  <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>)
                <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RegexpError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                  <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;WA\RNING: #{e.message} for #{node[1].inspect} #{options.inspect}&quot;</span>
                  <span class="ruby-keyword">begin</span>
                    <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;WA\RNING: trying to recover with ENC_UTF8&quot;</span>
                    <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_UTF8</span>)
                  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RegexpError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;WA\RNING: trying to recover with ENC_NONE&quot;</span>
                    <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>)
                  <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dregx</span>, <span class="ruby-string">&#39;&#39;</span>, <span class="ruby-identifier">node</span>);
    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span>
    <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_resbody" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_resbody</span><span
            class="method-args">(cond, body)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_resbody-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 804</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_resbody</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">body</span>.<span class="ruby-identifier">shift</span> <span class="ruby-comment"># remove block and splat it in directly</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">body</span> = [<span class="ruby-identifier">body</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:resbody</span>, <span class="ruby-identifier">cond</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">body</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_sclass" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_sclass</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_sclass-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 813</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_sclass</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">in_def</span>, <span class="ruby-identifier">in_single</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:sclass</span>, <span class="ruby-identifier">recv</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-identifier">in_def</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-identifier">in_single</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_string</span><span
            class="method-args">(val)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_string-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 832</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_string</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">str</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-string">&quot;ASCII-8BIT&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">RUBY_VERSION</span> <span class="ruby-operator">&lt;</span> <span class="ruby-string">&quot;1.9&quot;</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-identifier">str</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">count</span>(<span class="ruby-string">&quot;\n&quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">extra_lineno</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">extra_lineno</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_super" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_super</span><span
            class="method-args">(args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_super-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 841</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_super</span> <span class="ruby-identifier">args</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, <span class="ruby-identifier">args</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_undef" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_undef</span><span
            class="method-args">(n, m = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_undef-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 850</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_undef</span> <span class="ruby-identifier">n</span>, <span class="ruby-identifier">m</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">m</span>))
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">n</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_until" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_until</span><span
            class="method-args">(block, expr, pre)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_until-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 858</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:until</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_until_or_while" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_until_or_while</span><span
            class="method-args">(type, block, expr, pre)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_until_or_while-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 862</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-identifier">other</span> = <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:until</span> <span class="ruby-operator">?</span> <span class="ruby-value">:while</span> <span class="ruby-operator">:</span> <span class="ruby-value">:until</span>
  <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">last</span>, <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:begin</span>

  <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">expr</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">unless</span> <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>,  <span class="ruby-identifier">expr</span>,      <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-identifier">other</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
           <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_when" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_when</span><span
            class="method-args">(cond, body)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_when-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 879</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_when</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:when</span>, <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_while" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_while</span><span
            class="method-args">(block, expr, pre)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_while-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 883</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_while</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:while</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_xstring" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_xstring</span><span
            class="method-args">(str)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_xstring-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 887</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_xstring</span> <span class="ruby-identifier">str</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span>
      <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:xstr</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span>
      <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dxstr</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">str</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dxstr</span>, <span class="ruby-string">&#39;&#39;</span>, <span class="ruby-identifier">str</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">str</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:xstr</span>, <span class="ruby-string">&#39;&#39;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-new_yield" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_yield</span><span
            class="method-args">(args = nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="new_yield-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 903</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_yield</span> <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-comment"># TODO: raise args.inspect unless [:arglist].include? args.first # HACK</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 4&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Block argument should not be given.&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

  <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)

  <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:call_args</span>, <span class="ruby-value">:array</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>])
  <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:yield</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-next_token" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">next_token</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="next_token-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 917</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">next_token</span>
  <span class="ruby-identifier">token</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">next_token</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">token</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">token</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">token</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> [<span class="ruby-keyword">false</span>, <span class="ruby-string">&#39;$end&#39;</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-node_assign" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">node_assign</span><span
            class="method-args">(lhs, rhs)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="node_assign-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 927</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">node_assign</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-comment"># TODO: rename new_assign</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lhs</span>

  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">rhs</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-value">:lasgn</span>, <span class="ruby-value">:iasgn</span>, <span class="ruby-value">:cdecl</span>, <span class="ruby-value">:cvdecl</span>, <span class="ruby-value">:gasgn</span>, <span class="ruby-value">:cvasgn</span>, <span class="ruby-value">:attrasgn</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:const</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:cdecl</span>
    <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown lhs #{lhs.inspect} w/ #{rhs.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">lhs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-on_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">on_error</span><span
            class="method-args">(et, ev, values)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          
            <div class="method-calls-super">
              Calls superclass method
              
            </div>
          

          
          <div class="method-source-code" id="on_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1122</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">on_error</span>(<span class="ruby-identifier">et</span>, <span class="ruby-identifier">ev</span>, <span class="ruby-identifier">values</span>)
  <span class="ruby-keyword">super</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Racc</span><span class="ruby-operator">::</span><span class="ruby-constant">ParseError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-comment"># I don&#39;t like how the exception obscures the error message</span>
  <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">replace</span> <span class="ruby-string">&quot;%s:%p :: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>, <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">strip</span>]
  <span class="ruby-identifier">warn</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">$DEBUG</span>
  <span class="ruby-identifier">raise</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-process" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">process</span><span
            class="method-args">(str, file = "(string)", time = 10)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Parse <code>str</code> at path <code>file</code> and return a sexp. Raises
Timeout::Error if it runs for more than <code>time</code> seconds.</p>
          
          

          
          <div class="method-source-code" id="process-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1022</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">str</span>, <span class="ruby-identifier">file</span> = <span class="ruby-string">&quot;(string)&quot;</span>, <span class="ruby-identifier">time</span> = <span class="ruby-value">10</span>)
  <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span> <span class="ruby-identifier">time</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad val: #{str.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">str</span>

    <span class="ruby-identifier">str</span> = <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">dup</span>

    <span class="ruby-ivar">@yydebug</span> = <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-string">&#39;DEBUG&#39;</span>

    <span class="ruby-comment"># HACK -- need to get tests passing more than have graceful code</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">ss</span> = <span class="ruby-constant">RPStringScanner</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">str</span>

    <span class="ruby-identifier">do_parse</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-remove_begin" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_begin</span><span
            class="method-args">(node)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="remove_begin-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1041</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">node</span>
  <span class="ruby-identifier">oldnode</span> = <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-value">:begin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reset" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="reset-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1050</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
  <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">reset</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">reset</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">clear</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ret_args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ret_args</span><span
            class="method-args">(node)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="ret_args-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1075</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ret_args</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 5&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;block argument should not be given&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:array</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:call_args</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>

    <span class="ruby-comment"># HACK matz wraps ONE of the FOUR splats in a newline to</span>
    <span class="ruby-comment"># distinguish. I use paren for now. ugh</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:svalue</span>, <span class="ruby-identifier">node</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">paren</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:svalue</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-s" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">s</span><span
            class="method-args">(*args)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="s-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1094</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">s</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-constant">Sexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">ss</span>          <span class="ruby-comment"># otherwise...</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">file</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-syntax_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">syntax_error</span><span
            class="method-args">(msg)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="syntax_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 126</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">syntax_error</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">RubyParser</span><span class="ruby-operator">::</span><span class="ruby-constant">SyntaxError</span>, <span class="ruby-identifier">msg</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-value_expr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">value_expr</span><span
            class="method-args">(oldnode)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="value_expr-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1101</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">oldnode</span> <span class="ruby-comment"># HACK</span>
  <span class="ruby-identifier">node</span> = <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">oldnode</span>
  <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">oldnode</span>
  <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:if</span>
  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-void_stmts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">void_stmts</span><span
            class="method-args">(node)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="void_stmts-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1108</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">void_stmts</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block</span>

  <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] = <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">n</span>) }
  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-warning" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">warning</span><span
            class="method-args">(s)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="warning-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1116</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">warning</span> <span class="ruby-identifier">s</span>
  <span class="ruby-comment"># do nothing for now</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

